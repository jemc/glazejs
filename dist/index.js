!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var n,o=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.setTo=function(t,e){this.x=t,this.y=e},t.prototype.copy=function(t){this.x=t.x,this.y=t.y},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y)+t.ZERO_TOLERANCE;return this.x/=e,this.y/=e,e},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSqrd=function(){return this.x*this.x+this.y*this.y},t.prototype.clampScalar=function(t){var e=this.length();e>t&&this.multEquals(t/e)},t.prototype.clampVector=function(t){this.x=Math.min(Math.max(this.x,-t.x),t.x),this.y=Math.min(Math.max(this.y,-t.y),t.y)},t.prototype.plusEquals=function(t){this.x+=t.x,this.y+=t.y},t.prototype.minusEquals=function(t){this.x-=t.x,this.y-=t.y},t.prototype.multEquals=function(t){this.x*=t,this.y*=t},t.prototype.plusMultEquals=function(t,e){this.x+=t.x*e,this.y+=t.y*e},t.prototype.minusMultEquals=function(t,e){this.x-=t.x*e,this.y-=t.y*e},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.leftHandNormal=function(){return new t(this.y,-this.x)},t.prototype.leftHandNormalEquals=function(){var t=this.x;this.x=this.y,this.y=-t},t.prototype.rightHandNormal=function(){return new t(-this.y,this.x)},t.prototype.rightHandNormalEquals=function(){var t=this.x;this.x=-this.y,this.y=t},t.prototype.reflectEquals=function(t){var e=this.dot(t);this.x-=2*e*t.x,this.y-=2*e*t.y},t.prototype.interpolate=function(t,e,i){this.copy(t),this.multEquals(1-i),this.plusMultEquals(e,i)},t.prototype.setAngle=function(t){var e=this.length();this.x=Math.cos(t)*e,this.y=Math.sin(t)*e},t.prototype.rotateEquals=function(t){var e=t*(Math.PI/180),i=Math.cos(e),n=Math.sin(e);this.x=i*this.x-n*this.y,this.y=i*this.y+n*this.x},t.prototype.setUnitRotation=function(t){var e=t*(Math.PI/180);this.x=Math.cos(e),this.y=Math.sin(e)},t.prototype.heading=function(){return Math.atan2(this.y,this.x)},t.prototype.distSqrd=function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i},t.prototype.roundDown=function(t){return this.x=Math.floor(this.x/t)*t,this.y=Math.floor(this.y/t)*t,this},t.ZERO_TOLERANCE=1e-8,t}(),r=function(){function t(){this.keyMap=new Array;for(var t=0;t<256;t++)this.keyMap[t]=0;this.mousePosition=new o,this.mousePreviousPosition=new o,this.mouseOffset=new o,this.frameRef=2}return t.prototype.InputTarget=function(t,e){this.target=t,t.addEventListener("keydown",this.KeyDown.bind(this)),t.addEventListener("keyup",this.KeyUp.bind(this)),t.addEventListener("mousedown",this.MouseDown.bind(this)),t.addEventListener("mouseup",this.MouseUp.bind(this)),t.addEventListener("mousemove",this.MouseMove.bind(this)),this.inputCorrection=e},t.prototype.ViewCorrectedMousePosition=function(){var t=this.mousePosition.clone();return t.plusEquals(this.mouseOffset),t},t.prototype.Update=function(t,e){this.mouseOffset.x=t,this.mouseOffset.y=e,this.frameRef++},t.prototype.KeyDown=function(t){0==this.keyMap[t.keyCode]&&(this.keyMap[t.keyCode]=this.frameRef),t.preventDefault()},t.prototype.KeyUp=function(t){this.keyMap[t.keyCode]=0,t.preventDefault()},t.prototype.MouseDown=function(t){this.keyMap[200]=this.frameRef,t.preventDefault()},t.prototype.MouseUp=function(t){this.keyMap[200]=0,t.preventDefault()},t.prototype.MouseMove=function(t){this.mousePreviousPosition.x=this.mousePosition.x,this.mousePreviousPosition.y=this.mousePosition.y,this.mousePosition.x=t.clientX-this.inputCorrection.x,this.mousePosition.y=t.clientY-this.inputCorrection.y,t.preventDefault()},t.prototype.Pressed=function(t){return this.keyMap[t]>0},t.prototype.JustPressed=function(t){return this.keyMap[t]==this.frameRef-1},t.prototype.PressedDuration=function(t){var e=this.keyMap[t];return e>0?this.frameRef-e:-1},t.prototype.Released=function(t){return 0==this.keyMap[t]},t}(),s=function(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<i;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)n[o]=r[s];return n},a=function(){function t(t){this.pool=[],this.factory=t,this.nextAvailableIndex=-1,this.totalAllocationCount=0}return t.prototype.addCapacity=function(t){this.pool=s(c(this.pool.length,t,this.factory),this.pool),this.nextAvailableIndex+=t},t.prototype.reserve=function(){0==this.nextAvailableIndex&&this.addCapacity(this.totalAllocationCount);var t=this.pool[this.nextAvailableIndex];return this.pool[this.nextAvailableIndex]=null,this.nextAvailableIndex--,this.totalAllocationCount++,t},t.prototype.free=function(t){this.nextAvailableIndex++,this.pool[this.nextAvailableIndex]=t},Object.defineProperty(t.prototype,"capacity",{get:function(){return this.pool.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"assigned",{get:function(){return this.pool.length-this.nextAvailableIndex},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalAllocations",{get:function(){return this.totalAllocationCount},enumerable:!0,configurable:!0}),t}(),h=function(t,e){return e-t},c=function(t,e,i){return(n=e,Array(n).fill(null)).map((function(e,n){return i(t+n)})).sort(h);var n},u=function(){function t(t){this.reset(t)}return t.prototype.get=function(t){var e=Math.floor(t/32);return!!(this.values[e]&1<<t-32*e)},t.prototype.set=function(t,e){var i=Math.floor(t/32);e?this.values[i]|=1<<t-32*i:this.values[i]&=~(1<<t-32*i)},t.prototype.maskAll=function(t){for(var e=0;e<this.size;e++){var i=t[e];if((i&this.values[e])!==i)return!1}return!0},t.prototype.maskNone=function(t){for(var e=0;e<this.size;e++){if(t[e]&this.values[e])return!1}return!0},t.prototype.not=function(){for(var t=0;t<this.size;t++)this.values[t]=~this.values[t]},t.prototype.and=function(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]&t.values[e]},t.prototype.or=function(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]|t.values[e]},t.prototype.xor=function(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]^t.values[e]},t.prototype.reset=function(t){this.size=t,this.values=new Uint32Array(this.size);for(var e=0;e<Math.ceil(this.size/32);e++)this.values[e]=0},t}(),p=function(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<i;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)n[o]=r[s];return n},l=function(){function t(){this.components=new Map,this.componentTypes=new Map,this.phases=new Array,this.systems=new Array,this.c4e=new Map,this.entityPool=new a((function(t){return t})),this.nextTypeId=0}return t.prototype.addCapacityToEngine=function(t){var e=this;this.entityPool.addCapacity(t),this.components.forEach((function(t,i){return e.components.set(i,p(e.components.get(i),d(e.entityPool.capacity)))}))},t.prototype.createEntity=function(){var t=this.entityPool.reserve();return this.c4e.set(t,f(this,t)),t},t.prototype.destroyEntity=function(t){this.systems.forEach((function(e){return e.removeEntity(t)})),this.clearAllComponentsForEntity(t),this.entityPool.free(t),this.c4e.delete(t)},t.prototype.getComponentForEntity=function(t,e){var i=e.name;return this.components.has(i)?this.components.get(i)[t]:null},t.prototype.addComponentsToEntity=function(t,e){for(var i=0,n=e;i<n.length;i++){var o=n[i],r=this.createComponentEntryFromInstance(o);this.components.get(r)[t]=o}this.matchEntity(t)},t.prototype.removeComponentsFromEntityByType=function(t,e){for(var i=0,n=e;i<n.length;i++){var o=n[i].name;this.components.has(o)&&(this.components.get(o)[t]=null)}this.matchEntity(t)},t.prototype.addPhase=function(t){t.engine=this,this.phases.push(t)},t.prototype.addPhaseSystemToEngine=function(t){var e=this;this.systems.push(t);var i=new u(4);t.componentTypes.forEach((function(t){var n=e.createComponentEntryFromType(t);i.set(e.componentTypes.get(n),!0)})),t.onAddedToEngine(this,i)},t.prototype.update=function(t,e){for(var i=0,n=this.phases;i<n.length;i++){n[i].updatePhase(t,e)}},t.prototype.query=function(t){for(var e=this,i=[],n=0;n<this.entityPool.capacity;n++)t.every((function(t){return null!==e.components.get(t.name)[n]}))&&i.push(n);return i},t.prototype.snapshot=function(){return{activeEntities:this.entityPool.assigned,totalEntitiesCreated:this.entityPool.totalAllocations}},t.prototype.createComponentEntryFromType=function(t){var e=t.name;if(!this.components.has(e)){var i=this.nextTypeId++;this.components.set(e,d(this.entityPool.capacity)),this.componentTypes.set(e,i),t.prototype._id_=i}return e},t.prototype.createComponentEntryFromInstance=function(t){var e=t.constructor.name;if(!this.components.has(e)){var i=this.nextTypeId++;this.components.set(e,d(this.entityPool.capacity)),this.componentTypes.set(e,i),t.constructor.prototype._id_=i}return e},t.prototype.matchEntity=function(t){for(var e=0,i=this.systems;e<i.length;e++){for(var n=i[e],o=n.componentTypes.length,r=0,s=n.componentTypes;r<s.length;r++){var a=s[r];this.components.get(a.name)[t]&&o--}0===o?n.addEntity(t,this.entityComponentsForSystem(t,n)):n.removeEntity(t)}},t.prototype.entityComponentsForSystem=function(t,e){var i=this;return e.componentTypes.map((function(e){return i.components.get(e.name)[t]}))},t.prototype.addEntitiesToComponentList=function(t){this.components.set(t,d(this.entityPool.capacity))},t.prototype.clearAllComponentsForEntity=function(t){this.components.forEach((function(e){return e[t]=null}))},t}(),d=function(t){return Array(t).fill(null)},f=function(t,e){return function(i){return t.getComponentForEntity(e,i)}},y=function(){function t(t,e,i,n,o){void 0===o&&(o=0),this.active=!0,this.params=null,this._listener=e,this._isOnce=i,this.context=n,this._signal=t,this.priority=o||0}return t.prototype.execute=function(t){var e,i;return this.active&&this._listener&&(i=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,i),this._isOnce&&this.detach()),e},t.prototype.detach=function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},t.prototype.isBound=function(){return!!this._signal&&!!this._listener},t.prototype.isOnce=function(){return this._isOnce},t.prototype.getListener=function(){return this._listener},t.prototype.getSignal=function(){return this._signal},t.prototype._destroy=function(){delete this._signal,delete this._listener,delete this.context},t.prototype.toString=function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"},t}(),g=function(){function t(){this._bindings=[],this._prevParams=null,this.memorize=!1,this._shouldPropagate=!0,this.active=!0}return t.prototype.validateListener=function(t,e){if("function"!=typeof t)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))},t.prototype._registerListener=function(t,e,i,n){var o,r=this._indexOfListener(t,i);if(-1!==r){if((o=this._bindings[r]).isOnce()!==e)throw new Error("You cannot add"+(e?"":"Once")+"() then add"+(e?"Once":"")+"() the same listener without removing the relationship first.")}else o=new y(this,t,e,i,n),this._addBinding(o);return this.memorize&&this._prevParams&&o.execute(this._prevParams),o},t.prototype._addBinding=function(t){var e=this._bindings.length;do{--e}while(this._bindings[e]&&t.priority<=this._bindings[e].priority);this._bindings.splice(e+1,0,t)},t.prototype._indexOfListener=function(t,e){for(var i,n=this._bindings.length;n--;)if((i=this._bindings[n]).getListener()===t&&i.context===e)return n;return-1},t.prototype.has=function(t,e){return void 0===e&&(e=null),-1!==this._indexOfListener(t,e)},t.prototype.add=function(t,e,i){return void 0===e&&(e=null),void 0===i&&(i=0),this.validateListener(t,"add"),this._registerListener(t,!1,e,i)},t.prototype.addOnce=function(t,e,i){return void 0===e&&(e=null),void 0===i&&(i=0),this.validateListener(t,"addOnce"),this._registerListener(t,!0,e,i)},t.prototype.remove=function(t,e){void 0===e&&(e=null),this.validateListener(t,"remove");var i=this._indexOfListener(t,e);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),t},t.prototype.removeAll=function(){for(var t=this._bindings.length;t--;)this._bindings[t]._destroy();this._bindings.length=0},t.prototype.getNumListeners=function(){return this._bindings.length},t.prototype.halt=function(){this._shouldPropagate=!1},t.prototype.dispatch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this.active){var i,n=this._bindings.length;if(this.memorize&&(this._prevParams=t),n){i=this._bindings.slice(0),this._shouldPropagate=!0;do{n--}while(i[n]&&this._shouldPropagate&&!1!==i[n].execute(t))}}},t.prototype.forget=function(){this._prevParams=null},t.prototype.dispose=function(){this.removeAll(),delete this._bindings,delete this._prevParams},t.prototype.toString=function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"},t}(),m=function(){function t(){this.assets=new Map,this.loaded=new g,this.Reset()}return t.prototype.Reset=function(){this.running=!1,this.loaders=new Array},t.prototype.SetImagesToLoad=function(t){var e=this;t.forEach((function(t){return e.AddAsset(t)}))},t.prototype.AddAsset=function(t){if(1!=this.running){var e=this.LoaderFactory(t);e.Init(t),this.loaders.push(e)}},t.prototype.LoaderFactory=function(t){var e=t.substring(t.length-3,t.length);return"png"==e?new v(this):"tmx"==e||"xml"==e||"son"==e?new b(this):null},t.prototype.Load=function(){1!=this.running&&0!=this.loaders.length&&(this.completeCount=this.loaders.length,this.running=!0,this.loaders.forEach((function(t){return t.Load()})))},t.prototype.onLoad=function(t){this.completeCount--,this.assets.set(t.getKey(),t.getValue()),0==this.completeCount&&(this.loaded.dispatch(),this.running=!1)},t}(),v=function(){function t(t){this.mgr=t}return t.prototype.Init=function(t){this.url=t,this.image=new Image,this.image.onload=this.onLoad.bind(this),this.image.crossOrigin="anonymous"},t.prototype.Load=function(){this.image.src=this.url+"?cb="+Date.now(),1==this.image.complete&&this.onLoad(null)},t.prototype.onLoad=function(t){null!=this.mgr&&this.mgr.onLoad(this)},t.prototype.getKey=function(){return this.url},t.prototype.getValue=function(){return this.image},t}(),b=function(){function t(t){this.mgr=t}return t.prototype.Init=function(t){this.url=t,this.xhr=new XMLHttpRequest,this.xhr.responseType="text",this.xhr.onload=this.onLoad.bind(this),this.xhr.open("GET",this.url+"?cb="+Date.now(),!0)},t.prototype.Load=function(){this.xhr.send()},t.prototype.onLoad=function(t){null!=this.mgr&&this.mgr.onLoad(this)},t.prototype.getKey=function(){return this.url},t.prototype.getValue=function(){return this.xhr.response},t}(),x=function(){function t(){this.isRunning=!1,this.update=this.update.bind(this)}return t.prototype.update=function(t){this.delta=0==this.prevAnimationTime?1e3/60+1e-8:t-this.prevAnimationTime,this.prevAnimationTime=t,null!=this.updateFunc&&this.updateFunc(1e3/60+1e-8,Math.floor(t)),this.rafID=window.requestAnimationFrame(this.update)},t.prototype.start=function(){1!=this.isRunning&&(this.isRunning=!0,this.prevAnimationTime=0,this.rafID=window.requestAnimationFrame(this.update))},t.prototype.stop=function(){0!=this.isRunning&&(this.isRunning=!1,window.cancelAnimationFrame(this.rafID))},t}();!function(t){t.WHITE="white",t.RED="red",t.BLUE="blue"}(n||(n={}));var w=function(){function t(){}return t.prototype.Resize=function(t){},t.prototype.Clear=function(){},t.prototype.DrawAABB=function(t,e){},t.prototype.DrawAABB2=function(t,e){},t.prototype.DrawCross=function(t,e,i,n){},t.prototype.DrawLine=function(t,e,i,n,o){},t}(),C=function(){function t(t,e,i){this.view=t,this.camera=e,this.ctx=t.getContext("2d"),this.Resize(i)}return t.prototype.Resize=function(t){this.size=t,this.view.width=t.x,this.view.height=t.y},t.prototype.Clear=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.size.x,this.size.y),this.ctx.strokeStyle="rgba(0,255,0,1)",this.ctx.translate(this.camera.position.x,this.camera.position.y)},t.prototype.DrawRect=function(t,e,i,n,o){this.ctx.strokeRect(t,e,i,n)},t.prototype.DrawAABB=function(t,e){void 0===e&&(e=n.WHITE),this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t.l,t.t),this.ctx.lineTo(t.r,t.t),this.ctx.moveTo(t.r,t.b),this.ctx.lineTo(t.l,t.b),this.ctx.stroke()},t.prototype.DrawAABB2=function(t,e){void 0===e&&(e=n.WHITE),this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t.l,t.t),this.ctx.lineTo(t.r,t.t),this.ctx.lineTo(t.r,t.b),this.ctx.lineTo(t.l,t.b),this.ctx.lineTo(t.l,t.t),this.ctx.stroke()},t.prototype.DrawCross=function(t,e,i,o){void 0===o&&(o=n.WHITE),this.ctx.beginPath(),this.ctx.moveTo(t-i,e),this.ctx.lineTo(t+i,e),this.ctx.moveTo(t,e-i),this.ctx.lineTo(t,e+i),this.ctx.stroke()},t.prototype.DrawLine=function(t,e,i,o,r){void 0===r&&(r=n.WHITE),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,o),this.ctx.stroke()},t}(),E=function(){function t(){}return Object.defineProperty(t,"debug",{get:function(){return t._debug},set:function(e){t._debug=e,t.debugRender.Clear(),t.debugRender=t._debug?t.debuggingRender:t.nullDebuggingRender},enumerable:!0,configurable:!0}),t.engine=null,t.tileSize=16,t.resolution=new o(1280,720),t.nullDebuggingRender=new w,t.debuggingRender=new w,t.debugRender=t.nullDebuggingRender,t._debug=!1,t}(),_=function(){function t(t){this.canvas=t,this.loop=new x,this.loop.updateFunc=this.update.bind(this),this.input=new r;var e=t.getBoundingClientRect();this.input.InputTarget(document,new o(e.left,e.top)),window.location!==window.parent.location&&(window.onclick=function(){document.hasFocus()||window.focus()}),E.engine=this.engine=new l}return t.prototype.loadAssets=function(t){this.assets=new m,this.assets.loaded.add(this.initalize.bind(this)),this.assets.SetImagesToLoad(t),this.assets.Load()},t.prototype.initalize=function(){},t.prototype.update=function(t,e){this.preUpdate(),this.engine.update(t,e),this.postUpdate()},t.prototype.preUpdate=function(){},t.prototype.postUpdate=function(){},t}(),A=function(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<i;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)n[o]=r[s];return n},T=function(){function t(t){this.members=new Map,this.componentTypes=t}return t.prototype.onAddedToEngine=function(t,e){this.engine=t,this.matchMask=e},t.prototype.addEntity=function(t,e){var i;if(!this.members.has(t)){var n={components:e,boundUpdate:(i=this.updateEntity).bind.apply(i,A([this,t],e))};this.members.set(t,n),this.onEntityAdded.apply(this,A([t],e))}},t.prototype.onEntityAdded=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]},t.prototype.removeEntity=function(t){if(this.members.has(t)){var e=this.members.get(t);this.onEntityRemoved.apply(this,A([t],e.components)),this.members.delete(t)}},t.prototype.onEntityRemoved=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]},t.prototype.updateSystem=function(t,e){this.dt=t,this.timestamp=e,this.preUpdate()&&(this.updateAllEntities(),this.postUpdate())},t.prototype.preUpdate=function(){return!0},t.prototype.updateAllEntities=function(){for(var t=0,e=this.members.values();t<e.length;t++){e[t].boundUpdate()}},t.prototype.postUpdate=function(){},t.prototype.updateEntity=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]},t}(),P=function(){function t(t,e,i,n){void 0===i&&(i=1),void 0===n&&(n=1),this.coords=new o(t,e),this.prevCoords=new o(t,e),this.direction=new o(i,n)}return t.prototype.update=function(t){this.prevCoords.copy(this.coords),this.coords.copy(t)},t.prototype.clone=function(){var e=new t(this.coords.x,this.coords.y);return e.prevCoords.copy(this.prevCoords),e.direction.copy(this.direction),e},t}(),S=function(){function t(t,e){void 0===e&&(e=null),this.frameListId=t,this.initialFrameId=e}return t.prototype.setFrame=function(t){this.frame=t,null!=this.sprite&&this.frame.updateSprite(this.sprite)},t.prototype.setFrameId=function(t){this.frame=this.frameList.getFrame(t)},t}();function R(){return(t=new Float32Array(9))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t;var t}var L=function(){function t(){this.position=new o,this.scale=new o(1,1),this.pivot=new o,this._rotationComponents=new o,this.rotation=0,this.alpha=1,this.visible=!0,this.renderable=!1,this.parent=null,this.worldTransform=R(),this.localTransform=R()}return Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation=t,this._rotationComponents.x=Math.cos(this._rotation),this._rotationComponents.y=Math.sin(this._rotation)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t},enumerable:!0,configurable:!0}),t.prototype.RoundFunction=function(t){return t},t.prototype.updateTransform=function(){},t.prototype.calcExtents=function(){},t}(),F=(Math.PI,Math.PI/180),O=Math.pow(2,31)-1,B=-O;function M(t){return t*F}var W,G=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.l=O,this.t=O,this.r=B,this.b=B,this.t=t,this.r=e,this.b=i,this.l=n}return t.prototype.setToSweeptAABB=function(t,e){this.l=t.position.x-t.extents.x,this.r=t.position.x+t.extents.x,this.t=t.position.y-t.extents.y,this.b=t.position.y+t.extents.y},t.prototype.fromAABB=function(t){},t.prototype.clone=function(){return new t(this.t,this.r,this.b,this.l)},t.prototype.reset=function(){this.t=this.l=O,this.r=this.b=B},Object.defineProperty(t.prototype,"width",{get:function(){return this.r-this.l},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.b-this.t},enumerable:!0,configurable:!0}),t.prototype.intersect=function(t){return this.l<=t.r&&this.r>t.l&&this.t<=t.b&&this.b>=t.t},t.prototype.addAABB=function(t){t.t<this.t&&(this.t=t.t),t.r>this.r&&(this.r=t.r),t.b>this.b&&(this.b=t.b),t.l<this.l&&(this.l=t.l)},t.prototype.combine=function(t){var e=this.clone();return e.addAABB(t),e},t.prototype.combine2=function(t,e){return this.t=Math.min(t.t,e.t),this.r=Math.max(t.r,e.r),this.b=Math.max(t.b,e.b),this.l=Math.min(t.l,e.l),this},t.prototype.addPoint=function(t,e){t<this.l&&(this.l=t),t>this.r&&(this.r=t),e<this.t&&(this.t=e),e>this.b&&(this.b=e)},t.prototype.fitPoint=function(t){t.x<this.l&&(t.x=this.l),t.x>this.r&&(t.x=this.r),t.y<this.t&&(t.y=this.t),t.y>this.b&&(t.y=this.b)},t.prototype.expand=function(t){this.l-=t,this.r+=t,this.t-=t,this.b+=t},t.prototype.expand2=function(t,e){this.l+=t/2,this.r-=t/2,this.t+=e/2,this.b-=e/2},t.prototype.contains=function(t){return this.l<=t.l&&this.t<=t.t&&t.b<this.b&&t.r<this.r},t.prototype.copy=function(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b},t.prototype.copyAABB=function(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b},t.prototype.transform=function(t){this.l+=t.x,this.r+=t.x,this.t+=t.y,this.b+=t.y},t.prototype.perimeter=function(){return 2*(this.width+this.height)},t}(),I=(W=function(t,e){return(W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}W(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),D=function(t){function e(){var e=t.call(this)||this;return e.subTreeAABB=new G,e.childCount=0,e}return I(e,t),e.prototype.addChild=function(t){null!=t.parent&&t.parent.removeChild(t),this.insertEnd(t),this.childAdded(t)},e.prototype.addChildAt=function(t,e){e>=this.childCount?this.addChild(t):(0==e?this.insertBeginning(t):this.insertBefore(this.findChildByIndex(e),t),this.childAdded(t))},e.prototype.childAdded=function(t){this.childCount++,t.parent=this},e.prototype.findChildByIndex=function(t){for(var e=this.head,i=0;null!=e;){if(i++==t)return e;e=e.next}return this.tail},e.prototype.removeChild=function(t){t.parent==this&&(this.remove(t),this.childRemoved(t))},e.prototype.removeChildAt=function(t){var e=this.findChildByIndex(t);return this.removeChild(e),e},e.prototype.childRemoved=function(t){this.childCount--,t.parent=null},e.prototype.updateTransform=function(){var t=Math.floor(this.position.x),e=Math.floor(this.position.y),i=this._rotationComponents.y,n=this._rotationComponents.x;this.localTransform[0]=n*this.scale.x,this.localTransform[1]=-i*this.scale.y,this.localTransform[3]=i*this.scale.x,this.localTransform[4]=n*this.scale.y;var o=this.parent.worldTransform,r=this.localTransform[0],s=this.localTransform[1],a=t-(this.localTransform[0]*this.pivot.x-this.pivot.y*this.localTransform[1]),h=this.localTransform[3],c=this.localTransform[4],u=e-(this.localTransform[4]*this.pivot.y-this.pivot.x*this.localTransform[3]),p=o[0],l=o[1],d=o[2],f=o[3],y=o[4],g=o[5];this.localTransform[2]=a,this.localTransform[5]=u,this.worldTransform[0]=p*r+l*h,this.worldTransform[1]=p*s+l*c,this.worldTransform[2]=p*a+l*u+d,this.worldTransform[3]=f*r+y*h,this.worldTransform[4]=f*s+y*c,this.worldTransform[5]=f*a+y*u+g,this.worldAlpha=this.alpha*this.parent.worldAlpha,this.calcExtents();for(var m=this.head;null!=m;)m.updateTransform(),m=m.next},e.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,null==t.next?this.tail=e:t.next.prev=e,t.next=e},e.prototype.insertBefore=function(t,e){e.prev=t.prev,e.next=t,null==t.prev?this.head=e:t.prev.next=e,t.prev=e},e.prototype.insertBeginning=function(t){null==this.head?(this.head=t,this.tail=t,t.prev=null,t.next=null):this.insertBefore(this.head,t)},e.prototype.insertEnd=function(t){null==this.tail?this.insertBeginning(t):this.insertAfter(this.tail,t)},e.prototype.remove=function(t){null==t.prev?this.head=t.next:t.prev.next=t.next,null==t.next?this.tail=t.prev:t.next.prev=t.prev,t.prev=t.next=null},e.prototype.debug=function(){for(var t=this.head;null!=t;)t=t.next},e}(L),z=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),U=function(t){function e(){var e=t.call(this)||this;return e.id="Stage",e.worldAlpha=e.alpha,e}return z(e,t),e.prototype.updateTransform=function(){for(var t=this.head;null!=t;)t.updateTransform(),t=t.next},e}(D),k=function(){function t(t,e,i,n,o,r,s){void 0===n&&(n=800),void 0===o&&(o=600),void 0===r&&(r=!1),void 0===s&&(s=!1),this.stage=t,this.camera=e,this.view=i,this.contextLost=!1,this.contextAttributes={},this.contextAttributes.alpha=r,this.contextAttributes.antialias=s,this.contextAttributes.premultipliedAlpha=!0,this.contextAttributes.stencil=!1,this.renderers=new Array,this.InitalizeWebGlContext(),this.Resize(n,o)}return t.prototype.InitalizeWebGlContext=function(){this.view.addEventListener("webglcontextlost",this.onContextLost,!1),this.view.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.gl=this.view.getContext("webgl",this.contextAttributes),this.gl.disable(WebGLRenderingContext.DEPTH_TEST),this.gl.disable(WebGLRenderingContext.CULL_FACE),this.gl.enable(WebGLRenderingContext.BLEND),this.gl.colorMask(!0,!0,!0,this.contextAttributes.alpha),this.gl.clearColor(0,0,0,1),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.getExtension("OES_texture_float")||console.log("New browser time: Float textures not supported")},t.prototype.Resize=function(t,e){this.width=t,this.height=e,this.view.width=t,this.view.height=e,this.gl.viewport(0,0,t,e),this.gl.scissor(0,0,t,e)},t.prototype.AddRenderer=function(t){t.Init(this.gl,this.camera),t.Resize(this.width,this.height),this.renderers.push(t)},t.prototype.Render=function(t){if(!this.contextLost){this.gl.clearColor(159/255,188/255,197/255,1),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA);for(var e=0,i=this.renderers;e<i.length;e++){i[e].Render(t)}}},t.prototype.onContextLost=function(t){this.contextLost=!0,console.log("webGL Context Lost")},t.prototype.onContextRestored=function(t){this.contextLost=!1,console.log("webGL Context Restored")},t}(),N=function(){function t(t,e,i,n){void 0===n&&(n=!1),this.gl=t,this.powerOfTwo=!1,this.width=e,this.height=i,this.RegisterTexture(n)}return t.prototype.RegisterTexture=function(t){null==this.texture&&(this.texture=this.gl.createTexture()),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),this.powerOfTwo?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,this.width,this.height,0,WebGLRenderingContext.RGBA,t?WebGLRenderingContext.FLOAT:WebGLRenderingContext.UNSIGNED_BYTE,null)},t.FromImage=function(e,i){var n=new t(e,i.width,i.height);return e.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,i),n},t.prototype.bind=function(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture)},t.prototype.unbind=function(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,null)},t.prototype.drawTo=function(t){null==this.framebuffer&&(this.framebuffer=this.gl.createFramebuffer()),null==this.renderbuffer&&(this.renderbuffer=this.gl.createRenderbuffer()),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,this.framebuffer),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,this.renderbuffer),this.width==this.renderbuffer.width&&this.height==this.renderbuffer.height||(this.renderbuffer.width=this.width,this.renderbuffer.height=this.height,this.gl.renderbufferStorage(WebGLRenderingContext.RENDERBUFFER,WebGLRenderingContext.DEPTH_COMPONENT16,this.width,this.height),this.gl.framebufferTexture2D(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.COLOR_ATTACHMENT0,WebGLRenderingContext.TEXTURE_2D,this.texture,0),this.gl.framebufferRenderbuffer(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.DEPTH_ATTACHMENT,WebGLRenderingContext.RENDERBUFFER,this.renderbuffer)),this.gl.viewport(0,0,this.width,this.height),t(),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,null),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,null),this.gl.viewport(0,0,1280,720)},t.prototype.UnregisterTexture=function(t){this.texture},t}(),j=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n},V=function(){function t(t,e,i){void 0===i&&(i=null),this.noFrame=!1,this.baseTexture=t,null==e?(this.noFrame=!0,this.frame=new j(0,0,1,1)):this.frame=e,this.trim=new o,this.pivot=null==i?new o:i,this.uvs=new Float32Array(8),this.updateUVS()}return t.prototype.updateUVS=function(){var t=this.baseTexture.width,e=this.baseTexture.height;this.uvs[0]=this.frame.x/t,this.uvs[1]=this.frame.y/e,this.uvs[2]=(this.frame.x+this.frame.width)/t,this.uvs[3]=this.frame.y/e,this.uvs[4]=(this.frame.x+this.frame.width)/t,this.uvs[5]=(this.frame.y+this.frame.height)/e,this.uvs[6]=this.frame.x/t,this.uvs[7]=(this.frame.y+this.frame.height)/e},t}(),q=function(){function t(t){this.gl=t,this.baseTextures=new Map,this.textures=new Map}return t.prototype.AddTexture=function(t,e){var i=N.FromImage(this.gl,e);return this.baseTextures.set(t,i),i},t.prototype.ParseTexturePackerJSON=function(t,e){var i=this;if("string"==typeof t){var n=this.baseTextures.get(e),r=JSON.parse(t);Object.keys(r.frames).forEach((function(t){var e=r.frames[t];i.textures.set(t,new V(n,new j(e.frame.x,e.frame.y,e.frame.w,e.frame.h),new o(e.pivot.x,e.pivot.y)))}))}},t.prototype.ParseTexturesFromTiles=function(t,e){},t}(),H=function(){function t(){this.frames=new Array,this.framesHash=new Map,this.animationsHash=new Map}return t.prototype.addFrame=function(t){this.frames.push(t),this.framesHash.set(t.name,t)},t.prototype.getFrame=function(t){return this.framesHash.get(t)},t.prototype.addAnimation=function(t){this.animationsHash.set(t.name,t)},t.prototype.getAnimation=function(t){return this.animationsHash.get(t)},Object.defineProperty(t.prototype,"numFrames",{get:function(){return frames.length},enumerable:!0,configurable:!0}),t}(),X=function(){function t(t,e,i){this.name=t,this.texture=e,this.scale=i}return t.prototype.updateSprite=function(t,e,i){void 0===e&&(e=1),void 0===i&&(i=1),t.texture=this.texture,t.pivot.x=t.texture.frame.width*t.texture.pivot.x,t.pivot.y=(t.texture.frame.height+2)*t.texture.pivot.y,t.scale.x=this.scale.x*e,t.scale.y=this.scale.y*i},t}(),Y=function(t,e,i,n,o,r){void 0===i&&(i=0),void 0===n&&(n=!0),void 0===o&&(o=!1),void 0===r&&(r=!1),this.name=t,this.frameRate=i,this.frames=e,this.looped=n,this.flipX=o,this.flipY=r,this.msPerFrame=1e3/this.frameRate,this.length=this.frames.length},J=function(){function t(t){this.textureManager=t,this.frameLists=new Map}return t.prototype.getFrameList=function(t){return this.frameLists.get(t)},t.prototype.ParseFrameListJSON=function(t){var e=this;if("string"==typeof t){var i=JSON.parse(t);Object.keys(i).forEach((function(t){var n=new H;e.frameLists.set(t,n);var o=i[t];null!=o.frames&&(o.frames.forEach((function(t){n.addFrame(new X(t.id,e.textureManager.textures.get(t.name),t.scale))})),null!=o.animations&&Object.keys(o.animations).forEach((function(t){var e=o.animations[t];n.addAnimation(new Y(t,e.frames.map((function(t){return n.frames[t]})),e.fps,e.looped,e.flipX,e.flipY))})))}))}},t}(),K=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Z=function(t){function e(){var e=t.call(this)||this;return e.renderable=!0,e.anchor=new o,e.transformedVerts=new Float32Array(8),e.blendEquation=WebGLRenderingContext.FUNC_ADD,e.blendFuncRGB=WebGLRenderingContext.ONE,e.blendFuncA=WebGLRenderingContext.ZERO,e}return K(e,t),e.prototype.calcExtents=function(){var t=this.texture.frame.width,e=this.texture.frame.height,i=this.anchor.x,n=this.anchor.y,o=t*(1-i),r=t*-i,s=e*(1-n),a=e*-n,h=this.worldTransform[0],c=this.worldTransform[3],u=this.worldTransform[1],p=this.worldTransform[4],l=this.worldTransform[2],d=this.worldTransform[5];this.transformedVerts[0]=h*r+u*a+l,this.transformedVerts[1]=p*a+c*r+d,this.transformedVerts[2]=h*o+u*a+l,this.transformedVerts[3]=p*a+c*o+d,this.transformedVerts[4]=h*o+u*s+l,this.transformedVerts[5]=p*s+c*o+d,this.transformedVerts[6]=h*r+u*s+l,this.transformedVerts[7]=p*s+c*r+d},e}(D),Q=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),$=function(t){function e(e,i,n){var o=t.call(this,[P,S])||this;return o.canvas=e,o.stage=new U,o.camera=i,o.stage.addChild(o.camera),o.renderer=new k(o.stage,o.camera,o.canvas,n.x,n.y),o.camera.Resize(o.renderer.width,o.renderer.height),o.textureManager=new q(o.renderer.gl),o.frameListManager=new J(o.textureManager),o.itemContainer=new D,o.itemContainer.id="itemContainer",o.camera.addChild(o.itemContainer),o}return Q(e,t),e.prototype.initalize=function(){},e.prototype.onEntityAdded=function(t,e,i){null==i.sprite&&(i.sprite=new Z,i.frameList=this.frameListManager.getFrameList(i.frameListId),null!=i.initialFrameId?i.setFrame(i.frameList.getFrame(i.initialFrameId)):i.setFrame(i.frameList.frames[0]),i.sprite.position=e.coords),this.itemContainer.addChild(i.sprite)},e.prototype.onEntityRemoved=function(t,e,i){this.itemContainer.removeChild(i.sprite)},e.prototype.updateSystem=function(){this.camera.Focus(this._cameraTarget.x,this._cameraTarget.y),this.renderer.Render(this.camera.viewPortAABB)},Object.defineProperty(e.prototype,"cameraTarget",{set:function(t){this._cameraTarget=t},enumerable:!0,configurable:!0}),e}(T);function tt(t,e,i){var n=t.createShader(i);return t.shaderSource(n,e),t.compileShader(n),t.getShaderParameter(n,WebGLRenderingContext.COMPILE_STATUS)?n:(window.alert(t.getShaderInfoLog(n)),null)}function et(t,e,i){var n=function(t,e){return tt(t,e,WebGLRenderingContext.VERTEX_SHADER)}(t,e),o=function(t,e){return tt(t,e,WebGLRenderingContext.FRAGMENT_SHADER)}(t,i),r=t.createProgram();return t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r),t.getProgramParameter(r,WebGLRenderingContext.LINK_STATUS)||window.alert("Could not initialize program"),r}var it=function(t,e){this.program=e,this.attribute={},this.uniform={},t.useProgram(this.program);for(var i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_ATTRIBUTES),n=0;n<i;){var o=t.getActiveAttrib(e,n);this.attribute[o.name]=t.getAttribLocation(e,o.name),n++}for(i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_UNIFORMS),n=0;n<i;)o=t.getActiveUniform(e,n),this.uniform[o.name]=t.getUniformLocation(e,o.name),n++};new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]);var nt=function(){function t(t){this.gl=t,this.size=1,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.blendMode=0,this.dynamicSize=1}return t.prototype.Clean=function(){},t.prototype.ResizeBatch=function(t){this.size=t,this.dynamicSize=t,this.data=new Float32Array(20*this.dynamicSize),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=function(t){for(var e=new Uint16Array(6*t),i=0;i<t;i++){var n=6*i,o=4*i;e[n+0]=o+0,e[n+1]=o+1,e[n+2]=o+2,e[n+3]=o+0,e[n+4]=o+2,e[n+5]=o+3}return e}(this.dynamicSize),this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)},t.prototype.AddSpriteToBatch=function(t,e){var i=20*e,n=t.texture.uvs;this.data[i+0]=t.transformedVerts[0],this.data[i+1]=t.transformedVerts[1],this.data[i+2]=n[0],this.data[i+3]=n[1],this.data[i+4]=t.worldAlpha,this.data[i+5]=t.transformedVerts[2],this.data[i+6]=t.transformedVerts[3],this.data[i+7]=n[2],this.data[i+8]=n[3],this.data[i+9]=t.worldAlpha,this.data[i+10]=t.transformedVerts[4],this.data[i+11]=t.transformedVerts[5],this.data[i+12]=n[4],this.data[i+13]=n[5],this.data[i+14]=t.worldAlpha,this.data[i+15]=t.transformedVerts[6],this.data[i+16]=t.transformedVerts[7],this.data[i+17]=n[6],this.data[i+18]=n[7],this.data[i+19]=t.worldAlpha},t.prototype.Render=function(t,e,i){var n,o,r;n=e,(o=new Array(1e3))[0]=n,r=1;for(var s=0,a=null;r>0;){var h=o[--r];if(null!=h.next&&(o[r++]=h.next),null!=h.head&&(o[r++]=h.head),h.visible&&h.renderable){var c=h;c.texture.baseTexture.texture==a&&s!=this.size||(this.Flush(t,a,s),s=0,a=c.texture.baseTexture.texture),this.AddSpriteToBatch(c,s),s++}}s>0&&this.Flush(t,a,s)},t.prototype.Flush=function(t,e,i){this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.vertexAttribPointer(t.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(t.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(t.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,e),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*i,WebGLRenderingContext.UNSIGNED_SHORT,0)},t}(),ot=function(){function t(){this.first=!0}return t.prototype.Init=function(t,e){this.gl=t,this.camera=e,this.projection=new o,this.spriteShader=new it(t,et(t,"precision mediump float;\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute float aColor;\nuniform vec2 projectionVector;\nvarying vec2 vTextureCoord;\nvarying float vColor;\nvoid main(void) {\n    gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n    vColor = aColor;\n}","precision mediump float;\nvarying vec2 vTextureCoord;\nvarying float vColor;\nuniform sampler2D uSampler;\nvoid main(void) {\n    gl_FragColor = texture2D(uSampler,vTextureCoord) * vColor;\n}")),this.spriteBatch=new nt(t),this.spriteBatch.ResizeBatch(1e3)},t.prototype.Resize=function(t,e){this.projection.x=t/2,this.projection.y=e/2},t.prototype.AddStage=function(t){this.stage=t},t.prototype.Render=function(t){this.stage.updateTransform(),this.gl.useProgram(this.spriteShader.program),this.gl.uniform2f(this.spriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aColor),this.gl.vertexAttribPointer(this.spriteShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(this.spriteShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(this.spriteShader.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.spriteBatch.Render(this.spriteShader,this.stage,this.camera.viewPortAABB)},t}(),rt=function(){function t(t,e,i){void 0===i&&(i=null),this.w=t,this.h=e,this.buffer=null==i?new ArrayBuffer(this.w*this.h*4):i,this.data32=new Uint32Array(this.buffer),this.data8=new Uint8Array(this.buffer)}return t.prototype.get=function(t,e){return this.data32[e*this.w+t]},t.prototype.set=function(t,e,i){this.data32[e*this.w+t]=i},t}(),st=function(){function t(t,e,i,n,o){this.initalize(t,e,i,n,o)}return t.prototype.initalize=function(t,e,i,n,o){this.width=t,this.height=e,this.numberernalWidth=t*n,this.cellSize=i,this.invCellSize=1/i,this.bytesPerCell=n,this.data=null==o?new ArrayBuffer(t*e*n):o,this.data8=new Uint8Array(this.data)},t.prototype.get=function(t,e,i){return this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]},t.prototype.set=function(t,e,i,n){this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]=n},t.prototype.getReal=function(t,e,i){return this.get(this.Index(t),this.Index(e),i)},t.prototype.Index=function(t){return t*this.invCellSize|0},t}(),at=function(t,e){void 0===e&&(e=4);var i,n,o,r=function(t){return window.atob(t.replace(/[^A-Za-z0-9\+\/\=]/g,""))}(t),s=new Uint32Array(r.length/e);for(i=0,o=r.length/e;i<o;i++)for(s[i]=0,n=e-1;n>=0;--n)s[i]+=r.charCodeAt(i*e+n)<<(n<<3);return s};function ht(t){var e=at(t.data);return new st(t.width,t.height,16,4,e.buffer)}function ct(t,e){var i=t.layers.filter((function(t){return t.name===e}));return 1===i.length?i[0]:null}function ut(t){for(var e=new rt(t.width,t.height),i=0;i<t.width;i++)for(var n=0;n<t.height;n++){var o=t.get(i,n,3)<<24|t.get(i,n,2)<<16|t.get(i,n,1)<<8|t.get(i,n,0);if(o>0){var r=Math.floor(o/1024),s=Math.floor(r/8),a=r%8,h=o-1024*r;h--;var c=Math.floor(h/32),u=s<<24|a<<16|c<<8|h-32*c;e.set(i,n,u)}else e.set(i,n,4294967295)}return e}var pt=function(){function t(){this.scrollScale=new o(1,1),this.inverseTileDataTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2)}return t.prototype.setSpriteTexture=function(t){this.spriteTexture=t.texture,this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height},t.prototype.setTextureFromMap=function(t,e){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,e.w,e.h,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e.data8),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE),this.inverseTileDataTextureSize[0]=1/e.w,this.inverseTileDataTextureSize[1]=1/e.h},t.prototype.setTexture=function(t,e,i){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),i?(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.inverseTileDataTextureSize[0]=1/e.width,this.inverseTileDataTextureSize[1]=1/e.height},t}(),lt=function(){function t(t,e){this.tileMap=t,this.layers=e,this.lastSnap=new o(0,0),this.thisSnap=new o(-1e3,-1e3),this.snapChanged=!1,this.size=new o,this.renderSurface=this.renderSurface.bind(this)}return t.prototype.Init=function(t,e){this.sprite=new Z,this.sprite.id="renderTexture"},t.prototype.Resize=function(t,e){this.size.setTo(t,e),this.surface=new N(this.tileMap.gl,t,e),this.texture=new V(this.surface,new j(0,0,t,e),new o(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(2,-2),this.sprite.pivot.setTo(t/2,e/2)},t.prototype.calcSnap=function(t){return this.lastSnap.copy(this.thisSnap),this.thisSnap.x=16*(Math.floor(t.x/-16)-1),this.thisSnap.y=16*(Math.floor(t.y/-16)-1),this.snapChanged=this.lastSnap.x!=this.thisSnap.x||this.lastSnap.y!=this.thisSnap.y,this.snapChanged},t.prototype.Render=function(t){this.calcSnap(this.tileMap.camera.position),this.sprite.position.copy(this.size),this.sprite.position.plusEquals(this.thisSnap),this.surface.drawTo(this.renderSurface)},t.prototype.renderSurface=function(){this.tileMap.RenderLayers(this)},t}(),dt=function(){function t(t,e){this.tileSize=t,this.tileScale=e,this.layers=new Array,this.layersMap=new Map,this.renderLayers=new Array,this.renderLayersMap=new Map}return t.prototype.Init=function(t,e){if(null==this.gl){this.gl=t,this.camera=e,this.filtered=!1,this.spriteSheet=this.gl.createTexture(),this.viewportSize=new o,this.scaledViewportSize=new Float32Array(2),this.inverseTileTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2),this.quadVertBuffer=this.gl.createBuffer(),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer);var i=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]);t.bufferData(WebGLRenderingContext.ARRAY_BUFFER,i,WebGLRenderingContext.STATIC_DRAW),this.tilemapShader=new it(t,et(t,"precision mediump float;\nattribute vec2 position;\nattribute vec2 texture;\n\nvarying vec2 pixelCoord;\nvarying vec2 texCoord;\n\nuniform vec2 viewOffset;\nuniform vec2 viewportSize;\nuniform vec2 inverseTileTextureSize;\nuniform float inverseTileSize;\n\nvoid main(void) {\n    pixelCoord = (texture * viewportSize) + viewOffset;\n    texCoord = pixelCoord * inverseTileTextureSize * inverseTileSize;\n    gl_Position = vec4(position, 0.0, 1.0);\n}","precision mediump float;\n\nvarying vec2 pixelCoord;\nvarying vec2 texCoord;\n\nuniform sampler2D tiles;\nuniform sampler2D sprites;\n\nuniform vec2 inverseTileTextureSize;\nuniform vec2 inverseSpriteTextureSize;\nuniform float tileSize;\n\nvoid main(void) {\n    vec4 tile = texture2D(tiles, texCoord);\n    // if(tile.x == 1.0 && tile.y == 1.0) { discard; }\n    if (tile.x == 1.0 && tile.y == 1.0) { \n        discard;\n        // gl_FragColor = vec4(0.0,0.0,0.0,0.0);\n    } else {\n        vec2 superSpriteOffset = floor(tile.zw * 256.0) * 256.0;\n        vec2 spriteOffset = floor(tile.xy * 256.0) * tileSize;\n        vec2 spriteCoord = mod(pixelCoord, tileSize);\n\n        //Works\n        //    spriteCoord.x = (-1.0+(2.0* 0.0)) * (( 0.0*tileSize) - spriteCoord.x); //normal  0\n        //    spriteCoord.x = (-1.0+(2.0* 1.0)) * (( 1.0*tileSize) - spriteCoord.x); //flip   1\n\n        gl_FragColor = texture2D(sprites, (superSpriteOffset + spriteOffset + spriteCoord) * inverseSpriteTextureSize);\n    }\n}")),this.flip=!1,this.writebuffer2=new rt(3,3),this.renderLayers.forEach((function(i){return i.Init(t,e)}))}},t.prototype.Resize=function(t,e){var i=(Math.floor(t/(this.tileSize*this.tileScale))+2)*this.tileSize,n=(Math.floor(e/(this.tileSize*this.tileScale))+2)*this.tileSize;this.viewportSize.x=i*this.tileScale,this.viewportSize.y=n*this.tileScale,this.scaledViewportSize[0]=this.viewportSize.x/this.tileScale,this.scaledViewportSize[1]=this.viewportSize.y/this.tileScale,this.renderLayers.forEach((function(t){return t.Resize(Math.floor(i),Math.floor(n))}))},t.prototype.SetSpriteSheet=function(t){this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.spriteSheet),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,t),this.filtered?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST)),this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height},t.prototype.SetTileLayer=function(t,e,i,n){var o=new pt;o.setTexture(this.gl,t,!1),o.scrollScale.x=i,o.scrollScale.y=n,this.layers.push(o)},t.prototype.SetTileLayerFromData=function(t,e,i,n,o){var r=new pt;return r.setTextureFromMap(this.gl,t),r.setSpriteTexture(e),r.scrollScale.x=n,r.scrollScale.y=o,this.layers.push(r),this.layersMap.set(i,r),r},t.prototype.SetTileRenderLayer=function(t,e){var i=new lt(this,e);this.renderLayers.push(i),this.renderLayersMap.set(t,i)},t.prototype.updateMap=function(t,e,i){var n=i[0],o=i[1],r=i[2],s=i[3],a=i[4],h=i[5],c=Math.floor(i[6]/8),u=i[6]%8;this.writebuffer2.h=s,this.writebuffer2.w=r;for(var p=0;p<s;p++)for(var l=0;l<r;l++){var d=c<<24|u<<16|o+p<<8|n+l;this.writebuffer2.set(l,p,d)}var f=this.layers[2].tileDataTexture;this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,f),this.gl.texSubImage2D(WebGLRenderingContext.TEXTURE_2D,0,t-a,e-h,r,s,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,this.writebuffer2.data8)},t.prototype.Render=function(t){for(var e=0,i=this.renderLayers;e<i.length;e++){i[e].Render(t)}},t.prototype.RenderLayers=function(t){this.gl.clearColor(0,0,0,0),this.gl.colorMask(!0,!0,!0,!0),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.useProgram(this.tilemapShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.position),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.texture),this.gl.vertexAttribPointer(this.tilemapShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.tilemapShader.attribute.texture,2,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.uniform2fv(this.tilemapShader.uniform.viewportSize,this.scaledViewportSize),this.gl.uniform1f(this.tilemapShader.uniform.tileSize,this.tileSize),this.gl.uniform1f(this.tilemapShader.uniform.inverseTileSize,1/this.tileSize),this.gl.uniform1i(this.tilemapShader.uniform.sprites,0),this.gl.uniform1i(this.tilemapShader.uniform.tiles,1);for(var e=0;e<t.layers.length;e++){var i=this.layersMap.get(t.layers[e]),n=t.thisSnap.x/2,o=t.thisSnap.y/2;this.gl.uniform2f(this.tilemapShader.uniform.viewOffset,n,o),this.gl.uniform2fv(this.tilemapShader.uniform.inverseSpriteTextureSize,i.inverseSpriteTextureSize),this.gl.uniform2fv(this.tilemapShader.uniform.inverseTileTextureSize,i.inverseTileDataTextureSize),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.spriteTexture),this.gl.activeTexture(WebGLRenderingContext.TEXTURE1),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.tileDataTexture),this.gl.drawArrays(WebGLRenderingContext.TRIANGLES,0,6)}this.gl.colorMask(!0,!0,!0,!1)},t}(),ft=function(){function t(t,e){this.frameListId=t,this.play(e)}return t.prototype.play=function(t){this.animationId!==t&&(this.animationId=t,this.dirty=!0)},t}(),yt=function(){function t(t){this.play(t)}return t.prototype.update=function(t){return this.accumulatedTime+=t,this.accumulatedTime>this.animation.msPerFrame&&(this.frameIndex=++this.frameIndex%this.animation.length,this.accumulatedTime=0),this.animation.frames[this.frameIndex]},t.prototype.play=function(t){this.animation=t,this.frameIndex=0,this.accumulatedTime=0},t}(),gt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),mt=function(t){function e(e){var i=t.call(this,[P,S,ft])||this;return i.frameListManager=e,i}return gt(e,t),e.prototype.onEntityAdded=function(t,e,i,n){var o=this.frameListManager.getFrameList(n.frameListId).getAnimation(n.animationId);n.dirty=!1,n.animationController=new yt(o)},e.prototype.updateEntity=function(t,e,i,n){n.dirty&&this.playAnimation(n),n.animationController.update(this.dt).updateSprite(i.sprite,e.direction.x,e.direction.y)},e.prototype.playAnimation=function(t){t.dirty=!1;var e=this.frameListManager.getFrameList(t.frameListId).getAnimation(t.animationId);t.animationController.play(e)},e}(T),vt=function(){function t(){this.start=new o,this.end=new o,this.delta=new o,this.scale=new o,this.sign=new o}return t.prototype.set=function(t,e){this.start.copy(t),this.end.copy(e),this.delta.copy(this.end),this.delta.minusEquals(this.start),this.scale.setTo(1/this.delta.x,1/this.delta.y),this.sign.x=this.delta.x<0?-1:1,this.sign.y=this.delta.y<0?-1:1},t}(),bt=function(){function t(){this.position=new o,this.delta=new o,this.normal=new o,this.distance=0,this.time=0,this.sweepPosition=new o}return t.prototype.setTo=function(t){this.position.x=t.position.x,this.position.y=t.position.y,this.delta.x=t.delta.x,this.delta.y=t.delta.y,this.normal.x=t.normal.x,this.normal.y=t.normal.y,this.time=t.time,this.distance=t.distance,this.sweepPosition.x=t.sweepPosition.x,this.sweepPosition.y=t.sweepPosition.y},t}(),xt=function(){function t(t,e,i){void 0===t&&(t=1),void 0===e&&(e=4294967295),void 0===i&&(i=0),this.groupIndex=0,this.categoryBits=1,this.maskBits=4294967295,this.categoryBits=t,this.maskBits=e,this.groupIndex=i}return t.CHECK=function(t,e){return null==t||null==e||(t.groupIndex==e.groupIndex&&0!=t.groupIndex?t.groupIndex>0:0!=(t.maskBits&e.categoryBits)&&0!=(t.categoryBits&e.maskBits))},t.prototype.clone=function(){return new t(this.categoryBits,this.maskBits,this.groupIndex)},t}(),wt=new bt,Ct=null;var Et=function(t,e){if(t.isStatic&&e.isStatic||t.isSensor&&e.isSensor)return!1;if(!t.isActive||!e.isActive)return!1;if(!xt.CHECK(t.filter,e.filter))return!1;var i=!1;if(t.isSensor||e.isSensor)i=At(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,wt);else if(t.isStatic||e.isStatic){var n,o;t.isStatic?(n=t,o=e):(n=e,o=t),o.body.isBullet?(i=_t(o,n))&&o.body.respondBulletCollision(wt):(Rt(o.aabb.position,o.aabb.extents,n.aabb.position,n.aabb.extents,n.responseBias,wt),i=o.body.respondStaticCollision(wt))}else{if(t.body.isBullet&&e.body.isBullet)return!1;t.body.isBullet?1==St(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,wt)&&(t.body.respondBulletCollision(wt),i=!0):e.body.isBullet?1==St(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,e.body.delta,wt)&&(e.body.respondBulletCollision(wt),i=!0):i=At(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,wt)}return 1==i&&Ct.UpdateContacts(t,e,wt),i},_t=function(t,e){return St(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,wt)},At=function(t,e,i,n,o){var r=i.x-t.x,s=n.x+e.x-Math.abs(r);if(s<=0)return!1;var a=i.y-t.y,h=n.y+e.y-Math.abs(a);if(h<=0)return!1;if(s<h){var c=r<0?-1:1;o.distance=o.delta.x=s*c,o.delta.y=0,o.normal.x=c,o.normal.y=0,o.position.x=t.x+e.x*c,o.position.y=i.y}else{var u=a<0?-1:1;o.delta.x=0,o.distance=o.delta.y=h*u,o.normal.x=0,o.normal.y=u,o.position.x=i.x,o.position.y=t.y+e.y*u}return!0},Tt=function(t,e,i,n,o,r,s){var a=(t.x-o.x*(e.x+r)-i.x)*n.x,h=(t.y-o.y*(e.y+s)-i.y)*n.y,c=(t.x+o.x*(e.x+r)-i.x)*n.x,u=(t.y+o.y*(e.y+s)-i.y)*n.y;if(a>u||h>c)return!1;var p=Math.max(a,h),l=Math.min(c,u);return!(p>=1||l<=0)},Pt=function(t,e,i,n,o,r,s){var a=1/n.x,h=1/n.y,c=a<0?-1:1,u=h<0?-1:1,p=(t.x-c*(e.x+o)-i.x)*a,l=(t.y-u*(e.y+r)-i.y)*h,d=(t.x+c*(e.x+o)-i.x)*a,f=(t.y+u*(e.y+r)-i.y)*h;if(p>f||l>d)return!1;var y=Math.max(p,l),g=Math.min(d,f);return!(y>=1||g<=0)&&(s.time=Math.min(Math.max(y,0),1),p>l?(s.normal.x=-c,s.normal.y=0):(s.normal.x=0,s.normal.y=-u),s.delta.x=s.time*n.x,s.delta.y=s.time*n.y,s.position.x=i.x+s.delta.x,s.position.y=i.y+s.delta.y,!0)},St=function(t,e,i,n,o,r){if(0==o.x&&0==o.y)return r.sweepPosition.x=i.x,r.sweepPosition.y=i.y,At(t,e,i,n,r)?(r.time=0,!0):(r.time=1,!1);if(Pt(t,e,i,o,n.x,n.y,r)){r.time=Math.min(Math.max(r.time-1e-8,0),1),r.sweepPosition.x=i.x+o.x*r.time,r.sweepPosition.y=i.y+o.y*r.time;var s=Math.sqrt(o.x*o.x+o.y*o.y);return r.position.x+=o.x/s*n.x,r.position.y+=o.y/s*n.y,!0}return r.sweepPosition.x=i.x*o.x,r.sweepPosition.y=i.y*o.y,!1},Rt=function(t,e,i,n,o,r){var s=i.x-t.x,a=n.x+e.x-Math.abs(s),h=i.y-t.y;a<n.y+e.y-Math.abs(h)?(r.normal.x=s<0?1:-1,r.normal.y=0):(r.normal.x=0,r.normal.y=h<0?1:-1),r.normal.x*=o.x,r.normal.y*=o.y;var c=r.normal.x*(e.x+n.x)+i.x,u=r.normal.y*(e.y+n.y)+i.y,p=t.x-c,l=t.y-u;return r.distance=p*r.normal.x+l*r.normal.y,!0},Lt=function(t,e,i,n,o,r){r.normal.copy(o);var s=r.normal.x*(e.x+n.x)+i.x,a=r.normal.y*(e.y+n.y)+i.y,h=t.x-s,c=t.y-a;return r.distance=h*r.normal.x+c*r.normal.y,!0},Ft=function(){function t(){this.n=new o,this.d=0}return t.prototype.set=function(t,e){this.n.copy(t),this.d=this.n.dot(e)},t.prototype.setFromSegment=function(t,e){this.n.copy(t),this.n.minusEquals(e),this.n.normalize(),this.n.leftHandNormalEquals(),this.d=this.n.dot(t)},t.prototype.distancePoint=function(t){return this.n.dot(t)-this.d},t}(),Ot=function(){function t(){this.position=new o,this.extents=new o}return Object.defineProperty(t.prototype,"l",{get:function(){return this.position.x-this.extents.x},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"t",{get:function(){return this.position.y-this.extents.y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this.position.x+this.extents.x},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.position.y+this.extents.y},enumerable:!0,configurable:!0}),t.prototype.overlap=function(t){return!(Math.abs(this.position.x-t.position.x)>this.extents.x+t.extents.x)&&!(Math.abs(this.position.y-t.position.y)>this.extents.y+t.extents.y)},t.prototype.containsAABB=function(t){return!1},t.prototype.containsPoint=function(t){return Math.abs(t.x-this.position.x)<this.extents.x&&Math.abs(t.y-this.position.y)<this.extents.y},t.prototype.overlapArea=function(t){var e=Math.max(this.l,t.l),i=Math.min(this.r,t.r),n=Math.max(this.t,t.t);return(i-e)*(Math.min(this.b,t.b)-n)},t.prototype.area=function(){return this.extents.x*this.extents.y*4},t.prototype.toAABB2=function(){return new G(this.t,this.r,this.b,this.l)},t.prototype.copyToAABB2=function(t){t.t=this.t,t.r=this.r,t.b=this.b,t.l=this.l},t.prototype.clone=function(e){return(e=new t).position.copy(this.position),e.extents.copy(this.extents),e},t}(),Bt=function(){function t(t){this.tilePosition=new o,this.tileExtents=new o,this.halftilePosition=new o,this.halftileExtents=new o,this.workingAABB=new Ot,this.bias=new o(1,1),this.step=new o(0,-1),this.plane=new Ft,this.segment=new vt,this.data=t,this.tileSize=t.cellSize,this.tileHalfSize=this.tileSize/2,this.tileExtents.setTo(this.tileHalfSize,this.tileHalfSize),this.halftileExtents.setTo(this.tileHalfSize/4,this.tileHalfSize/4),this.contact=new bt,this.closestContact=new bt}return t.prototype.testCollision=function(t){var e,i,n,o,r,s=t.body,a=this.data.Index(Math.min(s.position.x,s.predictedPosition.x)-t.aabb.extents.x-0),h=this.data.Index(Math.min(s.position.y,s.predictedPosition.y)-t.aabb.extents.y-0),c=this.data.Index(Math.max(s.position.x,s.predictedPosition.x)+t.aabb.extents.x+0-.01)+1,u=this.data.Index(Math.max(s.position.y,s.predictedPosition.y)+t.aabb.extents.y+0)+1;if(s.isBullet){this.plane.setFromSegment(s.predictedPosition,s.position),this.closestContact.time=O;for(var p=h;p<u;p++)for(var l=a;l<c;l++){1==(1&(d=this.data.get(l,p,0)))&&0==(2&d)&&(this.tilePosition.x=l*this.tileSize+this.tileHalfSize,this.tilePosition.y=p*this.tileSize+this.tileHalfSize,Math.abs(this.plane.distancePoint(this.tilePosition))<40&&1==St(this.tilePosition,this.tileExtents,s.position,t.aabb.extents,s.delta,this.contact)&&s.respondBulletCollision(this.contact)&&this.closestContact.setTo(this.contact))}this.closestContact.time<O&&t.collide(null,this.contact)}else for(p=h;p<u;p++)for(l=a;l<c;l++){var d;if((7&(d=this.data.get(l,p,0)))>0)if(this.tilePosition.x=l*this.tileSize+this.tileHalfSize,this.tilePosition.y=p*this.tileSize+this.tileHalfSize,4==(4&d)&&s.usesStairs){this.segment.set(s.position,s.predictedPosition);for(var f=0;f<8;f++){var y=8-2*f;this.halftilePosition.copy(this.tilePosition),this.halftilePosition.x+=-1*y,this.halftilePosition.y+=y,e=this.segment,i=this.halftilePosition,n=this.halftileExtents,o=t.aabb.extents.x,r=t.aabb.extents.y,Tt(i,n,e.start,e.scale,e.sign,o,r)&&(Lt(s.position,t.aabb.extents,this.halftilePosition,this.halftileExtents,this.step,this.contact),s.respondStaticCollision(this.contact),t.collide(null,this.contact))}}else if(Rt(s.position,t.aabb.extents,this.tilePosition,this.tileExtents,this.bias,this.contact),2==(2&d))s.collideOneWay&&this.contact.normal.y<0&&this.contact.distance>=-4&&(s.respondStaticCollision(this.contact),t.collide(null,this.contact));else{var g=l+this.contact.normal.x,m=p+this.contact.normal.y;0==(7&this.data.get(g,m,0))&&(s.respondStaticCollision(this.contact),t.collide(null,this.contact))}}},t.prototype.iterateCells=function(t,e){var i=this.data.Index(t.l),n=this.data.Index(t.t),o=this.data.Index(t.r)+1,r=this.data.Index(t.b)+1;this.workingAABB.extents.setTo(this.tileHalfSize,this.tileHalfSize);for(var s=n;s<r;s++)for(var a=i;a<o;a++){1==(1&this.data.get(a,s,0))&&(this.workingAABB.position.setTo(a*this.tileSize+this.tileHalfSize,s*this.tileSize+this.tileHalfSize),e(this.workingAABB))}},t.prototype.castRay=function(t){var e=this.data.Index(t.origin.x),i=this.data.Index(t.origin.y),n=e*this.tileSize,o=i*this.tileSize,r=t.direction;if(0==r.x&&0==r.y)return!0;var s=0,a=1e8,h=0;r.x<0?(s=-1,a=(n-t.origin.x)/r.x,h=this.tileSize/-r.x):r.x>0&&(s=1,a=(n+this.tileSize-t.origin.x)/r.x,h=this.tileSize/r.x);var c=0,u=1e8,p=0;r.y<0?(c=-1,u=(o-t.origin.y)/r.y,p=this.tileSize/-r.y):r.y>0&&(c=1,u=(o+this.tileSize-t.origin.y)/r.y,p=this.tileSize/r.y);for(var l=0,d=0,f=0,y=0;;){if(a<u?(l=a*r.x,d=a*r.y,a+=h,e+=s):(l=u*r.x,d=u*r.y,u+=p,i+=c),l*l+d*d>t.range*t.range)return!1;if(1==(1&this.data.get(e,i,0)))return a<u?(f=s<0?1:-1,y=0):(f=0,y=c<0?1:-1),t.report(l,d,f,y),!0}},t}(),Mt=function(t,e,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this.halfWidths=new o(t,e),this.offset=new o(i,n)},Wt=function(){function t(){this.isStatic=!1,this.isSensor=!1,this.isActive=!0,this.limitToStaticCheck=!1,this.userData1=-1,this.userData2=-1,this.contactCallbacks=[],this.aabb=new Ot,this.offset=new o,this.responseBias=new o(1,1),this.id=t.nextID++}return t.prototype.setBody=function(t){this.body=t,this.aabb.position=t.position,this.isStatic=!1},t.prototype.collide=function(t,e){for(var i=0,n=this.contactCallbacks;i<n.length;i++){(0,n[i])(this,t,e)}},t.HashBodyIDs=function(t,e){return t<e?t<<16|e:e<<16|t},t.nextID=0,t}(),Gt=function(t,e,i,n,o){void 0===n&&(n=!1),void 0===o&&(o=null),this.proxy=new Wt,this.proxy.isSensor=t,this.proxy.filter=e,this.proxy.contactCallbacks=i,this.proxy.limitToStaticCheck=n,o&&(this.proxy.body=o)},It=function(){},Dt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),zt=function(t){function e(e){var i=t.call(this,[P,Mt,Gt,It])||this;return i.broadphase=e,i}return Dt(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){n.proxy.aabb.extents.copy(i.halfWidths),n.proxy.entity=t,n.proxy.isStatic=!0,n.proxy.aabb.position=e.coords,this.broadphase.addProxy(n.proxy)},e.prototype.onEntityRemoved=function(t,e,i,n,o){this.broadphase.removeProxy(n.proxy)},e.prototype.updateAllEntities=function(){},e}(T),Ut=function(){},kt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Nt=function(t){function e(e){var i=t.call(this,[P,Mt,Gt,Ut])||this;return i.broadphase=e,i}return kt(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){n.proxy.aabb.extents.copy(i.halfWidths),n.proxy.isStatic=!1,n.proxy.entity=t,n.proxy.aabb.position=e.coords,n.proxy.userData1=t,this.broadphase.addProxy(n.proxy)},e.prototype.onEntityRemoved=function(t,e,i,n,o){this.broadphase.removeProxy(n.proxy)},e.prototype.updateAllEntities=function(){},e}(T),jt=function(t,e){void 0===e&&(e=!1),this.body=t,this.setMassFromVolume=e},Vt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),qt=function(t){function e(e,i){var n,o=t.call(this,[Gt,jt,Ut])||this;return o.broadphase=e,o.contactMangager=i,n=o.contactMangager,Ct=n,o}return Vt(e,t),e.prototype.onEntityAdded=function(t,e,i,n){e.proxy.setBody(i.body)},e.prototype.updateAllEntities=function(){this.broadphase.collide(),this.contactMangager.ProcessContacts()},e}(T),Ht=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Xt=function(t){function e(){return t.call(this,[jt,Mt])||this}return Ht(e,t),e.prototype.onEntityAdded=function(t,e,i){e.setMassFromVolume&&e.body.setMassFromVolumeMaterial(i.halfWidths.x*i.halfWidths.y*4)},e}(T),Yt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Jt=function(t){function e(){return t.call(this,[P,jt])||this}return Yt(e,t),e.prototype.updateEntity=function(t,e,i){i.body.updatePosition(),e.update(i.body.position)},e}(T),Kt=function(){function t(t,e,i){void 0===t&&(t=1),void 0===e&&(e=.3),void 0===i&&(i=.1),this.density=t,this.elasticity=e,this.friction=i}return t.NORMAL=new t(1,.3,.1),t.LIGHTMETAL=new t(1.4,.3,.1),t.ROCK=new t(2,.2,.1),t.RUBBER=new t(1,1,.1),t}(),Zt=10,Qt=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=1),this.position=new o,this.positionCorrection=new o,this.predictedPosition=new o,this.delta=new o,this.previousPosition=new o,this.velocity=new o,this.originalVelocity=new o,this.previousVelocity=new o,this.contactNormal=new o,this.prevContactNormal=new o,this.tangent=new o,this.stepContactCount=0,this.maxScalarVelocity=1e3,this.maxVelocity=new o,this.forces=new o,this.accumulatedForces=new o,this.isBullet=!1,this.damping=1,this.globalForceFactor=1,this.mass=1,this.invMass=1,this.dt=0,this.motion=Zt,this.canSleep=!1,this.isSleeping=!1,this.onGround=!1,this.onGroundPrev=!1,this.inWater=!1,this.inWaterPrev=!1,this.usesStairs=!0,this.collideOneWay=!0,this.totalBounceCount=0,this.bounceCount=0,this.debug=0,this.skip=!1,this.material=null==t?new Kt:t,this.setMass(e)}return t.prototype.update=function(t,e,i){this.dt=t,this.onGroundPrev=this.onGround,this.onGround=!1,this.inWaterPrev=this.inWater,this.inWater=!1,this.skip||this.isSleeping||(this.motion=.99332805041467*this.motion+(1-.99332805041467)*this.velocity.lengthSqrd(),this.motion=Math.min(this.motion,.009),this.canSleep=this.motion<9e-4,this.previousVelocity.copy(this.velocity),this.forces.plusMultEquals(e,this.globalForceFactor),this.velocity.plusEquals(this.forces),this.velocity.multEquals(i*this.damping),this.maxScalarVelocity>0?this.velocity.clampScalar(this.maxScalarVelocity):this.velocity.clampVector(this.maxVelocity),this.originalVelocity.copy(this.velocity),this.predictedPosition.copy(this.position),this.predictedPosition.plusMultEquals(this.velocity,t),this.previousPosition.copy(this.position),this.delta.copy(this.predictedPosition),this.delta.minusEquals(this.position),this.prevContactNormal.copy(this.contactNormal),this.contactNormal.setTo(0,0),this.forces.setTo(0,0),this.damping=1,this.stepContactCount=0,this.toi=O)},t.prototype.respondStaticCollision=function(t){if(this.skip)return!1;var e=Math.max(t.distance,0),i=Math.min(t.distance,0);this.positionCorrection.minusMultEquals(t.normal,i/this.dt);var n=this.velocity.dot(t.normal)+e/this.dt;return n<0&&(this.stepContactCount++,this.velocity.minusMultEquals(t.normal,n),!this.canBounce&&t.normal.y<0&&(this.onGround=!0),this.contactNormal.copy(t.normal),!0)},t.prototype.t=function(t){this.debug>0&&this.debug--},t.prototype.respondBulletCollision=function(t){return t.time<=this.toi&&(this.toi=t.time,this.positionCorrection.copy(t.sweepPosition),this.contactNormal.copy(t.normal),!0)},t.prototype.updatePosition=function(){if(!this.skip&&!this.isSleeping)if(this.isBullet)this.toi<O?(this.position.copy(this.positionCorrection),this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity)):this.position.copy(this.predictedPosition);else{if(this.stepContactCount>0&&!this.canBounce&&this.contactNormal.y<0){this.tangent.copy(this.contactNormal),this.tangent.rightHandNormalEquals();var t=this.originalVelocity.dot(this.tangent)*this.material.friction;this.velocity.x-=this.tangent.x*t,this.velocity.y-=this.tangent.y*t}this.positionCorrection.plusEquals(this.velocity),this.positionCorrection.multEquals(this.dt),this.position.plusEquals(this.positionCorrection),this.positionCorrection.setTo(0,0),this.stepContactCount>0&&this.canBounce&&(this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity),this.bounceCount++)}},t.prototype.addForce=function(t){this.forces.plusMultEquals(t,this.invMass),this.wake()},t.prototype.addMasslessForce=function(t){this.forces.plusEquals(t),this.wake()},t.prototype.addProportionalForce=function(t){this.forces.plusMultEquals(t,this.mass),this.wake()},t.prototype.setMass=function(t){this.mass=t,this.invMass=1/t},t.prototype.setMassFromVolumeMaterial=function(t){this.setMass(this.material.density*t*.1)},t.prototype.setStaticPosition=function(t,e){this.position.setTo(t,e),this.positionCorrection.setTo(0,0),this.predictedPosition.setTo(0,0),this.forces.setTo(0,0),this.accumulatedForces.setTo(0,0),this.velocity.setTo(0,0),this.originalVelocity.setTo(0,0),this.delta.setTo(0,0),this.wake()},t.prototype.setBounces=function(t){this.totalBounceCount=t,this.bounceCount=0},Object.defineProperty(t.prototype,"canBounce",{get:function(){return 0!=this.totalBounceCount&&this.bounceCount<this.totalBounceCount},enumerable:!0,configurable:!0}),t.prototype.wake=function(){this.canSleep=!1,this.motion=Zt,this.bounceCount=0},Object.defineProperty(t.prototype,"down",{get:function(){return this.contactNormal.y<0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"downPrev",{get:function(){return this.prevContactNormal.y<0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"up",{get:function(){return this.contactNormal.y>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"upPrev",{get:function(){return this.prevContactNormal.y>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){return this.contactNormal.x<0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"leftPrev",{get:function(){return this.prevContactNormal.x<0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.contactNormal.x>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rightPrev",{get:function(){return this.prevContactNormal.x>0},enumerable:!0,configurable:!0}),t.Create=function(e,i,n,o,r){var s=new t(e);return s.setMass(i),s.setBounces(n),s.globalForceFactor=o,s.maxScalarVelocity=r,s},t}(),$t=function(t){void 0===t&&(t=!1),this.alwaysActive=t},te=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ee=function(t){function e(){var e=t.call(this,[P,jt,$t])||this;return e.globalForce=new o(0,30),e.globalDamping=.99,e}return te(e,t),e.prototype.onEntityAdded=function(t,e,i,n){i.body.position.copy(e.coords)},e.prototype.updateEntity=function(t,e,i,n){i.body.update(this.dt/1e3,this.globalForce,this.globalDamping),e.direction.x=i.body.velocity.x>0?1:-1},e}(T),ie=function(t){this.force=1,this.force=t},ne=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),oe=function(t){function e(e){var i=t.call(this,[jt,ie])||this;return i.input=e,i}return ne(e,t),e.prototype.onEntityAdded=function(t,e,i){},e.prototype.updateEntity=function(t,e,i){this.input.Pressed(38)&&(e.body.velocity.y-=i.force),this.input.Pressed(40)&&(e.body.velocity.y+=i.force),this.input.Pressed(37)&&(e.body.velocity.x-=i.force),this.input.Pressed(39)&&(e.body.velocity.x+=i.force)},e}(T),re=function(){function t(t){void 0===t&&(t=""),this.setTileFrameId(t)}return t.prototype.setTileFrameId=function(t){return this.tileFrameId=t,null!=this.onChange&&this.onChange(),t},t}(),se=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ae=function(t){function e(e,i,n){var o=t.call(this,[P,re])||this;return o.updates=new Array,o.frames=new Map,o.tileMap=i,o.map=n,o.parseFramesConfig(e),o}return se(e,t),e.prototype.parseFramesConfig=function(t){var e=this;JSON.parse(t).sheets.forEach((function(t,i){Object.keys(t).forEach((function(n){t[n].push(i),e.frames.set(n,t[n])}))}))},e.prototype.onEntityAdded=function(t,e,i){i.onChange=this.onChange.bind(this,t),null!=i.tileFrameId&&this.onChange(t)},e.prototype.onChange=function(t){this.updates.push(t)},e.prototype.updateAllEntities=function(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,P),i=this.engine.getComponentForEntity(t,re);""!=i.tileFrameId&&this.tileMap.updateMap(this.map.data.Index(e.coords.x),this.map.data.Index(e.coords.y),this.frames.get(i.tileFrameId))}},e}(T),he=function(){function t(t){this.maxSprites=t}return t.prototype.Init=function(t,e){this.gl=t,this.camera=e,this.projection=new o,this.pointSpriteShader=new it(t,et(t,"precision mediump float;\nuniform vec2 projectionVector;\nuniform vec2 cameraPosition;\n\nattribute vec2 position;\nattribute float size;\nattribute vec4 colour;\nvarying vec4 vColor;\n\nvoid main() {\n    gl_PointSize = size;\n    vColor = colour;\n    gl_Position = vec4( (cameraPosition.x + position.x) / projectionVector.x -1.0, (cameraPosition.y + position.y) / -projectionVector.y + 1.0 , 0.0, 1.0);            \n}"," precision mediump float;\n\nvarying vec4 vColor;\n\nvoid main() {\n    gl_FragColor = vColor;\n}")),this.dataBuffer=this.gl.createBuffer(),this.arrayBuffer=new ArrayBuffer(80*this.maxSprites),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.ResetBatch()},t.prototype.Resize=function(t,e){this.projection.x=t/2,this.projection.y=e/2},t.prototype.AddStage=function(t){this.stage=t},t.prototype.ResetBatch=function(){this.indexRun=0},t.prototype.AddSpriteToBatch=function(t,e,i,n,o,r,s){var a=4*this.indexRun;this.data[a+0]=t,this.data[a+1]=e,this.data[a+2]=i,a*=4,this.data8[a+12]=o,this.data8[a+13]=r,this.data8[a+14]=s,this.data8[a+15]=n,this.indexRun++},t.prototype.Render=function(t){0!=this.indexRun&&(this.gl.useProgram(this.pointSpriteShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.position),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.size),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.colour),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.size,1,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.colour,4,WebGLRenderingContext.UNSIGNED_BYTE,!0,16,12),this.gl.uniform2f(this.pointSpriteShader.uniform.cameraPosition,this.camera.position.x,this.camera.position.y),this.gl.uniform2f(this.pointSpriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.drawArrays(WebGLRenderingContext.POINTS,0,this.indexRun))},t}(),ce=function(){function t(){this.first=!0}return t.prototype.Initalize=function(t,e,i,n,o,r,s,a,h,c,u,p,l,d,f,y){this.pX=this.plX=t,this.pY=this.plY=e,this.vX=i,this.vY=n,this.fX=o,this.fY=r,this.ttl=s,this.age=s,this.damping=a,this.decay=h,this.externalForce=u,this.size=p,this.alpha=l*(1/255),this.red=d,this.green=f,this.blue=y,this.first=!0},t.prototype.Update=function(t,e){return this.first?(this.first=!1,this.age>0):(this.vX+=this.fX+this.externalForce.x,this.vY+=this.fY+this.externalForce.y,this.vX*=this.damping,this.vY*=this.damping,this.plX=this.pX,this.plY=this.pY,this.pX+=this.vX*e,this.pY+=this.vY*e,this.age-=t,this.alpha-=this.decay,this.age>0)},t}(),ue=function(){function t(t,e,i){this.particleCount=t,this.deltaTime=e,this.invDeltaTime=e/1e3,this.map=i,this.ZERO_FORCE=new o,this.activeParticles=new Array,this.activeParticles[0]=new Array(this.particleCount),this.activeParticles[1]=new Array(this.particleCount),this.cachedParticles=new Array(this.particleCount);for(var n=0;n<t;n++)this.cachedParticles[n]=new ce;this.availableParticleCount=this.particleCount,this.activeParticlesCount=0,this.activePool=0,this.renderer=new he(t)}return t.prototype.EmitParticle=function(t,e,i,n,o,r,s,a,h,c,u,p,l,d,f,y){if(0==this.availableParticleCount)return!1;var g=this.cachedParticles[--this.availableParticleCount];return this.activeParticles[this.activePool][this.activeParticlesCount++]=g,g.Initalize(t,e,i,n,o,r,s,a,h?this.deltaTime/s:0,c,null!=u?u:this.ZERO_FORCE,p,l,d,f,y),!0},t.prototype.Update=function(){this.renderer.ResetBatch();for(var t=this.activeParticles[this.activePool],e=this.activeParticles[1===this.activePool?0:1],i=0,n=0;n<this.activeParticlesCount;n++){var o=t[n];if(o.Update(this.deltaTime,this.invDeltaTime)){if(1==(1&this.map.getReal(o.pX,o.pY,0))){var r=this.map.Index(o.plX),s=this.map.Index(o.plY),a=this.map.Index(o.pX),h=this.map.Index(o.pY);a!=r&&(o.vX*=-.99,o.pX=o.plX),h!=s&&(o.vY*=-.99,o.pY=o.plY)}this.renderer.AddSpriteToBatch(o.pX,o.pY,o.size,255*o.alpha|0,o.red,o.green,o.blue),e[i++]=o}else this.cachedParticles[this.availableParticleCount++]=o}this.activeParticlesCount=i,this.activePool=1===this.activePool?0:1},t}(),pe=function(t){this.emitters=t},le=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),de=function(t){function e(e){var i=t.call(this,[P,$t,pe])||this;return i.blockParticleEngine=e,i}return le(e,t),e.prototype.updateEntity=function(t,e,i,n){for(var o=0,r=n.emitters;o<r.length;o++){r[o].update(this.timestamp,this.engine.c4e.get(t),e.coords,this.blockParticleEngine)}},e.prototype.postUpdate=function(){this.blockParticleEngine.Update()},e}(T),fe=function(){function t(t,e,i){this.initalize(t,e,i)}return t.prototype.initalize=function(t,e,i){this.gridWidth=t,this.gridHeight=e,this.cellSize=i,this.invCellSize=1/i,this.data=new Array(this.gridWidth*this.gridHeight)},t.prototype.get=function(t,e){return this.data[e*this.gridWidth+t]},t.prototype.getSafe=function(t,e){return t>=this.gridWidth||e>=this.gridHeight||t<0||e<0?null:this.data[e*this.gridWidth+t]},t.prototype.set=function(t,e,i){this.data[e*this.gridWidth+t]=i},t.prototype.Index=function(t){return t*this.invCellSize|0},t.prototype.Width=function(){return this.gridWidth*this.cellSize},t.prototype.Height=function(){return this.gridHeight*this.cellSize},t}(),ye=function(){this.aabb=new Ot,this.isStatic=!1,this.entity=null,this.active=!1,this.referenceCount=0},ge=function(){function t(t,e,i){this.count=1,this.updateDistanceDelta=1e4,this.grid=new fe(t,e,i),this.currentCells=new Array;for(var n=0;n<this.grid.gridWidth;n++)for(var o=0;o<this.grid.gridHeight;o++)this.grid.set(o,n,new me(o+":"+n,new G(n*i,(o+1)*i,(n+1)*i,o*i)))}return t.prototype.addEntity=function(t,e,i,n){var o=new ye;o.aabb.position=e.coords,o.aabb.extents=i.halfWidths,o.isStatic=!0,o.entity=t,o.name=n,this.hashProxy(o)},t.prototype.hashProxy=function(t){for(var e=this.grid.Index(t.aabb.position.x-t.aabb.extents.x),i=this.grid.Index(t.aabb.position.y-t.aabb.extents.y),n=this.grid.Index(t.aabb.position.x+t.aabb.extents.x)+1,o=this.grid.Index(t.aabb.position.y+t.aabb.extents.y)+1,r=i;r<o;r++)for(var s=e;s<n;s++){this.grid.get(s,r).proxies.push(t)}},t.prototype.search=function(t,e){if(null==this.lastUpdatePosition)this.lastUpdatePosition=t.position.clone();else{if(this.lastUpdatePosition.distSqrd(t.position)<this.updateDistanceDelta)return;this.lastUpdatePosition.copy(t.position)}var i=this.grid.Index(t.position.x-t.extents.x),n=this.grid.Index(t.position.y-t.extents.y),o=this.grid.Index(t.position.x+t.extents.x)+1,r=this.grid.Index(t.position.y+t.extents.y)+1;for(var s=n;s<r;s++)for(var a=i;a<o;a++){(c=this.grid.get(a,s))&&(0==c.updateCount?this.currentCells.push(c):c.updateCount=this.count)}for(var h=this.currentCells.length;h-- >0;){var c;0==(c=this.currentCells[h]).updateCount?this.addActiveCell(c,t,e):c.updateCount<this.count&&(this.removeActiveCell(c,t,e),this.currentCells.splice(h,1))}this.count++},t.prototype.addActiveCell=function(t,e,i){t.proxies.forEach((function(t){0==t.referenceCount++&&i(t.entity,!0)})),t.updateCount=this.count},t.prototype.removeActiveCell=function(t,e,i){t.proxies.forEach((function(t){0==--t.referenceCount&&i(t.entity,!1)})),t.updateCount=0},t.prototype.debugDraw=function(){this.currentCells.forEach((function(t,e){E.debugRender.DrawAABB2(t.aabb,"green")}))},t}(),me=function(t,e){this.id=t,this.aabb=e,this.proxies=new Array,this.updateCount=0},ve=function(){},be=function(t){this.name=t},xe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),we=function(t){function e(e){var i=t.call(this,[P,Mt,It])||this;return i.setEntityStatus=function(t,e){1==e?i.engine.addComponentsToEntity(t,[new ve]):i.engine.removeComponentsFromEntityByType(t,[ve])},i.camera=e,i.spaceManager=new ge(10,10,320),i.activeSpaceAABB=new Ot,i}return xe(e,t),e.prototype.onEntityAdded=function(t,e,i,n){var o=this.engine.getComponentForEntity(t,be);this.spaceManager.addEntity(t,e,i,o?o.name:"unknown")},e.prototype.updateAllEntities=function(){this.activeSpaceAABB.extents.setTo(this.camera.viewportSize.x/2,this.camera.viewportSize.y/2),this.activeSpaceAABB.position.copy(this.camera.realPosition),this.spaceManager.search(this.activeSpaceAABB,this.setEntityStatus)},e}(T),Ce=function(){function t(t,e){this.ttl=t,this.age=0,this.onExpire=e}return t.prototype.growOlder=function(t){return this.age+=t,this.isExpired()},t.prototype.isExpired=function(){return this.age>this.ttl},t.prototype.reset=function(){this.age=0},t}(),Ee=function(){function t(t,e,i){this.states=t,this.currentState=e,this.messages=new g}return t.prototype.setState=function(t){this.currentState=t,null!=this.onChange&&this.onChange()},t}(),_e=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ae=function(t){function e(){return t.call(this,[Ce,Ee,$t])||this}return _e(e,t),e.prototype.updateEntity=function(t,e,i,n){e.growOlder(this.dt)&&null!=e.onExpire&&i.setState(e.onExpire)},e}(T),Te=function(){function t(t,e,i,n){this.maxHealth=t,this.currentHealth=e,this.recoveryPerSecond=i,this.recoveryPerMs=i/1e3,this.onNoHealth=n}return t.prototype.applyDamage=function(t){this.currentHealth-=t},t.prototype.isDead=function(){return this.currentHealth<=0},t}(),Pe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Se=function(t){function e(){return t.call(this,[Te,Ee,$t])||this}return Pe(e,t),e.prototype.updateEntity=function(t,e,i,n){e.currentHealth<=0?null!=e.onNoHealth&&i.setState(e.onNoHealth):e.currentHealth=Math.min(e.maxHealth,e.currentHealth+e.recoveryPerMs*this.dt)},e}(T),Re=function(t,e,i){void 0===i&&(i=!0),this.count=t,this.onCount=e,this.ignoreStatic=i},Le=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Fe=function(t){function e(){var e=t.call(this,[Re,Gt,Ee,$t])||this;return e.callback=e.callback.bind(e),e}return Le(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){i.proxy.contactCallbacks.push(this.callback)},e.prototype.onEntityRemoved=function(t,e,i,n,o){i.proxy.contactCallbacks.splice(i.proxy.contactCallbacks.indexOf(this.callback),1)},e.prototype.updateAllEntities=function(){},e.prototype.callback=function(t,e,i){var n=this.engine.getComponentForEntity(t.entity,Re),o=--n.count;if(null==e){if(o<=0&&null!=n.onCount)this.engine.getComponentForEntity(t.entity,Ee).setState(n.onCount)}else{if(e.isSensor)return;if(this.engine.getComponentForEntity(e.entity,Ut)&&null!=n.onCount)this.engine.getComponentForEntity(t.entity,Ee).setState(n.onCount)}},e}(T),Oe=function(){function t(){}return t.PLAYER_CAT=4,t.PROJECTILE_CAT=8,t.PROJECTILE_COLLIDABLE_CAT=16,t.SOLID_CAT=32,t.HOLDABLE_CAT=64,t.ph1_CAT=128,t.ph2_CAT=256,t.ph3_CAT=512,t.ph4_CAT=1024,t.ph5_CAT=2048,t.PLAYER_GROUP=-1,t.ENEMY_GROUP=-2,t.TURRET_GROUP=-3,t.BIRD_GROUP=-3,t.SOLID_OBJECT_GROUP=1,t}(),Be=function(){function t(){}return t.calcProjectileVelocity=function(t,e,i){var n=e.clone();n.minusEquals(t.position),n.normalize(),n.multEquals(i),t.maxScalarVelocity=i,t.velocity.setTo(n.x,n.y)},t.calcProjectileForce=function(t,e,i){var n=e.clone();n.minusEquals(t.position),n.normalize(),n.multEquals(i),t.addForce(n)},t}(),Me=function(t){this.count=t};function We(t,e){return Math.random()*(e-t)+t}function Ge(t){return void 0===t&&(t=.5),Math.random()<t}function Ie(t){return void 0===t&&(t=.5),Math.random()<t?1:-1}function De(t,e){return Math.floor(We(t,e))}var ze,Ue=new o(0,9),ke=function(){function t(t,e){this.mass=t,this.power=e}return t.prototype.update=function(t,e,i,n){for(var o=0;o<this.mass;o++){var r=We(0,2*Math.PI),s=We(0,2*this.power),a=Math.cos(r)*s,h=Math.sin(r)*s;n.EmitParticle(i.x,i.y,a,h,0,1,We(250,500),.999,!0,!0,Ue,4,255,255,0,0)}n.EmitParticle(i.x,i.y,a,h,0,1,We(250,500),.999,!0,!0,Ue,4,0,0,0,0)},t}(),Ne=function(){function t(){this.origin=new o,this.target=new o,this.range=0,this.delta=new o,this.direction=new o,this.contact=new bt,this.bounds=new G}return t.prototype.initalize=function(t,e,i,n){this.reset(),this.origin.copy(t),this.target.copy(e),this.delta.copy(e),this.delta.minusEquals(t),this.direction.copy(this.delta),this.direction.normalize(),i<=0?this.range=this.delta.length():(this.range=i,this.delta.copy(this.direction),this.delta.multEquals(i)),this.bounds.addPoint(this.origin.x,this.origin.y),this.bounds.addPoint(this.origin.x+this.delta.x,this.origin.y+this.delta.y),this.callback=n},t.prototype.reset=function(){this.contact.distance=9999999999,this.hit=!1},t.prototype.report=function(t,e,i,n,o){if(void 0===o&&(o=null),!(null!=this.callback&&null!=o&&this.callback(o)<0)){var r=t*t+e*e;r<this.contact.distance*this.contact.distance&&(this.contact.position.setTo(this.origin.x+t,this.origin.y+e),this.contact.normal.setTo(i,n),this.contact.distance=Math.sqrt(r),this.hit=!0)}},t}(),je=function(){function t(t){this.entity=t}return t.SortClosestFirst=function(t,e){return t.distance-e.distance},t.prototype.reset=function(){},t}(),Ve=function(){function t(){this.entities=new Array}return t.prototype.addItem=function(t){var e=new je(t);return this.entities.push(e),e},t.prototype.getItem=function(t){return this.entities.find((function(e){return e.entity===t}))},t.prototype.removeItem=function(t){this.entities=this.entities.filter((function(e){return e.entity!==t}))},t.prototype.filter=function(t){this.entities=this.entities.filter(t)},t.prototype.clear=function(){this.entities.length=0},t}(),qe=function(){function t(t,e){this.engine=t,this.broadphase=e,this.entityCollection=new Ve,this.aabb=new Ot,this.ray=new Ne,this.addBroadphaseItem=this.addBroadphaseItem.bind(this)}return t.prototype.query=function(t,e,i,n){this.entityCollection.clear(),this.aabb.position.copy(t),this.aabb.extents.setTo(e,e),this.filterEntity=i,this.visibleCheck=n,this.broadphase.QueryArea(this.aabb,this.addBroadphaseItem,!0,!0)},t.prototype.addBroadphaseItem=function(e){if(null==this.filterEntity||e.entity!=this.filterEntity){var i=e.aabb.position.distSqrd(this.aabb.position)+1e-8;if(i>t.RAYCAST_THRESHOLD&&this.visibleCheck){var n=this.engine.getComponentForEntity(e.entity,P);if(this.ray.initalize(this.aabb.position,n.coords,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),this.ray.hit)return}var o=this.entityCollection.addItem(e.entity);o.distance=i,o.perspective=this.aabb.position}},t.RAYCAST_THRESHOLD=10,t}();!function(t){t[t.ALL=0]="ALL",t[t.FRIENDLY=1]="FRIENDLY",t[t.ENEMY=2]="ENEMY"}(ze||(ze={}));var He=function(){function t(){}return t.setup=function(e,i){t.engine=e,t.broadphase=i,t.bfAreaQuery=new qe(e,i),t.ray=new Ne},t.CanSee=function(t,e,i){return!(t.distSqrd(e)>=i*i)&&(this.ray.initalize(t,e,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),!this.ray.hit)},t.SearchSortAndFilter=function(e,i,n,o){return t.referenceEntity=n,t.bfAreaQuery.query(e,i,n,!0),t.bfAreaQuery.entityCollection},t.explode=function(e,i,n,o){t.bfAreaQuery.query(e,i,o,!0),t.bfAreaQuery.entityCollection.entities.forEach((function(o){if(!t.engine.getComponentForEntity(o.entity,Me)){var r=t.engine.getComponentForEntity(o.entity,Te),s=t.engine.getComponentForEntity(o.entity,jt);if(null!=r||null!=s){var a=i/Math.sqrt(o.distance)*n;if(null!=r&&r.applyDamage(a),null!=s){var h=s.body.position.clone();h.minusEquals(e),h.normalize(),h.multEquals(a),s.body.addForce(h)}}}}))},t}(),Xe=function(){function t(t,e){this.rate=t,this.speed=e}return t.prototype.update=function(t,e,i,n){var o=e(jt).body.velocity;n.EmitParticle(i.x,i.y,o.x,o.y,0,0,1e3,.9,!0,!0,null,De(0,3),De(16,32),Ie(.5),Ie(.5),0)},t}(),Ye=function(t){this.emitters=t},Je=function(){function t(){}return t.create=function(e,i,n,o){var r=new Qt(Kt.LIGHTMETAL);r.setMass(24),r.setBounces(3),r.globalForceFactor=1,r.isBullet=!0,r.maxScalarVelocity=1e4,n.categoryBits|=Oe.PROJECTILE_CAT,n.maskBits|=Oe.PROJECTILE_COLLIDABLE_CAT;var s=e.createEntity();return e.addComponentsToEntity(s,[i,new Mt(2,2),new S("projectiles","standard"),new jt(r,!0),new Ut,new Gt(!1,n,[]),new Ye([]),new Ee(t.states,null,!1),new Re(3,"destroy"),new Te(10,10,0,"destroy"),new Ce(1e3,"destroy"),new $t,new ve]),Be.calcProjectileVelocity(r,o,2e3),s},t.onDestroy=function(t,e){t.getComponentForEntity(e,Me)||(t.addComponentsToEntity(e,[new Me(1)]),t.getComponentForEntity(e,pe).emitters.push(new ke(10,50)))},t.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,Me)||(t.addComponentsToEntity(e,[new Me(1)]),t.getComponentForEntity(e,Ye).emitters.push(new Xe(4,80)),He.explode(t.getComponentForEntity(e,P).coords,100,1e4,e))}},t}(),Ke=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ze=function(t){function e(){var e=t.call(this,[Me])||this;return e.toDelete=new Array,e}return Ke(e,t),e.prototype.updateEntity=function(t,e){e.count--<=0&&this.toDelete.push(t)},e.prototype.postUpdate=function(){var t=this;this.toDelete.forEach((function(e){return t.engine.destroyEntity(e)})),this.toDelete.length=0},e}(T),Qe=function(){},$e=function(){function t(){}return t.create=function(t,e){var i=new xt;i.categoryBits=Oe.PLAYER_CAT,i.maskBits|=Oe.PROJECTILE_CAT,i.groupIndex=Oe.PLAYER_GROUP;var n=new Qt(new Kt(1,.3,.1));n.maxScalarVelocity=0,n.maxVelocity.setTo(1600,1e3);var o=t.createEntity();return t.addComponentsToEntity(o,[new Qe,e,new Mt(7,20),new S("player"),new ft("player","idle"),new jt(n,!0),new Gt(!1,i,[]),new Ut,new $t,new ve]),o},t}(),ti=function(){function t(t,e,i){this.controlForce=new o,this.jumpUnit=new o,this.jumping=!1,this.isWalking=!1,this.originalFriction=0,this.burn=0,this.input=t,this.body=e,this.originalFriction=e.material.friction,this.originalVelocityClamp=e.maxVelocity.clone(),this.setBaseForce(i)}return t.prototype.setBaseForce=function(t){this.BASE_FORCE=600,this.WALK_FORCE=2*this.BASE_FORCE,this.AIR_CONTROL_FORCE=1*this.BASE_FORCE,this.JUMP_FORCE=30*this.BASE_FORCE,this.MAX_AIR_HORIZONTAL_VELOCITY=.5*this.BASE_FORCE,this.MAX_BURN=5*this.BASE_FORCE,this.BOOST_FACTOR=1.4},t.prototype.update=function(){this.controlForce.setTo(0,0),this.left=this.input.PressedDuration(65),this.right=this.input.PressedDuration(68);var t=this.input.JustPressed(87),e=this.input.PressedDuration(87);if(this.down=this.input.PressedDuration(83),this.boost=this.input.PressedDuration(16),!this.jumping&&this.body.onGround&&t&&(this.jumping=!0,this.controlForce.y-=this.JUMP_FORCE/5),(this.jumping&&this.input.Released(87)||this.body.contactNormal.y>0)&&(this.jumping=!1),this.body.onGround&&!this.body.onGroundPrev&&(this.burn=0),this.body.onGround)this.left>0&&(this.controlForce.x-=this.WALK_FORCE),this.right>0&&(this.controlForce.x+=this.WALK_FORCE),t&&(this.controlForce.y-=this.JUMP_FORCE);else{this.left>0&&(this.controlForce.x-=this.AIR_CONTROL_FORCE),this.right>0&&(this.controlForce.x+=this.AIR_CONTROL_FORCE);t&&(this.burn=this.MAX_BURN),e>0&&(this.burn+=this.BASE_FORCE)}this.boost>0?this.burn=Math.min(this.burn,this.MAX_BURN*this.BOOST_FACTOR):this.burn=Math.min(this.burn,this.MAX_BURN),this.controlForce.y-=this.burn,this.burn*=.95,this.isWalking=this.body.onGround&&(this.left>0||this.right>0),this.isWalking,this.body.addForce(this.controlForce)},t}(),ei=function(){function t(t,e){this.maxAcceleration=t,this.maxSteeringForcePerStep=e}return t.default_scale=.2,t.heavy_scale=5,t.default_maxAcceleration=100,t.default_maxSteeringForcePerStep=100,t}(),ii=new ei(ei.default_maxAcceleration*ei.default_scale,ei.default_maxSteeringForcePerStep*ei.default_scale),ni=new ei(ei.default_maxAcceleration*ei.heavy_scale,ei.default_maxSteeringForcePerStep*ei.heavy_scale),oi=function(){function t(e,i,n){void 0===i&&(i=null),void 0===n&&(n=t.CALCULATE_SUM),this.behaviors=e,this.steeringParameters=null==i?ii:i,this.hasChanged=!0}return t.prototype.addBehavior=function(t){this.behaviors.push(t),this.hasChanged=!0},t.prototype.removeBehaviour=function(t){this.behaviors.splice(this.behaviors.indexOf(t),1),this.hasChanged=!0},t.prototype.getBehaviour=function(t){return this.behaviors.find((function(e){return e.constructor.name===t.name}))},t.CALCULATE_SUM=0,t.CALCULATE_SPEED=1,t.CALCULATE_ACCURACY=2,t}(),ri=function(){function t(t,e,i,n){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===n&&(n=!0),this.weight=t,this.priority=e,this.probability=i,this.active=n}return t.prototype.calculate=function(t,e,i){},t}(),si=function(){function t(){}return t.speedTweaker=.3,t.arriveFast=1,t.arriveNormal=3,t.arriveSlow=5,t.wanderJitter=300,t.wanderDistance=25,t.wanderRadius=15,t.separationProbability=.2,t.cohesionProbability=.6,t.alignmentProbability=.3,t.dodgeProbability=.6,t.seekProbability=.8,t.fleeProbability=.6,t.pursuitProbability=.8,t.evadeProbability=1,t.offsetPursuitProbability=.8,t.arriveProbability=.5,t.obstacleAvoidanceProbability=.5,t.wallAvoidanceProbability=.5,t.hideProbability=.8,t.followPathProbability=.7,t.interposeProbability=.8,t.wanderProbability=.8,t.separationWeight=1,t.alignmentWeight=3,t.cohesionWeight=2,t.dodgeWeight=1,t.seekWeight=1,t.fleeWeight=1,t.pursuitWeight=1,t.evadeWeight=.1,t.offsetPursuitWeight=1,t.arriveWeight=1,t.obstacleAvoidanceWeight=10,t.wallAvoidanceWeight=10,t.hideWeight=1,t.followPathWeight=.5,t.interposeWeight=1,t.wanderWeight=1,t.wallAvoidancePriority=10,t.obstacleAvoidancePriority=20,t.evadePriority=30,t.hidePriority=35,t.seperationPriority=40,t.alignmentPriority=50,t.cohesionPriority=60,t.dodgePriority=65,t.seekPriority=70,t.fleePriority=80,t.arrivePriority=90,t.pursuitPriority=100,t.offsetPursuitPriority=110,t.interposePriority=120,t.followPathPriority=130,t.wanderPriority=140,t}(),ai=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),hi=function(t){function e(e,i){void 0===i&&(i=0);var n=t.call(this,si.seekWeight,si.seekPriority)||this;return n.target=e,n.seekDist=i,n}return ai(e,t),e.prototype.calculate=function(t,i,n){e.calc(t,i,n,this.target,this.seekDist)},e.calc=function(t,e,i,n,o){void 0===o&&(o=0);var r=n.x-t.position.x+1e-6,s=n.y-t.position.y+1e-6,a=r*r+s*s;if(o>0&&a<o*o)return!1;var h=Math.sqrt(a);return i.x=r/h,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.y=s/h,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,!0},e}(ri),ci=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ui=function(t){function e(e,i,n){void 0===e&&(e=8),void 0===i&&(i=1),void 0===n&&(n=4);var r=t.call(this,si.wanderWeight,si.wanderPriority)||this;return r.circleCenter=new o,r.displacement=new o,r.circleRadius=e,r.circleDistance=i,r.wanderAngle=We(0,2*Math.PI),r.wanderChange=n,r}return ci(e,t),e.prototype.calculate=function(t,e,i){this.wanderAngle+=We(-this.wanderChange,this.wanderChange),this.circleCenter.copy(t.velocity),this.circleCenter.normalize(),this.circleCenter.multEquals(this.circleDistance),this.circleCenter.plusEquals(t.position);var n=Math.atan2(t.velocity.y,t.velocity.x);n+=Math.PI/2,this.displacement.setTo(this.circleRadius*Math.cos(this.wanderAngle+n),this.circleRadius*Math.sin(this.wanderAngle+n)),this.circleCenter.plusEquals(this.displacement),hi.calc(t,e,i,this.circleCenter,0)},e}(ri);var pi,li=function(){function t(t,e){this.angle=t,this.length=e,this.base=new o,this.tip=new o,this.closestIP=new o,this.ip=new o,this.normal=new o,this.sf=new o}return t.prototype.Reset=function(t,e){if(this.distToClosestIP=O,this.tip.copy(t),this.base.copy(e),0!=this.angle){var i=Math.atan2(t.y,t.x)+this.angle;this.tip.x=Math.cos(i),this.tip.y=Math.sin(i)}this.tip.multEquals(this.length),this.tip.plusEquals(this.base),E.debugRender.DrawLine(this.tip.x,this.tip.y,this.base.x,this.base.y)},t.prototype.TestSegment=function(t,e,i){var n=function(t,e,i,n,o){var r=(t.y-i.y)*(n.x-i.x)-(t.x-i.x)*(n.y-i.y),s=(t.y-i.y)*(e.x-t.x)-(t.x-i.x)*(e.y-t.y),a=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x),h=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x);if(0==a||0==h)return-1;var c=r/a,u=s/h;return c>0&&c<1&&u>0&&u<1?(o.x=t.x+c*(e.x-t.x),o.y=t.y+c*(e.y-t.y),t.distSqrd(e)*c):0}(this.base,this.tip,t,e,this.ip);n>0&&n<this.distToClosestIP&&(this.distToClosestIP=n,this.closestIP.copy(this.ip),this.normal.copy(i))},t.prototype.CalculateForce=function(t){this.distToClosestIP!=O&&(this.sf.copy(this.tip),this.sf.minusEquals(this.closestIP),this.normal.multEquals(this.sf.length()),t.plusEquals(this.normal),E.debugRender.DrawLine(this.tip.x,this.tip.y,this.base.x,this.base.y))},t}(),di=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),fi=function(t){function e(e){var i=t.call(this,si.wallAvoidanceWeight,si.wallAvoidancePriority)||this;return i.pA=new o,i.pB=new o,i.top=new o(0,-1),i.right=new o(1,0),i.bottom=new o(0,1),i.left=new o(-1,0),i.searchAABB=new G,i.tempVector=new o,i.closestFeeler=null,i.closestDist=O,i.checkAABB=function(t){for(var e=0;e<i.feelers.length;e++){var n=i.feelers[e];i.pA.setTo(t.l,t.t),i.pB.setTo(t.r,t.t),n.TestSegment(i.pA,i.pB,i.top),i.pA.setTo(t.r,t.b),n.TestSegment(i.pB,i.pA,i.right),i.pB.setTo(t.l,t.b),n.TestSegment(i.pA,i.pB,i.bottom),i.pA.setTo(t.l,t.t),n.TestSegment(i.pB,i.pA,i.left),n.distToClosestIP<i.closestDist&&(i.closestDist=n.distToClosestIP,i.closestFeeler=n)}},i.feelerLength=e,i.ptv1=new o,i.ptv2=new o,i.feelers=new Array,i.feelers.push(new li(0,e)),i.feelers.push(new li(M(-40),.5*e)),i.feelers.push(new li(M(40),.5*e)),i.lastPos=new o,i}return di(e,t),e.prototype.calculate=function(t,e,i){if(!(this.lastPos.distSqrd(t.position)<1)){this.lastPos.copy(t.position),this.tempVector.copy(t.velocity),this.tempVector.normalize(),this.searchAABB.reset(),this.searchAABB.addPoint(t.position.x,t.position.y);for(var n=0;n<this.feelers.length;n++){var o=this.feelers[n];o.Reset(this.tempVector,t.position),this.searchAABB.addPoint(o.tip.x,o.tip.y)}this.closestFeeler=null,this.closestDist=O,e.map.iterateCells(this.searchAABB,this.checkAABB),null!=this.closestFeeler&&this.closestFeeler.CalculateForce(i)}},e}(ri),yi=function(){function t(){}return t.create=function(e,i){var n=new Qt(new Kt(.1,.3,0));n.setMass(.1),n.setBounces(0),n.globalForceFactor=0,n.maxScalarVelocity=200;var o=e.createEntity();return e.addComponentsToEntity(o,[i,new Mt(1.5,1.5),new S("insects"),new ft("insects","firefly"),new jt(n,!0),new Ut,new Gt(!1,null,[]),new oi([new ui(80,40,143.5),new hi(i.coords.clone(),32),new fi(40)],ni),new Ee(t.states,null,!1),new Ce(1e4,"destroy"),new Te(10,10,0,"destroy"),new $t]),o},t.onDestroy=function(t,e){t.getComponentForEntity(e,Me)||t.addComponentsToEntity(e,[new Me(1)])},t.states={destroy:function(t,e){t.getComponentForEntity(e,Me)||t.addComponentsToEntity(e,[new Me(1)])}},t}(),gi=function(t){this.holder=t},mi=function(){function t(t){this.activate=!1,this.heldItem=null,this.parent=null,this.parent=t}return t.drop=function(t,e){if(null!=e.heldItem){var i=e.heldItem;return t.removeComponentsFromEntityByType(e.heldItem,[gi]),e.heldItem=null,i}return null},t}(),vi=function(){function t(t,e){this.rate=t,this.speed=e}return t.prototype.update=function(t,e,i,n){for(var o=e(jt).body.velocity,r=0;r<5;r++){var s=We(0,2*Math.PI),a=o.x+Math.cos(s)*this.speed*We(0,2),h=o.y+Math.sin(s)*this.speed*We(0,2);n.EmitParticle(i.x,i.y,a,h,0,0,100,.7,!0,!0,null,4,255,229,252,114)}},t}(),bi=function(){function t(){}return t.create=function(e,i,n,o){var r=new Qt(Kt.LIGHTMETAL);r.setMass(.3),r.setBounces(0),r.globalForceFactor=.1,r.isBullet=!0,r.maxScalarVelocity=1e4,n.categoryBits|=Oe.PROJECTILE_CAT,n.maskBits|=Oe.PROJECTILE_COLLIDABLE_CAT;var s=e.createEntity();return e.addComponentsToEntity(s,[i,new Mt(2,2),new S("projectiles","plasma"),new jt(r,!0),new Ut,new Gt(!1,n,[]),new pe([new vi(0,400)]),new Ee(t.states,null,!1),new Re(1,"destroy"),new Te(10,10,0,"destroy"),new Ce(1e3,"destroy"),new $t]),Be.calcProjectileVelocity(r,o,600),s},t.onDestroy=function(t,e){t.getComponentForEntity(e,Me)||(t.addComponentsToEntity(e,[new Me(1)]),t.getComponentForEntity(e,pe).emitters.push(new ke(10,50)))},t.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,Me)||(t.addComponentsToEntity(e,[new Me(1)]),t.getComponentForEntity(e,pe).emitters.push(new ke(10,50)),He.explode(t.getComponentForEntity(e,P).coords,100,1e4,e))}},t}(),xi=function(){function t(){this.parent=-1,this.children=[],this.level=0}return t.addChild=function(e,i,n){var o=e.getComponentForEntity(i,t);if(o||(o=new t,e.addComponentsToEntity(i,[o])),-1==o.children.indexOf(n)){var r=e.getComponentForEntity(n,t);r?r.parent&&t.removeChild(e,r.parent,n):(r=new t,e.addComponentsToEntity(n,[r])),r.parent=i,r.level=o.level+1,o.children.push(n),r.children.length>0&&t.updateChildLevel(e,r)}},t.removeChild=function(e,i,n){var o=e.getComponentForEntity(i,t);if(o){var r=o.children.indexOf(n);if(r>0){var s=e.getComponentForEntity(n,t);s&&(s.parent=null,s.level=0,o.children.splice(r,1))}}},t.updateChildLevel=function(e,i){for(var n=0,o=i.children;n<o.length;n++){var r=o[n],s=e.getComponentForEntity(r,t);s.level=i.level+1,s.children.length>0&&t.updateChildLevel(e,s)}},t}(),wi=function(t){this.point=t},Ci=function(t,e,i,n,o,r,s,a,h){void 0===a&&(a=0),void 0===h&&(h=0),this.range=t,this.attenuation=e,this.intensity=i,this.flicker=n,this.red=o,this.green=r,this.blue=s,this.arc=a,this.angle=h};!function(t){t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.Enter=13]="Enter",t[t.Shift=16]="Shift",t[t.Ctrl=17]="Ctrl",t[t.Alt=18]="Alt",t[t.PauseBreak=19]="PauseBreak",t[t.CapsLock=20]="CapsLock",t[t.Escape=27]="Escape",t[t.Space=32]="Space",t[t.PageUp=33]="PageUp",t[t.PageDown=34]="PageDown",t[t.End=35]="End",t[t.Home=36]="Home",t[t.LeftArrow=37]="LeftArrow",t[t.UpArrow=38]="UpArrow",t[t.RightArrow=39]="RightArrow",t[t.DownArrow=40]="DownArrow",t[t.Insert=45]="Insert",t[t.Delete=46]="Delete",t[t.Zero=48]="Zero",t[t.ClosedParen=48]="ClosedParen",t[t.One=49]="One",t[t.ExclamationMark=49]="ExclamationMark",t[t.Two=50]="Two",t[t.AtSign=50]="AtSign",t[t.Three=51]="Three",t[t.PoundSign=51]="PoundSign",t[t.Hash=51]="Hash",t[t.Four=52]="Four",t[t.DollarSign=52]="DollarSign",t[t.Five=53]="Five",t[t.PercentSign=53]="PercentSign",t[t.Six=54]="Six",t[t.Caret=54]="Caret",t[t.Hat=54]="Hat",t[t.Seven=55]="Seven",t[t.Ampersand=55]="Ampersand",t[t.Eight=56]="Eight",t[t.Star=56]="Star",t[t.Asterik=56]="Asterik",t[t.Nine=57]="Nine",t[t.OpenParen=57]="OpenParen",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.LeftWindowKey=91]="LeftWindowKey",t[t.RightWindowKey=92]="RightWindowKey",t[t.SelectKey=93]="SelectKey",t[t.Numpad0=96]="Numpad0",t[t.Numpad1=97]="Numpad1",t[t.Numpad2=98]="Numpad2",t[t.Numpad3=99]="Numpad3",t[t.Numpad4=100]="Numpad4",t[t.Numpad5=101]="Numpad5",t[t.Numpad6=102]="Numpad6",t[t.Numpad7=103]="Numpad7",t[t.Numpad8=104]="Numpad8",t[t.Numpad9=105]="Numpad9",t[t.Multiply=106]="Multiply",t[t.Add=107]="Add",t[t.Subtract=109]="Subtract",t[t.DecimalPoint=110]="DecimalPoint",t[t.Divide=111]="Divide",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NumLock=144]="NumLock",t[t.ScrollLock=145]="ScrollLock",t[t.SemiColon=186]="SemiColon",t[t.Equals=187]="Equals",t[t.Comma=188]="Comma",t[t.Dash=189]="Dash",t[t.Period=190]="Period",t[t.UnderScore=189]="UnderScore",t[t.PlusSign=187]="PlusSign",t[t.ForwardSlash=191]="ForwardSlash",t[t.Tilde=192]="Tilde",t[t.GraveAccent=192]="GraveAccent",t[t.OpenBracket=219]="OpenBracket",t[t.ClosedBracket=221]="ClosedBracket",t[t.Quote=222]="Quote"}(pi||(pi={}));var Ei=function(){function t(t){void 0===t&&(t=0),this.size=t,this.data=[]}return t.prototype.push=function(t){return this.data.push(t),this.data.length===this.size?this.data.splice(0,1):null},t.prototype.pop=function(){return this.data.pop()},t}(),_i=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ai=function(t){function e(e,i){var n=t.call(this,[P,Qe,Gt,jt,ft,Mt])||this;return n.currentWeapon=0,n.input=e,n.particleEngine=i,n.teleporterLocations=new Ei(5),n}return _i(e,t),e.prototype.onEntityAdded=function(t,e,i,n,r,s,a){if(this.members.size>1)throw new Error("Only one player allowed");r.body.usesStairs=!0,this.characterController=new ti(this.input,r.body,800),this.playerLight=new Ci(256,1,1,0,255,0,0,1),this.holder=new mi(t),this.playerHolder=this.engine.createEntity(),this.engine.addComponentsToEntity(this.playerHolder,[new P(0,0),new wi(new o(0,0)),a,this.holder,new Gt(!0,new xt(1,0,Oe.PLAYER_GROUP),[],!1,r.body),new Ut,new $t]),xi.addChild(this.engine,t,this.playerHolder)},e.prototype.updateEntity=function(t,e,i,n,o,r,s){this.characterController.update(),o.body.onGround&&Math.abs(o.body.velocity.x)>10?r.play("runright"):o.body.onGround?r.play("idle"):r.play("fly"),this.characterController.left>0&&(e.direction.x=-1),this.characterController.right>0&&(e.direction.x=1),o.body.collideOneWay=!(this.characterController.down>0);var a=this.input.JustPressed(pi.Space);this.input.JustPressed(71),this.input.Pressed(pi.J),this.input.Pressed(pi.R);if(this.input.Pressed(pi.U)&&yi.create(this.engine,e.clone()),this.holder.activate=this.input.JustPressed(pi.H),this.input.JustPressed(pi.J))mi.drop(this.engine,this.holder);else if(this.input.JustPressed(pi.K)){var h=mi.drop(this.engine,this.holder);null!=h&&Be.calcProjectileVelocity(this.engine.getComponentForEntity(h,jt).body,this.input.ViewCorrectedMousePosition(),700)}if(a&&(0==this.currentWeapon&&Je.create(this.engine,e.clone(),n.proxy.filter.clone(),this.input.ViewCorrectedMousePosition()),1==this.currentWeapon&&bi.create(this.engine,e.clone(),n.proxy.filter.clone(),this.input.ViewCorrectedMousePosition())),this.input.Pressed(pi.E)){var c=this.input.ViewCorrectedMousePosition().clone();c.minusEquals(e.coords),c.normalize(),c.multEquals(2e3),this.particleEngine.EmitParticle(e.coords.x,e.coords.y,c.x,c.y,0,0,200,1,!1,!0,null,4,255,255,255,255)}if(this.characterController.burn>0){var u=e.coords.x-8*e.direction.x,p=300+We(-150,150)+o.body.velocity.y,l=Math.floor((this.characterController.burn+500)/1e3);l>0&&this.particleEngine.EmitParticle(u,e.coords.y+8,We(-10,10)+o.body.velocity.x,p,0,0,40,.9,!1,!1,null,4,255,255,0,0);for(var d=0;d<l;d++)this.particleEngine.EmitParticle(u,e.coords.y+8,We(-50,50)+o.body.velocity.x,p,0,0,280,.9,!0,!0,null,4,255,255,255,255)}this.input.JustPressed(pi.One)&&(this.currentWeapon=0),this.input.JustPressed(pi.Two)&&(this.currentWeapon=1),this.input.JustPressed(pi.L)&&(this.engine.getComponentForEntity(t,Ci)?this.engine.removeComponentsFromEntityByType(t,[Ci]):this.engine.addComponentsToEntity(t,[this.playerLight]));var f=this.input.ViewCorrectedMousePosition().clone();if(f.minusEquals(e.coords),f.normalize(),this.playerLight.angle=f.heading(),this.input.JustPressed(pi.R)&&this.teleporterLocations.push(e.coords.clone()),this.input.JustPressed(pi.T)){var y=this.teleporterLocations.pop();y&&o.body.position.copy(y)}},e.prototype.fireWeapon=function(){},e}(T),Ti=function(t,e,i,n,r){this.direction=new o,this.direction.setUnitRotation(t-90),this.minForce=e,this.maxForce=i,this.minDuration=n,this.maxDuration=r},Pi=function(t){this.direction=new o,this.power=0,this.ttl=0,this.data=t},Si=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ri=function(t){function e(){var e=t.call(this,[Gt,Mt,Pi,$t])||this;return e.temp=new o,e.callback=e.callback.bind(e),e}return Si(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){e.proxy.contactCallbacks.push(this.callback),this.setActiveForce(n,0)},e.prototype.updateEntity=function(t,e,i,n,o){n.ttl>0&&(n.ttl-=this.dt,n.ttl)},e.prototype.onFinished=function(t){t.currentIndex++,t.currentIndex>=t.data.length&&(t.currentIndex=0),this.setActiveForce(t,t.currentIndex)},e.prototype.setActiveForce=function(t,e){t.currentIndex=e;var i=t.data[e];t.direction.copy(i.direction),t.power=i.maxForce,t.ttl=0==i.minDuration?-1:We(1e3*i.minDuration,1e3*i.maxDuration)},e.prototype.callback=function(t,e,i){var n=t.aabb.overlapArea(e.aabb),o=this.engine.getComponentForEntity(t.entity,Pi);this.temp.copy(o.direction),this.temp.multEquals(o.power*n),e.body.addForce(this.temp)},e}(T);function Li(t){return new P(Oi(t.x+t.width/2),Oi(t.y+t.height/2))}function Fi(t){return new Mt(Oi(t.width/2),Oi(t.height/2))}function Oi(t){return 2*t}var Bi,Mi=function(t){this.particlePerUnitPerFrame=t,this.particleCount=0,this.incPerFrame=0},Wi=function(){function t(){}return t.createTMXEntity=function(e,i){var n=e.createEntity(),o=[];o.push(Li(i)),o.push(Fi(i)),o.push(new Gt(!0,null,[])),o.push(new It),o.push(new $t);var r=[];return i.properties.forEach((function(e){var i=e.value.split(",").map(parseFloat);r.push(new Ti(i[0],i[1]*t.FORCE_SCALE,i[2]*t.FORCE_SCALE,i[3],i[4]))})),o.push(new Pi(r)),o.push(new Mi(.001)),e.addComponentsToEntity(n,o),n},t.FORCE_SCALE=.01,t.mapping="Force",t}(),Gi=function(){function t(t,e,i){this.radius=t,this.maxLights=e,this.lightingShader=i,this.lights=[];for(var n=0;n<this.maxLights;n++)this.lights.push(new Ii);this.reset()}return t.prototype.reset=function(){this.activeLights=0},t.prototype.addLight=function(t,e,i,n,o,r,s,a){void 0===s&&(s=0),void 0===a&&(a=0);var h=this.lights[this.activeLights++];h.x=t,h.y=e,h.intensity=i,h.red=n,h.green=o,h.blue=r,h.arc=s,h.angle=a},t}(),Ii=function(){},Di=function(){function t(t,e){this.quadVerts=new Float32Array([-1,-1,1,-1,1,1,-1,1]),this.ranges=t,this.renderSurface=this.renderSurface.bind(this),this.snapPosition=new o(-1e3,-1e3),this.layer=e,this.tileSize=8,this.halfTileSize=this.tileSize/2,this.backgroundLight=0}return t.prototype.Init=function(t,e){var i=this;this.gl=t,this.camera=e,this.projection=new o,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.resolution=new o,this.sprite=new Z,this.sprite.id="lightTexture",this.ResizeBatch(20*this.ranges.length),this.lightGroups=this.ranges.map((function(e){return new Gi(e,20,new it(t,et(t,"precision mediump float;\n\nuniform vec2 projectionVector;\nuniform vec2 viewOffset;\n\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aColor;\nattribute vec3 aArc;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying vec3 vArc;\n\nvoid main(void) {\n    gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n    vColor = aColor;\n    vArc = aArc;\n}",(n=e/i.tileSize,o=.5,"precision mediump float;\n\nconst int PATH_TRACKING_SAMPLES = ${count};\nconst float INV_PATH_TRACKING_SAMPLES = 1.0 / float(PATH_TRACKING_SAMPLES);\nconst vec2 EMPTY_TILE = vec2(1.0, 1.0);\nconst float LIGHT_TO_MAP_RESOLUTION_RATIO = float(${ratio}); // 0.5;\n\nuniform sampler2D uSampler;\nuniform vec2 viewOffset;\nuniform vec2 resolution;\nuniform vec2 inverseTileTextureSize;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying vec3 vArc;\n\nvoid main(void) {\n    vec2 fragToCenterPos = vTextureCoord.xy;\n    float d = length(fragToCenterPos) / float(PATH_TRACKING_SAMPLES);\n\n    vec2 pos = vec2(gl_FragCoord.x - 1., resolution.y - gl_FragCoord.y);\n\n    vec2 currentPos = (pos - viewOffset) - vec2(0.0,1.0); // * inverseTileTextureSize;\n    vec2 centerPos = currentPos - fragToCenterPos; // * inverseTileTextureSize;\n\n    float m = INV_PATH_TRACKING_SAMPLES * d; // * 0.5;\n\n    float light = 1. - d; // Linear\n    \n    // float light = pow(1. - d, 5.); // Ease in\n    // float light = 1. - pow(1. - (1. - d), 3.); // Ease out\n\n    // Torch\n    float cone = 1.;\n    if (bool(vArc.z)) {\n        vec2 dir = vArc.xy; // vec2(1.,0.);\n        float projection = dot(dir, normalize(fragToCenterPos));\n        cone *= smoothstep(0.5 ,0.7, projection);\n        // cone *= float( projection < 0.8 );\n    }\n    \n    float obs = light * cone;\n\n    vec2 scaledTilesSize = inverseTileTextureSize * LIGHT_TO_MAP_RESOLUTION_RATIO;\n\n    float stepPos = 0.;\n    for(int i = 0; i < PATH_TRACKING_SAMPLES; i++)\n    {\n        stepPos += INV_PATH_TRACKING_SAMPLES; \n        vec4 tile = texture2D(uSampler, floor(mix(centerPos, currentPos, stepPos)) * scaledTilesSize);\n        float obsMult = float(all(lessThan(tile.xy, EMPTY_TILE)));\n        obs -= m * obsMult;\n        // stepPos -= INV_PATH_TRACKING_SAMPLES * 0.9 * obsMult;\n        \n        // if (all(lessThan(tile.xy, EMPTY_TILE))) {\n        //     obs -= m;\n        //     // obs *= m;\n        //     // col *= saturate(1 - (1 - obstacle)*obstacle.a*m);\n        // }\n    }\n\n    gl_FragColor.a = clamp(obs,0.,1.);\n    // gl_FragColor.rgb = vec3(1.,0.,0.); // vColor.rgb\n    // gl_FragColor = vec4(1.,1.,1.,1.0-d);\n\n}".replace("${count}",n).replace("${ratio}",o)))));var n,o})),this.lightGroupsMap=new Array(this.ranges[this.ranges.length-1]),this.ranges.forEach((function(t,e){i.lightGroupsMap[t]=i.lightGroups[e]}))},t.prototype.ResizeBatch=function(t){this.size=t,this.data=new Float32Array(32*this.size),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=new Uint16Array(6*this.size);for(var e=0;e<this.size;e++){var i=6*e,n=4*e;this.indices[i+0]=n+0,this.indices[i+1]=n+1,this.indices[i+2]=n+2,this.indices[i+3]=n+0,this.indices[i+4]=n+2,this.indices[i+5]=n+3}this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)},t.prototype.Resize=function(t,e){var i=this.resolution.x=Math.floor(t/this.tileSize)+2,n=this.resolution.y=Math.floor(e/this.tileSize)+2;this.projection.x=i*this.tileSize/2,this.projection.y=n*this.tileSize/2,this.surface=new N(this.gl,i,n),this.texture=new V(this.surface,new j(0,0,i,n),new o(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(this.tileSize,-this.tileSize),this.sprite.pivot.setTo(i/2,n/2)},t.prototype.reset=function(){for(var t=0,e=this.lightGroups;t<e.length;t++){e[t].reset()}},t.prototype.addUnblockedLight=function(t,e,i,n,o,r){},t.prototype.addBlockedLight=function(t,e,i,n,o,r,s,a){var h=this.lightGroupsMap[Math.round(i)];h&&h.addLight(t,e,i,n,o,r,s,a)},t.prototype.processLightsBatch=function(){for(var t=0,e=0,i=this.lightGroups;e<i.length;e++)for(var n=i[e],o=0;o<n.activeLights;o++){var r=n.lights[o],s=32*t,a=r.intensity+this.halfTileSize,h=r.intensity/this.tileSize,c=r.x,u=r.y;c+=Math.floor(this.camera.position.x/this.tileSize)*this.tileSize,u+=Math.floor(this.camera.position.y/this.tileSize)*this.tileSize,c+=2*this.tileSize,u+=2*this.tileSize;var p=r.red<<24|r.green<<16|r.blue<<8|0,l=Math.cos(r.angle),d=Math.sin(r.angle),f=r.arc;this.data[s+0]=c+this.quadVerts[0]*a,this.data[s+1]=u+this.quadVerts[1]*a,this.data[s+2]=this.quadVerts[0]*h,this.data[s+3]=this.quadVerts[1]*h,this.data[s+4]=p,this.data[s+5]=l,this.data[s+6]=d,this.data[s+7]=f,this.data[s+8]=c+this.quadVerts[2]*a,this.data[s+9]=u+this.quadVerts[3]*a,this.data[s+10]=this.quadVerts[2]*h,this.data[s+11]=this.quadVerts[3]*h,this.data[s+12]=p,this.data[s+13]=l,this.data[s+14]=d,this.data[s+15]=f,this.data[s+16]=c+this.quadVerts[4]*a,this.data[s+17]=u+this.quadVerts[5]*a,this.data[s+18]=this.quadVerts[4]*h,this.data[s+19]=this.quadVerts[5]*h,this.data[s+20]=p,this.data[s+21]=l,this.data[s+22]=d,this.data[s+23]=f,this.data[s+24]=c+this.quadVerts[6]*a,this.data[s+25]=u+this.quadVerts[7]*a,this.data[s+26]=this.quadVerts[6]*h,this.data[s+27]=this.quadVerts[7]*h,this.data[s+28]=p,this.data[s+29]=l,this.data[s+30]=d,this.data[s+31]=f,t++}},t.prototype.calcSnap=function(t){this.snapPosition.x=Math.floor(t.x/this.tileSize)*this.tileSize,this.snapPosition.y=Math.floor(t.y/this.tileSize)*this.tileSize,this.snapPosition.x+=this.tileSize,this.snapPosition.y+=this.tileSize},t.prototype.Background=function(t){this.backgroundLight=t},t.prototype.Render=function(t){this.processLightsBatch(),this.calcSnap(this.camera.position);var e=this.camera.position.y/this.camera.worldExtentsAABB.height;this.Background(Math.abs(e)),this.sprite.position.copy(this.camera.halfViewportSize),this.sprite.position.minusEquals(this.snapPosition),this.surface.drawTo(this.renderSurface)},t.prototype.renderSurface=function(){this.gl.clearColor(0,0,0,this.backgroundLight),this.gl.colorMask(!0,!0,!0,!0),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.ZERO,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.layer.tileDataTexture);for(var t=0,e=0,i=this.lightGroups;e<i.length;e++){var n=i[e];0!=n.activeLights&&(this.gl.useProgram(n.lightingShader.program),this.gl.uniform2f(n.lightingShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.uniform2f(n.lightingShader.uniform.resolution,this.resolution.x,this.resolution.y),this.gl.uniform2f(n.lightingShader.uniform.viewOffset,this.snapPosition.x/this.tileSize,this.snapPosition.y/this.tileSize),this.gl.uniform2fv(n.lightingShader.uniform.inverseTileTextureSize,this.layer.inverseTileDataTextureSize),this.gl.enableVertexAttribArray(n.lightingShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(n.lightingShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(n.lightingShader.attribute.aColor),this.gl.vertexAttribPointer(n.lightingShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,32,0),this.gl.vertexAttribPointer(n.lightingShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,32,8),this.gl.vertexAttribPointer(n.lightingShader.attribute.aColor,4,WebGLRenderingContext.UNSIGNED_BYTE,!0,32,16),this.gl.vertexAttribPointer(n.lightingShader.attribute.aArc,3,WebGLRenderingContext.FLOAT,!1,32,20),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*n.activeLights,WebGLRenderingContext.UNSIGNED_SHORT,t),t+=12*n.activeLights)}this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.colorMask(!0,!0,!0,!0)},t}(),zi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ui=function(t){function e(e,i){var n=t.call(this,[P,Ci,ve])||this;return n.map=e,n.renderer=new Di([64,160,256,320,480],i),n}return zi(e,t),e.prototype.preUpdate=function(){return this.renderer.reset(),!0},e.prototype.updateEntity=function(t,e,i,n){i.flicker>0?this.renderer.addBlockedLight(e.coords.x+We(-10,10),e.coords.y+We(-10,10),i.range*i.intensity,i.red,i.green,i.blue,i.arc,i.angle):this.renderer.addBlockedLight(e.coords.x,e.coords.y,i.range*i.intensity,i.red,i.green,i.blue,i.arc,i.angle)},e.prototype.onEntityRemoved=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];console.log("removed light")},e.prototype.nexLightIntensity=function(t){return e=t+(Math.random()-.3)/10,i=0,n=1,Math.min(Math.max(e,i),n);var e,i,n},e}(T),ki=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ni=function(t){function e(e){var i=t.call(this,[jt,oi])||this;return i.behaviorForce=new o,i.totalForce=new o,i.map=e,i}return ki(e,t),e.prototype.updateEntity=function(t,e,i){i.hasChanged&&(i.steeringParameters.map=this.map,i.behaviors.sort(this.behaviorsCompare),i.hasChanged=!1),this.runningSum(i,e.body),e.body.addProportionalForce(this.totalForce)},e.prototype.runningSum=function(t,e){this.totalForce.setTo(0,0);for(var i=0;i<t.behaviors.length;i++){var n=t.behaviors[i];n.active&&(this.behaviorForce.setTo(0,0),n.calculate(e,t.steeringParameters,this.behaviorForce),this.behaviorForce.multEquals(n.weight),this.totalForce.plusEquals(this.behaviorForce))}this.totalForce.clampScalar(t.steeringParameters.maxAcceleration)},e.prototype.behaviorsCompare=function(t,e){return t.priority<e.priority?-1:t.priority==e.priority?0:1},e}(T);!function(t){t.Destroy="destroy"}(Bi||(Bi={}));var ji=function(){function t(t){this.maxMembers=t,this.members=new Set,this.messages=new g,this.onMemberMessage=this.onMemberMessage.bind(this)}return t.prototype.addMember=function(t,e){this.hasCapacity()&&(this.members.add(t),e.messages.add(this.onMemberMessage))},t.prototype.removeMember=function(t){this.members.delete(t)},t.prototype.onMemberMessage=function(t,e){switch(e){case Bi.Destroy:this.removeMember(t)}},t.prototype.hasCapacity=function(){return this.members.size<this.maxMembers},t}(),Vi=function(t){this.group=new ji(t)},qi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Hi=function(t){function e(){return t.call(this,[Vi,ve,$t])||this}return qi(e,t),e.prototype.onEntityRemoved=function(t,e,i,n){var o=this;e.group.members.forEach((function(t){o.engine.getComponentForEntity(t,Ee).setState(Bi.Destroy)}))},e.prototype.updateEntity=function(t,e,i,n){if(e.group.hasCapacity()&&Ge(.01)){var o=yi.create(this.engine,this.engine.getComponentForEntity(t,P).clone()),r=this.engine.getComponentForEntity(o,Ee);e.group.addMember(o,r)}},e}(T),Xi=function(){function t(t){void 0===t&&(t=0),this.reset(t)}return t.prototype.reset=function(t){void 0===t&&(t=0),this.current=0,this.intervalTime=t,this.intervals=0},t.prototype.tick=function(t){return this.current+=t,this.current>this.intervalTime&&(this.current=0,this.intervals++,!0)},t}(),Yi=function(t){this.triggered=!1,this.radius=100,this.group=new ji(t),this.intervalDelay=new Xi(1e3)},Ji=function(){function t(){this.stack=new Array}return t.prototype.update=function(t,e){var i=this.getCurrentState();null!=i&&i(t,this,e)},t.prototype.popState=function(){return this.stack.pop()},t.prototype.popAllStates=function(){for(;this.stack.length>0;)this.popState()},t.prototype.pushState=function(t){this.stack.push(t)},t.prototype.setState=function(t){this.popState(),this.pushState(t)},t.prototype.resetState=function(t){this.popAllStates(),this.pushState(t)},t.prototype.getCurrentState=function(){return this.stack.length>0?this.stack[this.stack.length-1]:null},t}(),Ki=function(t){this.nest=t,this.ai=new Ji,this.delay=new Xi(1e3),this.chaseCheck=new Xi(500)},Zi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Qi=function(t){function e(e,i,n){void 0===i&&(i=0),void 0===n&&(n=0);var o=t.call(this,si.seekWeight,si.seekPriority)||this;return o.target=e,o.arrivalZone=i,o.seekDist=n,o}return Zi(e,t),e.prototype.calculate=function(t,i,n){e.calc(t,i,n,this.target,this.arrivalZone,this.seekDist)},e.calc=function(t,e,i,n,o,r){void 0===o&&(o=0),void 0===r&&(r=0);var s=n.x-t.position.x+1e-6,a=n.y-t.position.y+1e-6,h=s*s+a*a;if(r>0&&h<r*r)return!1;var c=Math.sqrt(h),u=1;return c<o&&(u=c/o),i.x=s/c,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.x*=u,i.y=a/c,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,i.x*=u,!0},e}(ri),$i=function(){function t(){}return t.create=function(e,i,n,o){var r=new Qt(new Kt);r.setMass(1),r.setBounces(0),r.globalForceFactor=0,r.maxScalarVelocity=200;var s=e.createEntity();return e.addComponentsToEntity(s,[i,new Ki(o),new Mt(4,4),new S("bird"),new jt(r,!1),new Ut,new Gt(!1,null,[]),new ft("bird","fly"),new oi([new ui(55,80,.3),new Qi(n.coords,256),new fi(60)]),new Ee(t.states,null,!1),new Ce(15e3,"destroy"),new Te(10,10,0,"destroy"),new $t]),s},t.onDestroy=function(t,e){t.getComponentForEntity(e,Me)||t.addComponentsToEntity(e,[new Me(1)])},t.states={destroy:function(t,e){t.getComponentForEntity(e,Me)||t.addComponentsToEntity(e,[new Me(1)])}},t}(),tn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),en=function(t){function e(){return t.call(this,[P,Yi,ve,$t])||this}return tn(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){i.trigger=this.engine.createEntity(),this.engine.addComponentsToEntity(i.trigger,[e,new Mt(i.radius/2,i.radius/2),new Gt(!0,null,[this.triggerCallback]),new It,new $t])},e.prototype.updateEntity=function(t,e,i,n,o){if(i.intervalDelay.tick(this.dt)){var r=this.evaluateTargets(t);r>=0&&this.releaseBird(t,r)}i.triggered&&(i.triggered=!1)},e.prototype.triggerCallback=function(t,e,i){},e.prototype.evaluateTargets=function(t){var e=this.engine.getComponentForEntity(t,P),i=He.SearchSortAndFilter(e.coords,200,t,ze.ALL).entities;return i.length>0?i[0].entity:-1},e.prototype.releaseBird=function(t,e){var i=this.engine.getComponentForEntity(t,Yi);if(i.group.hasCapacity()){var n=this.engine.getComponentForEntity(t,P),o=$i.create(this.engine,n.clone(),n,t),r=this.engine.getComponentForEntity(o,Ee);i.group.addMember(t,r)}},e}(T),nn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),on=function(t){function e(e){var i=t.call(this,[Ki,Gt,Te,oi])||this;return i.bfAreaQuery=e,i.baseState=i.baseState.bind(i),i.seekState=i.seekState.bind(i),i.chaseState=i.chaseState.bind(i),i}return nn(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){e.ai.pushState(this.baseState)},e.prototype.updateEntity=function(t,e,i,n,o){e.ai.update(t,this.dt)},e.prototype.baseState=function(t,e,i){this.engine.getComponentForEntity(t,Ki).delay.tick(i)&&e.pushState(this.seekState)},e.prototype.seekState=function(t,e,i){var n=this.engine.getComponentForEntity(t,P),o=He.SearchSortAndFilter(n.coords,300,t,ze.ALL).entities;if(o.length>0){var r=this.engine.getComponentForEntity(t,Ki);r.target=o[0].entity;var s=this.engine.getComponentForEntity(t,oi),a=s.getBehaviour(Qi);return a.target=this.engine.getComponentForEntity(r.target,P).coords,a.arrivalZone=1,s.getBehaviour(ui).active=!1,e.popState(),void e.pushState(this.chaseState)}e.popState()},e.prototype.chaseState=function(t,e,i){var n=this.engine.getComponentForEntity(t,Ki);if(!n.chaseCheck.tick(i)){var o=this.engine.getComponentForEntity(t,P),r=this.engine.getComponentForEntity(n.target,P);if(!He.CanSee(o.coords,r.coords,300)){n.target=null;var s=this.engine.getComponentForEntity(t,oi);s.getBehaviour(ui).active=!0;var a=s.getBehaviour(Qi);a.target=this.engine.getComponentForEntity(t,P).coords,a.arrivalZone=128,e.popState()}}},e}(T),rn=function(){},sn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),an=function(t){function e(e){var i=t.call(this,[Gt,Mt,rn])||this;return i.particleEngine=e,i.cycle=0,i.callback=i.callback.bind(i),i._tempVec=new o,i}return sn(e,t),e.prototype.onEntityAdded=function(t,e,i,n){this.engine.getComponentForEntity(t,Gt).proxy.contactCallbacks.push(this.callback)},e.prototype.updateAllEntities=function(){this.cycle=2*Math.PI/1e3*this.timestamp%1e3},e.prototype.callback=function(t,e,i){var n=t.aabb.overlapArea(e.aabb);e.body.damping=.9,this._tempVec.setTo(0,-n*(4.5+.5*Math.sin(this.cycle))),e.body.addForce(this._tempVec),e.body.inWaterPrev?e.aabb.t<t.aabb.t&&Ge(.1)&&null!=this.engine.getComponentForEntity(t.entity,ve)&&this.particleEngine.EmitParticle(We(e.aabb.l,e.aabb.r),t.aabb.t,We(-20,20),We(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255):(this.particleEngine.EmitParticle(We(e.aabb.l,e.aabb.r),t.aabb.t,We(-20,20),We(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(We(e.aabb.l,e.aabb.r),t.aabb.t,We(-20,20),We(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(We(e.aabb.l,e.aabb.r),t.aabb.t,We(-20,20),We(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255)),e.body.inWater=!0},e}(T),hn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),cn=function(t){function e(e,i){var n=t.call(this,[Mt,Pi,Mi,ve,Gt,$t])||this;return n.particleEngine=e,n.tileSize=i,n}return hn(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o,r,s){var a=e.halfWidths.x*e.halfWidths.y*4/(this.tileSize*this.tileSize);n.incPerFrame=n.particlePerUnitPerFrame*a},e.prototype.updateEntity=function(t,e,i,n,o,r,s){for(n.particleCount+=n.incPerFrame;n.particleCount>1;)this.particleEngine.EmitParticle(We(r.proxy.aabb.l,r.proxy.aabb.r),We(r.proxy.aabb.t,r.proxy.aabb.b),i.direction.x*i.power*50,i.direction.y*i.power*50,0,1,De(200,400),1,!0,!0,null,4,255,255,255,255),n.particleCount--},e}(T),un=function(){function t(){}return t.createTMXEntity=function(t,e){var i=t.createEntity(),n=[];return n.push(Li(e)),n.push(Fi(e)),n.push(new Gt(!0,null,[])),n.push(new It),n.push(new $t),n.push(new rn),t.addComponentsToEntity(i,n),i},t.mapping="Water",t}(),pn=function(t,e,i){this.type=t,this.open=e,this.triggerEvent=i},ln=function(t,e){this.channel=t,this.sequence=e},dn=function(){function t(){}return t.create=function(e,i,n,o,r){var s=e.createEntity();return(new xt).groupIndex=Oe.SOLID_OBJECT_GROUP,e.addComponentsToEntity(s,[i,n,new re(r),new Gt(!1,null,[]),new It,new pn("door",!1,""),new Ee(t.states,"open",!0),new ln("doorA",["open","close"]),new $t]),s},t.onDestroy=function(t,e){},t.createTMXEntity=function(e,i){var n=Fi(i);return n.halfWidths.x/=2,t.create(e,Li(i),n,"doorOpen","doorClosed")},t.mapping="door",t.states={open:function(t,e){var i=t.getComponentForEntity(e,pn);t.getComponentForEntity(e,re).setTileFrameId(i.type+"Open");var n=t.getComponentForEntity(e,Gt);n.proxy.responseBias.x=0,n.proxy.isActive=!1},close:function(t,e){var i=t.getComponentForEntity(e,pn);t.getComponentForEntity(e,re).setTileFrameId(i.type+"Closed");var n=t.getComponentForEntity(e,Gt);n.proxy.responseBias.x=1,n.proxy.isActive=!0}},t}(),fn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),yn=function(t){function e(){var e=t.call(this,[Ee])||this;return e.updates=new Array,e}return fn(e,t),e.prototype.onEntityAdded=function(t,e){e.onChange=this.onChange.bind(this,t)},e.prototype.onEntityRemoved=function(t,e){},e.prototype.updateAllEntities=function(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,Ee);if(null===e||null===e.currentState)return;e.states[e.currentState](this.engine,t),e.messages.dispatch(t,e.currentState)}},e.prototype.onChange=function(t){this.updates.push(t)},e}(T),gn=function(){function t(){this.bus=new Map}return t.prototype.registerChannels=function(t,e){var i=this;t.forEach((function(t){i.bus.has(t)||i.bus.set(t,new g),i.bus.get(t).add(e)}))},t.prototype.unregisterChannels=function(t,e){var i=this;t.forEach((function(t){i.bus.has(t)&&i.bus.get(t).remove(e)}))},t.prototype.trigger=function(t,e){this.bus.has(t)&&this.bus.get(t).dispatch(e)},t}(),mn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),vn=function(t){function e(e){var i=t.call(this,[Ee,ln])||this;return i.bus=e,i}return mn(e,t),e.prototype.onEntityAdded=function(t,e,i){i.onChange=this.onChange.bind(this,t),this.bus.registerChannels([i.channel],i.onChange)},e.prototype.onEntityRemoved=function(t,e,i){this.bus.unregisterChannels([i.channel],i.onChange)},e.prototype.updateAllEntities=function(){},e.prototype.onChange=function(t){var e=this.engine.getComponentForEntity(t,Ee),i=this.engine.getComponentForEntity(t,ln),n=i.sequence.indexOf(e.currentState),o=++n%i.sequence.length;e.setState(i.sequence[o])},e}(T),bn=function(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<i;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)n[o]=r[s];return n},xn=function(t){return["<thead>","<tr>","<th></th>",t.map((function(t){return'<th class="rotate"><div><span>'+t+"</span></div></th>"})).join(""),"</tr>","</thead>"].join("")},wn=function(t,e,i,n){for(var o=[],r=t;r<t+e;r++)o.push(Cn(r,i,n));return o.join("")},Cn=function(t,e,i){return["<tr>",'<th class="row-header">'+t+"</th>",e.map((function(e){return null===i.get(e)[t]?"<td></td>":"<td>X</td>"})).join(""),"</tr>"].join("")},En=function(){},_n=function(){function t(){}return t.create=function(t,e){var i=t.createEntity(),n=new Qt(Kt.RUBBER);return n.setMass(.1),n.setBounces(7),n.maxScalarVelocity=1e3,t.addComponentsToEntity(i,[new En,e,new Mt(12,12),new S("chicken"),new ft("chicken","walk"),new Gt(!1,new xt(1,4294967295,1),[]),new jt(n,!0),new Ut,new $t,new ve]),i},t.states={destroy:function(t,e){t.getComponentForEntity(e,Me)||t.addComponentsToEntity(e,[new Me(1)])}},t}(),An=function(t){document.getElementById("debugDump").addEventListener("click",(function(){var e=document.getElementById("debugResult"),i=function(t,e,i){var n=bn(t.components.keys()).sort();return['<table class="table table-header-rotated">',xn(n),"<tbody>",wn(e,i,n,t.components),"</tbody>"].join("")}(t,0,100);e.innerHTML=i})),document.getElementById("debugChickens").addEventListener("click",(function(){for(var e=t.query([Qe])[0],i=t.getComponentForEntity(e,P),n=0;n<10;n++){var r=_n.create(t,i.clone());t.getComponentForEntity(r,jt).body.addForce(new o(De(-1e5,1e5),De(-1e5,-5e3)))}})),document.getElementById("debugDraw").addEventListener("click",(function(t){document.getElementById("viewDebug").style.display=t.target.checked?"block":"none",E.debug=t.target.checked}))},Tn=function(){function t(t){this.bounds=new G,this.reset(t)}return t.prototype.reset=function(t){this.parent=t||null,this.body=null,this.bounds.reset(),this.left=null,this.right=null,this.height=0},t.prototype.isLeaf=function(){return!this.left&&!this.right},t}(),Pn=function(){function t(t){void 0===t&&(t=new G(B,B,O,O)),this.worldBounds=t,this.root=null,this.nodes=new Map,this.tempBounds=new G,this.nodePool=new a((function(){return new Tn})),this.nodePool.addCapacity(1e4)}return t.prototype.insertNode=function(t){if(null===this.root)return this.root=t,void(this.root.parent=null);for(var e=t.bounds,i=this.root;!i.isLeaf();){var n=i.left,o=i.right,r=i.bounds.perimeter(),s=this.tempBounds.combine2(i.bounds,e).perimeter(),a=2*s,h=2*(s-r),c=0,u=this.tempBounds.combine2(e,n.bounds).perimeter();c=n.isLeaf()?u+h:u-n.bounds.perimeter()+h;var p=0,l=this.tempBounds.combine2(e,o.bounds).perimeter();if(p=o.isLeaf()?l+h:l-o.bounds.perimeter()+h,a<c&&a<p)break;i=c<p?n:o}var d=i.parent,f=this.nodePool.reserve();f.reset(d),f.bounds.combine2(e,i.bounds),f.height=i.height+1,null!==d?(d.left===i?d.left=f:d.right=f,f.left=i,f.right=t,i.parent=f,t.parent=f):(f.left=i,f.right=t,i.parent=f,t.parent=f,this.root=f);for(var y=t.parent;y;){if(!(y=this.balanceNode(y)).left)throw new Error("Parent of current leaf cannot have a null left child"+y);if(!y.right)throw new Error("Parent of current leaf cannot have a null right child"+y);y.height=1+Math.max(y.left.height,y.right.height),y.bounds.combine2(y.left.bounds,y.right.bounds),y=y.parent}},t.prototype.removeNode=function(t){if(t!==this.root){var e,i=t.parent,n=i.parent;if(e=i.left===t?i.right:i.left,n){n.left===i?n.left=e:n.right=e,e.parent=n,this.nodePool.free(i);for(var o=n;o;)(o=this.balanceNode(o)).bounds.combine2(o.left.bounds,o.right.bounds),o.height=1+Math.max(o.left.height,o.right.height),o=o.parent}else this.root=e,e.parent=null,this.nodePool.free(i)}else this.root=null},t.prototype.trackBody=function(t){var e=this.nodePool.reserve();e.reset(),e.body=t,e.bounds.copyAABB(t.aabb),e.bounds.expand(2),this.nodes.set(t.id,e),this.insertNode(e)},t.prototype.updateBody=function(t){var e=this.nodes.get(t.id);if(!e)return!1;this.tempBounds.copyAABB(t.aabb);var i=t.body.delta.x,n=t.body.delta.y;return i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,n<0?this.tempBounds.t+=n:this.tempBounds.b+=n,!e.bounds.contains(this.tempBounds)&&(this.removeNode(e),this.tempBounds.l-=5,this.tempBounds.t-=5,this.tempBounds.r+=5,this.tempBounds.b+=5,i=3*t.body.delta.x,n=3*t.body.delta.y,i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,n<0?this.tempBounds.t+=n:this.tempBounds.b+=n,e.bounds.copy(this.tempBounds),this.insertNode(e),!0)},t.prototype.untrackBody=function(t){var e=this.nodes.get(t.id);e&&(this.removeNode(e),this.nodePool.free(e),this.nodes.delete(t.id))},t.prototype.balanceNode=function(t){if(t.isLeaf()||t.height<2)return t;var e=t.left,i=t.right,n=t,o=e,r=i,s=e.left,a=e.right,h=i.left,c=i.right,u=r.height-o.height;if(u>1)return r.left=n,r.parent=n.parent,n.parent=r,r.parent?r.parent.left===n?r.parent.left=r:r.parent.right=r:this.root=r,h.height>c.height?(r.right=h,n.right=c,c.parent=n,n.bounds.combine2(o.bounds,c.bounds),r.bounds.combine2(n.bounds,h.bounds),n.height=1+Math.max(o.height,c.height),r.height=1+Math.max(n.height,h.height)):(r.right=c,n.right=h,h.parent=n,n.bounds.combine2(o.bounds,h.bounds),r.bounds.combine2(n.bounds,c.bounds),n.height=1+Math.max(o.height,h.height),r.height=1+Math.max(n.height,c.height)),r;if(u<-1){if(o.left=n,o.parent=n.parent,n.parent=o,o.parent)if(o.parent.left===n)o.parent.left=o;else{if(o.parent.right!==n)throw"Error rotating Dynamic Tree";o.parent.right=o}else this.root=o;return s.height>a.height?(o.right=s,n.left=a,a.parent=n,n.bounds.combine2(r.bounds,a.bounds),o.bounds.combine2(n.bounds,s.bounds),n.height=1+Math.max(r.height,a.height),o.height=1+Math.max(n.height,s.height)):(o.right=a,n.left=s,s.parent=n,n.bounds.combine2(r.bounds,s.bounds),o.bounds.combine2(n.bounds,a.bounds),n.height=1+Math.max(r.height,s.height),o.height=1+Math.max(n.height,a.height)),o}return t},t.prototype.getHeight=function(){return null===this.root?0:this.root.height},t.prototype.query=function(e){var i=this.nodes.get(e.id).bounds;t.queryHelper(e,i,this.root)},t.queryHelper=function(e,i,n){var o=1;for(t.stack[0]=n;o>0;){var r=t.stack[--o];r.bounds.intersect(i)&&(r.isLeaf()?r.body!==e&&Et(e,r.body):(t.stack[o++]=r.left,t.stack[o++]=r.right))}return!1},t.queryHelper2=function(e,i,n){return!(!n||!n.bounds.intersect(i))&&(n.isLeaf()&&n.body!==e?(Et(e,n.body),!1):t.queryHelper(e,i,n.left)||t.queryHelper(e,i,n.right))},t.prototype.rayCastQuery=function(t,e,i){void 0===e&&(e=O);var n=function(e){if(e&&function(t,e){return!!Pt(e.aabb.position,e.aabb.extents,t.origin,t.delta,0,0,wt)&&(t.report(wt.delta.x,wt.delta.y,wt.normal.x,wt.normal.y,e),!0)}(t,e.body)){if(!e.isLeaf())return n(e.left)||n(e.right);if(i.call(t,e.body))return!0}return!1};n(this.root)},t.prototype.queryArea=function(e,i){t.queryAreaHelper(this.root,e,i)},t.queryAreaHelper=function(e,i,n){var o=1;for(t.stack[0]=e;o>0;){var r=t.stack[--o];r.bounds.intersect(i)&&(r.isLeaf()?n(r.body):(t.stack[o++]=r.left,t.stack[o++]=r.right))}return!1},t.prototype.debugDraw=function(t){var e=function(i){i&&(i.isLeaf()?t.DrawAABB2(i.bounds,"green"):t.DrawAABB2(i.bounds,"white"),i.left&&e(i.left),i.right&&e(i.right))};e(this.root)},t.stack=new Array(100),t}(),Sn=function(){function t(t){this.map=t,this.staticProxies=new Array,this.dynamicProxies=new Array,this.sleepingProxies=new Array,this.tree=new Pn,this.tempArea=new G}return t.prototype.addProxy=function(t){(t.isStatic?this.staticProxies:this.dynamicProxies).push(t),this.tree.trackBody(t)},t.prototype.removeProxy=function(t){var e=t.isStatic?this.staticProxies:this.dynamicProxies;e.splice(e.indexOf(t),1),this.tree.untrackBody(t)},t.prototype.collide=function(){for(var t=this.dynamicProxies.length;--t>=0;){null!=(i=this.dynamicProxies[t]).body&&(i.isSensor||this.map.testCollision(i),i.body.canSleep&&this.sleep(i)),this.tree.updateBody(i)}for(var e=this.dynamicProxies.length;--e>=0;){var i=this.dynamicProxies[e];this.tree.query(i)}},t.prototype.QueryArea=function(t,e,i,n){void 0===i&&(i=!0),void 0===n&&(n=!0),this.tempArea.copyAABB(t),this.tree.queryArea(this.tempArea,e)},t.prototype.CastRay=function(t,e,i,n){void 0===i&&(i=!0),void 0===n&&(n=!0),this.map.castRay(t)},t.prototype.wake=function(t){},t.prototype.sleep=function(t){},t}(),Rn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ln=function(t){function e(e){var i=t.call(this,[P,En,jt])||this;return i.particleEngine=e,i}return Rn(e,t),e.prototype.updateEntity=function(t,e,i,n){var r=1e6,s=n.body,a=0;if(null!=this.scaredOfPosition&&(r=s.position.distSqrd(this.scaredOfPosition.coords),a=s.position.x-this.scaredOfPosition.coords.x<0?-1:1),r<4096)Ge(.1)&&(s.addForce(new o(5e3*a,-8e3)),this.particleEngine.EmitParticle(s.position.x,s.position.y,-10*a,-100,0,5,800,1,!1,!0,null,4,255,255,255,255));else if(Ge(.005)){a=Ie(.5);e.direction.x=-a,s.addForce(new o(5e3*a,-8e3)),this.particleEngine.EmitParticle(s.position.x,s.position.y,-20*a,-100,0,5,800,1,!1,!0,null,4,255,255,255,255)}},e.prototype.scaredOf=function(t){var e=this.engine.getComponentForEntity(t,P);e&&(this.scaredOfPosition=e)},e}(T),Fn=function(){},On=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Bn=function(t){function e(){return t.call(this,[P,Mt,Fn])||this}return On(e,t),e.prototype.preUpdate=function(){if(!E.debug)return!1},e.prototype.updateEntity=function(t,e,i,n){E.debugRender.DrawCross(e.coords.x,e.coords.y,15)},e}(T),Mn=function(t){this.intervalDelay=new Xi(t)},Wn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Gn=function(t){function e(){return t.call(this,[Mn,P])||this}return Wn(e,t),e.prototype.updateEntity=function(t,e,i){if(e.intervalDelay.tick(this.dt)){var n=He.SearchSortAndFilter(i.coords,300,t,ze.ENEMY).entities;n.length>0&&this.fireBulletAtEntity(i,n[0].entity)}},e.prototype.fireBulletAtEntity=function(t,e){this.fireBullet(t.coords.clone(),this.engine.getComponentForEntity(e,P).coords.clone())},e.prototype.fireBullet=function(t,e){var i=new xt;i.groupIndex=Oe.TURRET_GROUP;Je.create(this.engine,new P(t.x,t.y),i,e)},e}(T),In=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Dn=function(t){function e(){var e=t.call(this)||this;return e.id="Camera",e.realPosition=new o,e.viewportSize=new o,e.halfViewportSize=new o,e.shake=new o,e.viewPortAABB=new G,e.worldExtentsAABB=new G,e}return In(e,t),e.prototype.rf=function(t){return t},e.prototype.Focus=function(t,e){this.realPosition.x=t,this.realPosition.y=e,this.cameraExtentsAABB.fitPoint(this.realPosition);var i=-this.realPosition.x+this.halfViewportSize.x,n=-this.realPosition.y+this.halfViewportSize.y;Math.abs(i-this.position.x)>2&&(this.position.x=this.position.x+.1*(i-this.position.x)),Math.abs(n-this.position.y)>2&&(this.position.y=this.position.y+.1*(n-this.position.y)),this.position.plusEquals(this.shake),this.position.x=this.rf(this.position.x),this.position.y=this.rf(this.position.y),this.shake.setTo(0,0)},e.prototype.Resize=function(t,e){this.viewportSize.x=t,this.viewportSize.y=e,this.halfViewportSize.x=t/2,this.halfViewportSize.y=e/2,this.viewPortAABB.l=this.viewPortAABB.t=0,this.viewPortAABB.r=this.viewportSize.x,this.viewPortAABB.b=this.viewportSize.y,this.cameraExtentsAABB=this.worldExtentsAABB.clone(),this.cameraExtentsAABB.expand2(t,e)},e}(D),zn=function(){},Un=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),kn=function(t){function e(e){var i=t.call(this,[Gt,Mt,mi,$t])||this;return i.holderFilterCategory=e,i.callback=i.callback.bind(i),i}return Un(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o){e.proxy.contactCallbacks.push(this.callback),e.proxy.filter.maskBits|=this.holderFilterCategory},e.prototype.updateAllEntities=function(){},e.prototype.callback=function(t,e,i){var n=this.engine.getComponentForEntity(t.entity,mi);1==n.activate&&this.hold(n,e.entity,t.entity)},e.prototype.hold=function(t,e,i){if(null==t.heldItem&&null==this.engine.getComponentForEntity(e,gi)){var n=new gi(i);this.engine.addComponentsToEntity(e,[n]),t.heldItem=e}},e}(T),Nn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),jn=function(t){function e(e){var i=t.call(this,[Gt,Mt,zn])||this;return i.holderFilterCategory=e,i}return Nn(e,t),e.prototype.onEntityAdded=function(t,e,i,n){e.proxy.filter.categoryBits|=this.holderFilterCategory},e.prototype.updateAllEntities=function(){},e}(T),Vn=function(){},qn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Hn=function(t){function e(){return t.call(this,[P,zn,gi,jt,$t])||this}return qn(e,t),e.prototype.onEntityAdded=function(t,e,i,n,o,r){var s=o.body;s.velocity.setTo(0,0),s.skip=!0;var a=this.engine.getComponentForEntity(n.holder,P).coords;if(e.coords.copy(a),o.body.position.copy(a),null==this.engine.getComponentForEntity(t,Vn)){var h=this.engine.getComponentForEntity(n.holder,mi),c=this.engine.getComponentForEntity(h.parent,jt).body;null!=c&&c.setMass(c.mass+s.mass)}},e.prototype.onEntityRemoved=function(t,e,i,n,o,r){this.drop(n.holder);var s=o.body;if(s.skip=!1,s.velocity.setTo(0,0),null==this.engine.getComponentForEntity(t,Vn)){var a=this.engine.getComponentForEntity(n.holder,mi),h=this.engine.getComponentForEntity(a.parent,jt).body;null!=h&&h.setMass(h.mass-s.mass)}},e.prototype.updateEntity=function(t,e,i,n,o,r){var s=n.holder,a=this.engine.getComponentForEntity(s,P),h=o.body;h.setStaticPosition(a.coords.x+4*a.direction.x,a.coords.y),e.update(h.position)},e.prototype.drop=function(t){if(null!=t){var e=t;return this.engine.removeComponentsFromEntityByType(t,[gi]),t=null,e}return null},e}(T),Xn=function(){function t(){this.systems=[]}return t.prototype.addSystem=function(t){this.engine.addPhaseSystemToEngine(t),this.systems.push(t)},t.prototype.updatePhase=function(t,e){for(var i=0,n=this.systems;i<n.length;i++){n[i].updateSystem(t,e)}},t}(),Yn=function(t){this.teleportPosition=t},Jn=function(){function t(t,e,i,n){this.velocity=e,this.interval=t,this.ttl=i,this.jitter=n,this.lastTime=0}return t.prototype.update=function(t,e,i,n){if(!(t-this.lastTime<this.interval)){this.lastTime=t;for(var o=e(Mt).halfWidths,r=0;r<16;r++)n.EmitParticle(i.x-16+2*r,i.y-o.y,0,this.velocity+De(-this.jitter,this.jitter),0,0,this.ttl,.99,!0,!0,null,4,255,255,255,255)}},t}(),Kn=function(){function t(){}return t.create=function(e,i,n){var r=e.createEntity();return(new xt).groupIndex=Oe.SOLID_OBJECT_GROUP,e.addComponentsToEntity(r,[i,n,new Gt(!0,null,[]),new It,new pn("door",!1,""),new Yn(new o(192,576)),new Ee(t.states,"on",!0),new ln("telporterA",["on","off"]),new $t,new pe([new Jn(200,100,600,10)])]),r},t.mapping="teleporter",t.states={on:function(t,e){t.getComponentForEntity(e,Gt).proxy.isActive=!0,t.addComponentsToEntity(e,[])},off:function(t,e){t.getComponentForEntity(e,Gt).proxy.isActive=!0,t.removeComponentsFromEntityByType(e,[pe])}},t}(),Zn=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Qn=function(t){function e(){var e=t.call(this,[Gt,Yn])||this;return e.onCollision=e.onCollision.bind(e),e}return Zn(e,t),e.prototype.onEntityAdded=function(t,e,i,n){e.proxy.contactCallbacks.push(this.onCollision)},e.prototype.onCollision=function(t,e,i){Ge(.1)&&e.body.position.copy(this.engine.getComponentForEntity(t.entity,Yn).teleportPosition)},e}(T),$n=function(t){this.volume=t},to=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),eo=function(t){function e(){return t.call(this,[P,wi,xi])||this}return to(e,t),e.prototype.updateEntity=function(t,e,i,n){e.prevCoords.copy(e.coords);var o=this.engine.getComponentForEntity(n.parent,P);e.coords.x=o.coords.x+i.point.x*o.direction.x,e.coords.y=o.coords.y+i.point.y*o.direction.y},e}(T),io=function(){this.contact=new bt},no=function(){function t(){this.contacts=new Map,this.contactPairPool=new a((function(t){return new io})),this.stamp=0,this.contactPairPool.addCapacity(5e3)}return t.prototype.UpdateContacts=function(t,e,i){var n=Wt.HashBodyIDs(t.id,e.id),o=this.contacts.get(n);null!=o?(o.stamp<this.stamp&&(o.contactCount=0,o.stamp=this.stamp),o.contactCount++):((o=this.contactPairPool.reserve()).hash=n,o.stamp=this.stamp,o.contactCount=1,o.startContact=!0,o.endContact=!1,o.proxyA=t,o.proxyB=e,this.contacts.set(n,o)),o.contact.setTo(i)},t.prototype.ProcessContacts=function(){for(var t=0,e=this.contacts.values();t<e.length;t++){var i=e[t];i.stamp<this.stamp&&(i.endContact=!0),i.proxyA.collide(i.proxyB,i.contact),i.proxyB.collide(i.proxyA,i.contact),i.startContact=!1,i.endContact&&(this.contacts.delete(i.hash),this.contactPairPool.free(i)),this.stamp++}},t}(),oo=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ro=function(t){function e(e){var i=t.call(this,[P,$t,Ye])||this;return i.spriteParticleEngine=e,i}return oo(e,t),e.prototype.updateEntity=function(t,e,i,n){for(var o=0,r=n.emitters;o<r.length;o++){r[o].update(this.timestamp,this.engine.c4e.get(t),e.coords,this.spriteParticleEngine)}},e.prototype.postUpdate=function(){this.spriteParticleEngine.Update()},e}(T),so=function(){function t(){}return t.prototype.construcor=function(){},t.prototype.Initalize=function(t,e,i,n,o,r,s,a,h,c,u,p,l,d,f,y){this.pX=this.plX=t,this.pY=this.plY=e,this.vX=i,this.vY=n,this.fX=o,this.fY=r,this.ttl=p.ttl(),this.age=0,this.damping=a,this.decay=h,this.externalForce=u,this.sequence=p,this.currentFrame=0,this.currentInc=0,this.msPerInc=this.ttl/p.len,this.size=l,this.flipX=d,this.flipY=f,this.colour=0},t.prototype.Update=function(t,e){return this.vX+=this.fX+this.externalForce.x,this.vY+=this.fY+this.externalForce.y,this.vX*=this.damping,this.vY*=this.damping,this.pX+=this.vX*e,this.pY+=this.vY*e,this.age+=t,this.alpha=1,this.currentInc+=t,this.currentInc>=this.msPerInc&&(this.currentFrame++,this.currentInc=0),this.age<this.ttl},t.INV_ALPHA=1/255,t}(),ao=function(){function t(t){this.maxSprites=t}return t.prototype.Init=function(t,e){this.gl=t,this.camera=e,this.projection=new o,this.pointSpriteShader=new it(this.gl,et(t," precision mediump float;\nuniform vec2 projectionVector;\n// uniform vec2 flip;\n\nattribute vec2 position;\nattribute float size;\nattribute vec2 tilePosition;\nattribute vec2 tileDimension;\nattribute vec2 colour;\nvarying vec2 vTilePos;\nvarying vec2 tileDim;\n// varying vec2 vColor;\nvoid main() {\n    vTilePos = tilePosition;\n    tileDim = tileDimension;\n    gl_PointSize = size;\n    // vColor = colour;\n    gl_Position = vec4( position.x / projectionVector.x -1.0, position.y / -projectionVector.y + 1.0 , 0.0, 1.0);            \n}","precision mediump float;\nuniform sampler2D texture;\n// uniform vec2 flip;\nvarying vec2 vTilePos;\nvarying vec2 tileDim;\n// varying vec2 vColor;\nvoid main() {\n    vec2 uv = vec2( gl_PointCoord.x*tileDim.x + vTilePos.x, gl_PointCoord.y*tileDim.y + vTilePos.y );\n    \n    //Latest\n    //vec2 uv = vec2( ((-1.0+(2.0*vColor.x))*(vColor.x-gl_PointCoord.x)*tileDim.x) + vTilePos.x, ((-1.0+(2.0*vColor.y))*(vColor.y-gl_PointCoord.y)*tileDim.y) + vTilePos.y);\n    \n    //vec2 uv = vec2( gl_PointCoord.x*tileDim.x + vTilePos.x, gl_PointCoord.y*tileDim.y + vTilePos.y); //Works no rotation\n    // vec2 uv = vec2( gl_PointCoord.x*invTexTilesWide + invTexTilesWide*vTilePos.x, gl_PointCoord.y*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    //vec2 uv = vec2( (-1.0*(0.0-gl_PointCoord.x))*invTexTilesWide + invTexTilesWide*vTilePos.x, (gl_PointCoord.y)*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    // vec2 uv = vec2( ((-1.0+(2.0*flip.x))*(flip.x-gl_PointCoord.x))*invTexTilesWide + invTexTilesWide*vTilePos.x, ((-1.0+(2.0*flip.y))*(flip.y-gl_PointCoord.y))*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    gl_FragColor = texture2D( texture, uv );\n}")),this.dataBuffer=t.createBuffer(),this.arrayBuffer=new ArrayBuffer(80*this.maxSprites),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),t.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),t.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.ResetBatch()},t.prototype.SetSpriteSheet=function(t,e,i,n){this.texture=t,this.tileSize=e,this.texTilesWide=i,this.texTilesHigh=n,this.invTexTilesWide=1/this.texTilesWide,this.invTexTilesHigh=1/this.texTilesHigh},t.prototype.Resize=function(t,e){this.projection.x=t/2,this.projection.y=e/2},t.prototype.AddStage=function(t){this.stage=t},t.prototype.ResetBatch=function(){this.indexRun=0},t.prototype.AddSpriteToBatch=function(t,e,i,n,o,r,s,a,h,c,u){var p=7*this.indexRun;this.data[p+0]=Math.floor(o+this.camera.position.x),this.data[p+1]=Math.floor(r+this.camera.position.y),this.data[p+2]=s,this.data[p+3]=t+i*Math.min(h,0)*-1,this.data[p+4]=e+n*Math.min(c,0)*-1,this.data[p+5]=i*h,this.data[p+6]=n*c,this.indexRun++},t.prototype.Render=function(t){0!=this.indexRun&&(this.gl.enable(WebGLRenderingContext.BLEND),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.pointSpriteShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.position),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.size),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.tilePosition),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.tileDimension),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,28,0),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.size,1,WebGLRenderingContext.FLOAT,!1,28,8),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.tilePosition,2,WebGLRenderingContext.FLOAT,!1,28,12),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.tileDimension,2,WebGLRenderingContext.FLOAT,!1,28,20),this.gl.uniform2f(this.pointSpriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture),this.gl.drawArrays(WebGLRenderingContext.POINTS,0,this.indexRun))},t}(),ho=function(){function t(t,e,i,n){this.particleCount=t,this.deltaTime=e,this.invDeltaTime=e/1e3,this.map=i,this.spriteParticleManager=n,this.ZERO_FORCE=new o,this.activeParticles=new Array,this.activeParticles[0]=new Array(this.particleCount),this.activeParticles[1]=new Array(this.particleCount),this.cachedParticles=new Array(this.particleCount);for(var r=0;r<t;r++)this.cachedParticles[r]=new so;this.availableParticleCount=this.particleCount,this.activeParticlesCount=0,this.activePool=0,this.renderer=new ao(t)}return t.prototype.EmitParticle=function(t,e,i,n,o,r,s,a,h,c,u,p,l,d,f,y){if(0==this.availableParticleCount)return!1;var g=this.cachedParticles[--this.availableParticleCount];return this.activeParticles[this.activePool][this.activeParticlesCount++]=g,g.Initalize(t,e,i,n,o,r,s,a,h?this.deltaTime/s:0,c,null!=u?u:this.ZERO_FORCE,this.spriteParticleManager.sequencesList[p],l,d,f,y),!0},t.prototype.Update=function(){this.renderer.ResetBatch();for(var t=this.activeParticles[this.activePool],e=this.activeParticles[1===this.activePool?0:1],i=0,n=0;n<this.activeParticlesCount;n++){var o=t[n];if(o.Update(this.deltaTime,this.invDeltaTime)){if(1==(1&this.map.getReal(o.pX,o.pY,0))){var r=this.map.Index(o.plX),s=this.map.Index(o.plY),a=this.map.Index(o.pX),h=this.map.Index(o.pY);a!=r&&(o.vX*=-.99,o.pX=o.plX),h!=s&&(o.vY*=-.99,o.pY=o.plY)}var c=o.sequence.sequence[Math.min(o.currentFrame,o.sequence.len-1)];this.renderer.AddSpriteToBatch(c.x,c.y,c.width,c.height,o.pX,o.pY,o.size,1,o.flipX,o.flipY,0),e[i++]=o}else this.cachedParticles[this.availableParticleCount++]=o}this.activeParticlesCount=i,this.activePool=1===this.activePool?0:1},t}(),co=function(){function t(t,e,i,n){this.id=t,this.name=e,this.sequence=i,this.fps=n,this.len=i.length}return t.prototype.ttl=function(){return this.sequence.length/this.fps*1e3},t}(),uo=function(){function t(){this.count=0,this.frames=new Map,this.sequences=new Map,this.sequencesList=new Array}return t.prototype.ParseSequenceJSON=function(t){var e=this;"string"==typeof t&&(t=JSON.parse(t),Object.keys(t).forEach((function(i){var n=t[i],o=e.fromParticleSequencePattern(i,n);e.sequences.set(i,o),e.sequencesList[o.id]=o})))},t.prototype.ParseTexturePackerJSON=function(t){var e=this;if("string"==typeof t){var i=(t=JSON.parse(t)).meta.size.w,n=t.meta.size.h;Object.keys(t.frames).forEach((function(o){var r=t.frames[o],s=new j(r.frame.x/i,r.frame.y/n,r.frame.w/i,r.frame.h/n);e.frames.set(o,s)}))}},t.prototype.fromParticleSequencePattern=function(t,e){for(var i=new Array,n=e.start;n<=e.end;n++){var o=this.frames.get(e.pattern.replace("{x}",n+""));i.push(o)}return new co(this.count++,t,i,e.fps)},t}(),po=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),lo="data/16map.json",fo="data/sprites.json",yo="data/sprites.png",go="data/frames.json",mo="data/particles.png",vo="data/particles.json",bo="data/particleFrames.json",xo="data/tileFrames.json",wo="data/superSet.png";new(function(t){function e(){var e=this,i=document.getElementById("view");return(e=t.call(this,i)||this).loadAssets([fo,yo,go,lo,wo,xo,mo,bo,vo]),e}return po(e,t),e.prototype.initalize=function(){this.engine.addCapacityToEngine(1e3);var t=JSON.parse(this.assets.assets.get(lo)),e=new G(0,E.tileSize*t.width,E.tileSize*t.height,0);e.expand(-E.tileSize);var i=new Dn;i.worldExtentsAABB=e;var n=document.getElementById("viewDebug");E.debuggingRender=new C(n,i,E.resolution);var o,r,s,a=function(t,e,i){for(var n=new st(t.width,t.height,i,1),o=0;o<t.width;o++)for(var r=0;r<t.height;r++){var s=t.get(o,r,0);if(s>0){var a=s-e;n.set(o,r,0,1<<a)}else n.set(o,r,0,0)}for(var h=0;h<30;h++)for(var c=0;c<30;c++)n.get(c,h,0)?"X":"0";return n}(ht(ct(t,"Collision")),(o=t,r="Collision",s=o.tilesets.filter((function(t){return t.name===r})),1===s.length?s[0]:null).firstgid,E.tileSize);this.renderSystem=new $(this.canvas,i,E.resolution),this.renderSystem.textureManager.AddTexture(yo,this.assets.assets.get(yo)),this.renderSystem.textureManager.AddTexture(wo,this.assets.assets.get(wo)),this.renderSystem.textureManager.AddTexture(mo,this.assets.assets.get(mo)),this.renderSystem.textureManager.ParseTexturePackerJSON(this.assets.assets.get(fo),yo),this.renderSystem.frameListManager.ParseFrameListJSON(this.assets.assets.get(go));var h=new Bt(a),c=new uo;c.ParseTexturePackerJSON(this.assets.assets.get(vo)),c.ParseSequenceJSON(this.assets.assets.get(bo));var u=new ue(4e3,1e3/60,a),p=new ho(4e3,1e3/60,a,c);p.renderer.SetSpriteSheet(this.renderSystem.textureManager.baseTextures.get(mo).texture,16,16,16),setInterval((function(){p.EmitParticle(De(650,750),De(50,150),0,0,0,0,1e3,.9,!0,!0,null,De(0,3),De(16,32),Ie(.5),Ie(.5),0)}),16);var l=new Sn(h);He.setup(this.engine,l);var d=new gn;window.mb=d;var f=new Xn;this.engine.addPhase(f),f.addSystem(new Xt),f.addSystem(new zt(l)),f.addSystem(new Nt(l)),f.addSystem(new ee),f.addSystem(new qt(l,new no)),f.addSystem(new Jt),f.addSystem(new eo),f.addSystem(new Hn),f.addSystem(new Ai(this.input,u)),f.addSystem(new Ni(h)),f.addSystem(new oe(this.input)),f.addSystem(new de(u)),f.addSystem(new ro(p)),this.fixedViewManagementSystem=new we(i),f.addSystem(this.fixedViewManagementSystem),f.addSystem(new Ae),f.addSystem(new Se),f.addSystem(new Fe),f.addSystem(new Ri),f.addSystem(new Hi),f.addSystem(new en),f.addSystem(new on(He.bfAreaQuery));var y=new Ln(u);f.addSystem(y),f.addSystem(new Gn),f.addSystem(new an(u)),f.addSystem(new cn(u,16)),f.addSystem(new yn),f.addSystem(new vn(d)),f.addSystem(new kn(Oe.HOLDABLE_CAT)),f.addSystem(new jn(Oe.HOLDABLE_CAT)),f.addSystem(new Qn),f.addSystem(new Ze);var g=new Xn;this.engine.addPhase(g),g.addSystem(new mt(this.renderSystem.frameListManager));var m=ut(ht(ct(t,"Background"))),v=ut(ht(ct(t,"Foreground1"))),b=ut(ht(ct(t,"Foreground2"))),x=new dt(8,2);x.SetTileRenderLayer("bg",["Background","Foreground1"]),x.SetTileRenderLayer("fg",["Foreground2"]),this.renderSystem.renderer.AddRenderer(x),x.SetTileLayerFromData(b,this.renderSystem.textureManager.baseTextures.get(wo),"Foreground2",1,1);var w=x.SetTileLayerFromData(v,this.renderSystem.textureManager.baseTextures.get(wo),"Foreground1",1,1);x.SetTileLayerFromData(m,this.renderSystem.textureManager.baseTextures.get(wo),"Background",1,1);var _=new Ui(h,w);this.renderSystem.renderer.AddRenderer(_.renderer),g.addSystem(_),g.addSystem(new ae(this.assets.assets.get(xo),x,h));var A=new ot;A.AddStage(this.renderSystem.stage),this.renderSystem.renderer.AddRenderer(A),this.renderSystem.itemContainer.addChild(x.renderLayersMap.get("bg").sprite),this.renderSystem.camera.addChild(x.renderLayersMap.get("fg").sprite),this.renderSystem.camera.addChild(_.renderer.sprite),g.addSystem(this.renderSystem);var T=new Bn;g.addSystem(T),this.renderSystem.renderer.AddRenderer(u.renderer),this.renderSystem.renderer.AddRenderer(p.renderer);var R=this.mapPosition(33.5,38.5),L=$e.create(this.engine,R);y.scaredOf(L),this.renderSystem.cameraTarget=R.coords;for(var F=0,O=0,B=null,M=0;M<1;M++){var W=this.engine.createEntity();null==B&&(B=W),(F+=20)>700&&(F=0,O+=20);var I=new Qt(Kt.NORMAL);I.setBounces(3),I.maxScalarVelocity=1e3,this.engine.addComponentsToEntity(W,[new P(100+F,200+O),new Mt(12,12),new S("chicken"),new ft("chicken","walk"),new Gt(!1,new xt,[]),new jt(I,!0),new Ut,new $t,new ve,new Fn])}var D=new Map;D.set(Wi.mapping,Wi.createTMXEntity),D.set(un.mapping,un.createTMXEntity),D.set(dn.mapping,dn.createTMXEntity),function(t,e,i){e.objects.forEach((function(e){var n=i.get(e.type);n&&n(t,e)}))}(this.engine,ct(t,"Objects"),D),Kn.create(this.engine,this.mapPosition(3,23),new Mt(16,32));var z,U,k,N=this.engine.createEntity();this.engine.addComponentsToEntity(N,[this.mapPosition(10.5,18.5),new Mt(8,8),new Gt(!1,new xt,[(z=function(){d.trigger("doorA",{})},U=1e3,k=0,function(){var t=Date.now();t-k>U&&(k=t,z.apply(void 0,arguments))})]),new It,new $t,new re("switchOff")]);var j=this.engine.createEntity();this.engine.addComponentsToEntity(j,[new be("BeeHive"),this.mapPosition(20.5,17),new Mt(16,16),new S("insects","hive"),new Gt(!1,null,[]),new It,new $t,new Vi(5)]),this.engine.addComponentsToEntity(this.engine.createEntity(),[this.mapPosition(164,182),new be("torch1"),new Mt(160,160),new S("torch"),new ft("torch","burn"),new Ci(160,1,1,1,255,255,255,0),new It]),this.engine.addComponentsToEntity(this.engine.createEntity(),[this.mapPosition(184,187),new be("torch2"),new Mt(160,160),new S("torch"),new ft("torch","burn"),new Ci(160,1,1,1,255,255,255,0),new It]),this.engine.addComponentsToEntity(this.engine.createEntity(),[this.mapPosition(175,68),new be("torch3"),new Mt(160,160),new S("torch"),new ft("torch","burn"),new Ci(160,1,1,1,255,255,255,0),new It]),this.engine.addComponentsToEntity(this.engine.createEntity(),[this.mapPosition(134,164),new be("torch4"),new Mt(160,160),new S("torch"),new ft("torch","burn"),new Ci(160,1,1,1,255,255,255,0),new It]);var V=this.engine.createEntity();this.engine.addComponentsToEntity(V,[this.mapPosition(34,30),new Mt(7,7),new It,new Yi(1),new $t]);var q=this.engine.createEntity(),H=new xt;H.groupIndex=Oe.TURRET_GROUP,this.engine.addComponentsToEntity(q,[this.mapPosition(90,46.5),new re("turret"),new Mt(12,12),new Gt(!1,H,[]),new It,new Mn(1e3),new $t]);var X=this.engine.createEntity();this.engine.addComponentsToEntity(X,[this.mapPosition(13,4),new Mt(7,7),new S("items","rock"),new Gt(!1,new xt,[]),new Ut,new jt(new Qt(Kt.ROCK),!0),new zn,new $t]);var Y=this.engine.createEntity();this.engine.addComponentsToEntity(Y,[this.mapPosition(23,46),new Mt(6,14),new S("items","water_container"),new Gt(!1,new xt,[]),new Ut,new jt(new Qt(Kt.NORMAL),!0),new zn,new $n(10),new $t]),this.loop.start(),An(this.engine)},e.prototype.mapPosition=function(t,e){return new P(t*E.tileSize,e*E.tileSize)},e.prototype.fireBullet=function(t,e){var i=new xt;i.groupIndex=Oe.TURRET_GROUP,Je.create(this.engine,new P(t.x,t.y),i,e)},e.prototype.preUpdate=function(){E.debugRender.Clear(),this.input.Update(-this.renderSystem.camera.position.x,-this.renderSystem.camera.position.y)},e.prototype.postUpdate=function(){E.debug&&this.fixedViewManagementSystem.spaceManager.debugDraw()},e}(_))}]);