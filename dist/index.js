!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);const s="_id_";class n{constructor(t){this.pool=[],this.factory=t,this.nextAvailableIndex=-1,this.totalAllocationCount=0}addCapacity(t){this.pool=[...o(this.pool.length,t,this.factory),...this.pool],this.nextAvailableIndex+=t}reserve(){0==this.nextAvailableIndex&&this.addCapacity(this.totalAllocationCount);const t=this.pool[this.nextAvailableIndex];return this.pool[this.nextAvailableIndex]=null,this.nextAvailableIndex--,this.totalAllocationCount++,t}free(t){this.nextAvailableIndex++,this.pool[this.nextAvailableIndex]=t}get capacity(){return this.pool.length}get assigned(){return this.pool.length-this.nextAvailableIndex}get totalAllocations(){return this.totalAllocationCount}}const r=(t,e)=>e-t,o=(t,e,i)=>(t=>Array(t).fill(null))(e).map((e,s)=>i(t+s)).sort(r);class a{constructor(t){this.reset(t)}get(t){const e=t%32,i=(t-e)/32;return!!(this.values[i]&1<<e)}set(t,e){const i=t%32,s=(t-i)/32;e?this.values[s]|=1<<i:this.values[s]&=~(1<<i)}maskAll(t){for(var e=0;e<this.size;e++){const i=t.values[e];if((i&this.values[e])!==i)return!1}return!0}maskNone(t){for(var e=0;e<this.size;e++){if(t.values[e]&this.values[e])return!1}return!0}not(){for(var t=0;t<this.size;t++)this.values[t]=~this.values[t]}and(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]&t.values[e]}or(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]|t.values[e]}xor(t){for(var e=0;e<this.size;e++)this.values[e]=this.values[e]^t.values[e]}reset(t){this.size=t,this.values=new Uint32Array(this.size);for(var e=0;e<Math.ceil(this.size/32);e++)this.values[e]=0}}class h{constructor(t,e){this.name=t,this.matchMask=e}}class l{constructor(){this.components=new Map,this.componentTypes=new Map,this.phases=new Array,this.systems=new Array,this.c4e=new Map,this.entityPool=new n(t=>t),this.nextTypeId=0,this.metaDataName=this.createComponentEntryFromType(h)}addCapacityToEngine(t){this.entityPool.addCapacity(t),this.components.forEach((t,e)=>this.components.set(e,[...this.components.get(e),...c(this.entityPool.capacity)]))}createEntity(t=""){const e=this.entityPool.reserve();return this.c4e.set(e,d(this,e)),this.components.get(this.metaDataName)[e]=new h(t,new a(4)),e}destroyEntity(t){this.systems.forEach(e=>e.removeEntity(t)),this.clearAllComponentsForEntity(t),this.entityPool.free(t),this.c4e.delete(t)}getComponentForEntity(t,e){const i=e.name;return this.components.has(i)?this.components.get(i)[t]:null}addComponentsToEntity(t,e){const i=this.components.get(this.metaDataName)[t];for(const s of e){const e=this.createComponentEntryFromInstance(s);this.components.get(e)[t]=s,i.matchMask.set(this.componentTypes.get(e),!0)}this.matchEntityBitMask(t,i.matchMask)}removeComponentsFromEntityByType(t,e){const i=this.components.get(this.metaDataName)[t];for(const s of e){const e=s.name;this.components.has(e)&&(this.components.get(e)[t]=null),i.matchMask.set(this.componentTypes.get(e),!1)}this.matchEntityBitMask(t,i.matchMask)}addPhase(t){t.engine=this,this.phases.push(t)}addPhaseSystemToEngine(t){this.systems.push(t);const e=new a(4);t.componentTypes.forEach(t=>{const i=this.createComponentEntryFromType(t);e.set(this.componentTypes.get(i),!0)}),t.onAddedToEngine(this,e)}update(t,e){for(const i of this.phases)i.updatePhase(t,e)}query(t){const e=[];for(var i=0;i<this.entityPool.capacity;i++)t.every(t=>null!==this.components.get(t.name)[i])&&e.push(i);return e}snapshot(){return{activeEntities:this.entityPool.assigned,totalEntitiesCreated:this.entityPool.totalAllocations}}createComponentEntryFromType(t){const e=t.name;if(!this.components.has(e)){let i=this.nextTypeId++;i%32==0&&(i=this.nextTypeId++),this.components.set(e,c(this.entityPool.capacity)),this.componentTypes.set(e,i),t.prototype[s]=i,console.log(e+"="+i)}return e}createComponentEntryFromInstance(t){const e=t.constructor.name;if(!this.components.has(e)){const i=this.nextTypeId++;this.components.set(e,c(this.entityPool.capacity)),this.componentTypes.set(e,i),t.constructor.prototype[s]=i}return e}matchEntity(t){for(const i of this.systems){var e=i.componentTypes.length;for(const s of i.componentTypes)this.components.get(s.name)[t]&&e--;0===e?i.addEntity(t,this.entityComponentsForSystem(t,i)):i.removeEntity(t)}}matchEntityBitMask(t,e){for(const i of this.systems)e.maskAll(i.matchMask)?i.addEntity(t,this.entityComponentsForSystem(t,i)):i.removeEntity(t)}entityComponentsForSystem(t,e){return e.componentTypes.map(e=>this.components.get(e.name)[t])}addEntitiesToComponentList(t){this.components.set(t,c(this.entityPool.capacity))}clearAllComponentsForEntity(t){this.components.forEach(e=>e[t]=null)}}const c=t=>Array(t).fill(null),d=(t,e)=>i=>t.getComponentForEntity(e,i);class u{constructor(t,e,i,s,n=0){this.active=!0,this.params=null,this._listener=e,this._isOnce=i,this.context=s,this._signal=t,this.priority=n||0}execute(t){var e,i;return this.active&&this._listener&&(i=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,i),this._isOnce&&this.detach()),e}detach(){return this.isBound()?this._signal.remove(this._listener,this.context):null}isBound(){return!!this._signal&&!!this._listener}isOnce(){return this._isOnce}getListener(){return this._listener}getSignal(){return this._signal}_destroy(){delete this._signal,delete this._listener,delete this.context}toString(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}}class p{constructor(){this._bindings=[],this._prevParams=null,this.memorize=!1,this._shouldPropagate=!0,this.active=!0}validateListener(t,e){if("function"!=typeof t)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))}_registerListener(t,e,i,s){var n,r=this._indexOfListener(t,i);if(-1!==r){if((n=this._bindings[r]).isOnce()!==e)throw new Error("You cannot add"+(e?"":"Once")+"() then add"+(e?"Once":"")+"() the same listener without removing the relationship first.")}else n=new u(this,t,e,i,s),this._addBinding(n);return this.memorize&&this._prevParams&&n.execute(this._prevParams),n}_addBinding(t){var e=this._bindings.length;do{--e}while(this._bindings[e]&&t.priority<=this._bindings[e].priority);this._bindings.splice(e+1,0,t)}_indexOfListener(t,e){for(var i,s=this._bindings.length;s--;)if((i=this._bindings[s]).getListener()===t&&i.context===e)return s;return-1}has(t,e=null){return-1!==this._indexOfListener(t,e)}add(t,e=null,i=0){return this.validateListener(t,"add"),this._registerListener(t,!1,e,i)}addOnce(t,e=null,i=0){return this.validateListener(t,"addOnce"),this._registerListener(t,!0,e,i)}remove(t,e=null){this.validateListener(t,"remove");var i=this._indexOfListener(t,e);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),t}removeAll(){for(var t=this._bindings.length;t--;)this._bindings[t]._destroy();this._bindings.length=0}getNumListeners(){return this._bindings.length}halt(){this._shouldPropagate=!1}dispatch(...t){if(this.active){var e,i=this._bindings.length;if(this.memorize&&(this._prevParams=t),i){e=this._bindings.slice(0),this._shouldPropagate=!0;do{i--}while(e[i]&&this._shouldPropagate&&!1!==e[i].execute(t))}}}forget(){this._prevParams=null}dispose(){this.removeAll(),delete this._bindings,delete this._prevParams}toString(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}}class g{constructor(){this.assets=new Map,this.loaded=new p,this.Reset()}Reset(){this.running=!1,this.loaders=new Array}SetImagesToLoad(t){t.forEach(t=>this.AddAsset(t))}AddAsset(t){if(1!=this.running){var e=this.LoaderFactory(t);e.Init(t),this.loaders.push(e)}}Load(){1!=this.running&&0!=this.loaders.length&&(this.completeCount=this.loaders.length,this.running=!0,this.loaders.forEach(t=>t.Load()))}onLoad(t){this.completeCount--,this.assets.set(t.getKey(),t.getValue()),0==this.completeCount&&(this.loaded.dispatch(),this.running=!1)}LoaderFactory(t){var e=t.substring(t.length-3,t.length);return"png"==e?new m(this):"tmx"==e||"xml"==e||"son"==e?new y(this):null}}class m{constructor(t){this.mgr=t}Init(t){this.url=t,this.image=new Image,this.image.onload=this.onLoad.bind(this),this.image.crossOrigin="anonymous"}Load(){this.image.src=this.url+"?cb="+Date.now(),1==this.image.complete&&this.onLoad(null)}onLoad(t){null!=this.mgr&&this.mgr.onLoad(this)}getKey(){return this.url}getValue(){return this.image}}class y{constructor(t){this.mgr=t}Init(t){this.url=t,this.xhr=new XMLHttpRequest,this.xhr.responseType="text",this.xhr.onload=this.onLoad.bind(this),this.xhr.open("GET",this.url+"?cb="+Date.now(),!0)}Load(){this.xhr.send()}onLoad(t){null!=this.mgr&&this.mgr.onLoad(this)}getKey(){return this.url}getValue(){return this.xhr.response}}const x=1e3/60+1e-8;class b{constructor(){this.isRunning=!1,this.update=this.update.bind(this)}update(t){this.delta=0==this.prevAnimationTime?x:t-this.prevAnimationTime,this.prevAnimationTime=t,null!=this.updateFunc&&this.updateFunc(x,Math.floor(t)),this.rafID=requestAnimationFrame(this.update)}start(){1!=this.isRunning&&(this.isRunning=!0,this.prevAnimationTime=0,this.rafID=requestAnimationFrame(this.update))}stop(){0!=this.isRunning&&(this.isRunning=!1,cancelAnimationFrame(this.rafID))}}var f;!function(t){t.WHITE="white",t.RED="red",t.BLUE="blue"}(f||(f={}));class v{Resize(t){}Clear(){}DrawAABB(t,e){}DrawAABB2(t,e){}DrawCross(t,e,i,s){}DrawLine(t,e,i,s,n){}}class C{constructor(t=0,e=0){this.x=t,this.y=e}setTo(t,e){this.x=t,this.y=e}copy(t){this.x=t.x,this.y=t.y}clone(){return new C(this.x,this.y)}normalize(){var t=Math.sqrt(this.x*this.x+this.y*this.y)+C.ZERO_TOLERANCE;return this.x/=t,this.y/=t,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqrd(){return this.x*this.x+this.y*this.y}clampScalar(t){var e=this.length();e>t&&this.multEquals(t/e)}clampVector(t){this.x=Math.min(Math.max(this.x,-t.x),t.x),this.y=Math.min(Math.max(this.y,-t.y),t.y)}plusEquals(t){this.x+=t.x,this.y+=t.y}minusEquals(t){this.x-=t.x,this.y-=t.y}multEquals(t){this.x*=t,this.y*=t}plusMultEquals(t,e){this.x+=t.x*e,this.y+=t.y*e}minusMultEquals(t,e){this.x-=t.x*e,this.y-=t.y*e}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}leftHandNormal(){return new C(this.y,-this.x)}leftHandNormalEquals(){var t=this.x;this.x=this.y,this.y=-t}rightHandNormal(){return new C(-this.y,this.x)}rightHandNormalEquals(){var t=this.x;this.x=-this.y,this.y=t}reflectEquals(t){var e=this.dot(t);this.x-=2*e*t.x,this.y-=2*e*t.y}interpolate(t,e,i){this.copy(t),this.multEquals(1-i),this.plusMultEquals(e,i)}setAngle(t){var e=this.length();this.x=Math.cos(t)*e,this.y=Math.sin(t)*e}rotateEquals(t){var e=t*(Math.PI/180),i=Math.cos(e),s=Math.sin(e);this.x=i*this.x-s*this.y,this.y=i*this.y+s*this.x}setUnitRotation(t){var e=t*(Math.PI/180);this.x=Math.cos(e),this.y=Math.sin(e)}heading(){return Math.atan2(this.y,this.x)}distSqrd(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i}roundDown(t){return this.x=Math.floor(this.x/t)*t,this.y=Math.floor(this.y/t)*t,this}}C.ZERO_TOLERANCE=1e-8;class w{static get debug(){return w._debug}static set debug(t){w._debug=t,w.debugRender.Clear(),w.debugRender=w._debug?w.debuggingRender:w.nullDebuggingRender}}w.engine=null,w.tileSize=16,w.maxComponentTypes=128,w.resolution=new C(1280,720),w.nullDebuggingRender=new v,w.debuggingRender=new v,w.debugRender=w.nullDebuggingRender,w._debug=!1;class E{constructor(t,e){this.canvas=t,this.input=e,this.loop=new b,this.loop.updateFunc=this.update.bind(this),w.engine=this.engine=new l}loadAssets(t){this.assets=new g,this.assets.loaded.add(this.initalize.bind(this)),this.assets.SetImagesToLoad(t),this.assets.Load()}initalize(){}update(t,e){this.preUpdate(),this.engine.update(t,e),this.postUpdate()}preUpdate(){}postUpdate(){}}class A{constructor(t){this.members=new Map,this.componentTypes=t}onAddedToEngine(t,e){this.engine=t,this.matchMask=e}addEntity(t,e){if(this.members.has(t))return;const i={components:e,boundUpdate:this.updateEntity.bind(this,t,...e)};this.members.set(t,i),this.onEntityAdded(t,...e)}onEntityAdded(t,...e){}removeEntity(t){if(!this.members.has(t))return;const e=this.members.get(t);this.onEntityRemoved(t,...e.components),this.members.delete(t)}onEntityRemoved(t,...e){}updateSystem(t,e){this.dt=t,this.timestamp=e,this.preUpdate()&&(this.updateAllEntities(),this.postUpdate())}preUpdate(){return!0}updateAllEntities(){for(const t of this.members.values())t.boundUpdate()}postUpdate(){}updateEntity(t,...e){}}class T{constructor(t,e,i=1,s=1){this.coords=new C(t,e),this.prevCoords=new C(t,e),this.direction=new C(i,s)}update(t){this.prevCoords.copy(this.coords),this.coords.copy(t)}clone(){var t=new T(this.coords.x,this.coords.y);return t.prevCoords.copy(this.prevCoords),t.direction.copy(this.direction),t}}class S{constructor(t,e=null){this.frameListId=t,this.initialFrameId=e}setFrame(t){this.frame=t,null!=this.sprite&&this.frame.updateSprite(this.sprite)}setFrameId(t){this.frame=this.frameList.getFrame(t)}}function R(){return(t=new Float32Array(9))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t;var t}class P{constructor(){this.position=new C,this.scale=new C(1,1),this.pivot=new C,this._rotationComponents=new C,this.rotation=0,this.alpha=1,this.visible=!0,this.renderable=!1,this.parent=null,this.worldTransform=R(),this.localTransform=R()}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._rotationComponents.x=Math.cos(this._rotation),this._rotationComponents.y=Math.sin(this._rotation)}get visible(){return this._visible}set visible(t){this._visible=t}RoundFunction(t){return t}updateTransform(){}calcExtents(){}}const L=1e-8,F=(Math.PI,Math.PI/180),_=Math.pow(2,31)-1,B=-_;function M(t){return t*F}class W{constructor(t=0,e=0,i=0,s=0){this.l=_,this.t=_,this.r=B,this.b=B,this.t=t,this.r=e,this.b=i,this.l=s}setToSweeptAABB(t,e){this.l=t.position.x-t.extents.x,this.r=t.position.x+t.extents.x,this.t=t.position.y-t.extents.y,this.b=t.position.y+t.extents.y}fromAABB(t){}clone(){return new W(this.t,this.r,this.b,this.l)}reset(){this.t=this.l=_,this.r=this.b=B}get width(){return this.r-this.l}get height(){return this.b-this.t}intersect(t){return this.l<=t.r&&this.r>t.l&&this.t<=t.b&&this.b>=t.t}addAABB(t){t.t<this.t&&(this.t=t.t),t.r>this.r&&(this.r=t.r),t.b>this.b&&(this.b=t.b),t.l<this.l&&(this.l=t.l)}combine(t){const e=this.clone();return e.addAABB(t),e}combine2(t,e){return this.t=Math.min(t.t,e.t),this.r=Math.max(t.r,e.r),this.b=Math.max(t.b,e.b),this.l=Math.min(t.l,e.l),this}addPoint(t,e){t<this.l&&(this.l=t),t>this.r&&(this.r=t),e<this.t&&(this.t=e),e>this.b&&(this.b=e)}fitPoint(t){t.x<this.l&&(t.x=this.l),t.x>this.r&&(t.x=this.r),t.y<this.t&&(t.y=this.t),t.y>this.b&&(t.y=this.b)}expand(t){this.l-=t,this.r+=t,this.t-=t,this.b+=t}expand2(t,e){this.l+=t/2,this.r-=t/2,this.t+=e/2,this.b-=e/2}contains(t){return this.l<=t.l&&this.t<=t.t&&t.b<this.b&&t.r<this.r}copy(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b}copyAABB(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b}transform(t){this.l+=t.x,this.r+=t.x,this.t+=t.y,this.b+=t.y}perimeter(){return 2*(this.width+this.height)}}class G extends P{constructor(){super(),this.subTreeAABB=new W,this.childCount=0}addChild(t){null!=t.parent&&t.parent.removeChild(t),this.insertEnd(t),this.childAdded(t)}addChildAt(t,e){e>=this.childCount?this.addChild(t):(0==e?this.insertBeginning(t):this.insertBefore(this.findChildByIndex(e),t),this.childAdded(t))}childAdded(t){this.childCount++,t.parent=this}findChildByIndex(t){for(var e=this.head,i=0;null!=e;){if(i++==t)return e;e=e.next}return this.tail}removeChild(t){t.parent==this&&(this.remove(t),this.childRemoved(t))}removeChildAt(t){var e=this.findChildByIndex(t);return this.removeChild(e),e}childRemoved(t){this.childCount--,t.parent=null}updateTransform(){const t=Math.floor(this.position.x),e=Math.floor(this.position.y),i=this._rotationComponents.y,s=this._rotationComponents.x;this.localTransform[0]=s*this.scale.x,this.localTransform[1]=-i*this.scale.y,this.localTransform[3]=i*this.scale.x,this.localTransform[4]=s*this.scale.y;const n=this.parent.worldTransform,r=this.localTransform[0],o=this.localTransform[1],a=t-(this.localTransform[0]*this.pivot.x-this.pivot.y*this.localTransform[1]),h=this.localTransform[3],l=this.localTransform[4],c=e-(this.localTransform[4]*this.pivot.y-this.pivot.x*this.localTransform[3]),d=n[0],u=n[1],p=n[2],g=n[3],m=n[4],y=n[5];this.localTransform[2]=a,this.localTransform[5]=c,this.worldTransform[0]=d*r+u*h,this.worldTransform[1]=d*o+u*l,this.worldTransform[2]=d*a+u*c+p,this.worldTransform[3]=g*r+m*h,this.worldTransform[4]=g*o+m*l,this.worldTransform[5]=g*a+m*c+y,this.worldAlpha=this.alpha*this.parent.worldAlpha,this.calcExtents();for(var x=this.head;null!=x;)x.updateTransform(),x=x.next}insertAfter(t,e){e.prev=t,e.next=t.next,null==t.next?this.tail=e:t.next.prev=e,t.next=e}insertBefore(t,e){e.prev=t.prev,e.next=t,null==t.prev?this.head=e:t.prev.next=e,t.prev=e}insertBeginning(t){null==this.head?(this.head=t,this.tail=t,t.prev=null,t.next=null):this.insertBefore(this.head,t)}insertEnd(t){null==this.tail?this.insertBeginning(t):this.insertAfter(this.tail,t)}remove(t){null==t.prev?this.head=t.next:t.prev.next=t.next,null==t.next?this.tail=t.prev:t.next.prev=t.prev,t.prev=t.next=null}debug(){for(var t=this.head;null!=t;)t=t.next}}class D extends G{constructor(){super(),this.id="Stage",this.worldAlpha=this.alpha}updateTransform(){for(var t=this.head;null!=t;)t.updateTransform(),t=t.next}}class I{constructor(t,e,i,s=800,n=600,r=!1,o=!1){this.stage=t,this.camera=e,this.view=i,this.contextLost=!1,this.contextAttributes={},this.contextAttributes.alpha=r,this.contextAttributes.antialias=o,this.contextAttributes.premultipliedAlpha=!0,this.contextAttributes.stencil=!1,this.renderers=new Array,this.InitalizeWebGlContext(),this.Resize(s,n)}InitalizeWebGlContext(){this.view.addEventListener("webglcontextlost",this.onContextLost,!1),this.view.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.gl=this.view.getContext("webgl",this.contextAttributes),this.gl.disable(WebGLRenderingContext.DEPTH_TEST),this.gl.disable(WebGLRenderingContext.CULL_FACE),this.gl.enable(WebGLRenderingContext.BLEND),this.gl.colorMask(!0,!0,!0,this.contextAttributes.alpha),this.gl.clearColor(0,0,0,1),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.getExtension("OES_texture_float")||console.log("New browser time: Float textures not supported")}Resize(t,e){this.width=t,this.height=e,this.view.width=t,this.view.height=e,this.gl.viewport(0,0,t,e),this.gl.scissor(0,0,t,e)}AddRenderer(t){t.Init(this.gl,this.camera),t.Resize(this.width,this.height),this.renderers.push(t)}Render(t){if(!this.contextLost){this.gl.clearColor(159/255,188/255,197/255,1),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA);for(const e of this.renderers)e.Render(t)}}onContextLost(t){this.contextLost=!0,console.log("webGL Context Lost")}onContextRestored(t){this.contextLost=!1,console.log("webGL Context Restored")}}class z{constructor(t,e,i,s=!1){this.gl=t,this.powerOfTwo=!1,this.width=e,this.height=i,this.RegisterTexture(s)}RegisterTexture(t){null==this.texture&&(this.texture=this.gl.createTexture()),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),this.powerOfTwo?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,this.width,this.height,0,WebGLRenderingContext.RGBA,t?WebGLRenderingContext.FLOAT:WebGLRenderingContext.UNSIGNED_BYTE,null)}static FromImage(t,e){var i=new z(t,e.width,e.height);return t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),i}bind(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture)}unbind(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,null)}drawTo(t){null==this.framebuffer&&(this.framebuffer=this.gl.createFramebuffer()),null==this.renderbuffer&&(this.renderbuffer=this.gl.createRenderbuffer()),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,this.framebuffer),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,this.renderbuffer),this.width==this.renderbuffer.width&&this.height==this.renderbuffer.height||(this.renderbuffer.width=this.width,this.renderbuffer.height=this.height,this.gl.renderbufferStorage(WebGLRenderingContext.RENDERBUFFER,WebGLRenderingContext.DEPTH_COMPONENT16,this.width,this.height),this.gl.framebufferTexture2D(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.COLOR_ATTACHMENT0,WebGLRenderingContext.TEXTURE_2D,this.texture,0),this.gl.framebufferRenderbuffer(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.DEPTH_ATTACHMENT,WebGLRenderingContext.RENDERBUFFER,this.renderbuffer)),this.gl.viewport(0,0,this.width,this.height),t(),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,null),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,null),this.gl.viewport(0,0,1280,720)}UnregisterTexture(t){this.texture}}class O{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s}}class U{constructor(t,e,i=null){this.noFrame=!1,this.baseTexture=t,null==e?(this.noFrame=!0,this.frame=new O(0,0,1,1)):this.frame=e,this.trim=new C,this.pivot=null==i?new C:i,this.uvs=new Float32Array(8),this.updateUVS()}updateUVS(){var t=this.baseTexture.width,e=this.baseTexture.height;this.uvs[0]=this.frame.x/t,this.uvs[1]=this.frame.y/e,this.uvs[2]=(this.frame.x+this.frame.width)/t,this.uvs[3]=this.frame.y/e,this.uvs[4]=(this.frame.x+this.frame.width)/t,this.uvs[5]=(this.frame.y+this.frame.height)/e,this.uvs[6]=this.frame.x/t,this.uvs[7]=(this.frame.y+this.frame.height)/e}}class k{constructor(t){this.gl=t,this.baseTextures=new Map,this.textures=new Map}AddTexture(t,e){var i=z.FromImage(this.gl,e);return this.baseTextures.set(t,i),i}ParseTexturePackerJSON(t,e){if("string"==typeof t){var i=this.baseTextures.get(e),s=JSON.parse(t);Object.keys(s.frames).forEach(t=>{var e=s.frames[t];this.textures.set(t,new U(i,new O(e.frame.x,e.frame.y,e.frame.w,e.frame.h),new C(e.pivot.x,e.pivot.y)))})}}ParseTexturesFromTiles(t,e){}}class N{constructor(){this.frames=new Array,this.framesHash=new Map,this.animationsHash=new Map}addFrame(t){this.frames.push(t),this.framesHash.set(t.name,t)}getFrame(t){return this.framesHash.get(t)}addAnimation(t){this.animationsHash.set(t.name,t)}getAnimation(t){return this.animationsHash.get(t)}get numFrames(){return frames.length}}class V{constructor(t,e,i){this.name=t,this.texture=e,this.scale=i}updateSprite(t,e=1,i=1){t.texture=this.texture,t.pivot.x=t.texture.frame.width*t.texture.pivot.x,t.pivot.y=(t.texture.frame.height+2)*t.texture.pivot.y,t.scale.x=this.scale.x*e,t.scale.y=this.scale.y*i}}class q{constructor(t,e,i=0,s=!0,n=!1,r=!1){this.name=t,this.frameRate=i,this.frames=e,this.looped=s,this.flipX=n,this.flipY=r,this.msPerFrame=1e3/this.frameRate,this.length=this.frames.length}}class H{constructor(t){this.textureManager=t,this.frameLists=new Map}getFrameList(t){return this.frameLists.get(t)}ParseFrameListJSON(t){if("string"==typeof t){var e=JSON.parse(t);Object.keys(e).forEach(t=>{var i=new N;this.frameLists.set(t,i);const s=e[t];null!=s.frames&&(s.frames.forEach(t=>{i.addFrame(new V(t.id,this.textureManager.textures.get(t.name),t.scale))}),null!=s.animations&&Object.keys(s.animations).forEach(t=>{var e=s.animations[t];i.addAnimation(new q(t,e.frames.map(t=>i.frames[t]),e.fps,e.looped,e.flipX,e.flipY))}))})}}}class X extends G{constructor(){super(),this.renderable=!0,this.anchor=new C,this.transformedVerts=new Float32Array(8),this.blendEquation=WebGLRenderingContext.FUNC_ADD,this.blendFuncS=WebGLRenderingContext.SRC_ALPHA,this.blendFuncD=WebGLRenderingContext.ONE_MINUS_SRC_ALPHA}calcExtents(){const t=this.texture.frame.width,e=this.texture.frame.height,i=this.anchor.x,s=this.anchor.y,n=t*(1-i),r=t*-i,o=e*(1-s),a=e*-s,h=this.worldTransform[0],l=this.worldTransform[3],c=this.worldTransform[1],d=this.worldTransform[4],u=this.worldTransform[2],p=this.worldTransform[5];this.transformedVerts[0]=h*r+c*a+u,this.transformedVerts[1]=d*a+l*r+p,this.transformedVerts[2]=h*n+c*a+u,this.transformedVerts[3]=d*a+l*n+p,this.transformedVerts[4]=h*n+c*o+u,this.transformedVerts[5]=d*o+l*n+p,this.transformedVerts[6]=h*r+c*o+u,this.transformedVerts[7]=d*o+l*r+p}}class Y extends A{constructor(t,e,i){super([T,S]),this.canvas=t,this.stage=new D,this.camera=e,this.stage.addChild(this.camera),this.renderer=new I(this.stage,this.camera,this.canvas,i.x,i.y),this.camera.Resize(this.renderer.width,this.renderer.height),this.textureManager=new k(this.renderer.gl),this.frameListManager=new H(this.textureManager),this.itemContainer=new G,this.itemContainer.id="itemContainer",this.camera.addChild(this.itemContainer)}initalize(){}onEntityAdded(t,e,i){null==i.sprite&&(i.sprite=new X,i.frameList=this.frameListManager.getFrameList(i.frameListId),null!=i.initialFrameId?i.setFrame(i.frameList.getFrame(i.initialFrameId)):i.setFrame(i.frameList.frames[0]),i.sprite.position=e.coords),this.itemContainer.addChild(i.sprite)}onEntityRemoved(t,e,i){this.itemContainer.removeChild(i.sprite)}updateSystem(){this.camera.Focus(this._cameraTarget.x,this._cameraTarget.y),this.renderer.Render(this.camera.viewPortAABB)}set cameraTarget(t){this._cameraTarget=t}}function j(t,e,i){const s=t.createShader(i);return t.shaderSource(s,e),t.compileShader(s),t.getShaderParameter(s,WebGLRenderingContext.COMPILE_STATUS)?s:(console.error(t.getShaderInfoLog(s)),null)}function J(t,e,i){const s=function(t,e){return j(t,e,WebGLRenderingContext.VERTEX_SHADER)}(t,e),n=function(t,e){return j(t,e,WebGLRenderingContext.FRAGMENT_SHADER)}(t,i),r=t.createProgram();return t.attachShader(r,s),t.attachShader(r,n),t.linkProgram(r),t.getProgramParameter(r,WebGLRenderingContext.LINK_STATUS)||console.error("Could not initialize program"),r}class K{constructor(t,e){this.program=e,this.attribute={},this.uniform={},t.useProgram(this.program);let i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_ATTRIBUTES),s=0;for(;s<i;){const i=t.getActiveAttrib(e,s);this.attribute[i.name]=t.getAttribLocation(e,i.name),s++}for(i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_UNIFORMS),s=0;s<i;){const i=t.getActiveUniform(e,s);this.uniform[i.name]=t.getUniformLocation(e,i.name),s++}}}new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]);const Z=20;class Q{constructor(t){this.gl=t,this.size=1,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.blendMode=0,this.dynamicSize=1}Clean(){}ResizeBatch(t){this.size=t,this.dynamicSize=t,this.data=new Float32Array(this.dynamicSize*Z),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=function(t){const e=new Uint16Array(6*t);for(var i=0;i<t;i++){const t=6*i,s=4*i;e[t+0]=s+0,e[t+1]=s+1,e[t+2]=s+2,e[t+3]=s+0,e[t+4]=s+2,e[t+5]=s+3}return e}(this.dynamicSize),this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)}AddSpriteToBatch(t,e){const i=e*Z,s=t.texture.uvs;this.data[i+0]=t.transformedVerts[0],this.data[i+1]=t.transformedVerts[1],this.data[i+2]=s[0],this.data[i+3]=s[1],this.data[i+4]=t.worldAlpha,this.data[i+5]=t.transformedVerts[2],this.data[i+6]=t.transformedVerts[3],this.data[i+7]=s[2],this.data[i+8]=s[3],this.data[i+9]=t.worldAlpha,this.data[i+10]=t.transformedVerts[4],this.data[i+11]=t.transformedVerts[5],this.data[i+12]=s[4],this.data[i+13]=s[5],this.data[i+14]=t.worldAlpha,this.data[i+15]=t.transformedVerts[6],this.data[i+16]=t.transformedVerts[7],this.data[i+17]=s[6],this.data[i+18]=s[7],this.data[i+19]=t.worldAlpha}Render(t,e,i){var s,n,r;s=e,(n=new Array(1e3))[0]=s,r=1;for(var o=0,a=null;r>0;){var h=n[--r];if(null!=h.next&&(n[r++]=h.next),null!=h.head&&(n[r++]=h.head),h.visible&&h.renderable){var l=h;l.texture.baseTexture.texture==a&&o!=this.size||(this.Flush(t,a,o),o=0,a=l.texture.baseTexture.texture,this.gl.blendEquation(l.blendEquation),this.gl.blendFunc(l.blendFuncS,l.blendFuncD)),this.AddSpriteToBatch(l,o),o++}}o>0&&this.Flush(t,a,o)}Flush(t,e,i){this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.vertexAttribPointer(t.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,Z,0),this.gl.vertexAttribPointer(t.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,Z,8),this.gl.vertexAttribPointer(t.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,Z,16),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,e),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*i,WebGLRenderingContext.UNSIGNED_SHORT,0)}}var $="precision mediump float;\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute float aColor;\nuniform vec2 projectionVector;\nvarying vec2 vTextureCoord;\nvarying float vColor;\nvoid main(void) {\n    gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n    vColor = aColor;\n}",tt="precision mediump float;\nvarying vec2 vTextureCoord;\nvarying float vColor;\nuniform sampler2D uSampler;\nvoid main(void) {\n    gl_FragColor = texture2D(uSampler,vTextureCoord) * vColor;\n}";class et{constructor(){}Init(t,e){this.gl=t,this.camera=e,this.projection=new C,this.spriteShader=new K(t,J(t,$,tt)),this.spriteBatch=new Q(t),this.spriteBatch.ResizeBatch(1e3)}Resize(t,e){this.projection.x=t/2,this.projection.y=e/2}AddStage(t){this.stage=t}Render(t){this.stage.updateTransform(),this.gl.useProgram(this.spriteShader.program),this.gl.uniform2f(this.spriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aColor),this.gl.vertexAttribPointer(this.spriteShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(this.spriteShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(this.spriteShader.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.spriteBatch.Render(this.spriteShader,this.stage,this.camera.viewPortAABB)}}class it{constructor(t,e,i=null){this.w=t,this.h=e,this.buffer=null==i?new ArrayBuffer(this.w*this.h*4):i,this.data32=new Uint32Array(this.buffer),this.data8=new Uint8Array(this.buffer)}get(t,e){return this.data32[e*this.w+t]}set(t,e,i){this.data32[e*this.w+t]=i}}class st{constructor(t,e,i,s,n){this.initalize(t,e,i,s,n)}initalize(t,e,i,s,n){this.width=t,this.height=e,this.numberernalWidth=t*s,this.cellSize=i,this.invCellSize=1/i,this.bytesPerCell=s,this.data=null==n?new ArrayBuffer(t*e*s):n,this.data8=new Uint8Array(this.data)}get(t,e,i){return this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]}set(t,e,i,s){this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]=s}getReal(t,e,i){return this.get(this.Index(t),this.Index(e),i)}Index(t){return t*this.invCellSize|0}}const nt=function(t,e=4){var i,s,n,r=function(t){return atob(t.replace(/[^A-Za-z0-9\+\/\=]/g,""))}(t),o=new Uint32Array(r.length/e);for(i=0,n=r.length/e;i<n;i++)for(o[i]=0,s=e-1;s>=0;--s)o[i]+=r.charCodeAt(i*e+s)<<(s<<3);return o};function rt(t){const e=nt(t.data);return new st(t.width,t.height,16,4,e.buffer)}function ot(t,e){const i=t.layers.filter(t=>t.name===e);return 1===i.length?i[0]:null}function at(t){for(var e=new it(t.width,t.height),i=0;i<t.width;i++)for(var s=0;s<t.height;s++){var n=t.get(i,s,3)<<24|t.get(i,s,2)<<16|t.get(i,s,1)<<8|t.get(i,s,0);if(n>0){var r=Math.floor(n/1024),o=Math.floor(r/8),a=r%8,h=n-1024*r;h--;var l=Math.floor(h/32),c=o<<24|a<<16|l<<8|h-32*l;e.set(i,s,c)}else e.set(i,s,4294967295)}return e}class ht{constructor(){this.scrollScale=new C(1,1),this.inverseTileDataTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2)}setSpriteTexture(t){this.spriteTexture=t.texture,this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height}setTextureFromMap(t,e){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,e.w,e.h,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e.data8),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE),this.inverseTileDataTextureSize[0]=1/e.w,this.inverseTileDataTextureSize[1]=1/e.h}setTexture(t,e,i){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),i?(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.inverseTileDataTextureSize[0]=1/e.width,this.inverseTileDataTextureSize[1]=1/e.height}}class lt{constructor(t,e){this.tileMap=t,this.layers=e,this.lastSnap=new C(0,0),this.thisSnap=new C(-1e3,-1e3),this.snapChanged=!1,this.size=new C,this.renderSurface=this.renderSurface.bind(this)}Init(t,e){this.sprite=new X,this.sprite.id="renderTexture"}Resize(t,e){this.size.setTo(t,e),this.surface=new z(this.tileMap.gl,t,e),this.texture=new U(this.surface,new O(0,0,t,e),new C(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(2,-2),this.sprite.pivot.setTo(t/2,e/2)}calcSnap(t){return this.lastSnap.copy(this.thisSnap),this.thisSnap.x=16*(Math.floor(t.x/-16)-1),this.thisSnap.y=16*(Math.floor(t.y/-16)-1),this.snapChanged=this.lastSnap.x!=this.thisSnap.x||this.lastSnap.y!=this.thisSnap.y,this.snapChanged}Render(t){this.calcSnap(this.tileMap.camera.position),this.sprite.position.copy(this.size),this.sprite.position.plusEquals(this.thisSnap),this.surface.drawTo(this.renderSurface)}renderSurface(){this.tileMap.RenderLayers(this)}}var ct="precision mediump float;\nattribute vec2 position;\nattribute vec2 texture;\n\nvarying vec2 pixelCoord;\nvarying vec2 texCoord;\n\nuniform vec2 viewOffset;\nuniform vec2 viewportSize;\nuniform vec2 inverseTileTextureSize;\nuniform float inverseTileSize;\n\nvoid main(void) {\n    pixelCoord = (texture * viewportSize) + viewOffset;\n    texCoord = pixelCoord * inverseTileTextureSize * inverseTileSize;\n    gl_Position = vec4(position, 0.0, 1.0);\n}",dt="precision mediump float;\n\nvarying vec2 pixelCoord;\nvarying vec2 texCoord;\n\nuniform sampler2D tiles;\nuniform sampler2D sprites;\n\nuniform vec2 inverseTileTextureSize;\nuniform vec2 inverseSpriteTextureSize;\nuniform float tileSize;\n\nvoid main(void) {\n    vec4 tile = texture2D(tiles, texCoord);\n    if (tile.x == 1.0 && tile.y == 1.0) { \n        discard;\n    } else {\n        vec2 superSpriteOffset = floor(tile.zw * 256.0) * 256.0;\n        vec2 spriteOffset = floor(tile.xy * 256.0) * tileSize;\n        vec2 spriteCoord = mod(pixelCoord, tileSize);\n\n        // TODO?\n        // Way to flip the tile. Works.\n        //    spriteCoord.x = (-1.0+(2.0* 0.0)) * (( 0.0*tileSize) - spriteCoord.x); //normal  0\n        //    spriteCoord.x = (-1.0+(2.0* 1.0)) * (( 1.0*tileSize) - spriteCoord.x); //flip   1\n\n        gl_FragColor = texture2D(sprites, (superSpriteOffset + spriteOffset + spriteCoord) * inverseSpriteTextureSize);\n    }\n}";class ut{constructor(t,e){this.tileSize=t,this.tileScale=e,this.layers=new Array,this.layersMap=new Map,this.renderLayers=new Array,this.renderLayersMap=new Map}Init(t,e){if(null==this.gl){this.gl=t,this.camera=e,this.filtered=!1,this.spriteSheet=this.gl.createTexture(),this.viewportSize=new C,this.scaledViewportSize=new Float32Array(2),this.inverseTileTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2),this.quadVertBuffer=this.gl.createBuffer(),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer);var i=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]);t.bufferData(WebGLRenderingContext.ARRAY_BUFFER,i,WebGLRenderingContext.STATIC_DRAW),this.tilemapShader=new K(t,J(t,ct,dt)),this.flip=!1,this.writebuffer2=new it(3,3),this.renderLayers.forEach(i=>i.Init(t,e))}}Resize(t,e){var i=(Math.floor(t/(this.tileSize*this.tileScale))+2)*this.tileSize,s=(Math.floor(e/(this.tileSize*this.tileScale))+2)*this.tileSize;this.viewportSize.x=i*this.tileScale,this.viewportSize.y=s*this.tileScale,this.scaledViewportSize[0]=this.viewportSize.x/this.tileScale,this.scaledViewportSize[1]=this.viewportSize.y/this.tileScale,this.renderLayers.forEach(t=>t.Resize(Math.floor(i),Math.floor(s)))}SetSpriteSheet(t){this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.spriteSheet),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,t),this.filtered?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST)),this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height}SetTileLayer(t,e,i,s){var n=new ht;n.setTexture(this.gl,t,!1),n.scrollScale.x=i,n.scrollScale.y=s,this.layers.push(n)}SetTileLayerFromData(t,e,i,s,n){var r=new ht;return r.setTextureFromMap(this.gl,t),r.setSpriteTexture(e),r.scrollScale.x=s,r.scrollScale.y=n,this.layers.push(r),this.layersMap.set(i,r),r}SetTileRenderLayer(t,e){var i=new lt(this,e);this.renderLayers.push(i),this.renderLayersMap.set(t,i)}updateMap(t,e,i){var s=i[0],n=i[1],r=i[2],o=i[3],a=i[4],h=i[5],l=Math.floor(i[6]/8),c=i[6]%8;this.writebuffer2.h=o,this.writebuffer2.w=r;for(var d=0;d<o;d++)for(var u=0;u<r;u++){var p=l<<24|c<<16|n+d<<8|s+u;this.writebuffer2.set(u,d,p)}var g=this.layers[2].tileDataTexture;this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,g),this.gl.texSubImage2D(WebGLRenderingContext.TEXTURE_2D,0,t-a,e-h,r,o,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,this.writebuffer2.data8)}Render(t){for(const e of this.renderLayers)e.Render(t)}RenderLayers(t){this.gl.clearColor(0,0,0,0),this.gl.colorMask(!0,!0,!0,!0),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.useProgram(this.tilemapShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.position),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.texture),this.gl.vertexAttribPointer(this.tilemapShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.tilemapShader.attribute.texture,2,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.uniform2fv(this.tilemapShader.uniform.viewportSize,this.scaledViewportSize),this.gl.uniform1f(this.tilemapShader.uniform.tileSize,this.tileSize),this.gl.uniform1f(this.tilemapShader.uniform.inverseTileSize,1/this.tileSize),this.gl.uniform1i(this.tilemapShader.uniform.sprites,0),this.gl.uniform1i(this.tilemapShader.uniform.tiles,1);for(var e=0;e<t.layers.length;e++){const i=this.layersMap.get(t.layers[e]),s=t.thisSnap.x/2,n=t.thisSnap.y/2;this.gl.uniform2f(this.tilemapShader.uniform.viewOffset,s,n),this.gl.uniform2fv(this.tilemapShader.uniform.inverseSpriteTextureSize,i.inverseSpriteTextureSize),this.gl.uniform2fv(this.tilemapShader.uniform.inverseTileTextureSize,i.inverseTileDataTextureSize),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.spriteTexture),this.gl.activeTexture(WebGLRenderingContext.TEXTURE1),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.tileDataTexture),this.gl.drawArrays(WebGLRenderingContext.TRIANGLES,0,6)}this.gl.colorMask(!0,!0,!0,!1)}}class pt{constructor(t,e){this.frameListId=t,this.play(e)}play(t){this.animationId!==t&&(this.animationId=t,this.dirty=!0)}}class gt{constructor(t){this.play(t)}update(t){return this.accumulatedTime+=t,this.accumulatedTime>this.animation.msPerFrame&&(this.frameIndex=++this.frameIndex%this.animation.length,this.accumulatedTime=0),this.animation.frames[this.frameIndex]}play(t){this.animation=t,this.frameIndex=0,this.accumulatedTime=0}}class mt extends A{constructor(t){super([T,S,pt]),this.frameListManager=t}onEntityAdded(t,e,i,s){const n=this.frameListManager.getFrameList(s.frameListId).getAnimation(s.animationId);s.dirty=!1,s.animationController=new gt(n)}updateEntity(t,e,i,s){s.dirty&&this.playAnimation(s),s.animationController.update(this.dt).updateSprite(i.sprite,e.direction.x,e.direction.y)}playAnimation(t){t.dirty=!1;const e=this.frameListManager.getFrameList(t.frameListId).getAnimation(t.animationId);t.animationController.play(e)}}class yt{constructor(){this.start=new C,this.end=new C,this.delta=new C,this.scale=new C,this.sign=new C}set(t,e){this.start.copy(t),this.end.copy(e),this.delta.copy(this.end),this.delta.minusEquals(this.start),this.scale.setTo(1/this.delta.x,1/this.delta.y),this.sign.x=this.delta.x<0?-1:1,this.sign.y=this.delta.y<0?-1:1}}class xt{constructor(){this.position=new C,this.delta=new C,this.normal=new C,this.distance=0,this.time=0,this.sweepPosition=new C}setTo(t){this.position.x=t.position.x,this.position.y=t.position.y,this.delta.x=t.delta.x,this.delta.y=t.delta.y,this.normal.x=t.normal.x,this.normal.y=t.normal.y,this.time=t.time,this.distance=t.distance,this.sweepPosition.x=t.sweepPosition.x,this.sweepPosition.y=t.sweepPosition.y}}class bt{constructor(t=1,e=4294967295,i=0){this.groupIndex=0,this.categoryBits=1,this.maskBits=4294967295,this.categoryBits=t,this.maskBits=e,this.groupIndex=i}static CHECK(t,e){return null==t||null==e||(t.groupIndex==e.groupIndex&&0!=t.groupIndex?t.groupIndex>0:0!=(t.maskBits&e.categoryBits)&&0!=(t.categoryBits&e.maskBits))}clone(){return new bt(this.categoryBits,this.maskBits,this.groupIndex)}}const ft=new xt;var vt=null;const Ct=function(t,e){if(t.isStatic&&e.isStatic||t.isSensor&&e.isSensor)return!1;if(!t.isActive||!e.isActive)return!1;if(!bt.CHECK(t.filter,e.filter))return!1;var i=!1;if(t.isSensor||e.isSensor)i=At(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,ft);else if(t.isStatic||e.isStatic){var s,n;t.isStatic?(s=t,n=e):(s=e,n=t),n.body.isBullet?(i=wt(n,s))&&n.body.respondBulletCollision(ft):(Lt(n.aabb.position,n.aabb.extents,s.aabb.position,s.aabb.extents,s.responseBias,ft),i=n.body.respondStaticCollision(ft))}else{if(t.body.isBullet&&e.body.isBullet)return!1;t.body.isBullet?1==Pt(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,ft)&&(t.body.respondBulletCollision(ft),i=!0):e.body.isBullet?1==Pt(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,e.body.delta,ft)&&(e.body.respondBulletCollision(ft),i=!0):i=At(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,ft)}return 1==i&&vt.UpdateContacts(t,e,ft),i},wt=function(t,e){return Pt(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,ft)},Et=function(t,e){return!!Rt(e.aabb.position,e.aabb.extents,t.origin,t.delta,0,0,ft)&&(t.report(ft.delta.x,ft.delta.y,ft.normal.x,ft.normal.y,e),!0)},At=function(t,e,i,s,n){const r=i.x-t.x,o=s.x+e.x-Math.abs(r);if(o<=0)return!1;const a=i.y-t.y,h=s.y+e.y-Math.abs(a);if(h<=0)return!1;if(o<h){const s=r<0?-1:1;n.distance=n.delta.x=o*s,n.delta.y=0,n.normal.x=s,n.normal.y=0,n.position.x=t.x+e.x*s,n.position.y=i.y}else{const s=a<0?-1:1;n.delta.x=0,n.distance=n.delta.y=h*s,n.normal.x=0,n.normal.y=s,n.position.x=i.x,n.position.y=t.y+e.y*s}return!0},Tt=function(t,e,i,s,n){return St(e,i,t.start,t.scale,t.sign,s,n)},St=function(t,e,i,s,n,r,o){const a=(t.x-n.x*(e.x+r)-i.x)*s.x,h=(t.y-n.y*(e.y+o)-i.y)*s.y,l=(t.x+n.x*(e.x+r)-i.x)*s.x,c=(t.y+n.y*(e.y+o)-i.y)*s.y;if(a>c||h>l)return!1;const d=Math.max(a,h),u=Math.min(l,c);return!(d>=1||u<=0)},Rt=function(t,e,i,s,n,r,o){const a=1/s.x,h=1/s.y,l=a<0?-1:1,c=h<0?-1:1,d=(t.x-l*(e.x+n)-i.x)*a,u=(t.y-c*(e.y+r)-i.y)*h,p=(t.x+l*(e.x+n)-i.x)*a,g=(t.y+c*(e.y+r)-i.y)*h;if(d>g||u>p)return!1;const m=Math.max(d,u),y=Math.min(p,g);return!(m>=1||y<=0)&&(o.time=Math.min(Math.max(m,0),1),d>u?(o.normal.x=-l,o.normal.y=0):(o.normal.x=0,o.normal.y=-c),o.delta.x=o.time*s.x,o.delta.y=o.time*s.y,o.position.x=i.x+o.delta.x,o.position.y=i.y+o.delta.y,!0)},Pt=function(t,e,i,s,n,r){if(0==n.x&&0==n.y)return r.sweepPosition.x=i.x,r.sweepPosition.y=i.y,At(t,e,i,s,r)?(r.time=0,!0):(r.time=1,!1);if(Rt(t,e,i,n,s.x,s.y,r)){r.time=Math.min(Math.max(r.time-1e-8,0),1),r.sweepPosition.x=i.x+n.x*r.time,r.sweepPosition.y=i.y+n.y*r.time;const t=Math.sqrt(n.x*n.x+n.y*n.y);return r.position.x+=n.x/t*s.x,r.position.y+=n.y/t*s.y,!0}return r.sweepPosition.x=i.x*n.x,r.sweepPosition.y=i.y*n.y,!1},Lt=function(t,e,i,s,n,r){const o=i.x-t.x,a=s.x+e.x-Math.abs(o),h=i.y-t.y;a<s.y+e.y-Math.abs(h)?(r.normal.x=o<0?1:-1,r.normal.y=0):(r.normal.x=0,r.normal.y=h<0?1:-1),r.normal.x*=n.x,r.normal.y*=n.y;const l=r.normal.x*(e.x+s.x)+i.x,c=r.normal.y*(e.y+s.y)+i.y,d=t.x-l,u=t.y-c;return r.distance=d*r.normal.x+u*r.normal.y,!0},Ft=function(t,e,i,s,n,r){r.normal.copy(n);const o=r.normal.x*(e.x+s.x)+i.x,a=r.normal.y*(e.y+s.y)+i.y,h=t.x-o,l=t.y-a;return r.distance=h*r.normal.x+l*r.normal.y,!0};class _t{constructor(){this.n=new C,this.d=0}set(t,e){this.n.copy(t),this.d=this.n.dot(e)}setFromSegment(t,e){this.n.copy(t),this.n.minusEquals(e),this.n.normalize(),this.n.leftHandNormalEquals(),this.d=this.n.dot(t)}distancePoint(t){return this.n.dot(t)-this.d}}class Bt{constructor(){this.position=new C,this.extents=new C}get l(){return this.position.x-this.extents.x}get t(){return this.position.y-this.extents.y}get r(){return this.position.x+this.extents.x}get b(){return this.position.y+this.extents.y}overlap(t){return!(Math.abs(this.position.x-t.position.x)>this.extents.x+t.extents.x)&&!(Math.abs(this.position.y-t.position.y)>this.extents.y+t.extents.y)}containsAABB(t){return!1}containsPoint(t){return Math.abs(t.x-this.position.x)<this.extents.x&&Math.abs(t.y-this.position.y)<this.extents.y}overlapArea(t){var e=Math.max(this.l,t.l),i=Math.min(this.r,t.r),s=Math.max(this.t,t.t);return(i-e)*(Math.min(this.b,t.b)-s)}area(){return this.extents.x*this.extents.y*4}toAABB2(){return new W(this.t,this.r,this.b,this.l)}copyToAABB2(t){t.t=this.t,t.r=this.r,t.b=this.b,t.l=this.l}clone(t){return(t=new Bt).position.copy(this.position),t.extents.copy(this.extents),t}}const Mt=1,Wt=2,Gt=4,Dt=Mt|Wt|Gt,It=-4,zt=0,Ot=.01,Ut=[new C(-4,4),new C(4,-4)];class kt{constructor(t){this.tilePosition=new C,this.tileExtents=new C,this.halftilePosition=new C,this.halftileExtents=new C,this.halftileStairExtents=new C,this.bias=new C(1,1),this.step=new C(0,-1),this.plane=new _t,this.segment=new yt,this.workingAABB=new Bt,this.data=t,this.tileSize=t.cellSize,this.tileHalfSize=this.tileSize/2,this.tileExtents.setTo(this.tileHalfSize,this.tileHalfSize),this.halftileExtents.setTo(this.tileHalfSize/4,this.tileHalfSize/4),this.halftileStairExtents.setTo(this.tileHalfSize/8,this.tileHalfSize/8),this.contact=new xt,this.closestContact=new xt}testCollision(t){const e=t.body,i=this.data.Index(Math.min(e.position.x,e.predictedPosition.x)-t.aabb.extents.x-zt),s=this.data.Index(Math.min(e.position.y,e.predictedPosition.y)-t.aabb.extents.y-zt),n=this.data.Index(Math.max(e.position.x,e.predictedPosition.x)+t.aabb.extents.x+zt-Ot)+1,r=this.data.Index(Math.max(e.position.y,e.predictedPosition.y)+t.aabb.extents.y+zt)+1;if(e.isBullet){this.plane.setFromSegment(e.predictedPosition,e.position),this.closestContact.time=_;for(var o=s;o<r;o++)for(var a=i;a<n;a++){const i=this.data.get(a,o,0);1==(i&Mt)&&0==(i&Wt)&&(this.tilePosition.x=a*this.tileSize+this.tileHalfSize,this.tilePosition.y=o*this.tileSize+this.tileHalfSize,Math.abs(this.plane.distancePoint(this.tilePosition))<40&&1==Pt(this.tilePosition,this.tileExtents,e.position,t.aabb.extents,e.delta,this.contact)&&e.respondBulletCollision(this.contact)&&this.closestContact.setTo(this.contact))}this.closestContact.time<_&&t.collide(null,this.contact)}else for(o=s;o<r;o++)for(a=i;a<n;a++){const i=this.data.get(a,o,0);if((i&Dt)>0)if(this.tilePosition.x=a*this.tileSize+this.tileHalfSize,this.tilePosition.y=o*this.tileSize+this.tileHalfSize,(i&Gt)==Gt&&e.usesStairs){this.segment.set(e.position,e.predictedPosition);for(var h=0;h<2;h++){const i=Ut[h];this.halftilePosition.copy(this.tilePosition),this.halftilePosition.plusEquals(i),Tt(this.segment,this.halftilePosition,this.halftileStairExtents,t.aabb.extents.x,t.aabb.extents.y)&&(Ft(e.position,t.aabb.extents,this.halftilePosition,this.halftileStairExtents,this.step,this.contact),e.respondStaticCollision(this.contact),t.collide(null,this.contact))}}else if(Lt(e.position,t.aabb.extents,this.tilePosition,this.tileExtents,this.bias,this.contact),(i&Wt)==Wt)e.collideOneWay&&this.contact.normal.y<0&&this.contact.distance>=It&&(e.respondStaticCollision(this.contact),t.collide(null,this.contact));else{const i=a+this.contact.normal.x,s=o+this.contact.normal.y;0==(this.data.get(i,s,0)&Dt)&&(e.respondStaticCollision(this.contact),t.collide(null,this.contact))}}}iterateCells(t,e){const i=this.data.Index(t.l),s=this.data.Index(t.t),n=this.data.Index(t.r)+1,r=this.data.Index(t.b)+1;this.workingAABB.extents.setTo(this.tileHalfSize,this.tileHalfSize);for(var o=s;o<r;o++)for(var a=i;a<n;a++){(this.data.get(a,o,0)&Mt)==Mt&&(this.workingAABB.position.setTo(a*this.tileSize+this.tileHalfSize,o*this.tileSize+this.tileHalfSize),e(this.workingAABB))}}castRay(t){var e=this.data.Index(t.origin.x),i=this.data.Index(t.origin.y);const s=e*this.tileSize,n=i*this.tileSize,r=t.direction;if(0==r.x&&0==r.y)return!0;var o=0,a=1e8,h=0;r.x<0?(o=-1,a=(s-t.origin.x)/r.x,h=this.tileSize/-r.x):r.x>0&&(o=1,a=(s+this.tileSize-t.origin.x)/r.x,h=this.tileSize/r.x);var l=0,c=1e8,d=0;r.y<0?(l=-1,c=(n-t.origin.y)/r.y,d=this.tileSize/-r.y):r.y>0&&(l=1,c=(n+this.tileSize-t.origin.y)/r.y,d=this.tileSize/r.y);for(var u=0,p=0,g=0,m=0;;){if(a<c?(u=a*r.x,p=a*r.y,a+=h,e+=o):(u=c*r.x,p=c*r.y,c+=d,i+=l),u*u+p*p>t.range*t.range)return!1;if((this.data.get(e,i,0)&Mt)==Mt)return a<c?(g=o<0?1:-1,m=0):(g=0,m=l<0?1:-1),t.report(u,p,g,m),!0}}}class Nt{constructor(t,e,i=0,s=0){this.halfWidths=new C(t,e),this.offset=new C(i,s)}}class Vt{constructor(){this.isStatic=!1,this.isSensor=!1,this.isActive=!0,this.limitToStaticCheck=!1,this.userData1=-1,this.userData2=-1,this.contactCallbacks=[],this.aabb=new Bt,this.offset=new C,this.responseBias=new C(1,1),this.id=Vt.nextID++}static HashBodyIDs(t,e){return t<e?t<<16|e:e<<16|t}setBody(t){this.body=t,this.aabb.position=t.position,this.isStatic=!1}collide(t,e){for(const i of this.contactCallbacks)i(this,t,e)}}Vt.nextID=0;class qt{constructor(t,e,i,s=!1,n=null){this.proxy=new Vt,this.proxy.isSensor=t,this.proxy.filter=e,this.proxy.contactCallbacks=i,this.proxy.limitToStaticCheck=s,n&&(this.proxy.body=n)}}class Ht{}class Xt extends A{constructor(t){super([T,Nt,qt,Ht]),this.broadphase=t}onEntityAdded(t,e,i,s,n){s.proxy.aabb.extents.copy(i.halfWidths),s.proxy.entity=t,s.proxy.isStatic=!0,s.proxy.aabb.position=e.coords,this.broadphase.addProxy(s.proxy)}onEntityRemoved(t,e,i,s,n){this.broadphase.removeProxy(s.proxy)}updateAllEntities(){}}class Yt{}class jt extends A{constructor(t){super([T,Nt,qt,Yt]),this.broadphase=t}onEntityAdded(t,e,i,s,n){s.proxy.aabb.extents.copy(i.halfWidths),s.proxy.isStatic=!1,s.proxy.entity=t,s.proxy.aabb.position=e.coords,s.proxy.userData1=t,this.broadphase.addProxy(s.proxy)}onEntityRemoved(t,e,i,s,n){this.broadphase.removeProxy(s.proxy)}updateAllEntities(){}}class Jt{constructor(t,e=!1){this.body=t,this.setMassFromVolume=e}}class Kt extends A{constructor(t,e){var i;super([qt,Jt,Yt]),this.broadphase=t,this.contactMangager=e,i=this.contactMangager,vt=i}onEntityAdded(t,e,i,s){e.proxy.setBody(i.body)}updateAllEntities(){this.broadphase.collide(),this.contactMangager.ProcessContacts()}}class Zt extends A{constructor(){super([Jt,Nt])}onEntityAdded(t,e,i){e.setMassFromVolume&&e.body.setMassFromVolumeMaterial(i.halfWidths.x*i.halfWidths.y*4)}}class Qt extends A{constructor(){super([T,Jt])}updateEntity(t,e,i){i.body.updatePosition(),e.update(i.body.position)}}class $t{constructor(t=1,e=.3,i=.1){this.density=t,this.elasticity=e,this.friction=i}}$t.NORMAL=new $t(1,.3,.1),$t.LIGHTMETAL=new $t(1.4,.3,.1),$t.ROCK=new $t(2,.2,.1),$t.RUBBER=new $t(1,1,.1);const te=.99332805041467,ee=9e-4,ie=10,se=.1;class ne{constructor(t=null,e=1){this.position=new C,this.positionCorrection=new C,this.predictedPosition=new C,this.delta=new C,this.previousPosition=new C,this.velocity=new C,this.originalVelocity=new C,this.previousVelocity=new C,this.contactNormal=new C,this.prevContactNormal=new C,this.tangent=new C,this.stepContactCount=0,this.maxScalarVelocity=1e3,this.maxVelocity=new C,this.forces=new C,this.accumulatedForces=new C,this.isBullet=!1,this.damping=1,this.globalForceFactor=1,this.mass=1,this.invMass=1,this.dt=0,this.motion=ie,this.canSleep=!1,this.isSleeping=!1,this.onGround=!1,this.onGroundPrev=!1,this.inWater=!1,this.inWaterPrev=!1,this.usesStairs=!0,this.collideOneWay=!0,this.totalBounceCount=0,this.bounceCount=0,this.debug=0,this.skip=!1,this.material=null==t?new $t:t,this.setMass(e)}update(t,e,i){this.dt=t,this.onGroundPrev=this.onGround,this.onGround=!1,this.inWaterPrev=this.inWater,this.inWater=!1,this.skip||this.isSleeping||(this.motion=te*this.motion+(1-te)*this.velocity.lengthSqrd(),this.motion=Math.min(this.motion,10*ee),this.canSleep=this.motion<ee,this.previousVelocity.copy(this.velocity),this.forces.plusMultEquals(e,this.globalForceFactor),this.velocity.plusEquals(this.forces),this.velocity.multEquals(i*this.damping),this.maxScalarVelocity>0?this.velocity.clampScalar(this.maxScalarVelocity):this.velocity.clampVector(this.maxVelocity),this.originalVelocity.copy(this.velocity),this.predictedPosition.copy(this.position),this.predictedPosition.plusMultEquals(this.velocity,t),this.previousPosition.copy(this.position),this.delta.copy(this.predictedPosition),this.delta.minusEquals(this.position),this.prevContactNormal.copy(this.contactNormal),this.contactNormal.setTo(0,0),this.forces.setTo(0,0),this.damping=1,this.stepContactCount=0,this.toi=_)}respondStaticCollision(t){if(this.skip)return!1;var e=Math.max(t.distance,0),i=Math.min(t.distance,0);this.positionCorrection.minusMultEquals(t.normal,i/this.dt);var s=this.velocity.dot(t.normal)+e/this.dt;return s<0&&(this.stepContactCount++,this.velocity.minusMultEquals(t.normal,s),!this.canBounce&&t.normal.y<0&&(this.onGround=!0),this.contactNormal.copy(t.normal),!0)}t(t){this.debug>0&&this.debug--}respondBulletCollision(t){return t.time<=this.toi&&(this.toi=t.time,this.positionCorrection.copy(t.sweepPosition),this.contactNormal.copy(t.normal),!0)}updatePosition(){if(!this.skip&&!this.isSleeping)if(this.isBullet)this.toi<_?(this.position.copy(this.positionCorrection),this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity)):this.position.copy(this.predictedPosition);else{if(this.stepContactCount>0&&!this.canBounce&&this.contactNormal.y<0){this.tangent.copy(this.contactNormal),this.tangent.rightHandNormalEquals();var t=this.originalVelocity.dot(this.tangent)*this.material.friction;this.velocity.x-=this.tangent.x*t,this.velocity.y-=this.tangent.y*t}this.positionCorrection.plusEquals(this.velocity),this.positionCorrection.multEquals(this.dt),this.position.plusEquals(this.positionCorrection),this.positionCorrection.setTo(0,0),this.stepContactCount>0&&this.canBounce&&(this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity),this.bounceCount++)}}addForce(t){this.forces.plusMultEquals(t,this.invMass),this.wake()}addMasslessForce(t){this.forces.plusEquals(t),this.wake()}addProportionalForce(t){this.forces.plusMultEquals(t,this.mass),this.wake()}setMass(t){this.mass=t,this.invMass=1/t}setMassFromVolumeMaterial(t){this.setMass(this.material.density*t*se)}setStaticPosition(t,e){this.position.setTo(t,e),this.positionCorrection.setTo(0,0),this.predictedPosition.setTo(0,0),this.forces.setTo(0,0),this.accumulatedForces.setTo(0,0),this.velocity.setTo(0,0),this.originalVelocity.setTo(0,0),this.delta.setTo(0,0),this.wake()}setBounces(t){this.totalBounceCount=t,this.bounceCount=0}get canBounce(){return 0!=this.totalBounceCount&&this.bounceCount<this.totalBounceCount}wake(){this.canSleep=!1,this.motion=ie,this.bounceCount=0}get down(){return this.contactNormal.y<0}get downPrev(){return this.prevContactNormal.y<0}get up(){return this.contactNormal.y>0}get upPrev(){return this.prevContactNormal.y>0}get left(){return this.contactNormal.x<0}get leftPrev(){return this.prevContactNormal.x<0}get right(){return this.contactNormal.x>0}get rightPrev(){return this.prevContactNormal.x>0}static Create(t,e,i,s,n){var r=new ne(t);return r.setMass(e),r.setBounces(i),r.globalForceFactor=s,r.maxScalarVelocity=n,r}}class re{constructor(t=!1){this.alwaysActive=t}}class oe extends A{constructor(){super([T,Jt,re]),this.globalForce=new C(0,30),this.globalDamping=.99}onEntityAdded(t,e,i,s){i.body.position.copy(e.coords)}updateEntity(t,e,i,s){i.body.update(this.dt/1e3,this.globalForce,this.globalDamping),e.direction.x=i.body.velocity.x>0?1:-1}}class ae{constructor(t){this.force=1,this.force=t}}class he extends A{constructor(t){super([Jt,ae]),this.input=t}onEntityAdded(t,e,i){}updateEntity(t,e,i){this.input.Pressed(38)&&(e.body.velocity.y-=i.force),this.input.Pressed(40)&&(e.body.velocity.y+=i.force),this.input.Pressed(37)&&(e.body.velocity.x-=i.force),this.input.Pressed(39)&&(e.body.velocity.x+=i.force)}}class le{constructor(t=""){this.setTileFrameId(t)}setTileFrameId(t){return this.tileFrameId=t,null!=this.onChange&&this.onChange(),t}}class ce extends A{constructor(t,e,i){super([T,le]),this.updates=new Array,this.frames=new Map,this.tileMap=e,this.map=i,this.parseFramesConfig(t)}parseFramesConfig(t){JSON.parse(t).sheets.forEach((t,e)=>{Object.keys(t).forEach(i=>{t[i].push(e),this.frames.set(i,t[i])})})}onEntityAdded(t,e,i){i.onChange=this.onChange.bind(this,t),null!=i.tileFrameId&&this.onChange(t)}onChange(t){this.updates.push(t)}updateAllEntities(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,T),i=this.engine.getComponentForEntity(t,le);""!=i.tileFrameId&&this.tileMap.updateMap(this.map.data.Index(e.coords.x),this.map.data.Index(e.coords.y),this.frames.get(i.tileFrameId))}}}var de="precision mediump float;\nuniform vec2 projectionVector;\nuniform vec2 cameraPosition;\n\nattribute vec2 position;\nattribute float size;\nattribute vec4 colour;\nvarying vec4 vColor;\n\nvoid main() {\n    gl_PointSize = size;\n    vColor = colour;\n    gl_Position = vec4( (cameraPosition.x + position.x) / projectionVector.x -1.0, (cameraPosition.y + position.y) / -projectionVector.y + 1.0 , 0.0, 1.0);            \n}",ue=" precision mediump float;\n\nvarying vec4 vColor;\n\nvoid main() {\n    gl_FragColor = vColor;\n}";class pe{constructor(t){this.maxSprites=t}Init(t,e){this.gl=t,this.camera=e,this.projection=new C,this.pointSpriteShader=new K(t,J(t,de,ue)),this.dataBuffer=this.gl.createBuffer(),this.arrayBuffer=new ArrayBuffer(80*this.maxSprites),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.ResetBatch()}Resize(t,e){this.projection.x=t/2,this.projection.y=e/2}AddStage(t){this.stage=t}ResetBatch(){this.indexRun=0}AddSpriteToBatch(t,e,i,s,n,r,o){var a=4*this.indexRun;this.data[a+0]=t,this.data[a+1]=e,this.data[a+2]=i,a*=4,this.data8[a+12]=n,this.data8[a+13]=r,this.data8[a+14]=o,this.data8[a+15]=s,this.indexRun++}Render(t){0!=this.indexRun&&(this.gl.useProgram(this.pointSpriteShader.program),this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.position),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.size),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.colour),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.size,1,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.colour,4,WebGLRenderingContext.UNSIGNED_BYTE,!0,16,12),this.gl.uniform2f(this.pointSpriteShader.uniform.cameraPosition,this.camera.position.x,this.camera.position.y),this.gl.uniform2f(this.pointSpriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.drawArrays(WebGLRenderingContext.POINTS,0,this.indexRun))}}const ge=1/255;class me{constructor(){this.first=!0}Initalize(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,m){this.pX=this.plX=t,this.pY=this.plY=e,this.vX=i,this.vY=s,this.fX=n,this.fY=r,this.ttl=o,this.age=o,this.damping=a,this.decay=h,this.externalForce=c,this.size=d,this.alpha=u*ge,this.red=p,this.green=g,this.blue=m,this.first=!0}Update(t,e){return this.first?(this.first=!1,this.age>0):(this.vX+=this.fX+this.externalForce.x,this.vY+=this.fY+this.externalForce.y,this.vX*=this.damping,this.vY*=this.damping,this.plX=this.pX,this.plY=this.pY,this.pX+=this.vX*e,this.pY+=this.vY*e,this.age-=t,this.alpha-=this.decay,this.age>0)}}class ye{constructor(t,e,i){this.particleCount=t,this.deltaTime=e,this.invDeltaTime=e/1e3,this.map=i,this.ZERO_FORCE=new C,this.activeParticles=new Array,this.activeParticles[0]=new Array(this.particleCount),this.activeParticles[1]=new Array(this.particleCount),this.cachedParticles=new Array(this.particleCount);for(let e=0;e<t;e++)this.cachedParticles[e]=new me;this.availableParticleCount=this.particleCount,this.activeParticlesCount=0,this.activePool=0,this.renderer=new pe(t)}EmitParticle(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,m){if(0==this.availableParticleCount)return!1;var y=this.cachedParticles[--this.availableParticleCount];return this.activeParticles[this.activePool][this.activeParticlesCount++]=y,y.Initalize(t,e,i,s,n,r,o,a,h?this.deltaTime/o:0,l,null!=c?c:this.ZERO_FORCE,d,u,p,g,m),!0}Update(){this.renderer.ResetBatch();const t=this.activeParticles[this.activePool],e=this.activeParticles[1===this.activePool?0:1];for(var i=0,s=0;s<this.activeParticlesCount;s++){const n=t[s];if(n.Update(this.deltaTime,this.invDeltaTime)){if(1==(1&this.map.getReal(n.pX,n.pY,0))){const t=this.map.Index(n.plX),e=this.map.Index(n.plY),i=this.map.Index(n.pX),s=this.map.Index(n.pY);i!=t&&(n.vX*=-.99,n.pX=n.plX),s!=e&&(n.vY*=-.99,n.pY=n.plY)}this.renderer.AddSpriteToBatch(n.pX,n.pY,n.size,255*n.alpha|0,n.red,n.green,n.blue),e[i++]=n}else this.cachedParticles[this.availableParticleCount++]=n}this.activeParticlesCount=i,this.activePool=1===this.activePool?0:1}}class xe{constructor(t){this.emitters=t}}class be extends A{constructor(t){super([T,re,xe]),this.blockParticleEngine=t}updateEntity(t,e,i,s){for(const i of s.emitters)i.update(this.timestamp,this.engine.c4e.get(t),e.coords,this.blockParticleEngine)}postUpdate(){this.blockParticleEngine.Update()}}class fe{constructor(t,e,i){this.initalize(t,e,i)}initalize(t,e,i){this.gridWidth=t,this.gridHeight=e,this.cellSize=i,this.invCellSize=1/i,this.data=new Array(this.gridWidth*this.gridHeight)}get(t,e){return this.data[e*this.gridWidth+t]}getSafe(t,e){return t>=this.gridWidth||e>=this.gridHeight||t<0||e<0?null:this.data[e*this.gridWidth+t]}set(t,e,i){this.data[e*this.gridWidth+t]=i}Index(t){return t*this.invCellSize|0}Width(){return this.gridWidth*this.cellSize}Height(){return this.gridHeight*this.cellSize}}class ve{constructor(){this.aabb=new Bt,this.isStatic=!1,this.entity=null,this.active=!1,this.referenceCount=0}}class Ce{constructor(t,e,i){this.count=1,this.updateDistanceDelta=1e4,this.grid=new fe(t,e,i),this.currentCells=new Array;for(var s=0;s<this.grid.gridWidth;s++)for(var n=0;n<this.grid.gridHeight;n++)this.grid.set(n,s,new we(`${n}:${s}`,new W(s*i,(n+1)*i,(s+1)*i,n*i)))}addEntity(t,e,i,s){var n=new ve;n.aabb.position=e.coords,n.aabb.extents=i.halfWidths,n.isStatic=!0,n.entity=t,n.name=s,this.hashProxy(n)}hashProxy(t){const e=this.grid.Index(t.aabb.position.x-t.aabb.extents.x),i=this.grid.Index(t.aabb.position.y-t.aabb.extents.y),s=this.grid.Index(t.aabb.position.x+t.aabb.extents.x)+1,n=this.grid.Index(t.aabb.position.y+t.aabb.extents.y)+1;for(var r=i;r<n;r++)for(var o=e;o<s;o++){this.grid.get(o,r).proxies.push(t)}}search(t,e){if(null==this.lastUpdatePosition)this.lastUpdatePosition=t.position.clone();else{if(this.lastUpdatePosition.distSqrd(t.position)<this.updateDistanceDelta)return;this.lastUpdatePosition.copy(t.position)}const i=this.grid.Index(t.position.x-t.extents.x),s=this.grid.Index(t.position.y-t.extents.y),n=this.grid.Index(t.position.x+t.extents.x)+1,r=this.grid.Index(t.position.y+t.extents.y)+1;for(var o=s;o<r;o++)for(var a=i;a<n;a++){const t=this.grid.get(a,o);t&&(0==t.updateCount?this.currentCells.push(t):t.updateCount=this.count)}for(var h=this.currentCells.length;h-- >0;){const i=this.currentCells[h];0==i.updateCount?this.addActiveCell(i,t,e):i.updateCount<this.count&&(this.removeActiveCell(i,t,e),this.currentCells.splice(h,1))}this.count++}addActiveCell(t,e,i){t.proxies.forEach(t=>{0==t.referenceCount++&&i(t.entity,!0)}),t.updateCount=this.count}removeActiveCell(t,e,i){t.proxies.forEach(t=>{0==--t.referenceCount&&i(t.entity,!1)}),t.updateCount=0}debugDraw(){this.currentCells.forEach((t,e)=>{w.debugRender.DrawAABB2(t.aabb,"green")})}}class we{constructor(t,e){this.id=t,this.aabb=e,this.proxies=new Array,this.updateCount=0}}class Ee{}class Ae extends A{constructor(t){super([T,Nt,Ht]),this.setEntityStatus=(t,e)=>{1==e?this.engine.addComponentsToEntity(t,[new Ee]):this.engine.removeComponentsFromEntityByType(t,[Ee])},this.camera=t,this.spaceManager=new Ce(10,10,320),this.activeSpaceAABB=new Bt}onEntityAdded(t,e,i,s){const n=this.engine.getComponentForEntity(t,h);this.spaceManager.addEntity(t,e,i,n?n.name:"unknown")}updateAllEntities(){this.activeSpaceAABB.extents.setTo(this.camera.viewportSize.x/2,this.camera.viewportSize.y/2),this.activeSpaceAABB.position.copy(this.camera.realPosition),this.spaceManager.search(this.activeSpaceAABB,this.setEntityStatus)}}class Te{constructor(t,e){this.ttl=t,this.age=0,this.onExpire=e}growOlder(t){return this.age+=t,this.isExpired()}isExpired(){return this.age>this.ttl}reset(){this.age=0}}class Se{constructor(t,e,i){this.states=t,this.currentState=e,this.messages=new p}setState(t){this.currentState=t,null!=this.onChange&&this.onChange()}}class Re extends A{constructor(){super([Te,Se,re])}updateEntity(t,e,i,s){e.growOlder(this.dt)&&null!=e.onExpire&&i.setState(e.onExpire)}}class Pe{constructor(t,e,i,s){this.maxHealth=t,this.currentHealth=e,this.recoveryPerSecond=i,this.recoveryPerMs=i/1e3,this.onNoHealth=s}applyDamage(t){this.currentHealth-=t}isDead(){return this.currentHealth<=0}}class Le extends A{constructor(){super([Pe,Se,re])}updateEntity(t,e,i,s){e.currentHealth<=0?null!=e.onNoHealth&&i.setState(e.onNoHealth):e.currentHealth=Math.min(e.maxHealth,e.currentHealth+e.recoveryPerMs*this.dt)}}class Fe{constructor(t,e,i=!0){this.count=t,this.onCount=e,this.ignoreStatic=i}}class _e extends A{constructor(){super([Fe,qt,Se,re]),this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){i.proxy.contactCallbacks.push(this.callback)}onEntityRemoved(t,e,i,s,n){i.proxy.contactCallbacks.splice(i.proxy.contactCallbacks.indexOf(this.callback),1)}updateAllEntities(){}callback(t,e,i){var s=this.engine.getComponentForEntity(t.entity,Fe),n=--s.count;if(null==e){if(n<=0&&null!=s.onCount)this.engine.getComponentForEntity(t.entity,Se).setState(s.onCount)}else{if(e.isSensor)return;if(this.engine.getComponentForEntity(e.entity,Yt)&&null!=s.onCount)this.engine.getComponentForEntity(t.entity,Se).setState(s.onCount)}}}class Be{}Be.PLAYER_CAT=4,Be.PROJECTILE_CAT=8,Be.PROJECTILE_COLLIDABLE_CAT=16,Be.SOLID_CAT=32,Be.HOLDABLE_CAT=64,Be.ph1_CAT=128,Be.ph2_CAT=256,Be.ph3_CAT=512,Be.ph4_CAT=1024,Be.ph5_CAT=2048,Be.PLAYER_GROUP=-1,Be.ENEMY_GROUP=-2,Be.TURRET_GROUP=-3,Be.BIRD_GROUP=-3,Be.CHICKEN_GROUP=-4,Be.BEE_GROUP=-5,Be.SOLID_OBJECT_GROUP=1;class Me{static calcProjectileVelocity(t,e,i){var s=e.clone();s.minusEquals(t.position),s.normalize(),s.multEquals(i),t.maxScalarVelocity=i,t.velocity.setTo(s.x,s.y)}static calcProjectileForce(t,e,i){var s=e.clone();s.minusEquals(t.position),s.normalize(),s.multEquals(i),t.addForce(s)}}class We{constructor(t){this.count=t}}function Ge(t,e){return Math.random()*(e-t)+t}function De(t=.5){return Math.random()<t}function Ie(t=.5){return Math.random()<t?1:-1}function ze(t,e){return Math.floor(Ge(t,e))}const Oe=new C(0,9);class Ue{constructor(t,e){this.mass=t,this.power=e}update(t,e,i,s){for(let t=0;t<this.mass;t++){var n=Ge(0,2*Math.PI),r=Ge(0,2*this.power),o=Math.cos(n)*r,a=Math.sin(n)*r;s.EmitParticle(i.x,i.y,o,a,0,1,Ge(250,500),.999,!0,!0,Oe,4,255,255,0,0)}s.EmitParticle(i.x,i.y,o,a,0,1,Ge(250,500),.999,!0,!0,Oe,4,0,0,0,0)}}class ke{constructor(){this.origin=new C,this.target=new C,this.range=0,this.delta=new C,this.direction=new C,this.contact=new xt,this.bounds=new W}initalize(t,e,i,s){this.reset(),this.origin.copy(t),this.target.copy(e),this.delta.copy(e),this.delta.minusEquals(t),this.direction.copy(this.delta),this.direction.normalize(),i<=0?this.range=this.delta.length():(this.range=i,this.delta.copy(this.direction),this.delta.multEquals(i)),this.bounds.addPoint(this.origin.x,this.origin.y),this.bounds.addPoint(this.origin.x+this.delta.x,this.origin.y+this.delta.y),this.callback=s}reset(){this.contact.distance=9999999999,this.hit=!1}report(t,e,i,s,n=null){if(!(null!=this.callback&&null!=n&&this.callback(n)<0)){var r=t*t+e*e;r<this.contact.distance*this.contact.distance&&(this.contact.position.setTo(this.origin.x+t,this.origin.y+e),this.contact.normal.setTo(i,s),this.contact.distance=Math.sqrt(r),this.hit=!0)}}}class Ne{constructor(t){this.entity=t}static SortClosestFirst(t,e){return t.distance-e.distance}reset(){}}class Ve{constructor(){this.entities=new Array}addItem(t){const e=new Ne(t);return this.entities.push(e),e}getItem(t){return this.entities.find(e=>e.entity===t)}removeItem(t){this.entities=this.entities.filter(e=>e.entity!==t)}filter(t){this.entities=this.entities.filter(t)}clear(){this.entities.length=0}}class qe{constructor(t,e){this.engine=t,this.broadphase=e,this.entityCollection=new Ve,this.aabb=new Bt,this.ray=new ke,this.addBroadphaseItem=this.addBroadphaseItem.bind(this)}query(t,e,i,s){this.entityCollection.clear(),this.aabb.position.copy(t),this.aabb.extents.setTo(e,e),this.filterEntity=i,this.visibleCheck=s,this.broadphase.QueryArea(this.aabb,this.addBroadphaseItem,!0,!0)}addBroadphaseItem(t){if(null==this.filterEntity||t.entity!=this.filterEntity){var e=t.aabb.position.distSqrd(this.aabb.position)+L;if(e>qe.RAYCAST_THRESHOLD&&this.visibleCheck){const e=this.engine.getComponentForEntity(t.entity,T);if(this.ray.initalize(this.aabb.position,e.coords,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),this.ray.hit)return}var i=this.entityCollection.addItem(t.entity);i.distance=e,i.perspective=this.aabb.position}}}var He;qe.RAYCAST_THRESHOLD=10,function(t){t[t.ALL=0]="ALL",t[t.FRIENDLY=1]="FRIENDLY",t[t.ENEMY=2]="ENEMY"}(He||(He={}));class Xe{constructor(){}static setup(t,e){Xe.engine=t,Xe.broadphase=e,Xe.bfAreaQuery=new qe(t,e),Xe.ray=new ke}static CanSee(t,e,i){return!(t.distSqrd(e)>=i*i)&&(this.ray.initalize(t,e,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),!this.ray.hit)}static SearchSortAndFilter(t,e,i,s){return Xe.referenceEntity=i,Xe.bfAreaQuery.query(t,e,i,!0),Xe.bfAreaQuery.entityCollection}static explode(t,e,i,s){Xe.bfAreaQuery.query(t,e,s,!0),Xe.bfAreaQuery.entityCollection.entities.forEach(s=>{if(!Xe.engine.getComponentForEntity(s.entity,We)){var n=Xe.engine.getComponentForEntity(s.entity,Pe),r=Xe.engine.getComponentForEntity(s.entity,Jt);if(null!=n||null!=r){var o=e/Math.sqrt(s.distance)*i;if(null!=n&&n.applyDamage(o),null!=r){var a=r.body.position.clone();a.minusEquals(t),a.normalize(),a.multEquals(o),r.body.addForce(a)}}}})}}class Ye{constructor(t,e,i,s,n,r,o,a=0,h=0){this.range=t,this.attenuation=e,this.intensity=i,this.flicker=s,this.red=n,this.green=r,this.blue=o,this.arc=a,this.angle=h}}class je{constructor(t,e){this.rate=t,this.speed=e}update(t,e,i,s){s.EmitParticle(i.x,i.y,0,0,0,0,1e3,.9,!0,!0,null,ze(0,3),ze(16,32),Ie(.5),Ie(.5),0)}}class Je{constructor(t){this.emitters=t}}class Ke{static create(t,e,i,s){var n=new ne($t.LIGHTMETAL);n.setMass(24),n.setBounces(3),n.globalForceFactor=1,n.isBullet=!0,n.maxScalarVelocity=1e4,i.categoryBits|=Be.PROJECTILE_CAT,i.maskBits|=Be.PROJECTILE_COLLIDABLE_CAT;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Nt(2,2),new S("projectiles","standard"),new Jt(n,!0),new Yt,new qt(!1,i,[]),new Je([]),new Se(Ke.states,null,!1),new Fe(3,"destroy"),new Pe(10,10,0,"destroy"),new Te(1e3,"destroy"),new re,new Ee]),Me.calcProjectileVelocity(n,s,2e3),r}static onDestroy(t,e){t.getComponentForEntity(e,We)||(t.addComponentsToEntity(e,[new We(1)]),t.getComponentForEntity(e,xe).emitters.push(new Ue(10,50)))}}Ke.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,We)||(t.addComponentsToEntity(e,[new We(3),new Ye(64,1,1,1,255,255,255)]),t.removeComponentsFromEntityByType(e,[Jt]),t.getComponentForEntity(e,Je).emitters.push(new je(4,80)),Xe.explode(t.getComponentForEntity(e,T).coords,100,4e3,e))}};class Ze extends A{constructor(){super([We]),this.toDelete=new Array}updateEntity(t,e){e.count--<=0&&this.toDelete.push(t)}postUpdate(){this.toDelete.forEach(t=>this.engine.destroyEntity(t)),this.toDelete.length=0}}class Qe{}class $e{static create(t,e){var i=new bt;i.categoryBits=Be.PLAYER_CAT,i.maskBits|=Be.PROJECTILE_CAT,i.groupIndex=Be.PLAYER_GROUP;var s=new ne(new $t(1,.3,.1));s.maxScalarVelocity=0,s.maxVelocity.setTo(1600,1e3);var n=t.createEntity();return t.addComponentsToEntity(n,[new Qe,e,new Nt(7,20),new S("player"),new pt("player","idle"),new Jt(s,!0),new qt(!1,i,[]),new Yt,new re,new Ee]),n}}class ti{constructor(t,e,i){this.controlForce=new C,this.jumpUnit=new C,this.jumping=!1,this.isWalking=!1,this.originalFriction=0,this.burn=0,this.input=t,this.body=e,this.originalFriction=e.material.friction,this.originalVelocityClamp=e.maxVelocity.clone(),this.setBaseForce(i)}setBaseForce(t){this.BASE_FORCE=600,this.WALK_FORCE=2*this.BASE_FORCE,this.AIR_CONTROL_FORCE=1*this.BASE_FORCE,this.JUMP_FORCE=30*this.BASE_FORCE,this.MAX_AIR_HORIZONTAL_VELOCITY=.5*this.BASE_FORCE,this.MAX_BURN=5*this.BASE_FORCE,this.BOOST_FACTOR=1.4}update(){this.controlForce.setTo(0,0),this.left=this.input.PressedDuration(65),this.right=this.input.PressedDuration(68);var t=this.input.JustPressed(87),e=this.input.PressedDuration(87);if(this.down=this.input.PressedDuration(83),this.boost=this.input.PressedDuration(16),!this.jumping&&this.body.onGround&&t&&(this.jumping=!0,this.controlForce.y-=this.JUMP_FORCE/5),(this.jumping&&this.input.Released(87)||this.body.contactNormal.y>0)&&(this.jumping=!1),this.body.onGround&&!this.body.onGroundPrev&&(this.burn=0),this.body.onGround)this.left>0&&(this.controlForce.x-=this.WALK_FORCE),this.right>0&&(this.controlForce.x+=this.WALK_FORCE),t&&(this.controlForce.y-=this.JUMP_FORCE);else{this.left>0&&(this.controlForce.x-=this.AIR_CONTROL_FORCE),this.right>0&&(this.controlForce.x+=this.AIR_CONTROL_FORCE);t&&(this.burn=this.MAX_BURN),e>0&&(this.burn+=this.BASE_FORCE)}this.boost>0?this.burn=Math.min(this.burn,this.MAX_BURN*this.BOOST_FACTOR):this.burn=Math.min(this.burn,this.MAX_BURN),this.controlForce.y-=this.burn,this.burn*=.95,this.isWalking=this.body.onGround&&(this.left>0||this.right>0),this.isWalking,this.body.addForce(this.controlForce)}}class ei{constructor(t,e){this.maxAcceleration=t,this.maxSteeringForcePerStep=e}}ei.default_scale=.2,ei.heavy_scale=5,ei.default_maxAcceleration=100,ei.default_maxSteeringForcePerStep=100;const ii=new ei(ei.default_maxAcceleration*ei.default_scale,ei.default_maxSteeringForcePerStep*ei.default_scale),si=new ei(ei.default_maxAcceleration*ei.heavy_scale,ei.default_maxSteeringForcePerStep*ei.heavy_scale);class ni{constructor(t,e=null,i=ni.CALCULATE_SUM){this.behaviors=t,this.steeringParameters=null==e?ii:e,this.hasChanged=!0}addBehavior(t){this.behaviors.push(t),this.hasChanged=!0}removeBehaviour(t){this.behaviors.splice(this.behaviors.indexOf(t),1),this.hasChanged=!0}getBehaviour(t){return this.behaviors.find(e=>e.constructor.name===t.name)}}ni.CALCULATE_SUM=0,ni.CALCULATE_SPEED=1,ni.CALCULATE_ACCURACY=2;class ri{constructor(t=1,e=1,i=1,s=!0){this.weight=t,this.priority=e,this.probability=i,this.active=s}calculate(t,e,i){}}class oi{}oi.speedTweaker=.3,oi.arriveFast=1,oi.arriveNormal=3,oi.arriveSlow=5,oi.wanderJitter=300,oi.wanderDistance=25,oi.wanderRadius=15,oi.separationProbability=.2,oi.cohesionProbability=.6,oi.alignmentProbability=.3,oi.dodgeProbability=.6,oi.seekProbability=.8,oi.fleeProbability=.6,oi.pursuitProbability=.8,oi.evadeProbability=1,oi.offsetPursuitProbability=.8,oi.arriveProbability=.5,oi.obstacleAvoidanceProbability=.5,oi.wallAvoidanceProbability=.5,oi.hideProbability=.8,oi.followPathProbability=.7,oi.interposeProbability=.8,oi.wanderProbability=.8,oi.separationWeight=1,oi.alignmentWeight=3,oi.cohesionWeight=2,oi.dodgeWeight=1,oi.seekWeight=1,oi.fleeWeight=1,oi.pursuitWeight=1,oi.evadeWeight=.1,oi.offsetPursuitWeight=1,oi.arriveWeight=1,oi.obstacleAvoidanceWeight=10,oi.wallAvoidanceWeight=10,oi.hideWeight=1,oi.followPathWeight=.5,oi.interposeWeight=1,oi.wanderWeight=1,oi.wallAvoidancePriority=10,oi.obstacleAvoidancePriority=20,oi.evadePriority=30,oi.hidePriority=35,oi.seperationPriority=40,oi.alignmentPriority=50,oi.cohesionPriority=60,oi.dodgePriority=65,oi.seekPriority=70,oi.fleePriority=80,oi.arrivePriority=90,oi.pursuitPriority=100,oi.offsetPursuitPriority=110,oi.interposePriority=120,oi.followPathPriority=130,oi.wanderPriority=140;class ai extends ri{constructor(t,e=0){super(oi.seekWeight,oi.seekPriority),this.target=t,this.seekDist=e}calculate(t,e,i){ai.calc(t,e,i,this.target,this.seekDist)}static calc(t,e,i,s,n=0){const r=s.x-t.position.x+1e-6,o=s.y-t.position.y+1e-6,a=r*r+o*o;if(n>0&&a<n*n)return!1;const h=Math.sqrt(a);return i.x=r/h,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.y=o/h,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,!0}}class hi extends ri{constructor(t=8,e=1,i=4){super(oi.wanderWeight,oi.wanderPriority),this.circleCenter=new C,this.displacement=new C,this.circleRadius=t,this.circleDistance=e,this.wanderAngle=Ge(0,2*Math.PI),this.wanderChange=i}calculate(t,e,i){this.wanderAngle+=Ge(-this.wanderChange,this.wanderChange),this.circleCenter.copy(t.velocity),this.circleCenter.normalize(),this.circleCenter.multEquals(this.circleDistance),this.circleCenter.plusEquals(t.position);var s=Math.atan2(t.velocity.y,t.velocity.x);s+=Math.PI/2,this.displacement.setTo(this.circleRadius*Math.cos(this.wanderAngle+s),this.circleRadius*Math.sin(this.wanderAngle+s)),this.circleCenter.plusEquals(this.displacement),ai.calc(t,e,i,this.circleCenter,0)}}class li{constructor(t,e){this.angle=t,this.length=e,this.base=new C,this.tip=new C,this.closestIP=new C,this.ip=new C,this.normal=new C,this.sf=new C}Reset(t,e){if(this.distToClosestIP=_,this.tip.copy(t),this.base.copy(e),0!=this.angle){const e=Math.atan2(t.y,t.x)+this.angle;this.tip.x=Math.cos(e),this.tip.y=Math.sin(e)}this.tip.multEquals(this.length),this.tip.plusEquals(this.base),w.debugRender.DrawLine(this.tip.x,this.tip.y,this.base.x,this.base.y)}TestSegment(t,e,i){var s=function(t,e,i,s,n){const r=(t.y-i.y)*(s.x-i.x)-(t.x-i.x)*(s.y-i.y),o=(t.y-i.y)*(e.x-t.x)-(t.x-i.x)*(e.y-t.y),a=(e.x-t.x)*(s.y-i.y)-(e.y-t.y)*(s.x-i.x),h=(e.x-t.x)*(s.y-i.y)-(e.y-t.y)*(s.x-i.x);if(0==a||0==h)return-1;const l=r/a,c=o/h;return l>0&&l<1&&c>0&&c<1?(n.x=t.x+l*(e.x-t.x),n.y=t.y+l*(e.y-t.y),t.distSqrd(e)*l):0}(this.base,this.tip,t,e,this.ip);s>0&&s<this.distToClosestIP&&(this.distToClosestIP=s,this.closestIP.copy(this.ip),this.normal.copy(i))}CalculateForce(t){this.distToClosestIP!=_&&(this.sf.copy(this.tip),this.sf.minusEquals(this.closestIP),this.normal.multEquals(this.sf.length()),t.plusEquals(this.normal),w.debugRender.DrawLine(this.tip.x,this.tip.y,this.base.x,this.base.y))}}class ci extends ri{constructor(t){super(oi.wallAvoidanceWeight,oi.wallAvoidancePriority),this.pA=new C,this.pB=new C,this.top=new C(0,-1),this.right=new C(1,0),this.bottom=new C(0,1),this.left=new C(-1,0),this.searchAABB=new W,this.tempVector=new C,this.closestFeeler=null,this.closestDist=_,this.checkAABB=t=>{for(var e=0;e<this.feelers.length;e++){const i=this.feelers[e];this.pA.setTo(t.l,t.t),this.pB.setTo(t.r,t.t),i.TestSegment(this.pA,this.pB,this.top),this.pA.setTo(t.r,t.b),i.TestSegment(this.pB,this.pA,this.right),this.pB.setTo(t.l,t.b),i.TestSegment(this.pA,this.pB,this.bottom),this.pA.setTo(t.l,t.t),i.TestSegment(this.pB,this.pA,this.left),i.distToClosestIP<this.closestDist&&(this.closestDist=i.distToClosestIP,this.closestFeeler=i)}},this.feelerLength=t,this.ptv1=new C,this.ptv2=new C,this.feelers=new Array,this.feelers.push(new li(0,t)),this.feelers.push(new li(M(-40),.5*t)),this.feelers.push(new li(M(40),.5*t)),this.lastPos=new C}calculate(t,e,i){if(!(this.lastPos.distSqrd(t.position)<1)){this.lastPos.copy(t.position),this.tempVector.copy(t.velocity),this.tempVector.normalize(),this.searchAABB.reset(),this.searchAABB.addPoint(t.position.x,t.position.y);for(var s=0;s<this.feelers.length;s++){const e=this.feelers[s];e.Reset(this.tempVector,t.position),this.searchAABB.addPoint(e.tip.x,e.tip.y)}this.closestFeeler=null,this.closestDist=_,e.map.iterateCells(this.searchAABB,this.checkAABB),null!=this.closestFeeler&&this.closestFeeler.CalculateForce(i)}}}class di{static create(t,e){var i=new ne(new $t(.1,.3,0));i.setMass(.1),i.setBounces(0),i.globalForceFactor=0,i.maxScalarVelocity=200;var s=t.createEntity();return t.addComponentsToEntity(s,[e,new Nt(1.5,1.5),new S("insects"),new pt("insects","firefly"),new Jt(i,!0),new Yt,new qt(!1,null,[]),new ni([new hi(80,40,143.5),new ai(e.coords.clone(),32),new ci(40)],si),new Se(di.states,null,!1),new Te(1e4,"destroy"),new Pe(10,10,0,"destroy"),new re]),s}static onDestroy(t,e){t.getComponentForEntity(e,We)||t.addComponentsToEntity(e,[new We(1)])}}di.states={destroy:function(t,e){t.getComponentForEntity(e,We)||t.addComponentsToEntity(e,[new We(1)])}};class ui{constructor(t){this.holder=t}}class pi{constructor(t){this.activate=!1,this.heldItem=null,this.parent=null,this.parent=t}static drop(t,e){if(null!=e.heldItem){const i=e.heldItem;return t.removeComponentsFromEntityByType(e.heldItem,[ui]),e.heldItem=null,i}return null}}class gi{constructor(t,e){this.rate=t,this.speed=e}update(t,e,i,s){const n=e(Jt).body.velocity;for(let t=0;t<5;t++){var r=Ge(0,2*Math.PI),o=n.x+Math.cos(r)*this.speed*Ge(0,2),a=n.y+Math.sin(r)*this.speed*Ge(0,2);s.EmitParticle(i.x,i.y,o,a,0,0,100,.7,!0,!0,null,4,255,229,252,114)}}}class mi{static create(t,e,i,s){var n=new ne($t.LIGHTMETAL);n.setMass(.3),n.setBounces(0),n.globalForceFactor=.1,n.isBullet=!0,n.maxScalarVelocity=1e4,i.categoryBits|=Be.PROJECTILE_CAT,i.maskBits|=Be.PROJECTILE_COLLIDABLE_CAT;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Nt(2,2),new S("projectiles","plasma"),new Jt(n,!0),new Yt,new qt(!1,i,[]),new xe([new gi(0,400)]),new Se(mi.states,null,!1),new Fe(1,"destroy"),new Pe(10,10,0,"destroy"),new Te(2e3,"destroy"),new Ye(160,1,1,1,255,255,255,0),new Ee,new re]),Me.calcProjectileVelocity(n,s,600),r}static onDestroy(t,e){t.getComponentForEntity(e,We)||(t.addComponentsToEntity(e,[new We(1)]),t.getComponentForEntity(e,xe).emitters.push(new Ue(10,50)))}}mi.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,We)||(t.addComponentsToEntity(e,[new We(1)]),t.getComponentForEntity(e,xe).emitters.push(new Ue(10,50)),Xe.explode(t.getComponentForEntity(e,T).coords,100,1e4,e))}};class yi{constructor(){this.parent=-1,this.children=[],this.level=0}static addChild(t,e,i){var s=t.getComponentForEntity(e,yi);if(s||(s=new yi,t.addComponentsToEntity(e,[s])),-1==s.children.indexOf(i)){var n=t.getComponentForEntity(i,yi);n?n.parent&&yi.removeChild(t,n.parent,i):(n=new yi,t.addComponentsToEntity(i,[n])),n.parent=e,n.level=s.level+1,s.children.push(i),n.children.length>0&&yi.updateChildLevel(t,n)}}static removeChild(t,e,i){const s=t.getComponentForEntity(e,yi);if(s){const e=s.children.indexOf(i);if(e>0){const n=t.getComponentForEntity(i,yi);n&&(n.parent=null,n.level=0,s.children.splice(e,1))}}}static updateChildLevel(t,e){for(let i of e.children){const s=t.getComponentForEntity(i,yi);s.level=e.level+1,s.children.length>0&&yi.updateChildLevel(t,s)}}}class xi{constructor(t){this.point=t}}var bi;!function(t){t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.Enter=13]="Enter",t[t.Shift=16]="Shift",t[t.Ctrl=17]="Ctrl",t[t.Alt=18]="Alt",t[t.PauseBreak=19]="PauseBreak",t[t.CapsLock=20]="CapsLock",t[t.Escape=27]="Escape",t[t.Space=32]="Space",t[t.PageUp=33]="PageUp",t[t.PageDown=34]="PageDown",t[t.End=35]="End",t[t.Home=36]="Home",t[t.LeftArrow=37]="LeftArrow",t[t.UpArrow=38]="UpArrow",t[t.RightArrow=39]="RightArrow",t[t.DownArrow=40]="DownArrow",t[t.Insert=45]="Insert",t[t.Delete=46]="Delete",t[t.Zero=48]="Zero",t[t.ClosedParen=48]="ClosedParen",t[t.One=49]="One",t[t.ExclamationMark=49]="ExclamationMark",t[t.Two=50]="Two",t[t.AtSign=50]="AtSign",t[t.Three=51]="Three",t[t.PoundSign=51]="PoundSign",t[t.Hash=51]="Hash",t[t.Four=52]="Four",t[t.DollarSign=52]="DollarSign",t[t.Five=53]="Five",t[t.PercentSign=53]="PercentSign",t[t.Six=54]="Six",t[t.Caret=54]="Caret",t[t.Hat=54]="Hat",t[t.Seven=55]="Seven",t[t.Ampersand=55]="Ampersand",t[t.Eight=56]="Eight",t[t.Star=56]="Star",t[t.Asterik=56]="Asterik",t[t.Nine=57]="Nine",t[t.OpenParen=57]="OpenParen",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.LeftWindowKey=91]="LeftWindowKey",t[t.RightWindowKey=92]="RightWindowKey",t[t.SelectKey=93]="SelectKey",t[t.Numpad0=96]="Numpad0",t[t.Numpad1=97]="Numpad1",t[t.Numpad2=98]="Numpad2",t[t.Numpad3=99]="Numpad3",t[t.Numpad4=100]="Numpad4",t[t.Numpad5=101]="Numpad5",t[t.Numpad6=102]="Numpad6",t[t.Numpad7=103]="Numpad7",t[t.Numpad8=104]="Numpad8",t[t.Numpad9=105]="Numpad9",t[t.Multiply=106]="Multiply",t[t.Add=107]="Add",t[t.Subtract=109]="Subtract",t[t.DecimalPoint=110]="DecimalPoint",t[t.Divide=111]="Divide",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NumLock=144]="NumLock",t[t.ScrollLock=145]="ScrollLock",t[t.SemiColon=186]="SemiColon",t[t.Equals=187]="Equals",t[t.Comma=188]="Comma",t[t.Dash=189]="Dash",t[t.Period=190]="Period",t[t.UnderScore=189]="UnderScore",t[t.PlusSign=187]="PlusSign",t[t.ForwardSlash=191]="ForwardSlash",t[t.Tilde=192]="Tilde",t[t.GraveAccent=192]="GraveAccent",t[t.OpenBracket=219]="OpenBracket",t[t.ClosedBracket=221]="ClosedBracket",t[t.Quote=222]="Quote"}(bi||(bi={}));class fi{constructor(t=0){this.size=t,this.data=[]}push(t){return this.data.push(t),this.data.length===this.size?this.data.splice(0,1):null}pop(){return this.data.pop()}}class vi extends A{constructor(t,e){super([T,Qe,qt,Jt,pt,Nt]),this.currentWeapon=0,this.input=t,this.particleEngine=e,this.teleporterLocations=new fi(5),this.mousePosition=new C}onEntityAdded(t,e,i,s,n,r,o){if(this.members.size>1)throw new Error("Only one player allowed");n.body.usesStairs=!0,this.characterController=new ti(this.input,n.body,800),this.playerLight=new Ye(256,1,1,0,255,255,0,1),this.holder=new pi(t),this.playerHolder=this.engine.createEntity(),this.engine.addComponentsToEntity(this.playerHolder,[new T(0,0),new xi(new C(0,0)),o,this.holder,new qt(!0,new bt(1,0,Be.PLAYER_GROUP),[],!1,n.body),new Yt,new re]),yi.addChild(this.engine,t,this.playerHolder)}updateEntity(t,e,i,s,n,r,o){this.characterController.update(),n.body.onGround&&Math.abs(n.body.velocity.x)>10?r.play("runright"):n.body.onGround?r.play("idle"):r.play("fly"),this.characterController.left>0&&(e.direction.x=-1),this.characterController.right>0&&(e.direction.x=1),n.body.collideOneWay=!(this.characterController.down>0),this.input.ViewCorrectedMousePosition(this.mousePosition);const a=this.input.JustPressed(bi.Space);if(this.input.Pressed(bi.U)&&di.create(this.engine,e.clone()),this.holder.activate=this.input.JustPressed(bi.H),this.input.JustPressed(bi.J))pi.drop(this.engine,this.holder);else if(this.input.JustPressed(bi.K)){const t=pi.drop(this.engine,this.holder);null!=t&&Me.calcProjectileVelocity(this.engine.getComponentForEntity(t,Jt).body,this.mousePosition.clone(),700)}if(a&&(0==this.currentWeapon&&Ke.create(this.engine,e.clone(),s.proxy.filter.clone(),this.mousePosition.clone()),1==this.currentWeapon&&mi.create(this.engine,e.clone(),s.proxy.filter.clone(),this.mousePosition.clone())),this.input.Pressed(bi.E)){var h=this.mousePosition.clone();h.minusEquals(e.coords),h.normalize(),h.multEquals(2e3),this.particleEngine.EmitParticle(e.coords.x,e.coords.y,h.x,h.y,0,0,200,1,!1,!0,null,4,255,255,255,255)}if(this.characterController.burn>0){const t=280;var l=e.coords.x-8*e.direction.x,c=300+Ge(-150,150)+n.body.velocity.y,d=Math.floor((this.characterController.burn+500)/1e3);d>0&&this.particleEngine.EmitParticle(l,e.coords.y+8,Ge(-10,10)+n.body.velocity.x,c,0,0,40,.9,!1,!1,null,4,255,255,0,0);for(var u=0;u<d;u++)this.particleEngine.EmitParticle(l,e.coords.y+8,Ge(-50,50)+n.body.velocity.x,c,0,0,t,.9,!0,!0,null,4,255,255,255,255)}this.input.JustPressed(bi.One)&&(this.currentWeapon=0),this.input.JustPressed(bi.Two)&&(this.currentWeapon=1),this.input.JustPressed(bi.L)&&(this.engine.getComponentForEntity(t,Ye)?this.engine.removeComponentsFromEntityByType(t,[Ye]):this.engine.addComponentsToEntity(t,[this.playerLight]));const p=this.mousePosition.clone();if(p.minusEquals(e.coords),p.normalize(),this.playerLight.angle=p.heading(),this.input.JustPressed(bi.R)&&this.teleporterLocations.push(e.coords.clone()),this.input.JustPressed(bi.T)){const t=this.teleporterLocations.pop();t&&n.body.position.copy(t)}}}class Ci{constructor(t,e,i,s,n){this.direction=new C,this.direction.setUnitRotation(t-90),this.minForce=e,this.maxForce=i,this.minDuration=s,this.maxDuration=n}}class wi{constructor(t){this.direction=new C,this.power=0,this.ttl=0,this.data=t}}class Ei extends A{constructor(){super([qt,Nt,wi,re]),this.temp=new C,this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){e.proxy.contactCallbacks.push(this.callback),this.setActiveForce(s,0)}updateEntity(t,e,i,s,n){s.ttl>0&&(s.ttl-=this.dt,s.ttl)}onFinished(t){t.currentIndex++,t.currentIndex>=t.data.length&&(t.currentIndex=0),this.setActiveForce(t,t.currentIndex)}setActiveForce(t,e){t.currentIndex=e;var i=t.data[e];t.direction.copy(i.direction),t.power=i.maxForce,t.ttl=0==i.minDuration?-1:Ge(1e3*i.minDuration,1e3*i.maxDuration)}callback(t,e,i){var s=t.aabb.overlapArea(e.aabb),n=this.engine.getComponentForEntity(t.entity,wi);this.temp.copy(n.direction),this.temp.multEquals(n.power*s),e.body.addForce(this.temp)}}function Ai(t){return new T(Si(t.x+t.width/2),Si(t.y+t.height/2))}function Ti(t){return new Nt(Si(t.width/2),Si(t.height/2))}function Si(t){return 2*t}class Ri{constructor(t){this.particlePerUnitPerFrame=t,this.particleCount=0,this.incPerFrame=0}}class Pi{static createTMXEntity(t,e){const i=t.createEntity(e.name);var s=[];s.push(Ai(e)),s.push(Ti(e)),s.push(new qt(!0,null,[])),s.push(new Ht),s.push(new re(!0));var n=[];return e.properties.forEach(t=>{const e=t.value.split(",").map(parseFloat);n.push(new Ci(e[0],e[1]*Pi.FORCE_SCALE,e[2]*Pi.FORCE_SCALE,e[3],e[4]))}),s.push(new wi(n)),s.push(new Ri(.001)),t.addComponentsToEntity(i,s),i}}Pi.FORCE_SCALE=.01,Pi.mapping="Force";class Li{constructor(t,e,i){this.radius=t,this.maxLights=e,this.lightingShader=i,this.lights=[];for(let t=0;t<this.maxLights;t++)this.lights.push(new Fi);this.reset()}reset(){this.activeLights=0}addLight(t,e,i,s,n,r,o=0,a=0){const h=this.lights[this.activeLights++];h.x=t,h.y=e,h.intensity=i,h.red=255*s,h.green=255*n,h.blue=255*r,h.arc=o,h.angle=a}}class Fi{}var _i="precision mediump float;\n\nuniform vec2 projectionVector;\nuniform vec2 viewOffset;\n\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aColor;\nattribute vec3 aArc;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying vec3 vArc;\n\nvoid main(void) {\n    gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n    vColor = aColor;\n    vArc = aArc;\n}";const Bi=32,Mi=50,Wi=(t,e)=>"precision mediump float;\n\nconst int PATH_TRACKING_SAMPLES = ${count};\nconst float INV_PATH_TRACKING_SAMPLES = 1.0 / float(PATH_TRACKING_SAMPLES);\nconst vec2 EMPTY_TILE = vec2(1.0, 1.0);\nconst float LIGHT_TO_MAP_RESOLUTION_RATIO = float(${ratio});\n\nuniform sampler2D uSampler;\nuniform vec2 viewOffset;\nuniform vec2 resolution;\nuniform vec2 inverseTileTextureSize;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying vec3 vArc;\n\nvoid main(void) {\n    vec2 fragToCenterPos = vTextureCoord.xy;\n    float d = length(fragToCenterPos) / float(PATH_TRACKING_SAMPLES);\n\n    vec2 pos = vec2(gl_FragCoord.x - 1., resolution.y - gl_FragCoord.y);\n\n    vec2 currentPos = (pos - viewOffset) - vec2(0.0,1.0); // * inverseTileTextureSize;\n    vec2 centerPos = currentPos - fragToCenterPos; // * inverseTileTextureSize;\n\n    float m = INV_PATH_TRACKING_SAMPLES * d; // * 0.5;\n\n    float light = 1. - d; // Linear\n    \n    // float light = pow(1. - d, 5.); // Ease in\n    // float light = 1. - pow(1. - (1. - d), 3.); // Ease out\n\n    // Torch\n    float cone = 1.;\n    if (bool(vArc.z)) {\n        vec2 dir = vArc.xy;\n        float projection = dot(dir, normalize(fragToCenterPos));\n        cone *= smoothstep(0.5 ,0.7, projection);\n        // cone *= float( projection < 0.8 );\n    }\n    \n    float obs = light * cone;\n\n    vec2 scaledTilesSize = inverseTileTextureSize * LIGHT_TO_MAP_RESOLUTION_RATIO;\n\n    float stepPos = 0.;\n    for(int i = 0; i < PATH_TRACKING_SAMPLES; i++)\n    {\n        stepPos += INV_PATH_TRACKING_SAMPLES; \n        vec4 tile = texture2D(uSampler, floor(mix(centerPos, currentPos, stepPos)) * scaledTilesSize);\n        float obsMult = float(all(lessThan(tile.xy, EMPTY_TILE)));\n        obs -= m * obsMult;\n    }\n    float addition = clamp(obs,0.,1.);\n    gl_FragColor = vec4(vColor.r,vColor.g,vColor.b,addition);\n}".replace("${count}",t).replace("${ratio}",e);class Gi{constructor(t,e){this.quadVerts=new Float32Array([-1,-1,1,-1,1,1,-1,1]),this.ranges=t,this.renderSurface=this.renderSurface.bind(this),this.snapPosition=new C(-1e3,-1e3),this.layer=e,this.tileSize=8,this.halfTileSize=this.tileSize/2,this.backgroundLight=0}Init(t,e){this.gl=t,this.camera=e,this.projection=new C,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.resolution=new C,this.sprite=new X,this.sprite.blendEquation=WebGLRenderingContext.FUNC_ADD,this.sprite.blendFuncS=WebGLRenderingContext.DST_COLOR,this.sprite.blendFuncD=WebGLRenderingContext.ZERO,this.sprite.id="lightTexture",this.ResizeBatch(this.ranges.length*Mi),this.lightGroups=this.ranges.map(e=>new Li(e,Mi,new K(t,J(t,_i,Wi(e/this.tileSize,.5))))),this.lightGroupsMap=new Array(this.ranges[this.ranges.length-1]),this.ranges.forEach((t,e)=>{this.lightGroupsMap[t]=this.lightGroups[e]})}ResizeBatch(t){this.size=t,this.arrayBuffer=new ArrayBuffer(this.size*Bi),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=new Uint16Array(6*this.size);for(let t=0;t<this.size;t++){const e=6*t,i=4*t;this.indices[e+0]=i+0,this.indices[e+1]=i+1,this.indices[e+2]=i+2,this.indices[e+3]=i+0,this.indices[e+4]=i+2,this.indices[e+5]=i+3}this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)}Resize(t,e){const i=this.resolution.x=Math.floor(t/this.tileSize)+2,s=this.resolution.y=Math.floor(e/this.tileSize)+2;this.projection.x=i*this.tileSize/2,this.projection.y=s*this.tileSize/2,this.surface=new z(this.gl,i,s),this.texture=new U(this.surface,new O(0,0,i,s),new C(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(this.tileSize,-this.tileSize),this.sprite.pivot.setTo(i/2,s/2)}reset(){for(const t of this.lightGroups)t.reset()}addUnblockedLight(t,e,i,s,n,r){}addBlockedLight(t,e,i,s,n,r,o,a){const h=this.lightGroupsMap[Math.round(i)];h&&h.addLight(t,e,i,s,n,r,o,a)}processLightsBatch(){let t=0;for(const e of this.lightGroups)for(let i=0;i<e.activeLights;i++){const s=e.lights[i],n=t*Bi;let r=4*n;const o=s.intensity+this.halfTileSize,a=s.intensity/this.tileSize;let h=s.x,l=s.y;h+=Math.floor(this.camera.position.x/this.tileSize)*this.tileSize,l+=Math.floor(this.camera.position.y/this.tileSize)*this.tileSize,h+=2*this.tileSize,l+=2*this.tileSize;const c=Math.cos(s.angle),d=Math.sin(s.angle),u=s.arc;this.data[n+0]=h+this.quadVerts[0]*o,this.data[n+1]=l+this.quadVerts[1]*o,this.data[n+2]=this.quadVerts[0]*a,this.data[n+3]=this.quadVerts[1]*a,this.data8[r+16]=s.red,this.data8[r+17]=s.green,this.data8[r+18]=s.blue,this.data8[r+19]=1,this.data[n+5]=c,this.data[n+6]=d,this.data[n+7]=u,this.data[n+8]=h+this.quadVerts[2]*o,this.data[n+9]=l+this.quadVerts[3]*o,this.data[n+10]=this.quadVerts[2]*a,this.data[n+11]=this.quadVerts[3]*a,this.data8[r+48]=s.red,this.data8[r+49]=s.green,this.data8[r+50]=s.blue,this.data8[r+51]=1,this.data[n+13]=c,this.data[n+14]=d,this.data[n+15]=u,this.data[n+16]=h+this.quadVerts[4]*o,this.data[n+17]=l+this.quadVerts[5]*o,this.data[n+18]=this.quadVerts[4]*a,this.data[n+19]=this.quadVerts[5]*a,this.data8[r+80]=s.red,this.data8[r+81]=s.green,this.data8[r+82]=s.blue,this.data8[r+83]=1,this.data[n+21]=c,this.data[n+22]=d,this.data[n+23]=u,this.data[n+24]=h+this.quadVerts[6]*o,this.data[n+25]=l+this.quadVerts[7]*o,this.data[n+26]=this.quadVerts[6]*a,this.data[n+27]=this.quadVerts[7]*a,this.data8[r+112]=s.red,this.data8[r+113]=s.green,this.data8[r+114]=s.blue,this.data8[r+115]=1,this.data[n+29]=c,this.data[n+30]=d,this.data[n+31]=u,t++}}calcSnap(t){this.snapPosition.x=Math.floor(t.x/this.tileSize)*this.tileSize,this.snapPosition.y=Math.floor(t.y/this.tileSize)*this.tileSize,this.snapPosition.x+=this.tileSize,this.snapPosition.y+=this.tileSize}Background(t){this.backgroundLight=t}Render(t){this.processLightsBatch(),this.calcSnap(this.camera.position);const e=this.camera.position.y/this.camera.worldExtentsAABB.height;this.Background(Math.abs(e)),this.sprite.position.copy(this.camera.halfViewportSize),this.sprite.position.minusEquals(this.snapPosition),this.surface.drawTo(this.renderSurface)}renderSurface(){this.gl.clearColor(1-this.backgroundLight,1-this.backgroundLight,1-this.backgroundLight,0),this.gl.colorMask(!0,!0,!0,!1),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.layer.tileDataTexture);let t=0;for(const e of this.lightGroups)0!=e.activeLights&&(this.gl.useProgram(e.lightingShader.program),this.gl.uniform2f(e.lightingShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.uniform2f(e.lightingShader.uniform.resolution,this.resolution.x,this.resolution.y),this.gl.uniform2f(e.lightingShader.uniform.viewOffset,this.snapPosition.x/this.tileSize,this.snapPosition.y/this.tileSize),this.gl.uniform2fv(e.lightingShader.uniform.inverseTileTextureSize,this.layer.inverseTileDataTextureSize),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aColor),this.gl.vertexAttribPointer(e.lightingShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,32,0),this.gl.vertexAttribPointer(e.lightingShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,32,8),this.gl.vertexAttribPointer(e.lightingShader.attribute.aColor,4,WebGLRenderingContext.UNSIGNED_BYTE,!0,32,16),this.gl.vertexAttribPointer(e.lightingShader.attribute.aArc,3,WebGLRenderingContext.FLOAT,!1,32,20),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*e.activeLights,WebGLRenderingContext.UNSIGNED_SHORT,t),t+=12*e.activeLights);this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.colorMask(!0,!0,!0,!0)}}class Di extends A{constructor(t,e){super([T,Ye,Ee]),this.map=t,this.renderer=new Gi([64,160,256,320,480],e)}preUpdate(){return this.renderer.reset(),!0}updateEntity(t,e,i,s){i.flicker>0?this.renderer.addBlockedLight(e.coords.x+Ge(-10,10),e.coords.y+Ge(-10,10),i.range*i.intensity,i.red,i.green,i.blue,i.arc,i.angle):this.renderer.addBlockedLight(e.coords.x,e.coords.y,i.range*i.intensity,i.red,i.green,i.blue,i.arc,i.angle)}onEntityRemoved(t,...e){console.log("removed light")}nexLightIntensity(t){return e=t+(Math.random()-.3)/10,i=0,s=1,Math.min(Math.max(e,i),s);var e,i,s}}class Ii extends A{constructor(t){super([Jt,ni]),this.behaviorForce=new C,this.totalForce=new C,this.map=t}updateEntity(t,e,i){i.hasChanged&&(i.steeringParameters.map=this.map,i.behaviors.sort(this.behaviorsCompare),i.hasChanged=!1),this.runningSum(i,e.body),e.body.addProportionalForce(this.totalForce)}runningSum(t,e){this.totalForce.setTo(0,0);for(var i=0;i<t.behaviors.length;i++){const s=t.behaviors[i];s.active&&(this.behaviorForce.setTo(0,0),s.calculate(e,t.steeringParameters,this.behaviorForce),this.behaviorForce.multEquals(s.weight),this.totalForce.plusEquals(this.behaviorForce))}this.totalForce.clampScalar(t.steeringParameters.maxAcceleration)}behaviorsCompare(t,e){return t.priority<e.priority?-1:t.priority==e.priority?0:1}}var zi;!function(t){t.Destroy="destroy"}(zi||(zi={}));class Oi{constructor(t){this.maxMembers=t,this.members=new Set,this.messages=new p,this.onMemberMessage=this.onMemberMessage.bind(this)}addMember(t,e){this.hasCapacity()&&(this.members.add(t),e.messages.add(this.onMemberMessage))}removeMember(t){this.members.delete(t)}onMemberMessage(t,e){switch(e){case zi.Destroy:this.removeMember(t)}}hasCapacity(){return this.members.size<this.maxMembers}}class Ui{constructor(t){this.group=new Oi(t)}}class ki extends A{constructor(){super([Ui,Ee,re])}onEntityRemoved(t,e,i,s){e.group.members.forEach(t=>{this.engine.getComponentForEntity(t,Se).setState(zi.Destroy)})}updateEntity(t,e,i,s){if(e.group.hasCapacity()&&De(.01)){const i=di.create(this.engine,this.engine.getComponentForEntity(t,T).clone()),s=this.engine.getComponentForEntity(i,Se);e.group.addMember(i,s)}}}class Ni{constructor(t=0){this.reset(t)}reset(t=0){this.current=0,this.intervalTime=t,this.intervals=0}tick(t){return this.current+=t,this.current>this.intervalTime&&(this.current=0,this.intervals++,!0)}}class Vi{constructor(t){this.triggered=!1,this.radius=100,this.group=new Oi(t),this.intervalDelay=new Ni(1e3)}}class qi{constructor(){this.stack=new Array}update(t,e){var i=this.getCurrentState();null!=i&&i(t,this,e)}popState(){return this.stack.pop()}popAllStates(){for(;this.stack.length>0;)this.popState()}pushState(t){this.stack.push(t)}setState(t){this.popState(),this.pushState(t)}resetState(t){this.popAllStates(),this.pushState(t)}getCurrentState(){return this.stack.length>0?this.stack[this.stack.length-1]:null}}class Hi{constructor(t){this.nest=t,this.ai=new qi,this.delay=new Ni(1e3),this.chaseCheck=new Ni(500)}}class Xi extends ri{constructor(t,e=0,i=0){super(oi.seekWeight,oi.seekPriority),this.target=t,this.arrivalZone=e,this.seekDist=i}calculate(t,e,i){Xi.calc(t,e,i,this.target,this.arrivalZone,this.seekDist)}static calc(t,e,i,s,n,r){var o=s.x-t.position.x+1e-6,a=s.y-t.position.y+1e-6,h=o*o+a*a;if(r>0&&h<r*r)return!1;var l=Math.sqrt(h),c=1;return l<n&&(c=l/n),i.x=o/l,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.x*=c,i.y=a/l,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,i.x*=c,!0}}class Yi{static create(t,e,i,s){var n=new ne(new $t);n.setMass(1),n.setBounces(0),n.globalForceFactor=0,n.maxScalarVelocity=200;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Hi(s),new Nt(4,4),new S("bird"),new Jt(n,!1),new Yt,new qt(!1,null,[]),new pt("bird","fly"),new ni([new hi(55,80,.3),new Xi(i.coords,256),new ci(60)]),new Se(Yi.states,null,!1),new Te(15e3,"destroy"),new Pe(10,10,0,"destroy"),new re]),r}static onDestroy(t,e){t.getComponentForEntity(e,We)||t.addComponentsToEntity(e,[new We(1)])}}Yi.states={destroy:function(t,e){t.getComponentForEntity(e,We)||t.addComponentsToEntity(e,[new We(1)])}};class ji extends A{constructor(){super([T,Vi,Ee,re])}onEntityAdded(t,e,i,s,n){i.trigger=this.engine.createEntity(),this.engine.addComponentsToEntity(i.trigger,[e,new Nt(i.radius/2,i.radius/2),new qt(!0,null,[this.triggerCallback]),new Ht,new re])}updateEntity(t,e,i,s,n){if(i.intervalDelay.tick(this.dt)){var r=this.evaluateTargets(t);r>=0&&this.releaseBird(t,r)}i.triggered&&(i.triggered=!1)}triggerCallback(t,e,i){}evaluateTargets(t){const e=this.engine.getComponentForEntity(t,T);var i=Xe.SearchSortAndFilter(e.coords,200,t,He.ALL).entities;return i.length>0?i[0].entity:-1}releaseBird(t,e){var i=this.engine.getComponentForEntity(t,Vi);if(i.group.hasCapacity()){const e=this.engine.getComponentForEntity(t,T);var s=Yi.create(this.engine,e.clone(),e,t);const n=this.engine.getComponentForEntity(s,Se);i.group.addMember(t,n)}}}class Ji extends A{constructor(t){super([Hi,qt,Pe,ni]),this.bfAreaQuery=t,this.baseState=this.baseState.bind(this),this.seekState=this.seekState.bind(this),this.chaseState=this.chaseState.bind(this)}onEntityAdded(t,e,i,s,n){e.ai.pushState(this.baseState)}updateEntity(t,e,i,s,n){e.ai.update(t,this.dt)}baseState(t,e,i){this.engine.getComponentForEntity(t,Hi).delay.tick(i)&&e.pushState(this.seekState)}seekState(t,e,i){const s=this.engine.getComponentForEntity(t,T);var n=Xe.SearchSortAndFilter(s.coords,300,t,He.ALL).entities;if(n.length>0){var r=this.engine.getComponentForEntity(t,Hi);r.target=n[0].entity;var o=this.engine.getComponentForEntity(t,ni),a=o.getBehaviour(Xi);return a.target=this.engine.getComponentForEntity(r.target,T).coords,a.arrivalZone=1,o.getBehaviour(hi).active=!1,e.popState(),void e.pushState(this.chaseState)}e.popState()}chaseState(t,e,i){var s=this.engine.getComponentForEntity(t,Hi);if(s.chaseCheck.tick(i))return;const n=this.engine.getComponentForEntity(t,T),r=this.engine.getComponentForEntity(s.target,T);if(!Xe.CanSee(n.coords,r.coords,300)){s.target=null;var o=this.engine.getComponentForEntity(t,ni);o.getBehaviour(hi).active=!0;var a=o.getBehaviour(Xi);a.target=this.engine.getComponentForEntity(t,T).coords,a.arrivalZone=128,e.popState()}}}class Ki{constructor(){}}class Zi extends A{constructor(t){super([qt,Nt,Ki]),this.particleEngine=t,this.cycle=0,this.callback=this.callback.bind(this),this._tempVec=new C}onEntityAdded(t,e,i,s){this.engine.getComponentForEntity(t,qt).proxy.contactCallbacks.push(this.callback)}updateAllEntities(){this.cycle=2*Math.PI/1e3*this.timestamp%1e3}callback(t,e,i){var s=t.aabb.overlapArea(e.aabb);e.body.damping=.9,this._tempVec.setTo(0,-s*(4.5+.5*Math.sin(this.cycle))),e.body.addForce(this._tempVec),e.body.inWaterPrev?e.aabb.t<t.aabb.t&&De(.1)&&null!=this.engine.getComponentForEntity(t.entity,Ee)&&this.particleEngine.EmitParticle(Ge(e.aabb.l,e.aabb.r),t.aabb.t,Ge(-20,20),Ge(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255):(this.particleEngine.EmitParticle(Ge(e.aabb.l,e.aabb.r),t.aabb.t,Ge(-20,20),Ge(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(Ge(e.aabb.l,e.aabb.r),t.aabb.t,Ge(-20,20),Ge(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(Ge(e.aabb.l,e.aabb.r),t.aabb.t,Ge(-20,20),Ge(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255)),e.body.inWater=!0}}class Qi extends A{constructor(t,e){super([Nt,wi,Ri,Ee,qt,re]),this.particleEngine=t,this.tileSize=e}onEntityAdded(t,e,i,s,n,r,o){var a=e.halfWidths.x*e.halfWidths.y*4/(this.tileSize*this.tileSize);s.incPerFrame=s.particlePerUnitPerFrame*a}updateEntity(t,e,i,s,n,r,o){for(s.particleCount+=s.incPerFrame;s.particleCount>1;)this.particleEngine.EmitParticle(Ge(r.proxy.aabb.l,r.proxy.aabb.r),Ge(r.proxy.aabb.t,r.proxy.aabb.b),i.direction.x*i.power*50,i.direction.y*i.power*50,0,1,ze(200,400),1,!1,!1,null,4,255,255,255,255),s.particleCount--}}class $i{static createTMXEntity(t,e){const i=t.createEntity();var s=[];return s.push(Ai(e)),s.push(Ti(e)),s.push(new qt(!0,null,[])),s.push(new Ht),s.push(new re),s.push(new Ki),t.addComponentsToEntity(i,s),i}}$i.mapping="Water";class ts{constructor(t,e,i){this.type=t,this.open=e,this.triggerEvent=i}}class es{constructor(t,e){this.channel=t,this.sequence=e}}class is{static create(t,e,i,s,n){var r=t.createEntity();return(new bt).groupIndex=Be.SOLID_OBJECT_GROUP,t.addComponentsToEntity(r,[e,i,new le(n),new qt(!1,null,[]),new Ht,new ts("door",!1,""),new Se(is.states,"open",!0),new es("doorA",["open","close"]),new re]),r}static onDestroy(t,e){}static createTMXEntity(t,e){const i=Ti(e);return i.halfWidths.x/=2,is.create(t,Ai(e),i,"doorOpen","doorClosed")}}is.mapping="door",is.states={open:function(t,e){var i=t.getComponentForEntity(e,ts);t.getComponentForEntity(e,le).setTileFrameId(i.type+"Open");var s=t.getComponentForEntity(e,qt);s.proxy.responseBias.x=0,s.proxy.isActive=!1},close:function(t,e){var i=t.getComponentForEntity(e,ts);t.getComponentForEntity(e,le).setTileFrameId(i.type+"Closed");var s=t.getComponentForEntity(e,qt);s.proxy.responseBias.x=1,s.proxy.isActive=!0}};class ss extends A{constructor(){super([Se]),this.updates=new Array}onEntityAdded(t,e){e.onChange=this.onChange.bind(this,t)}onEntityRemoved(t,e){}updateAllEntities(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,Se);if(null===e||null===e.currentState)return;e.states[e.currentState](this.engine,t),e.messages.dispatch(t,e.currentState)}}onChange(t){this.updates.push(t)}}class ns{constructor(){this.bus=new Map}registerChannels(t,e){t.forEach(t=>{this.bus.has(t)||this.bus.set(t,new p),this.bus.get(t).add(e)})}unregisterChannels(t,e){t.forEach(t=>{this.bus.has(t)&&this.bus.get(t).remove(e)})}trigger(t,e){this.bus.has(t)&&this.bus.get(t).dispatch(e)}}class rs extends A{constructor(t){super([Se,es]),this.bus=t}onEntityAdded(t,e,i){i.onChange=this.onChange.bind(this,t),this.bus.registerChannels([i.channel],i.onChange)}onEntityRemoved(t,e,i){this.bus.unregisterChannels([i.channel],i.onChange)}updateAllEntities(){}onChange(t){var e=this.engine.getComponentForEntity(t,Se),i=this.engine.getComponentForEntity(t,es),s=i.sequence.indexOf(e.currentState);const n=++s%i.sequence.length;e.setState(i.sequence[n])}}const os=t=>["<thead>","<tr>","<th></th>",t.map(t=>`<th class="rotate"><div><span>${t}</span></div></th>`).join(""),"</tr>","</thead>"].join(""),as=(t,e,i,s)=>{const n=[];for(let r=t;r<t+e;r++)n.push(hs(r,i,s));return n.join("")},hs=(t,e,i)=>["<tr>",`<th class="row-header">${t}</th>`,e.map(e=>null===i.get(e)[t]?"<td></td>":"<td>X</td>").join(""),"</tr>"].join("");class ls{}class cs{static create(t,e){const i=t.createEntity();var s=new ne($t.RUBBER);return s.setMass(.1),s.setBounces(7),s.maxScalarVelocity=1e3,t.addComponentsToEntity(i,[new ls,e,new Nt(12,12),new S("chicken"),new pt("chicken","walk"),new qt(!1,new bt(1,4294967295,Be.CHICKEN_GROUP),[]),new Jt(s,!0),new Yt,new re,new Ee]),i}}cs.states={destroy:function(t,e){t.getComponentForEntity(e,We)||t.addComponentsToEntity(e,[new We(1)])}};const ds=t=>{document.getElementById("debugDump").addEventListener("click",()=>{const e=document.getElementById("debugResult"),i=((t,e,i)=>{const s=[...t.components.keys()].sort();return['<table class="table table-header-rotated">',os(s),"<tbody>",as(e,i,s,t.components),"</tbody>"].join("")})(t,0,100);e.innerHTML=i}),document.getElementById("debugChickens").addEventListener("click",()=>{const e=t.query([Qe])[0],i=t.getComponentForEntity(e,T);for(let e=0;e<10;e++){const e=cs.create(t,i.clone());t.getComponentForEntity(e,Jt).body.addForce(new C(ze(-1e5,1e5),ze(-1e5,-5e3)))}}),document.getElementById("debugDraw").addEventListener("click",t=>{document.getElementById("viewDebug").style.display=t.target.checked?"block":"none",w.debug=t.target.checked})},us=5,ps=3;class gs{constructor(t){this.bounds=new W,this.reset(t)}reset(t){this.parent=t||null,this.body=null,this.bounds.reset(),this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class ms{constructor(t=new W(B,B,_,_)){this.worldBounds=t,this.root=null,this.nodes=new Map,this.tempBounds=new W,this.nodePool=new n(()=>new gs),this.nodePool.addCapacity(1e4)}insertNode(t){if(null===this.root)return this.root=t,void(this.root.parent=null);for(var e=t.bounds,i=this.root;!i.isLeaf();){const t=i.left,r=i.right,o=i.bounds.perimeter(),a=this.tempBounds.combine2(i.bounds,e).perimeter(),h=2*a,l=2*(a-o);var s=0;const c=this.tempBounds.combine2(e,t.bounds).perimeter();s=t.isLeaf()?c+l:c-t.bounds.perimeter()+l;var n=0;const d=this.tempBounds.combine2(e,r.bounds).perimeter();if(n=r.isLeaf()?d+l:d-r.bounds.perimeter()+l,h<s&&h<n)break;i=s<n?t:r}var r=i.parent,o=this.nodePool.reserve();o.reset(r),o.bounds.combine2(e,i.bounds),o.height=i.height+1,null!==r?(r.left===i?r.left=o:r.right=o,o.left=i,o.right=t,i.parent=o,t.parent=o):(o.left=i,o.right=t,i.parent=o,t.parent=o,this.root=o);for(var a=t.parent;a;){if(!(a=this.balanceNode(a)).left)throw new Error("Parent of current leaf cannot have a null left child"+a);if(!a.right)throw new Error("Parent of current leaf cannot have a null right child"+a);a.height=1+Math.max(a.left.height,a.right.height),a.bounds.combine2(a.left.bounds,a.right.bounds),a=a.parent}}removeNode(t){if(t===this.root)return void(this.root=null);const e=t.parent,i=e.parent;var s;if(s=e.left===t?e.right:e.left,i){i.left===e?i.left=s:i.right=s,s.parent=i,this.nodePool.free(e);for(var n=i;n;)(n=this.balanceNode(n)).bounds.combine2(n.left.bounds,n.right.bounds),n.height=1+Math.max(n.left.height,n.right.height),n=n.parent}else this.root=s,s.parent=null,this.nodePool.free(e)}trackBody(t){var e=this.nodePool.reserve();e.reset(),e.body=t,e.bounds.copyAABB(t.aabb),e.bounds.expand(2),this.nodes.set(t.id,e),this.insertNode(e)}updateBody(t){var e=this.nodes.get(t.id);if(!e)return!1;this.tempBounds.copyAABB(t.aabb);var i=t.body.delta.x,s=t.body.delta.y;return i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,s<0?this.tempBounds.t+=s:this.tempBounds.b+=s,!e.bounds.contains(this.tempBounds)&&(this.removeNode(e),this.tempBounds.l-=us,this.tempBounds.t-=us,this.tempBounds.r+=us,this.tempBounds.b+=us,i=t.body.delta.x*ps,s=t.body.delta.y*ps,i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,s<0?this.tempBounds.t+=s:this.tempBounds.b+=s,e.bounds.copy(this.tempBounds),this.insertNode(e),!0)}untrackBody(t){var e=this.nodes.get(t.id);e&&(this.removeNode(e),this.nodePool.free(e),this.nodes.delete(t.id))}balanceNode(t){if(t.isLeaf()||t.height<2)return t;var e=t.left,i=t.right,s=t,n=e,r=i,o=e.left,a=e.right,h=i.left,l=i.right,c=r.height-n.height;if(c>1)return r.left=s,r.parent=s.parent,s.parent=r,r.parent?r.parent.left===s?r.parent.left=r:r.parent.right=r:this.root=r,h.height>l.height?(r.right=h,s.right=l,l.parent=s,s.bounds.combine2(n.bounds,l.bounds),r.bounds.combine2(s.bounds,h.bounds),s.height=1+Math.max(n.height,l.height),r.height=1+Math.max(s.height,h.height)):(r.right=l,s.right=h,h.parent=s,s.bounds.combine2(n.bounds,h.bounds),r.bounds.combine2(s.bounds,l.bounds),s.height=1+Math.max(n.height,h.height),r.height=1+Math.max(s.height,l.height)),r;if(c<-1){if(n.left=s,n.parent=s.parent,s.parent=n,n.parent)if(n.parent.left===s)n.parent.left=n;else{if(n.parent.right!==s)throw"Error rotating Dynamic Tree";n.parent.right=n}else this.root=n;return o.height>a.height?(n.right=o,s.left=a,a.parent=s,s.bounds.combine2(r.bounds,a.bounds),n.bounds.combine2(s.bounds,o.bounds),s.height=1+Math.max(r.height,a.height),n.height=1+Math.max(s.height,o.height)):(n.right=a,s.left=o,o.parent=s,s.bounds.combine2(r.bounds,o.bounds),n.bounds.combine2(s.bounds,a.bounds),s.height=1+Math.max(r.height,o.height),n.height=1+Math.max(s.height,a.height)),n}return t}getHeight(){return null===this.root?0:this.root.height}query(t){var e=this.nodes.get(t.id).bounds;ms.queryHelper(t,e,this.root)}static queryHelper(t,e,i){var s=1;for(ms.stack[0]=i;s>0;){const i=ms.stack[--s];i.bounds.intersect(e)&&(i.isLeaf()?i.body!==t&&Ct(t,i.body):(ms.stack[s++]=i.left,ms.stack[s++]=i.right))}return!1}static queryHelper2(t,e,i){return!(!i||!i.bounds.intersect(e))&&(i.isLeaf()&&i.body!==t?(Ct(t,i.body),!1):ms.queryHelper(t,e,i.left)||ms.queryHelper(t,e,i.right))}rayCastQuery(t,e=_,i){var s=e=>{if(e&&Et(t,e.body)){if(!e.isLeaf())return s(e.left)||s(e.right);if(i.call(t,e.body))return!0}return!1};s(this.root)}queryArea(t,e){ms.queryAreaHelper(this.root,t,e)}static queryAreaHelper(t,e,i){var s=1;for(ms.stack[0]=t;s>0;){const t=ms.stack[--s];t.bounds.intersect(e)&&(t.isLeaf()?i(t.body):(ms.stack[s++]=t.left,ms.stack[s++]=t.right))}return!1}debugDraw(t){var e=i=>{i&&(i.isLeaf()?t.DrawAABB2(i.bounds,"green"):t.DrawAABB2(i.bounds,"white"),i.left&&e(i.left),i.right&&e(i.right))};e(this.root)}}ms.stack=new Array(100);class ys{constructor(t){this.map=t,this.staticProxies=new Array,this.dynamicProxies=new Array,this.sleepingProxies=new Array,this.tree=new ms,this.tempArea=new W}addProxy(t){(t.isStatic?this.staticProxies:this.dynamicProxies).push(t),this.tree.trackBody(t)}removeProxy(t){var e=t.isStatic?this.staticProxies:this.dynamicProxies;e.splice(e.indexOf(t),1),this.tree.untrackBody(t)}collide(){for(var t=this.dynamicProxies.length;--t>=0;){null!=(i=this.dynamicProxies[t]).body&&(i.isSensor||this.map.testCollision(i),i.body.canSleep&&this.sleep(i)),this.tree.updateBody(i)}for(var e=this.dynamicProxies.length;--e>=0;){var i=this.dynamicProxies[e];this.tree.query(i)}}QueryArea(t,e,i=!0,s=!0){this.tempArea.copyAABB(t),this.tree.queryArea(this.tempArea,e)}CastRay(t,e,i=!0,s=!0){this.map.castRay(t)}wake(t){}sleep(t){}}class xs extends A{constructor(t){super([T,ls,Jt]),this.particleEngine=t}updateEntity(t,e,i,s){var n=1e6,r=s.body,o=0;if(null!=this.scaredOfPosition&&(n=r.position.distSqrd(this.scaredOfPosition.coords),o=r.position.x-this.scaredOfPosition.coords.x<0?-1:1),n<4096)De(.1)&&(r.addForce(new C(5e3*o,-8e3)),this.particleEngine.EmitParticle(r.position.x,r.position.y,-10*o,-100,0,5,800,1,!1,!0,null,4,255,255,255,255));else if(De(.005)){o=Ie(.5);e.direction.x=-o,r.addForce(new C(5e3*o,-8e3)),this.particleEngine.EmitParticle(r.position.x,r.position.y,-20*o,-100,0,5,800,1,!1,!0,null,4,255,255,255,255)}}scaredOf(t){const e=this.engine.getComponentForEntity(t,T);e&&(this.scaredOfPosition=e)}}class bs{constructor(){}}class fs extends A{constructor(){super([T,Nt,bs])}preUpdate(){if(!w.debug)return!1}updateEntity(t,e,i,s){w.debugRender.DrawCross(e.coords.x,e.coords.y,15)}}class vs{constructor(t){this.intervalDelay=new Ni(t)}}class Cs extends A{constructor(){super([vs,T])}updateEntity(t,e,i){if(e.intervalDelay.tick(this.dt)){var s=Xe.SearchSortAndFilter(i.coords,300,t,He.ENEMY).entities;s.length>0&&this.fireBulletAtEntity(i,s[0].entity)}}fireBulletAtEntity(t,e){this.fireBullet(t.coords.clone(),this.engine.getComponentForEntity(e,T).coords.clone())}fireBullet(t,e){var i=new bt;i.groupIndex=Be.TURRET_GROUP;Ke.create(this.engine,new T(t.x,t.y),i,e)}}const ws=function(t,e){let i=0;return function(){const s=Date.now();s-i>e&&(i=s,t(...arguments))}};class Es extends G{constructor(){super(),this.id="Camera",this.realPosition=new C,this.viewportSize=new C,this.halfViewportSize=new C,this.shake=new C,this.viewPortAABB=new W,this.worldExtentsAABB=new W}rf(t){return t}Focus(t,e){this.realPosition.x=t,this.realPosition.y=e,this.cameraExtentsAABB.fitPoint(this.realPosition);var i=-this.realPosition.x+this.halfViewportSize.x,s=-this.realPosition.y+this.halfViewportSize.y;Math.abs(i-this.position.x)>2&&(this.position.x=this.position.x+.1*(i-this.position.x)),Math.abs(s-this.position.y)>2&&(this.position.y=this.position.y+.1*(s-this.position.y)),this.position.plusEquals(this.shake),this.position.x=this.rf(this.position.x),this.position.y=this.rf(this.position.y),this.shake.setTo(0,0)}Resize(t,e){this.viewportSize.x=t,this.viewportSize.y=e,this.halfViewportSize.x=t/2,this.halfViewportSize.y=e/2,this.viewPortAABB.l=this.viewPortAABB.t=0,this.viewPortAABB.r=this.viewportSize.x,this.viewPortAABB.b=this.viewportSize.y,this.cameraExtentsAABB=this.worldExtentsAABB.clone(),this.cameraExtentsAABB.expand2(t,e)}}class As{constructor(){}}class Ts extends A{constructor(t){super([qt,Nt,pi,re]),this.holderFilterCategory=t,this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){e.proxy.contactCallbacks.push(this.callback),e.proxy.filter.maskBits|=this.holderFilterCategory}updateAllEntities(){}callback(t,e,i){var s=this.engine.getComponentForEntity(t.entity,pi);1==s.activate&&this.hold(s,e.entity,t.entity)}hold(t,e,i){if(null==t.heldItem&&null==this.engine.getComponentForEntity(e,ui)){var s=new ui(i);this.engine.addComponentsToEntity(e,[s]),t.heldItem=e}}}class Ss extends A{constructor(t){super([qt,Nt,As]),this.holderFilterCategory=t}onEntityAdded(t,e,i,s){e.proxy.filter.categoryBits|=this.holderFilterCategory}updateAllEntities(){}}class Rs{constructor(){}}class Ps extends A{constructor(){super([T,As,ui,Jt,re])}onEntityAdded(t,e,i,s,n,r){var o=n.body;o.velocity.setTo(0,0),o.skip=!0;var a=this.engine.getComponentForEntity(s.holder,T).coords;if(e.coords.copy(a),n.body.position.copy(a),null==this.engine.getComponentForEntity(t,Rs)){var h=this.engine.getComponentForEntity(s.holder,pi),l=this.engine.getComponentForEntity(h.parent,Jt).body;null!=l&&l.setMass(l.mass+o.mass)}}onEntityRemoved(t,e,i,s,n,r){this.drop(s.holder);var o=n.body;if(o.skip=!1,o.velocity.setTo(0,0),null==this.engine.getComponentForEntity(t,Rs)){var a=this.engine.getComponentForEntity(s.holder,pi),h=this.engine.getComponentForEntity(a.parent,Jt).body;null!=h&&h.setMass(h.mass-o.mass)}}updateEntity(t,e,i,s,n,r){var o=s.holder,a=this.engine.getComponentForEntity(o,T),h=n.body;h.setStaticPosition(a.coords.x+4*a.direction.x,a.coords.y),e.update(h.position)}drop(t){if(null!=t){var e=t;return this.engine.removeComponentsFromEntityByType(t,[ui]),t=null,e}return null}}class Ls{constructor(){this.systems=[]}addSystem(t){return this.engine.addPhaseSystemToEngine(t),this.systems.push(t),t}updatePhase(t,e){for(const i of this.systems)i.updateSystem(t,e)}}class Fs{constructor(t){this.teleportPosition=t}}class _s{constructor(t,e,i,s){this.velocity=e,this.interval=t,this.ttl=i,this.jitter=s,this.lastTime=0}update(t,e,i,s){if(!(t-this.lastTime<this.interval)){this.lastTime=t;var n=e(Nt).halfWidths;for(let t=0;t<16;t++)s.EmitParticle(i.x-16+2*t,i.y-n.y,0,this.velocity+ze(-this.jitter,this.jitter),0,0,this.ttl,.99,!0,!0,null,4,255,255,255,255)}}}class Bs{static create(t,e,i){var s=t.createEntity();return(new bt).groupIndex=Be.SOLID_OBJECT_GROUP,t.addComponentsToEntity(s,[e,i,new qt(!0,null,[]),new Ht,new ts("door",!1,""),new Fs(new C(192,576)),new Se(Bs.states,"on",!0),new es("telporterA",["on","off"]),new re,new xe([new _s(200,100,600,10)])]),s}}Bs.mapping="teleporter",Bs.states={on:function(t,e){t.getComponentForEntity(e,qt).proxy.isActive=!0,t.addComponentsToEntity(e,[])},off:function(t,e){t.getComponentForEntity(e,qt).proxy.isActive=!0,t.removeComponentsFromEntityByType(e,[xe])}};class Ms extends A{constructor(){super([qt,Fs]),this.onCollision=this.onCollision.bind(this)}onEntityAdded(t,e,i,s){e.proxy.contactCallbacks.push(this.onCollision)}onCollision(t,e,i){De(.1)&&e.body.position.copy(this.engine.getComponentForEntity(t.entity,Fs).teleportPosition)}}class Ws{constructor(t){this.volume=t}}class Gs extends A{constructor(){super([T,xi,yi])}updateEntity(t,e,i,s){e.prevCoords.copy(e.coords);const n=this.engine.getComponentForEntity(s.parent,T);e.coords.x=n.coords.x+i.point.x*n.direction.x,e.coords.y=n.coords.y+i.point.y*n.direction.y}}class Ds{constructor(){this.contact=new xt}}class Is{constructor(){this.contacts=new Map,this.contactPairPool=new n(t=>new Ds),this.stamp=0,this.contactPairPool.addCapacity(5e3)}UpdateContacts(t,e,i){const s=Vt.HashBodyIDs(t.id,e.id);var n=this.contacts.get(s);null!=n?(n.stamp<this.stamp&&(n.contactCount=0,n.stamp=this.stamp),n.contactCount++):((n=this.contactPairPool.reserve()).hash=s,n.stamp=this.stamp,n.contactCount=1,n.startContact=!0,n.endContact=!1,n.proxyA=t,n.proxyB=e,this.contacts.set(s,n)),n.contact.setTo(i)}ProcessContacts(){for(const t of this.contacts.values())t.stamp<this.stamp&&(t.endContact=!0),t.proxyA.collide(t.proxyB,t.contact),t.proxyB.collide(t.proxyA,t.contact),t.startContact=!1,t.endContact&&(this.contacts.delete(t.hash),this.contactPairPool.free(t)),this.stamp++}}class zs extends A{constructor(t){super([T,re,Je]),this.spriteParticleEngine=t}updateEntity(t,e,i,s){for(const i of s.emitters)i.update(this.timestamp,this.engine.c4e.get(t),e.coords,this.spriteParticleEngine)}postUpdate(){this.spriteParticleEngine.Update()}}class Os{construcor(){}Initalize(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,m){this.pX=this.plX=t,this.pY=this.plY=e,this.vX=i,this.vY=s,this.fX=n,this.fY=r,this.ttl=d.ttl(),this.age=0,this.damping=a,this.decay=h,this.externalForce=c,this.sequence=d,this.currentFrame=0,this.currentInc=0,this.msPerInc=this.ttl/d.len,this.size=u,this.flipX=p,this.flipY=g,this.colour=0}Update(t,e){return this.vX+=this.fX+this.externalForce.x,this.vY+=this.fY+this.externalForce.y,this.vX*=this.damping,this.vY*=this.damping,this.pX+=this.vX*e,this.pY+=this.vY*e,this.age+=t,this.alpha=1,this.currentInc+=t,this.currentInc>=this.msPerInc&&(this.currentFrame++,this.currentInc=0),this.age<this.ttl}}Os.INV_ALPHA=1/255;var Us=" precision mediump float;\nuniform vec2 projectionVector;\n\nattribute vec2 position;\nattribute float size;\nattribute vec2 tilePosition;\nattribute vec2 tileDimension;\nattribute vec2 colour;\nvarying vec2 vTilePos;\nvarying vec2 tileDim;\nvoid main() {\n    vTilePos = tilePosition;\n    tileDim = tileDimension;\n    gl_PointSize = size;\n    gl_Position = vec4( position.x / projectionVector.x -1.0, position.y / -projectionVector.y + 1.0 , 0.0, 1.0);            \n}",ks="precision mediump float;\nuniform sampler2D texture;\n// uniform vec2 flip;\nvarying vec2 vTilePos;\nvarying vec2 tileDim;\n// varying vec2 vColor;\nvoid main() {\n    vec2 uv = vec2( gl_PointCoord.x*tileDim.x + vTilePos.x, gl_PointCoord.y*tileDim.y + vTilePos.y );\n    \n    //Latest\n    //vec2 uv = vec2( ((-1.0+(2.0*vColor.x))*(vColor.x-gl_PointCoord.x)*tileDim.x) + vTilePos.x, ((-1.0+(2.0*vColor.y))*(vColor.y-gl_PointCoord.y)*tileDim.y) + vTilePos.y);\n    \n    //vec2 uv = vec2( gl_PointCoord.x*tileDim.x + vTilePos.x, gl_PointCoord.y*tileDim.y + vTilePos.y); //Works no rotation\n    // vec2 uv = vec2( gl_PointCoord.x*invTexTilesWide + invTexTilesWide*vTilePos.x, gl_PointCoord.y*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    //vec2 uv = vec2( (-1.0*(0.0-gl_PointCoord.x))*invTexTilesWide + invTexTilesWide*vTilePos.x, (gl_PointCoord.y)*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    // vec2 uv = vec2( ((-1.0+(2.0*flip.x))*(flip.x-gl_PointCoord.x))*invTexTilesWide + invTexTilesWide*vTilePos.x, ((-1.0+(2.0*flip.y))*(flip.y-gl_PointCoord.y))*invTexTilesHigh + invTexTilesHigh*vTilePos.y);\n    gl_FragColor = texture2D( texture, uv );\n}";class Ns{constructor(t){this.maxSprites=t}Init(t,e){this.gl=t,this.camera=e,this.projection=new C,this.pointSpriteShader=new K(this.gl,J(t,Us,ks)),this.dataBuffer=t.createBuffer(),this.arrayBuffer=new ArrayBuffer(80*this.maxSprites),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),t.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),t.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.ResetBatch()}SetSpriteSheet(t,e,i,s){this.texture=t,this.tileSize=e,this.texTilesWide=i,this.texTilesHigh=s,this.invTexTilesWide=1/this.texTilesWide,this.invTexTilesHigh=1/this.texTilesHigh}Resize(t,e){this.projection.x=t/2,this.projection.y=e/2}AddStage(t){this.stage=t}ResetBatch(){this.indexRun=0}AddSpriteToBatch(t,e,i,s,n,r,o,a,h,l,c){var d=7*this.indexRun;this.data[d+0]=Math.floor(n+this.camera.position.x),this.data[d+1]=Math.floor(r+this.camera.position.y),this.data[d+2]=o,this.data[d+3]=t+i*Math.min(h,0)*-1,this.data[d+4]=e+s*Math.min(l,0)*-1,this.data[d+5]=i*h,this.data[d+6]=s*l,this.indexRun++}Render(t){0!=this.indexRun&&(this.gl.enable(WebGLRenderingContext.BLEND),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.pointSpriteShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.position),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.size),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.tilePosition),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.tileDimension),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,28,0),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.size,1,WebGLRenderingContext.FLOAT,!1,28,8),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.tilePosition,2,WebGLRenderingContext.FLOAT,!1,28,12),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.tileDimension,2,WebGLRenderingContext.FLOAT,!1,28,20),this.gl.uniform2f(this.pointSpriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture),this.gl.drawArrays(WebGLRenderingContext.POINTS,0,this.indexRun))}}class Vs{constructor(t,e,i,s){this.particleCount=t,this.deltaTime=e,this.invDeltaTime=e/1e3,this.map=i,this.spriteParticleManager=s,this.ZERO_FORCE=new C,this.activeParticles=new Array,this.activeParticles[0]=new Array(this.particleCount),this.activeParticles[1]=new Array(this.particleCount),this.cachedParticles=new Array(this.particleCount);for(let e=0;e<t;e++)this.cachedParticles[e]=new Os;this.availableParticleCount=this.particleCount,this.activeParticlesCount=0,this.activePool=0,this.renderer=new Ns(t)}EmitParticle(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,m){if(0==this.availableParticleCount)return!1;var y=this.cachedParticles[--this.availableParticleCount];return this.activeParticles[this.activePool][this.activeParticlesCount++]=y,y.Initalize(t,e,i,s,n,r,o,a,h?this.deltaTime/o:0,l,null!=c?c:this.ZERO_FORCE,this.spriteParticleManager.sequencesList[d],u,p,g,m),!0}Update(){this.renderer.ResetBatch();const t=this.activeParticles[this.activePool],e=this.activeParticles[1===this.activePool?0:1];for(var i=0,s=0;s<this.activeParticlesCount;s++){const r=t[s];if(r.Update(this.deltaTime,this.invDeltaTime)){if(1==(1&this.map.getReal(r.pX,r.pY,0))){const t=this.map.Index(r.plX),e=this.map.Index(r.plY),i=this.map.Index(r.pX),s=this.map.Index(r.pY);i!=t&&(r.vX*=-.99,r.pX=r.plX),s!=e&&(r.vY*=-.99,r.pY=r.plY)}var n=r.sequence.sequence[Math.min(r.currentFrame,r.sequence.len-1)];this.renderer.AddSpriteToBatch(n.x,n.y,n.width,n.height,r.pX,r.pY,r.size,1,r.flipX,r.flipY,0),e[i++]=r}else this.cachedParticles[this.availableParticleCount++]=r}this.activeParticlesCount=i,this.activePool=1===this.activePool?0:1}}class qs{constructor(t,e,i,s){this.id=t,this.name=e,this.sequence=i,this.fps=s,this.len=i.length}ttl(){return this.sequence.length/this.fps*1e3}}class Hs{constructor(){this.count=0,this.frames=new Map,this.sequences=new Map,this.sequencesList=new Array}ParseSequenceJSON(t){"string"==typeof t&&(t=JSON.parse(t),Object.keys(t).forEach(e=>{const i=t[e],s=this.fromParticleSequencePattern(e,i);this.sequences.set(e,s),this.sequencesList[s.id]=s}))}ParseTexturePackerJSON(t){if("string"!=typeof t)return;const e=(t=JSON.parse(t)).meta.size.w,i=t.meta.size.h;Object.keys(t.frames).forEach(s=>{const n=t.frames[s],r=new O(n.frame.x/e,n.frame.y/i,n.frame.w/e,n.frame.h/i);this.frames.set(s,r)})}fromParticleSequencePattern(t,e){const i=new Array;for(var s=e.start;s<=e.end;s++){const t=this.frames.get(e.pattern.replace("{x}",s+""));i.push(t)}return new qs(this.count++,t,i,e.fps)}}class Xs{constructor(t,e){this.damagePerSecond=t,this.force=e}}class Ys extends A{constructor(){super([Nt,qt,Xs]),this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s){i.proxy.contactCallbacks.push(this.callback)}onEntityRemoved(t,e,i,s){i.proxy.contactCallbacks.splice(i.proxy.contactCallbacks.indexOf(this.callback),1)}updateAllEntities(){}callback(t,e,i){const s=this.engine.getComponentForEntity(e.entity,Pe);if(s){const e=this.engine.getComponentForEntity(t.entity,Xs);s.applyDamage(e.damagePerSecond*(this.dt/1e3))}}}const js="data/16map.json",Js="data/sprites.json",Ks="data/sprites.png",Zs="data/frames.json",Qs="data/particles.png",$s="data/particles.json",tn="data/particleFrames.json",en="data/tileFrames.json",sn="data/superSet.png";const nn=256,rn=Int32Array.BYTES_PER_ELEMENT*nn,on=0,an=200,hn=210,ln=211,cn=212,dn=213;const un=document.getElementById("view"),pn=new class{constructor(t=null){this.proxyMode=!1,t?(this.proxyMode=!0,this.sharedArray=t):this.sharedArray=new Uint32Array(new ArrayBuffer(rn));for(var e=0;e<nn;e++)this.sharedArray[e]=0;this.mousePosition=new C,this.mousePreviousPosition=new C,this.mouseOffset=new C,this.sharedArray[on]=2}InputTarget(t,e){this.target=t,t.addEventListener("keydown",this.KeyDown.bind(this)),t.addEventListener("keyup",this.KeyUp.bind(this)),t.addEventListener("mousedown",this.MouseDown.bind(this)),t.addEventListener("mouseup",this.MouseUp.bind(this)),t.addEventListener("mousemove",this.MouseMove.bind(this)),this.inputCorrection=e}ViewCorrectedMousePosition(t){t.x=this.sharedArray[hn]+this.mouseOffset.x,t.y=this.sharedArray[ln]+this.mouseOffset.y}Update(t,e){this.mouseOffset.x=t,this.mouseOffset.y=e,this.sharedArray[on]++}KeyDown(t){0==this.sharedArray[t.keyCode]&&(this.sharedArray[t.keyCode]=this.sharedArray[on]),t.preventDefault()}KeyUp(t){this.sharedArray[t.keyCode]=0,t.preventDefault()}MouseDown(t){this.sharedArray[an]=this.sharedArray[on],t.preventDefault()}MouseUp(t){this.sharedArray[an]=0,t.preventDefault()}MouseMove(t){this.sharedArray[cn]=this.sharedArray[hn],this.sharedArray[dn]=this.sharedArray[ln],this.sharedArray[hn]=t.clientX-this.inputCorrection.x,this.sharedArray[ln]=t.clientY-this.inputCorrection.y,t.preventDefault()}Pressed(t){return this.sharedArray[t]>0}JustPressed(t){return this.sharedArray[t]==this.sharedArray[on]-1}PressedDuration(t){var e=this.sharedArray[t];return e>0?this.sharedArray[on]-e:-1}Released(t){return 0==this.sharedArray[t]}},gn=un.getBoundingClientRect();pn.InputTarget(document,new C(gn.left,gn.top)),window.location!==window.parent.location&&(window.onclick=()=>{document.hasFocus()||window.focus()});new class extends E{constructor(t,e){super(t,e),this.loadAssets([Js,Ks,Zs,js,sn,en,Qs,tn,$s])}initalize(){this.engine.addCapacityToEngine(1e3);const t=JSON.parse(this.assets.assets.get(js)),e=new W(0,w.tileSize*t.width,w.tileSize*t.height,0);e.expand(-w.tileSize);const i=new Es;i.worldExtentsAABB=e;const s=function(t,e,i){for(var s=new st(t.width,t.height,i,1),n=0;n<t.width;n++)for(var r=0;r<t.height;r++){var o=t.get(n,r,0);if(o>0){var a=o-e;s.set(n,r,0,1<<a)}else s.set(n,r,0,0)}for(var h=0;h<30;h++){let t="";for(var l=0;l<30;l++)t+=s.get(l,h,0)?"X":"0"}return s}(rt(ot(t,"Collision")),function(t,e){const i=t.tilesets.filter(t=>t.name===e);return 1===i.length?i[0]:null}(t,"Collision").firstgid,w.tileSize);this.renderSystem=new Y(this.canvas,i,w.resolution),this.renderSystem.textureManager.AddTexture(Ks,this.assets.assets.get(Ks)),this.renderSystem.textureManager.AddTexture(sn,this.assets.assets.get(sn)),this.renderSystem.textureManager.AddTexture(Qs,this.assets.assets.get(Qs)),this.renderSystem.textureManager.ParseTexturePackerJSON(this.assets.assets.get(Js),Ks),this.renderSystem.frameListManager.ParseFrameListJSON(this.assets.assets.get(Zs));const n=new kt(s),r=new Hs;r.ParseTexturePackerJSON(this.assets.assets.get($s)),r.ParseSequenceJSON(this.assets.assets.get(tn));const o=new ye(4e3,1e3/60,s),a=new Vs(4e3,1e3/60,s,r);a.renderer.SetSpriteSheet(this.renderSystem.textureManager.baseTextures.get(Qs).texture,16,16,16),setInterval(()=>{a.EmitParticle(ze(650,750),ze(50,150),0,0,0,0,1e3,.9,!0,!0,null,ze(0,3),ze(16,32),Ie(.5),Ie(.5),0)},16);const h=new ys(n);Xe.setup(this.engine,h);const l=new ns,c=new Ls;this.engine.addPhase(c),c.addSystem(new Zt),c.addSystem(new Xt(h)),c.addSystem(new jt(h)),c.addSystem(new oe),c.addSystem(new Kt(h,new Is)),c.addSystem(new Qt),c.addSystem(new Gs),c.addSystem(new Ps),c.addSystem(new vi(this.input,o)),c.addSystem(new Ii(n)),c.addSystem(new he(this.input)),c.addSystem(new be(o)),c.addSystem(new zs(a)),this.fixedViewManagementSystem=new Ae(i),c.addSystem(this.fixedViewManagementSystem),c.addSystem(new Re),c.addSystem(new Ys),c.addSystem(new Le),c.addSystem(new _e),c.addSystem(new Ei),c.addSystem(new ki),c.addSystem(new ji),c.addSystem(new Ji(Xe.bfAreaQuery));const d=c.addSystem(new xs(o));c.addSystem(new Cs),c.addSystem(new Zi(o)),c.addSystem(new Qi(o,16)),c.addSystem(new ss),c.addSystem(new rs(l)),c.addSystem(new Ts(Be.HOLDABLE_CAT)),c.addSystem(new Ss(Be.HOLDABLE_CAT)),c.addSystem(new Ms),c.addSystem(new Ze);const u=new Ls;this.engine.addPhase(u),u.addSystem(new mt(this.renderSystem.frameListManager));const p=at(rt(ot(t,"Background"))),g=at(rt(ot(t,"Foreground1"))),m=at(rt(ot(t,"Foreground2")));var y=new ut(8,2);y.SetTileRenderLayer("bg",["Background","Foreground1"]),y.SetTileRenderLayer("fg",["Foreground2"]),this.renderSystem.renderer.AddRenderer(y),y.SetTileLayerFromData(m,this.renderSystem.textureManager.baseTextures.get(sn),"Foreground2",1,1);const x=y.SetTileLayerFromData(g,this.renderSystem.textureManager.baseTextures.get(sn),"Foreground1",1,1);y.SetTileLayerFromData(p,this.renderSystem.textureManager.baseTextures.get(sn),"Background",1,1);const b=new Di(n,x);this.renderSystem.renderer.AddRenderer(b.renderer),u.addSystem(b),u.addSystem(new ce(this.assets.assets.get(en),y,n));const f=new et;f.AddStage(this.renderSystem.stage),this.renderSystem.renderer.AddRenderer(f),this.renderSystem.itemContainer.addChild(y.renderLayersMap.get("bg").sprite),this.renderSystem.camera.addChild(y.renderLayersMap.get("fg").sprite),this.renderSystem.camera.addChild(b.renderer.sprite),u.addSystem(this.renderSystem);const v=new fs;u.addSystem(v),this.renderSystem.renderer.AddRenderer(o.renderer),this.renderSystem.renderer.AddRenderer(a.renderer);const C=this.mapPosition(33.5,38.5),E=$e.create(this.engine,C);d.scaredOf(E),this.renderSystem.cameraTarget=C.coords;let A=0,R=0,P=null;for(var L=0;L<1;L++){const t=this.engine.createEntity();null==P&&(P=t),(A+=20)>700&&(A=0,R+=20);var F=new ne($t.NORMAL);F.setBounces(3),F.maxScalarVelocity=1e3,this.engine.addComponentsToEntity(t,[new T(100+A,200+R),new Nt(12,12),new S("chicken"),new pt("chicken","walk"),new qt(!1,new bt,[]),new Jt(F,!0),new Yt,new re,new Ee,new bs])}const _=new Map;_.set(Pi.mapping,Pi.createTMXEntity),_.set($i.mapping,$i.createTMXEntity),_.set(is.mapping,is.createTMXEntity),function(t,e,i){e.objects.forEach(e=>{const s=i.get(e.type);s&&s(t,e)})}(this.engine,ot(t,"Objects"),_),Bs.create(this.engine,this.mapPosition(3,23),new Nt(16,32));const B=this.engine.createEntity();this.engine.addComponentsToEntity(B,[this.mapPosition(10.5,18.5),new Nt(8,8),new qt(!1,new bt,[ws(()=>{l.trigger("doorA",{})},1e3)]),new Ht,new re,new le("switchOff")]);const M=this.engine.createEntity("BeeHive");this.engine.addComponentsToEntity(M,[this.mapPosition(20.5,17),new Nt(16,16),new S("insects","hive"),new qt(!1,null,[]),new Ht,new re,new Ui(5)]),this.engine.addComponentsToEntity(this.engine.createEntity("torch1"),[this.mapPosition(164,182),new Nt(160,160),new S("torch"),new pt("torch","burn"),new Ye(160,1,1,1,255,255,255,0),new Ht]),this.engine.addComponentsToEntity(this.engine.createEntity("torch2"),[this.mapPosition(184,187),new Nt(160,160),new S("torch"),new pt("torch","burn"),new Ye(160,1,1,1,255,0,0,0),new Ht]),this.engine.addComponentsToEntity(this.engine.createEntity("torch3"),[this.mapPosition(175,68),new Nt(160,160),new S("torch"),new pt("torch","burn"),new Ye(160,1,1,1,0,0,255,0),new Ht]),this.engine.addComponentsToEntity(this.engine.createEntity("torch4"),[this.mapPosition(134,164),new Nt(160,160),new S("torch"),new pt("torch","burn"),new Ye(160,1,1,1,0,255,0,0),new Ht]);const G=this.engine.createEntity();this.engine.addComponentsToEntity(G,[this.mapPosition(34,30),new Nt(7,7),new Ht,new Vi(1),new re]);const D=this.engine.createEntity(),I=new bt;I.groupIndex=Be.TURRET_GROUP,this.engine.addComponentsToEntity(D,[this.mapPosition(90,46.5),new le("turret"),new Nt(12,12),new qt(!1,I,[]),new Ht,new vs(1e3),new re]);const z=this.engine.createEntity();this.engine.addComponentsToEntity(z,[this.mapPosition(13,4),new Nt(7,7),new S("items","rock"),new qt(!1,new bt,[]),new Yt,new Jt(new ne($t.ROCK),!0),new As,new re]);const O=this.engine.createEntity();this.engine.addComponentsToEntity(O,[this.mapPosition(23,46),new Nt(6,14),new S("items","water_container"),new qt(!1,new bt,[]),new Yt,new Jt(new ne($t.NORMAL),!0),new As,new Ws(10),new re]),this.loop.start(),ds(this.engine)}mapPosition(t,e){return new T(t*w.tileSize,e*w.tileSize)}fireBullet(t,e){var i=new bt;i.groupIndex=Be.TURRET_GROUP,Ke.create(this.engine,new T(t.x,t.y),i,e)}preUpdate(){w.debugRender.Clear(),this.input.Update(-this.renderSystem.camera.position.x,-this.renderSystem.camera.position.y)}postUpdate(){w.debug&&this.fixedViewManagementSystem.spaceManager.debugDraw()}}(un,pn)}]);