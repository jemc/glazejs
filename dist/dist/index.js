!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{constructor(t=0,e=0){this.x=t,this.y=e}setTo(t,e){this.x=t,this.y=e}copy(t){this.x=t.x,this.y=t.y}clone(){return new s(this.x,this.y)}normalize(){var t=Math.sqrt(this.x*this.x+this.y*this.y)+s.ZERO_TOLERANCE;return this.x/=t,this.y/=t,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqrd(){return this.x*this.x+this.y*this.y}clampScalar(t){var e=this.length();e>t&&this.multEquals(t/e)}clampVector(t){this.x=Math.min(Math.max(this.x,-t.x),t.x),this.y=Math.min(Math.max(this.y,-t.y),t.y)}plusEquals(t){this.x+=t.x,this.y+=t.y}minusEquals(t){this.x-=t.x,this.y-=t.y}multEquals(t){this.x*=t,this.y*=t}plusMultEquals(t,e){this.x+=t.x*e,this.y+=t.y*e}minusMultEquals(t,e){this.x-=t.x*e,this.y-=t.y*e}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}leftHandNormal(){return new s(this.y,-this.x)}leftHandNormalEquals(){var t=this.x;this.x=this.y,this.y=-t}rightHandNormal(){return new s(-this.y,this.x)}rightHandNormalEquals(){var t=this.x;this.x=-this.y,this.y=t}reflectEquals(t){var e=this.dot(t);this.x-=2*e*t.x,this.y-=2*e*t.y}interpolate(t,e,i){this.copy(t),this.multEquals(1-i),this.plusMultEquals(e,i)}setAngle(t){var e=this.length();this.x=Math.cos(t)*e,this.y=Math.sin(t)*e}rotateEquals(t){var e=t*(Math.PI/180),i=Math.cos(e),s=Math.sin(e);this.x=i*this.x-s*this.y,this.y=i*this.y+s*this.x}setUnitRotation(t){var e=t*(Math.PI/180);this.x=Math.cos(e),this.y=Math.sin(e)}heading(){return Math.atan2(this.y,this.x)}distSqrd(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i}}s.ZERO_TOLERANCE=1e-8;class n{constructor(){this.keyMap=new Array;for(var t=0;t<256;t++)this.keyMap[t]=0;this.mousePosition=new s,this.mousePreviousPosition=new s,this.mouseOffset=new s,this.frameRef=2}InputTarget(t,e){this.target=t,t.addEventListener("keydown",this.KeyDown.bind(this)),t.addEventListener("keyup",this.KeyUp.bind(this)),t.addEventListener("mousedown",this.MouseDown.bind(this)),t.addEventListener("mouseup",this.MouseUp.bind(this)),t.addEventListener("mousemove",this.MouseMove.bind(this)),this.inputCorrection=e}ViewCorrectedMousePosition(){var t=this.mousePosition.clone();return t.plusEquals(this.mouseOffset),t}Update(t,e){this.mouseOffset.x=t,this.mouseOffset.y=e,this.frameRef++}KeyDown(t){0==this.keyMap[t.keyCode]&&(this.keyMap[t.keyCode]=this.frameRef),console.log("x"),t.preventDefault()}KeyUp(t){this.keyMap[t.keyCode]=0,t.preventDefault()}MouseDown(t){this.keyMap[200]=this.frameRef,t.preventDefault()}MouseUp(t){this.keyMap[200]=0,t.preventDefault()}MouseMove(t){this.mousePreviousPosition.x=this.mousePosition.x,this.mousePreviousPosition.y=this.mousePosition.y,this.mousePosition.x=t.clientX-this.inputCorrection.x,this.mousePosition.y=t.clientY-this.inputCorrection.y,t.preventDefault()}Pressed(t){return this.keyMap[t]>0}JustPressed(t){return this.keyMap[t]==this.frameRef-1}PressedDuration(t){var e=this.keyMap[t];return e>0?this.frameRef-e:-1}Released(t){return 0==this.keyMap[t]}}const r="_id_";class o{constructor(t){this.pool=[],this.factory=t,this.nextAvailableIndex=-1,this.totalAllocationCount=0}addCapacity(t){this.pool=[...h(this.pool.length,t,this.factory),...this.pool],this.nextAvailableIndex+=t}reserve(){const t=this.pool[this.nextAvailableIndex];return this.pool[this.nextAvailableIndex]=null,this.nextAvailableIndex--,this.totalAllocationCount++,t}free(t){this.nextAvailableIndex++,this.pool[this.nextAvailableIndex]=t}get capacity(){return this.pool.length}get assigned(){return this.pool.length-this.nextAvailableIndex}get totalAllocations(){return this.totalAllocationCount}}const a=(t,e)=>e-t,h=(t,e,i)=>(t=>Array(t).fill(null))(e).map((e,s)=>i(t+s)).sort(a);class l{constructor(t){this.reset(t)}get(t){const e=Math.floor(t/32);return!!(this.values[e]&1<<t-32*e)}set(t,e){const i=Math.floor(t/32);e?this.values[i]|=1<<t-32*i:this.values[i]&=~(1<<t-32*i)}maskAll(t){for(let e=0;e<this.size;e++){const i=t[e];if((i&this.values[e])!==i)return!1}return!0}maskNone(t){for(let e=0;e<this.size;e++){if(t[e]&this.values[e])return!1}return!0}not(){for(let t=0;t<this.size;t++)this.values[t]=~this.values[t]}and(t){for(let e=0;e<this.size;e++)this.values[e]=this.values[e]&t.values[e]}or(t){for(let e=0;e<this.size;e++)this.values[e]=this.values[e]|t.values[e]}xor(t){for(let e=0;e<this.size;e++)this.values[e]=this.values[e]^t.values[e]}reset(t){this.size=t,this.values=new Uint32Array(this.size);for(let t=0;t<Math.ceil(this.size/32);t++)this.values[t]=0}}class c{constructor(){this.components=new Map,this.componentTypes=new Map,this.phases=new Array,this.systems=new Array,this.c4e=new Map,this.entityPool=new o(t=>t),this.nextId=0}addCapacityToEngine(t){this.entityPool.addCapacity(t),this.components.forEach((t,e)=>this.components.set(e,[...this.components.get(e),...d(this.entityPool.capacity)]))}createEntity(){const t=this.entityPool.reserve();return this.c4e.set(t,u(this,t)),t}destroyEntity(t){this.systems.forEach(e=>e.removeEntity(t)),this.clearAllComponentsForEntity(t),this.entityPool.free(t),this.c4e.delete(t)}getComponentForEntity(t,e){const i=e.name;return this.components.has(i)?this.components.get(i)[t]:null}addComponentsToEntity(t,e){e.forEach(e=>{const i=this.createComponentEntryFromInstance(e);this.components.get(i)[t]=e}),this.matchEntity(t)}removeComponentsFromEntityByType(t,e){e.forEach(e=>{const i=e.name;this.components.has(i)&&(this.components.get(i)[t]=null)}),this.matchEntity(t)}addPhase(t){t.engine=this,this.phases.push(t)}addPhaseSystemToEngine(t){this.systems.push(t);const e=new l(4);t.componentTypes.forEach(t=>{const i=this.createComponentEntryFromType(t);e.set(this.componentTypes.get(i),!0)}),t.onAddedToEngine(this,e)}update(t,e){this.phases.forEach(i=>i.updatePhase(t,e))}query(t){const e=[];for(let i=0;i<this.entityPool.capacity;i++)t.every(t=>null!==this.components.get(t.name)[i])&&e.push(i);return e}createComponentEntryFromType(t){const e=t.name;if(!this.components.has(e)){const i=this.nextId++;this.components.set(e,d(this.entityPool.capacity)),this.componentTypes.set(e,i),t.prototype[r]=i}return e}createComponentEntryFromInstance(t){const e=t.constructor.name;if(!this.components.has(e)){const i=this.nextId++;this.components.set(e,d(this.entityPool.capacity)),this.componentTypes.set(e,i),t.constructor.prototype[r]=i}return e}matchEntity(t){this.systems.forEach(e=>0===e.componentTypes.reduce((e,i)=>this.components.get(i.name)[t]?e-1:e,e.componentTypes.length)?e.addEntity(t,this.entityComponentsForSystem(t,e)):e.removeEntity(t))}entityComponentsForSystem(t,e){return e.componentTypes.map(e=>this.components.get(e.name)[t])}addEntitiesToComponentList(t){this.components.set(t,d(this.entityPool.capacity))}clearAllComponentsForEntity(t){this.components.forEach(e=>e[t]=null)}snapshot(){return{activeEntities:this.entityPool.assigned,totalEntitiesCreated:this.entityPool.totalAllocations}}}const d=t=>Array(t).fill(null),u=(t,e)=>i=>t.getComponentForEntity(e,i);class p{constructor(t,e,i,s,n=0){this.active=!0,this.params=null,this._listener=e,this._isOnce=i,this.context=s,this._signal=t,this.priority=n||0}execute(t){var e,i;return this.active&&this._listener&&(i=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,i),this._isOnce&&this.detach()),e}detach(){return this.isBound()?this._signal.remove(this._listener,this.context):null}isBound(){return!!this._signal&&!!this._listener}isOnce(){return this._isOnce}getListener(){return this._listener}getSignal(){return this._signal}_destroy(){delete this._signal,delete this._listener,delete this.context}toString(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}}class g{constructor(){this._bindings=[],this._prevParams=null,this.memorize=!1,this._shouldPropagate=!0,this.active=!0}validateListener(t,e){if("function"!=typeof t)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))}_registerListener(t,e,i,s){var n,r=this._indexOfListener(t,i);if(-1!==r){if((n=this._bindings[r]).isOnce()!==e)throw new Error("You cannot add"+(e?"":"Once")+"() then add"+(e?"Once":"")+"() the same listener without removing the relationship first.")}else n=new p(this,t,e,i,s),this._addBinding(n);return this.memorize&&this._prevParams&&n.execute(this._prevParams),n}_addBinding(t){var e=this._bindings.length;do{--e}while(this._bindings[e]&&t.priority<=this._bindings[e].priority);this._bindings.splice(e+1,0,t)}_indexOfListener(t,e){for(var i,s=this._bindings.length;s--;)if((i=this._bindings[s]).getListener()===t&&i.context===e)return s;return-1}has(t,e=null){return-1!==this._indexOfListener(t,e)}add(t,e=null,i=0){return this.validateListener(t,"add"),this._registerListener(t,!1,e,i)}addOnce(t,e=null,i=0){return this.validateListener(t,"addOnce"),this._registerListener(t,!0,e,i)}remove(t,e=null){this.validateListener(t,"remove");var i=this._indexOfListener(t,e);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),t}removeAll(){for(var t=this._bindings.length;t--;)this._bindings[t]._destroy();this._bindings.length=0}getNumListeners(){return this._bindings.length}halt(){this._shouldPropagate=!1}dispatch(...t){if(this.active){var e,i=this._bindings.length;if(this.memorize&&(this._prevParams=t),i){e=this._bindings.slice(0),this._shouldPropagate=!0;do{i--}while(e[i]&&this._shouldPropagate&&!1!==e[i].execute(t))}}}forget(){this._prevParams=null}dispose(){this.removeAll(),delete this._bindings,delete this._prevParams}toString(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}}class y{constructor(){this.assets=new Map,this.loaded=new g,this.Reset()}Reset(){this.running=!1,this.loaders=new Array}SetImagesToLoad(t){t.forEach(t=>this.AddAsset(t))}AddAsset(t){if(1!=this.running){var e=this.LoaderFactory(t);e.Init(t),this.loaders.push(e)}}LoaderFactory(t){var e=t.substring(t.length-3,t.length);return"png"==e?new m(this):"tmx"==e||"xml"==e||"son"==e?new x(this):null}Load(){1!=this.running&&0!=this.loaders.length&&(this.completeCount=this.loaders.length,this.running=!0,this.loaders.forEach(t=>t.Load()))}onLoad(t){this.completeCount--,this.assets.set(t.getKey(),t.getValue()),0==this.completeCount&&(this.loaded.dispatch(),this.running=!1)}}class m{constructor(t){this.mgr=t}Init(t){this.url=t,this.image=new Image,this.image.onload=this.onLoad.bind(this),this.image.crossOrigin="anonymous"}Load(){this.image.src=this.url+"?cb="+Date.now(),1==this.image.complete&&this.onLoad(null)}onLoad(t){null!=this.mgr&&this.mgr.onLoad(this)}getKey(){return this.url}getValue(){return this.image}}class x{constructor(t){this.mgr=t}Init(t){this.url=t,this.xhr=new XMLHttpRequest,this.xhr.responseType="text",this.xhr.onload=this.onLoad.bind(this),this.xhr.open("GET",this.url+"?cb="+Date.now(),!0)}Load(){this.xhr.send()}onLoad(t){null!=this.mgr&&this.mgr.onLoad(this)}getKey(){return this.url}getValue(){return this.xhr.response}}const b=1e3/60+1e-8;class f{constructor(){this.isRunning=!1,this.update=this.update.bind(this)}update(t){return this.delta=0==this.prevAnimationTime?b:t-this.prevAnimationTime,this.prevAnimationTime=t,null!=this.updateFunc&&this.updateFunc(b,Math.floor(t)),this.rafID=window.requestAnimationFrame(this.update),!1}start(){1!=this.isRunning&&(this.isRunning=!0,this.prevAnimationTime=0,this.rafID=window.requestAnimationFrame(this.update))}stop(){0!=this.isRunning&&(this.isRunning=!1,window.cancelAnimationFrame(this.rafID))}}class E{}E.tileSize=16,E.engine=null;class w{constructor(t){this.canvas=t,this.loop=new f,this.loop.updateFunc=this.update.bind(this),this.input=new n;var e=t.getBoundingClientRect();this.input.InputTarget(document,new s(e.left,e.top)),window.location!==window.parent.location&&(window.onclick=()=>{document.hasFocus()||window.focus()}),E.engine=this.engine=new c}loadAssets(t){this.assets=new y,this.assets.loaded.add(this.initalize.bind(this)),this.assets.SetImagesToLoad(t),this.assets.Load()}initalize(){}update(t,e){this.preUpdate(),this.engine.update(t,e),this.postUpdate()}preUpdate(){}postUpdate(){}}w.params={tileSize:16,debug:!1};class v{constructor(t){this.members=new Map,this.componentTypes=t}onAddedToEngine(t,e){this.engine=t,this.matchMask=e}addEntity(t,e){if(this.members.has(t))return;const i={components:e,boundUpdate:this.updateEntity.bind(this,t,...e)};this.members.set(t,i),this.onEntityAdded(t,...e)}onEntityAdded(t,...e){}removeEntity(t){if(!this.members.has(t))return;const e=this.members.get(t);this.onEntityRemoved(t,...e.components),this.members.delete(t)}onEntityRemoved(t,...e){}updateSystem(t,e){this.dt=t,this.timestamp=e,this.preUpdate()&&(this.updateAllEntities(),this.postUpdate())}preUpdate(){return!0}updateAllEntities(){for(const t of this.members)t[1].boundUpdate()}postUpdate(){}updateEntity(t,...e){}}class C{constructor(t,e,i=1,n=1){this.coords=new s(t,e),this.prevCoords=new s(t,e),this.direction=new s(i,n)}update(t){this.prevCoords.copy(this.coords),this.coords.copy(t)}clone(){var t=new C(this.coords.x,this.coords.y);return t.prevCoords.copy(this.prevCoords),t.direction.copy(this.direction),t}}class T{constructor(t,e=null){this.frameListId=t,this.initialFrameId=e}setFrame(t){this.frame=t,null!=this.sprite&&this.frame.updateSprite(this.sprite)}setFrameId(t){this.frame=this.frameList.getFrame(t)}}function S(){return(t=new Float32Array(9))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t;var t}class A{constructor(){this.position=new s,this.scale=new s(1,1),this.pivot=new s,this._rotationComponents=new s,this.rotation=0,this.alpha=1,this.visible=!0,this.renderable=!1,this.parent=null,this.worldTransform=S(),this.localTransform=S()}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._rotationComponents.x=Math.cos(this._rotation),this._rotationComponents.y=Math.sin(this._rotation)}get visible(){return this._visible}set visible(t){this._visible=t}RoundFunction(t){return t}updateTransform(){}calcExtents(){}}const R=1e-8,P=(Math.PI,Math.PI/180),L=Math.pow(2,31)-1,_=-L;function F(t){return t*P}class B{constructor(t=0,e=0,i=0,s=0){this.l=L,this.t=L,this.r=_,this.b=_,this.t=t,this.r=e,this.b=i,this.l=s}setToSweeptAABB(t,e){this.l=t.position.x-t.extents.x,this.r=t.position.x+t.extents.x,this.t=t.position.y-t.extents.y,this.b=t.position.y+t.extents.y}fromAABB(t){}clone(){return new B(this.t,this.r,this.b,this.l)}reset(){this.t=this.l=L,this.r=this.b=_}get width(){return this.r-this.l}get height(){return this.b-this.t}intersect(t){return this.l<=t.r&&this.r>t.l&&this.t<=t.b&&this.b>=t.t}addAABB(t){t.t<this.t&&(this.t=t.t),t.r>this.r&&(this.r=t.r),t.b>this.b&&(this.b=t.b),t.l<this.l&&(this.l=t.l)}combine(t){const e=this.clone();return e.addAABB(t),e}combine2(t,e){return this.t=Math.min(t.t,e.t),this.r=Math.max(t.r,e.r),this.b=Math.max(t.b,e.b),this.l=Math.min(t.l,e.l),this}addPoint(t,e){t<this.l&&(this.l=t),t>this.r&&(this.r=t),e<this.t&&(this.t=e),e>this.b&&(this.b=e)}fitPoint(t){t.x<this.l&&(t.x=this.l),t.x>this.r&&(t.x=this.r),t.y<this.t&&(t.y=this.t),t.y>this.b&&(t.y=this.b)}expand(t){this.l-=t,this.r+=t,this.t-=t,this.b+=t}expand2(t,e){this.l+=t/2,this.r-=t/2,this.t+=e/2,this.b-=e/2}contains(t){return this.l<=t.l&&this.t<=t.t&&t.b<this.b&&t.r<this.r}copy(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b}copyAABB(t){this.l=t.l,this.r=t.r,this.t=t.t,this.b=t.b}transform(t){this.l+=t.x,this.r+=t.x,this.t+=t.y,this.b+=t.y}perimeter(){return 2*(this.width+this.height)}}class M extends A{constructor(){super(),this.subTreeAABB=new B,this.childCount=0}addChild(t){null!=t.parent&&t.parent.removeChild(t),this.insertEnd(t),this.childAdded(t)}addChildAt(t,e){e>=this.childCount?this.addChild(t):(0==e?this.insertBeginning(t):this.insertBefore(this.findChildByIndex(e),t),this.childAdded(t))}childAdded(t){this.childCount++,t.parent=this}findChildByIndex(t){for(var e=this.head,i=0;null!=e;){if(i++==t)return e;e=e.next}return this.tail}removeChild(t){t.parent==this&&(this.remove(t),this.childRemoved(t))}removeChildAt(t){var e=this.findChildByIndex(t);return this.removeChild(e),e}childRemoved(t){this.childCount--,t.parent=null}updateTransform(){const t=Math.floor(this.position.x),e=Math.floor(this.position.y),i=this._rotationComponents.y,s=this._rotationComponents.x;this.localTransform[0]=s*this.scale.x,this.localTransform[1]=-i*this.scale.y,this.localTransform[3]=i*this.scale.x,this.localTransform[4]=s*this.scale.y;const n=this.parent.worldTransform,r=this.localTransform[0],o=this.localTransform[1],a=t-(this.localTransform[0]*this.pivot.x-this.pivot.y*this.localTransform[1]),h=this.localTransform[3],l=this.localTransform[4],c=e-(this.localTransform[4]*this.pivot.y-this.pivot.x*this.localTransform[3]),d=n[0],u=n[1],p=n[2],g=n[3],y=n[4],m=n[5];this.localTransform[2]=a,this.localTransform[5]=c,this.worldTransform[0]=d*r+u*h,this.worldTransform[1]=d*o+u*l,this.worldTransform[2]=d*a+u*c+p,this.worldTransform[3]=g*r+y*h,this.worldTransform[4]=g*o+y*l,this.worldTransform[5]=g*a+y*c+m,this.worldAlpha=this.alpha*this.parent.worldAlpha,this.calcExtents();let x=this.head;for(;null!=x;)x.updateTransform(),x=x.next}insertAfter(t,e){e.prev=t,e.next=t.next,null==t.next?this.tail=e:t.next.prev=e,t.next=e}insertBefore(t,e){e.prev=t.prev,e.next=t,null==t.prev?this.head=e:t.prev.next=e,t.prev=e}insertBeginning(t){null==this.head?(this.head=t,this.tail=t,t.prev=null,t.next=null):this.insertBefore(this.head,t)}insertEnd(t){null==this.tail?this.insertBeginning(t):this.insertAfter(this.tail,t)}remove(t){null==t.prev?this.head=t.next:t.prev.next=t.next,null==t.next?this.tail=t.prev:t.next.prev=t.prev,t.prev=t.next=null}debug(){for(var t=this.head;null!=t;)t=t.next}}class G extends M{constructor(){super(),this.id="Stage",this.worldAlpha=this.alpha}updateTransform(){for(var t=this.head;null!=t;)t.updateTransform(),t=t.next}}class I{constructor(t,e,i,s=800,n=600,r=!1,o=!1){this.stage=t,this.camera=e,this.view=i,this.contextLost=!1,this.contextAttributes={},this.contextAttributes.alpha=r,this.contextAttributes.antialias=o,this.contextAttributes.premultipliedAlpha=!0,this.contextAttributes.stencil=!1,this.renderers=new Array,this.InitalizeWebGlContext(),this.Resize(s,n)}InitalizeWebGlContext(){this.view.addEventListener("webglcontextlost",this.onContextLost,!1),this.view.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.gl=this.view.getContext("webgl",this.contextAttributes),this.gl.disable(WebGLRenderingContext.DEPTH_TEST),this.gl.disable(WebGLRenderingContext.CULL_FACE),this.gl.enable(WebGLRenderingContext.BLEND),this.gl.colorMask(!0,!0,!0,this.contextAttributes.alpha),this.gl.clearColor(0,0,0,1),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.getExtension("OES_texture_float")||console.log("New browser time: Float textures not supported")}Resize(t,e){this.width=t,this.height=e,this.view.width=t,this.view.height=e,this.gl.viewport(0,0,t,e),this.gl.scissor(0,0,t,e)}AddRenderer(t){t.Init(this.gl,this.camera),t.Resize(this.width,this.height),this.renderers.push(t)}Render(t){this.contextLost||(this.gl.clearColor(159/255,188/255,197/255,1),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.renderers.forEach(e=>{e.Render(t)}))}onContextLost(t){this.contextLost=!0,console.log("webGL Context Lost")}onContextRestored(t){this.contextLost=!1,console.log("webGL Context Restored")}}class W{constructor(t,e,i,s=!1){this.gl=t,this.powerOfTwo=!1,this.width=e,this.height=i,this.RegisterTexture(s)}RegisterTexture(t){null==this.texture&&(this.texture=this.gl.createTexture()),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),this.powerOfTwo?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,this.width,this.height,0,WebGLRenderingContext.RGBA,t?WebGLRenderingContext.FLOAT:WebGLRenderingContext.UNSIGNED_BYTE,null)}static FromImage(t,e){var i=new W(t,e.width,e.height);return t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),i}bind(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.texture)}unbind(t){this.gl.activeTexture(WebGLRenderingContext.TEXTURE0+t),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,null)}drawTo(t){null==this.framebuffer&&(this.framebuffer=this.gl.createFramebuffer()),null==this.renderbuffer&&(this.renderbuffer=this.gl.createRenderbuffer()),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,this.framebuffer),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,this.renderbuffer),this.width==this.renderbuffer.width&&this.height==this.renderbuffer.height||(this.renderbuffer.width=this.width,this.renderbuffer.height=this.height,this.gl.renderbufferStorage(WebGLRenderingContext.RENDERBUFFER,WebGLRenderingContext.DEPTH_COMPONENT16,this.width,this.height),this.gl.framebufferTexture2D(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.COLOR_ATTACHMENT0,WebGLRenderingContext.TEXTURE_2D,this.texture,0),this.gl.framebufferRenderbuffer(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.DEPTH_ATTACHMENT,WebGLRenderingContext.RENDERBUFFER,this.renderbuffer)),this.gl.viewport(0,0,this.width,this.height),t(),this.gl.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,null),this.gl.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,null),this.gl.viewport(0,0,1280,720)}UnregisterTexture(t){this.texture}}class D{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s}}class z{constructor(t,e,i=null){this.noFrame=!1,this.baseTexture=t,null==e?(this.noFrame=!0,this.frame=new D(0,0,1,1)):this.frame=e,this.trim=new s,this.pivot=null==i?new s:i,this.uvs=new Float32Array(8),this.updateUVS()}updateUVS(){var t=this.baseTexture.width,e=this.baseTexture.height;this.uvs[0]=this.frame.x/t,this.uvs[1]=this.frame.y/e,this.uvs[2]=(this.frame.x+this.frame.width)/t,this.uvs[3]=this.frame.y/e,this.uvs[4]=(this.frame.x+this.frame.width)/t,this.uvs[5]=(this.frame.y+this.frame.height)/e,this.uvs[6]=this.frame.x/t,this.uvs[7]=(this.frame.y+this.frame.height)/e}}class O{constructor(t){this.gl=t,this.baseTextures=new Map,this.textures=new Map}AddTexture(t,e){var i=W.FromImage(this.gl,e);return this.baseTextures.set(t,i),i}ParseTexturePackerJSON(t,e){if("string"==typeof t){var i=this.baseTextures.get(e),n=JSON.parse(t);Object.keys(n.frames).forEach(t=>{var e=n.frames[t];this.textures.set(t,new z(i,new D(e.frame.x,e.frame.y,e.frame.w,e.frame.h),new s(e.pivot.x,e.pivot.y)))})}}ParseTexturesFromTiles(t,e){}}class U{constructor(){this.frames=new Array,this.framesHash=new Map,this.animationsHash=new Map}addFrame(t){this.frames.push(t),this.framesHash.set(t.name,t)}getFrame(t){return this.framesHash.get(t)}addAnimation(t){this.animationsHash.set(t.name,t)}getAnimation(t){return this.animationsHash.get(t)}get numFrames(){return frames.length}}class k{constructor(t,e,i){this.name=t,this.texture=e,this.scale=i}updateSprite(t,e=1,i=1){t.texture=this.texture,t.pivot.x=t.texture.frame.width*t.texture.pivot.x,t.pivot.y=(t.texture.frame.height+2)*t.texture.pivot.y,t.scale.x=this.scale.x*e,t.scale.y=this.scale.y*i}}class N{constructor(t,e,i=0,s=!0,n=!1,r=!1){this.name=t,this.frameRate=i,this.frames=e,this.looped=s,this.flipX=n,this.flipY=r,this.msPerFrame=1e3/this.frameRate,this.length=this.frames.length}}class V{constructor(t){this.textureManager=t,this.frameLists=new Map}getFrameList(t){return this.frameLists.get(t)}ParseFrameListJSON(t){if("string"==typeof t){var e=JSON.parse(t);Object.keys(e).forEach(t=>{var i=new U;this.frameLists.set(t,i);const s=e[t];null!=s.frames&&(s.frames.forEach(t=>{i.addFrame(new k(t.id,this.textureManager.textures.get(t.name),t.scale))}),null!=s.animations&&Object.keys(s.animations).forEach(t=>{var e=s.animations[t];i.addAnimation(new N(t,e.frames.map(t=>i.frames[t]),e.fps,e.looped,e.flipX,e.flipY))}))})}}}class H extends M{constructor(){super(),this.renderable=!0,this.anchor=new s,this.transformedVerts=new Float32Array(8)}calcExtents(){const t=this.texture.frame.width,e=this.texture.frame.height,i=this.anchor.x,s=this.anchor.y,n=t*(1-i),r=t*-i,o=e*(1-s),a=e*-s,h=this.worldTransform[0],l=this.worldTransform[3],c=this.worldTransform[1],d=this.worldTransform[4],u=this.worldTransform[2],p=this.worldTransform[5];this.transformedVerts[0]=h*r+c*a+u,this.transformedVerts[1]=d*a+l*r+p,this.transformedVerts[2]=h*n+c*a+u,this.transformedVerts[3]=d*a+l*n+p,this.transformedVerts[4]=h*n+c*o+u,this.transformedVerts[5]=d*o+l*n+p,this.transformedVerts[6]=h*r+c*o+u,this.transformedVerts[7]=d*o+l*r+p}}class q extends v{constructor(t,e,i){super([C,T]),this.canvas=t,this.stage=new G,this.camera=e,this.stage.addChild(this.camera),this.renderer=new I(this.stage,this.camera,this.canvas,i.x,i.y),this.camera.Resize(this.renderer.width,this.renderer.height),this.textureManager=new O(this.renderer.gl),this.frameListManager=new V(this.textureManager),this.itemContainer=new M,this.itemContainer.id="itemContainer",this.camera.addChild(this.itemContainer)}initalize(){}onEntityAdded(t,e,i){null==i.sprite&&(i.sprite=new H,i.frameList=this.frameListManager.getFrameList(i.frameListId),null!=i.initialFrameId?i.setFrame(i.frameList.getFrame(i.initialFrameId)):i.setFrame(i.frameList.frames[0]),i.sprite.position=e.coords),this.itemContainer.addChild(i.sprite)}onEntityRemoved(t,e,i){this.itemContainer.removeChild(i.sprite)}updateSystem(){this.camera.Focus(this._cameraTarget.x,this._cameraTarget.y),this.renderer.Render(this.camera.viewPortAABB)}set cameraTarget(t){this._cameraTarget=t}}function X(t,e,i){var s=t.createShader(i);return t.shaderSource(s,e),t.compileShader(s),t.getShaderParameter(s,WebGLRenderingContext.COMPILE_STATUS)?s:(window.alert(t.getShaderInfoLog(s)),null)}function j(t,e,i){var s=function(t,e){return X(t,e,WebGLRenderingContext.VERTEX_SHADER)}(t,e),n=function(t,e){return X(t,e,WebGLRenderingContext.FRAGMENT_SHADER)}(t,i),r=t.createProgram();return t.attachShader(r,s),t.attachShader(r,n),t.linkProgram(r),t.getProgramParameter(r,WebGLRenderingContext.LINK_STATUS)||window.alert("Could not initialize program"),r}class Y{constructor(t,e){this.program=e,t.useProgram(this.program),this.attribute={},this.uniform={};for(var i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_ATTRIBUTES),s=0;s<i;){var n=t.getActiveAttrib(e,s);this.attribute[n.name]=t.getAttribLocation(e,n.name),s++}for(i=t.getProgramParameter(e,WebGLRenderingContext.ACTIVE_UNIFORMS),s=0;s<i;){n=t.getActiveUniform(e,s);this.uniform[n.name]=t.getUniformLocation(e,n.name),s++}}}class J{constructor(t){this.gl=t,this.size=1,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.blendMode=0,this.dynamicSize=1}Clean(){}ResizeBatch(t){this.size=t,this.dynamicSize=t,this.data=new Float32Array(20*this.dynamicSize),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=new Uint16Array(6*this.dynamicSize);for(let t=0;t<this.dynamicSize;t++){const e=6*t,i=4*t;this.indices[e+0]=i+0,this.indices[e+1]=i+1,this.indices[e+2]=i+2,this.indices[e+3]=i+0,this.indices[e+4]=i+2,this.indices[e+5]=i+3}this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)}AddSpriteToBatch(t,e){const i=20*e,s=(t.texture.frame,t.texture.baseTexture.width,t.texture.baseTexture.height,t.texture.uvs);this.data[i+0]=t.transformedVerts[0],this.data[i+1]=t.transformedVerts[1],this.data[i+2]=s[0],this.data[i+3]=s[1],this.data[i+4]=t.worldAlpha,this.data[i+5]=t.transformedVerts[2],this.data[i+6]=t.transformedVerts[3],this.data[i+7]=s[2],this.data[i+8]=s[3],this.data[i+9]=t.worldAlpha,this.data[i+10]=t.transformedVerts[4],this.data[i+11]=t.transformedVerts[5],this.data[i+12]=s[4],this.data[i+13]=s[5],this.data[i+14]=t.worldAlpha,this.data[i+15]=t.transformedVerts[6],this.data[i+16]=t.transformedVerts[7],this.data[i+17]=s[6],this.data[i+18]=s[7],this.data[i+19]=t.worldAlpha}Render(t,e,i){var s,n,r;s=e,(n=new Array)[0]=s,r=1;for(var o=0,a=null;r>0;){var h=n[--r];if(null!=h.next&&(n[r++]=h.next),null!=h.head&&(n[r++]=h.head),h.visible&&h.renderable){var l=h;l.texture.baseTexture.texture==a&&o!=this.size||(this.Flush(t,a,o),o=0,a=l.texture.baseTexture.texture),this.AddSpriteToBatch(l,o),o++}}o>0&&this.Flush(t,a,o)}Flush(t,e,i){this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferSubData(WebGLRenderingContext.ARRAY_BUFFER,0,this.data),this.gl.vertexAttribPointer(t.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(t.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(t.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,e),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*i,WebGLRenderingContext.UNSIGNED_SHORT,0)}}class K{constructor(){this.first=!0}Init(t,e){this.gl=t,this.camera=e,this.projection=new s,this.spriteShader=new Y(t,j(t,K.SPRITE_VERTEX_SHADER,K.SPRITE_FRAGMENT_SHADER)),this.spriteBatch=new J(t),this.spriteBatch.ResizeBatch(1e3)}Resize(t,e){this.projection.x=t/2,this.projection.y=e/2}AddStage(t){this.stage=t}Render(t){this.stage.updateTransform(),this.gl.useProgram(this.spriteShader.program),this.gl.uniform2f(this.spriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(this.spriteShader.attribute.aColor),this.gl.vertexAttribPointer(this.spriteShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(this.spriteShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(this.spriteShader.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.spriteBatch.Render(this.spriteShader,this.stage,this.camera.viewPortAABB)}}K.SPRITE_VERTEX_SHADER="\n        precision mediump float;\n        attribute vec2 aVertexPosition;\n        attribute vec2 aTextureCoord;\n        attribute float aColor;\n        uniform vec2 projectionVector;\n        varying vec2 vTextureCoord;\n        varying float vColor;\n        void main(void) {\n            gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n            vTextureCoord = aTextureCoord;\n            vColor = aColor;\n        }",K.SPRITE_FRAGMENT_SHADER="\n        precision mediump float;\n        varying vec2 vTextureCoord;\n        varying float vColor;\n        uniform sampler2D uSampler;\n        void main(void) {\n            gl_FragColor = texture2D(uSampler,vTextureCoord) * vColor;\n        }";class Z{constructor(t,e,i=null){this.w=t,this.h=e,this.buffer=null==i?new ArrayBuffer(this.w*this.h*4):i,this.data32=new Uint32Array(this.buffer),this.data8=new Uint8Array(this.buffer)}get(t,e){return this.data32[e*this.w+t]}set(t,e,i){this.data32[e*this.w+t]=i}}class Q{constructor(t,e,i,s,n){this.initalize(t,e,i,s,n)}initalize(t,e,i,s,n){this.width=t,this.height=e,this.numberernalWidth=t*s,this.cellSize=i,this.invCellSize=1/i,this.bytesPerCell=s,this.data=null==n?new ArrayBuffer(t*e*s):n,this.data8=new Uint8Array(this.data)}get(t,e,i){return this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]}set(t,e,i,s){this.data8[e*this.numberernalWidth+t*this.bytesPerCell+i]=s}getReal(t,e,i){return this.get(this.Index(t),this.Index(e),i)}Index(t){return t*this.invCellSize|0}}const $=function(t,e=4){var i,s,n,r=function(t){return window.atob(t.replace(/[^A-Za-z0-9\+\/\=]/g,""))}(t),o=new Uint32Array(r.length/e);for(i=0,n=r.length/e;i<n;i++)for(o[i]=0,s=e-1;s>=0;--s)o[i]+=r.charCodeAt(i*e+s)<<(s<<3);return o};function tt(t){const e=$(t.data);return new Q(t.width,t.height,16,4,e.buffer)}function et(t,e){const i=t.layers.filter(t=>t.name===e);return 1===i.length?i[0]:null}function it(t){for(var e=new Z(t.width,t.height),i=0;i<t.width;i++)for(var s=0;s<t.height;s++){var n=t.get(i,s,3)<<24|t.get(i,s,2)<<16|t.get(i,s,1)<<8|t.get(i,s,0);if(n>0){var r=Math.floor(n/1024),o=Math.floor(r/8),a=r%8,h=n-1024*r;h--;var l=Math.floor(h/32),c=o<<24|a<<16|l<<8|h-32*l;e.set(i,s,c)}else e.set(i,s,4294967295)}return e}class st{constructor(){this.scrollScale=new s(1,1),this.inverseTileDataTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2)}setSpriteTexture(t){this.spriteTexture=t.texture,this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height}setTextureFromMap(t,e){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,e.w,e.h,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e.data8),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE),this.inverseTileDataTextureSize[0]=1/e.w,this.inverseTileDataTextureSize[1]=1/e.h}setTexture(t,e,i){null==this.tileDataTexture&&(this.tileDataTexture=t.createTexture()),t.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.tileDataTexture),t.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),i?(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.inverseTileDataTextureSize[0]=1/e.width,this.inverseTileDataTextureSize[1]=1/e.height}}class nt{constructor(t,e){this.tileMap=t,this.layers=e,this.lastSnap=new s(0,0),this.thisSnap=new s(-1e3,-1e3),this.snapChanged=!1,this.size=new s,this.renderSurface=this.renderSurface.bind(this)}Init(t,e){this.sprite=new H,this.sprite.id="renderTexture"}Resize(t,e){this.size.setTo(t,e),this.surface=new W(this.tileMap.gl,t,e),this.texture=new z(this.surface,new D(0,0,t,e),new s(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(2,-2),this.sprite.pivot.setTo(t/2,e/2)}calcSnap(t){return this.lastSnap.copy(this.thisSnap),this.thisSnap.x=16*(Math.floor(t.x/-16)-1),this.thisSnap.y=16*(Math.floor(t.y/-16)-1),this.snapChanged=this.lastSnap.x!=this.thisSnap.x||this.lastSnap.y!=this.thisSnap.y,this.snapChanged}Render(t){this.calcSnap(this.tileMap.camera.position),this.sprite.position.copy(this.size),this.sprite.position.plusEquals(this.thisSnap),this.surface.drawTo(this.renderSurface)}renderSurface(){this.tileMap.RenderLayers(this)}}class rt{constructor(t,e){this.tileSize=t,this.tileScale=e,this.layers=new Array,this.layersMap=new Map,this.renderLayers=new Array,this.renderLayersMap=new Map}Init(t,e){if(null==this.gl){this.gl=t,this.camera=e,this.filtered=!1,this.spriteSheet=this.gl.createTexture(),this.viewportSize=new s,this.scaledViewportSize=new Float32Array(2),this.inverseTileTextureSize=new Float32Array(2),this.inverseSpriteTextureSize=new Float32Array(2),this.quadVertBuffer=this.gl.createBuffer(),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer);var i=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]);t.bufferData(WebGLRenderingContext.ARRAY_BUFFER,i,WebGLRenderingContext.STATIC_DRAW),this.tilemapShader=new Y(t,j(t,rt.TILEMAP_VERTEX_SHADER,rt.TILEMAP_FRAGMENT_SHADER)),this.flip=!1,this.writebuffer2=new Z(3,3),this.renderLayers.forEach(i=>i.Init(t,e))}}Resize(t,e){var i=(Math.floor(t/(this.tileSize*this.tileScale))+2)*this.tileSize,s=(Math.floor(e/(this.tileSize*this.tileScale))+2)*this.tileSize;this.viewportSize.x=i*this.tileScale,this.viewportSize.y=s*this.tileScale,this.scaledViewportSize[0]=this.viewportSize.x/this.tileScale,this.scaledViewportSize[1]=this.viewportSize.y/this.tileScale,this.renderLayers.forEach(t=>t.Resize(Math.floor(i),Math.floor(s)))}SetSpriteSheet(t){this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.spriteSheet),this.gl.pixelStorei(WebGLRenderingContext.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,t),this.filtered?(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR)):(this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),this.gl.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST)),this.inverseSpriteTextureSize[0]=1/t.width,this.inverseSpriteTextureSize[1]=1/t.height}SetTileLayer(t,e,i,s){var n=new st;n.setTexture(this.gl,t,!1),n.scrollScale.x=i,n.scrollScale.y=s,this.layers.push(n)}SetTileLayerFromData(t,e,i,s,n){var r=new st;return r.setTextureFromMap(this.gl,t),r.setSpriteTexture(e),r.scrollScale.x=s,r.scrollScale.y=n,this.layers.push(r),this.layersMap.set(i,r),r}SetTileRenderLayer(t,e){var i=new nt(this,e);this.renderLayers.push(i),this.renderLayersMap.set(t,i)}updateMap(t,e,i){var s=i[0],n=i[1],r=i[2],o=i[3],a=i[4],h=i[5],l=Math.floor(i[6]/8),c=i[6]%8;this.writebuffer2.h=o,this.writebuffer2.w=r;for(var d=0;d<o;d++)for(var u=0;u<r;u++){var p=l<<24|c<<16|n+d<<8|s+u;this.writebuffer2.set(u,d,p)}var g=this.layers[2].tileDataTexture;this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,g),this.gl.texSubImage2D(WebGLRenderingContext.TEXTURE_2D,0,t-a,e-h,r,o,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,this.writebuffer2.data8)}Render(t){this.renderLayers.forEach(e=>e.Render(t))}RenderLayers(t){this.gl.clearColor(0,0,0,0),this.gl.colorMask(!0,!0,!0,!0),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.useProgram(this.tilemapShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.quadVertBuffer),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.position),this.gl.enableVertexAttribArray(this.tilemapShader.attribute.texture),this.gl.vertexAttribPointer(this.tilemapShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.tilemapShader.attribute.texture,2,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.uniform2fv(this.tilemapShader.uniform.viewportSize,this.scaledViewportSize),this.gl.uniform1f(this.tilemapShader.uniform.tileSize,this.tileSize),this.gl.uniform1f(this.tilemapShader.uniform.inverseTileSize,1/this.tileSize),this.gl.uniform1i(this.tilemapShader.uniform.sprites,0),this.gl.uniform1i(this.tilemapShader.uniform.tiles,1);for(var e=0;e<t.layers.length;e++){const i=this.layersMap.get(t.layers[e]),s=t.thisSnap.x/2,n=t.thisSnap.y/2;this.gl.uniform2f(this.tilemapShader.uniform.viewOffset,s,n),this.gl.uniform2fv(this.tilemapShader.uniform.inverseSpriteTextureSize,i.inverseSpriteTextureSize),this.gl.uniform2fv(this.tilemapShader.uniform.inverseTileTextureSize,i.inverseTileDataTextureSize),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.spriteTexture),this.gl.activeTexture(WebGLRenderingContext.TEXTURE1),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,i.tileDataTexture),this.gl.drawArrays(WebGLRenderingContext.TRIANGLES,0,6)}this.gl.colorMask(!0,!0,!0,!1)}}rt.TILEMAP_VERTEX_SHADER="\n        precision mediump float;\n        attribute vec2 position;\n        attribute vec2 texture;\n\n        varying vec2 pixelCoord;\n        varying vec2 texCoord;\n\n        uniform vec2 viewOffset;\n        uniform vec2 viewportSize;\n        uniform vec2 inverseTileTextureSize;\n        uniform float inverseTileSize;\n\n        void main(void) {\n           pixelCoord = (texture * viewportSize) + viewOffset;\n           texCoord = pixelCoord * inverseTileTextureSize * inverseTileSize;\n           gl_Position = vec4(position, 0.0, 1.0);\n        }",rt.TILEMAP_FRAGMENT_SHADER="\n        precision mediump float;\n\n        varying vec2 pixelCoord;\n        varying vec2 texCoord;\n\n        uniform sampler2D tiles;\n        uniform sampler2D sprites;\n\n        uniform vec2 inverseTileTextureSize;\n        uniform vec2 inverseSpriteTextureSize;\n        uniform float tileSize;\n\n        void main(void) {\n           vec4 tile = texture2D(tiles, texCoord);\n            // if(tile.x == 1.0 && tile.y == 1.0) { discard; }\n            if (tile.x == 1.0 && tile.y == 1.0) { \n                discard;\n                // gl_FragColor = vec4(0.0,0.0,0.0,0.0);\n            } else {\n                vec2 superSpriteOffset = floor(tile.zw * 256.0) * 256.0;\n                vec2 spriteOffset = floor(tile.xy * 256.0) * tileSize;\n                vec2 spriteCoord = mod(pixelCoord, tileSize);\n\n                //Works\n                //    spriteCoord.x = (-1.0+(2.0* 0.0)) * (( 0.0*tileSize) - spriteCoord.x); //normal  0\n                //    spriteCoord.x = (-1.0+(2.0* 1.0)) * (( 1.0*tileSize) - spriteCoord.x); //flip   1\n\n                gl_FragColor = texture2D(sprites, (superSpriteOffset + spriteOffset + spriteCoord) * inverseSpriteTextureSize);\n            }\n        }";class ot{constructor(t,e){this.frameListId=t,this.play(e)}play(t){this.animationId!==t&&(this.animationId=t,this.dirty=!0)}}class at{constructor(t){this.play(t)}update(t){return this.accumulatedTime+=t,this.accumulatedTime>this.animation.msPerFrame&&(this.frameIndex=++this.frameIndex%this.animation.length,this.accumulatedTime=0),this.animation.frames[this.frameIndex]}play(t){this.animation=t,this.frameIndex=0,this.accumulatedTime=0}}class ht extends v{constructor(t){super([C,T,ot]),this.frameListManager=t}onEntityAdded(t,e,i,s){const n=this.frameListManager.getFrameList(s.frameListId).getAnimation(s.animationId);s.dirty=!1,s.animationController=new at(n)}updateEntity(t,e,i,s){s.dirty&&this.playAnimation(s),s.animationController.update(this.dt).updateSprite(i.sprite,e.direction.x,e.direction.y)}playAnimation(t){t.dirty=!1;const e=this.frameListManager.getFrameList(t.frameListId).getAnimation(t.animationId);t.animationController.play(e)}}class lt{constructor(){this.start=new s,this.end=new s,this.delta=new s,this.scale=new s,this.sign=new s}set(t,e){this.start.copy(t),this.end.copy(e),this.delta.copy(this.end),this.delta.minusEquals(this.start),this.scale.setTo(1/this.delta.x,1/this.delta.y),this.sign.x=this.delta.x<0?-1:1,this.sign.y=this.delta.y<0?-1:1}}class ct{constructor(){this.position=new s,this.delta=new s,this.normal=new s,this.distance=0,this.time=0,this.sweepPosition=new s}setTo(t){this.position.x=t.position.x,this.position.y=t.position.y,this.delta.x=t.delta.x,this.delta.y=t.delta.y,this.normal.x=t.normal.x,this.normal.y=t.normal.y,this.time=t.time,this.distance=t.distance,this.sweepPosition.x=t.sweepPosition.x,this.sweepPosition.y=t.sweepPosition.y}}class dt{constructor(t=1,e=4294967295,i=0){this.groupIndex=0,this.categoryBits=1,this.maskBits=4294967295,this.categoryBits=t,this.maskBits=e,this.groupIndex=i}static CHECK(t,e){return null==t||null==e||(t.groupIndex==e.groupIndex&&0!=t.groupIndex?t.groupIndex>0:0!=(t.maskBits&e.categoryBits)&&0!=(t.categoryBits&e.maskBits))}clone(){return new dt(this.categoryBits,this.maskBits,this.groupIndex)}}const ut=new ct;const pt=function(t,e){if(0,t.isStatic&&e.isStatic||t.isSensor&&e.isSensor)return!1;if(!t.isActive||!e.isActive)return!1;if(!dt.CHECK(t.filter,e.filter))return!1;var i=!1;if(t.isSensor||e.isSensor)i=mt(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,ut);else if(t.isStatic||e.isStatic){var s,n;t.isStatic?(s=t,n=e):(s=e,n=t),n.body.isBullet?(i=gt(n,s))&&n.body.respondBulletCollision(ut):(wt(n.aabb.position,n.aabb.extents,s.aabb.position,s.aabb.extents,s.responseBias,ut),i=n.body.respondStaticCollision(ut))}else{if(t.body.isBullet&&e.body.isBullet)return!1;t.body.isBullet?1==Et(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,ut)&&(t.body.respondBulletCollision(ut),i=!0):e.body.isBullet?1==Et(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,e.body.delta,ut)&&(e.body.respondBulletCollision(ut),i=!0):i=mt(t.aabb.position,t.aabb.extents,e.aabb.position,e.aabb.extents,ut)}return 1==i&&(t.collide(e,ut),e.collide(t,ut)),i},gt=function(t,e){return Et(e.aabb.position,e.aabb.extents,t.aabb.position,t.aabb.extents,t.body.delta,ut)},yt=function(t,e){return!!ft(e.aabb.position,e.aabb.extents,t.origin,t.delta,0,0,ut)&&(t.report(ut.delta.x,ut.delta.y,ut.normal.x,ut.normal.y,e),!0)},mt=function(t,e,i,s,n){const r=i.x-t.x,o=s.x+e.x-Math.abs(r);if(o<=0)return!1;const a=i.y-t.y,h=s.y+e.y-Math.abs(a);if(h<=0)return!1;if(o<h){const s=r<0?-1:1;n.distance=n.delta.x=o*s,n.delta.y=0,n.normal.x=s,n.normal.y=0,n.position.x=t.x+e.x*s,n.position.y=i.y}else{const s=a<0?-1:1;n.delta.x=0,n.distance=n.delta.y=h*s,n.normal.x=0,n.normal.y=s,n.position.x=i.x,n.position.y=t.y+e.y*s}return!0},xt=function(t,e,i,s,n){return bt(e,i,t.start,t.scale,t.sign,s,n)},bt=function(t,e,i,s,n,r,o){const a=(t.x-n.x*(e.x+r)-i.x)*s.x,h=(t.y-n.y*(e.y+o)-i.y)*s.y,l=(t.x+n.x*(e.x+r)-i.x)*s.x,c=(t.y+n.y*(e.y+o)-i.y)*s.y;if(a>c||h>l)return!1;const d=Math.max(a,h),u=Math.min(l,c);return!(d>=1||u<=0)},ft=function(t,e,i,s,n,r,o){const a=1/s.x,h=1/s.y,l=a<0?-1:1,c=h<0?-1:1,d=(t.x-l*(e.x+n)-i.x)*a,u=(t.y-c*(e.y+r)-i.y)*h,p=(t.x+l*(e.x+n)-i.x)*a,g=(t.y+c*(e.y+r)-i.y)*h;if(d>g||u>p)return!1;const y=Math.max(d,u),m=Math.min(p,g);return!(y>=1||m<=0)&&(o.time=Math.min(Math.max(y,0),1),d>u?(o.normal.x=-l,o.normal.y=0):(o.normal.x=0,o.normal.y=-c),o.delta.x=o.time*s.x,o.delta.y=o.time*s.y,o.position.x=i.x+o.delta.x,o.position.y=i.y+o.delta.y,!0)},Et=function(t,e,i,s,n,r){if(0==n.x&&0==n.y)return r.sweepPosition.x=i.x,r.sweepPosition.y=i.y,mt(t,e,i,s,r)?(r.time=0,!0):(r.time=1,!1);if(ft(t,e,i,n,s.x,s.y,r)){r.time=Math.min(Math.max(r.time-1e-8,0),1),r.sweepPosition.x=i.x+n.x*r.time,r.sweepPosition.y=i.y+n.y*r.time;const t=Math.sqrt(n.x*n.x+n.y*n.y);return r.position.x+=n.x/t*s.x,r.position.y+=n.y/t*s.y,!0}return r.sweepPosition.x=i.x*n.x,r.sweepPosition.y=i.y*n.y,!1},wt=function(t,e,i,s,n,r){const o=i.x-t.x,a=s.x+e.x-Math.abs(o),h=i.y-t.y;a<s.y+e.y-Math.abs(h)?(r.normal.x=o<0?1:-1,r.normal.y=0):(r.normal.x=0,r.normal.y=h<0?1:-1),r.normal.x*=n.x,r.normal.y*=n.y;const l=r.normal.x*(e.x+s.x)+i.x,c=r.normal.y*(e.y+s.y)+i.y,d=t.x-l,u=t.y-c;return r.distance=d*r.normal.x+u*r.normal.y,!0},vt=function(t,e,i,s,n,r){r.normal.copy(n);const o=r.normal.x*(e.x+s.x)+i.x,a=r.normal.y*(e.y+s.y)+i.y,h=t.x-o,l=t.y-a;return r.distance=h*r.normal.x+l*r.normal.y,!0};class Ct{constructor(){this.n=new s,this.d=0}set(t,e){this.n.copy(t),this.d=this.n.dot(e)}setFromSegment(t,e){this.n.copy(t),this.n.minusEquals(e),this.n.normalize(),this.n.leftHandNormalEquals(),this.d=this.n.dot(t)}distancePoint(t){return this.n.dot(t)-this.d}}class Tt{constructor(){this.position=new s,this.extents=new s}get l(){return this.position.x-this.extents.x}get t(){return this.position.y-this.extents.y}get r(){return this.position.x+this.extents.x}get b(){return this.position.y+this.extents.y}overlap(t){return!(Math.abs(this.position.x-t.position.x)>this.extents.x+t.extents.x)&&!(Math.abs(this.position.y-t.position.y)>this.extents.y+t.extents.y)}containsAABB(t){return!1}containsPoint(t){return Math.abs(t.x-this.position.x)<this.extents.x&&Math.abs(t.y-this.position.y)<this.extents.y}overlapArea(t){var e=Math.max(this.l,t.l),i=Math.min(this.r,t.r),s=Math.max(this.t,t.t);return(i-e)*(Math.min(this.b,t.b)-s)}area(){return this.extents.x*this.extents.y*4}toAABB2(){return new B(this.t,this.r,this.b,this.l)}copyToAABB2(t){t.t=this.t,t.r=this.r,t.b=this.b,t.l=this.l}clone(t){return(t=new Tt).position.copy(this.position),t.extents.copy(this.extents),t}}const St=1,At=2,Rt=4,Pt=St|At|Rt,Lt=-4,_t=0,Ft=.01;class Bt{constructor(t){this.tilePosition=new s,this.tileExtents=new s,this.halftilePosition=new s,this.halftileExtents=new s,this.bias=new s(1,1),this.step=new s(0,-1),this.plane=new Ct,this.segment=new lt,this.data=t,this.tileSize=t.cellSize,this.tileHalfSize=this.tileSize/2,this.tileExtents.setTo(this.tileHalfSize,this.tileHalfSize),this.halftileExtents.setTo(this.tileHalfSize/4,this.tileHalfSize/4),this.contact=new ct,this.closestContact=new ct}testCollision(t){const e=t.body,i=this.data.Index(Math.min(e.position.x,e.predictedPosition.x)-t.aabb.extents.x-_t),s=this.data.Index(Math.min(e.position.y,e.predictedPosition.y)-t.aabb.extents.y-_t),n=this.data.Index(Math.max(e.position.x,e.predictedPosition.x)+t.aabb.extents.x+_t-Ft)+1,r=this.data.Index(Math.max(e.position.y,e.predictedPosition.y)+t.aabb.extents.y+_t)+1;if(e.isBullet){this.plane.setFromSegment(e.predictedPosition,e.position),this.closestContact.time=L;for(let o=s;o<r;o++)for(let s=i;s<n;s++){const i=this.data.get(s,o,0);1==(i&St)&&0==(i&At)&&(this.tilePosition.x=s*this.tileSize+this.tileHalfSize,this.tilePosition.y=o*this.tileSize+this.tileHalfSize,Math.abs(this.plane.distancePoint(this.tilePosition))<40&&1==Et(this.tilePosition,this.tileExtents,e.position,t.aabb.extents,e.delta,this.contact)&&e.respondBulletCollision(this.contact)&&this.closestContact.setTo(this.contact))}this.closestContact.time<L&&t.collide(null,this.contact)}else for(let a=s;a<r;a++)for(let s=i;s<n;s++){const i=this.data.get(s,a,0);if((i&Pt)>0)if(this.tilePosition.x=s*this.tileSize+this.tileHalfSize,this.tilePosition.y=a*this.tileSize+this.tileHalfSize,(i&Rt)==Rt&&e.usesStairs){this.segment.set(e.position,e.predictedPosition);const i=2;for(var o=0;o<8;o++){const s=8-o*i;this.halftilePosition.copy(this.tilePosition),this.halftilePosition.x+=-1*s,this.halftilePosition.y+=s,xt(this.segment,this.halftilePosition,this.halftileExtents,t.aabb.extents.x,t.aabb.extents.y)&&(vt(e.position,t.aabb.extents,this.halftilePosition,this.halftileExtents,this.step,this.contact),e.respondStaticCollision(this.contact),t.collide(null,this.contact))}}else if(wt(e.position,t.aabb.extents,this.tilePosition,this.tileExtents,this.bias,this.contact),(i&At)==At)e.collideOneWay&&this.contact.normal.y<0&&this.contact.distance>=Lt&&(e.respondStaticCollision(this.contact),t.collide(null,this.contact));else{const i=s+this.contact.normal.x,n=a+this.contact.normal.y;0==(this.data.get(i,n,0)&Pt)&&(e.respondStaticCollision(this.contact),t.collide(null,this.contact))}}}iterateCells(t,e){var i=this.data.Index(t.l),s=this.data.Index(t.t),n=this.data.Index(t.r)+1,r=this.data.Index(t.b)+1,o=new Tt;o.extents.setTo(this.tileHalfSize,this.tileHalfSize);for(var a=s;a<r;a++)for(var h=i;h<n;h++){(this.data.get(h,a,0)&St)==St&&(o.position.setTo(h*this.tileSize+this.tileHalfSize,a*this.tileSize+this.tileHalfSize),e(o))}}castRay(t){var e=this.data.Index(t.origin.x),i=this.data.Index(t.origin.y);const s=e*this.tileSize,n=i*this.tileSize,r=t.direction;if(0==r.x&&0==r.y)return!0;let o=0,a=1e8,h=0;r.x<0?(o=-1,a=(s-t.origin.x)/r.x,h=this.tileSize/-r.x):r.x>0&&(o=1,a=(s+this.tileSize-t.origin.x)/r.x,h=this.tileSize/r.x);let l=0,c=1e8,d=0;r.y<0?(l=-1,c=(n-t.origin.y)/r.y,d=this.tileSize/-r.y):r.y>0&&(l=1,c=(n+this.tileSize-t.origin.y)/r.y,d=this.tileSize/r.y);for(var u=0,p=0,g=0,y=0;;){if(a<c?(u=a*r.x,p=a*r.y,a+=h,e+=o):(u=c*r.x,p=c*r.y,c+=d,i+=l),u*u+p*p>t.range*t.range)return!1;if((this.data.get(e,i,0)&St)==St)return a<c?(g=o<0?1:-1,y=0):(g=0,y=l<0?1:-1),t.report(u,p,g,y),!0}}}class Mt{constructor(t,e,i=0,n=0){this.halfWidths=new s(t,e),this.offset=new s(i,n)}}class Gt{constructor(){this.isStatic=!1,this.isSensor=!1,this.isActive=!0,this.limitToStaticCheck=!1,this.userData1=-1,this.userData2=-1,this.contactCallbacks=[],this.aabb=new Tt,this.offset=new s,this.responseBias=new s(1,1),this.id=Gt.nextID++}setBody(t){this.body=t,this.aabb.position=t.position,this.isStatic=!1}collide(t,e){this.contactCallbacks.forEach(i=>i(this,t,e))}static HashBodyIDs(t,e){return t<e?t<<16|e:e<<16|t}}Gt.nextID=0;class It{constructor(t,e,i,s=!1,n=null){this.proxy=new Gt,this.proxy.isSensor=t,this.proxy.filter=e,this.proxy.contactCallbacks=i,this.proxy.limitToStaticCheck=s,n&&(this.proxy.body=n)}}class Wt{}class Dt extends v{constructor(t){super([C,Mt,It,Wt]),this.broadphase=t}onEntityAdded(t,e,i,s,n){s.proxy.aabb.extents.copy(i.halfWidths),s.proxy.entity=t,s.proxy.isStatic=!0,s.proxy.aabb.position=e.coords,this.broadphase.addProxy(s.proxy)}onEntityRemoved(t,e,i,s,n){this.broadphase.removeProxy(s.proxy)}updateAllEntities(){}}class zt{}class Ot extends v{constructor(t){super([C,Mt,It,zt]),this.broadphase=t}onEntityAdded(t,e,i,s,n){s.proxy.aabb.extents.copy(i.halfWidths),s.proxy.isStatic=!1,s.proxy.entity=t,s.proxy.aabb.position=e.coords,s.proxy.userData1=t,this.broadphase.addProxy(s.proxy)}onEntityRemoved(t,e,i,s,n){this.broadphase.removeProxy(s.proxy)}updateAllEntities(){}}class Ut{constructor(t,e=!1){this.body=t,this.setMassFromVolume=e}}class kt extends v{constructor(t){super([It,Ut,zt]),this.broadphase=t}onEntityAdded(t,e,i,s){e.proxy.setBody(i.body)}updateAllEntities(){this.broadphase.collide()}}class Nt extends v{constructor(){super([Ut,Mt])}onEntityAdded(t,e,i){e.setMassFromVolume&&e.body.setMassFromVolumeMaterial(i.halfWidths.x*i.halfWidths.y*4)}}class Vt extends v{constructor(){super([C,Ut])}updateEntity(t,e,i){i.body.updatePosition(),e.update(i.body.position)}}class Ht{constructor(t=1,e=.3,i=.1){this.density=t,this.elasticity=e,this.friction=i}}Ht.NORMAL=new Ht(1,.3,.1),Ht.LIGHTMETAL=new Ht(1.4,.3,.1),Ht.ROCK=new Ht(2,.2,.1),Ht.RUBBER=new Ht(1,1,.1);const qt=.99332805041467,Xt=9e-4,jt=10,Yt=.1;class Jt{constructor(t=null,e=1){this.position=new s,this.positionCorrection=new s,this.predictedPosition=new s,this.delta=new s,this.previousPosition=new s,this.velocity=new s,this.originalVelocity=new s,this.previousVelocity=new s,this.contactNormal=new s,this.prevContactNormal=new s,this.tangent=new s,this.stepContactCount=0,this.maxScalarVelocity=1e3,this.maxVelocity=new s,this.forces=new s,this.accumulatedForces=new s,this.isBullet=!1,this.damping=1,this.globalForceFactor=1,this.mass=1,this.invMass=1,this.dt=0,this.motion=jt,this.canSleep=!1,this.isSleeping=!1,this.onGround=!1,this.onGroundPrev=!1,this.inWater=!1,this.inWaterPrev=!1,this.usesStairs=!0,this.collideOneWay=!0,this.totalBounceCount=0,this.bounceCount=0,this.debug=0,this.skip=!1,this.material=null==t?new Ht:t,this.setMass(e)}update(t,e,i){this.dt=t,this.onGroundPrev=this.onGround,this.onGround=!1,this.inWaterPrev=this.inWater,this.inWater=!1,this.skip||this.isSleeping||(this.motion=qt*this.motion+(1-qt)*this.velocity.lengthSqrd(),this.motion=Math.min(this.motion,10*Xt),this.canSleep=this.motion<Xt,this.previousVelocity.copy(this.velocity),this.forces.plusMultEquals(e,this.globalForceFactor),this.velocity.plusEquals(this.forces),this.velocity.multEquals(i*this.damping),this.maxScalarVelocity>0?this.velocity.clampScalar(this.maxScalarVelocity):this.velocity.clampVector(this.maxVelocity),this.originalVelocity.copy(this.velocity),this.predictedPosition.copy(this.position),this.predictedPosition.plusMultEquals(this.velocity,t),this.previousPosition.copy(this.position),this.delta.copy(this.predictedPosition),this.delta.minusEquals(this.position),this.prevContactNormal.copy(this.contactNormal),this.contactNormal.setTo(0,0),this.forces.setTo(0,0),this.damping=1,this.stepContactCount=0,this.toi=L)}respondStaticCollision(t){if(this.skip)return!1;var e=Math.max(t.distance,0),i=Math.min(t.distance,0);this.positionCorrection.minusMultEquals(t.normal,i/this.dt);var s=this.velocity.dot(t.normal)+e/this.dt;return s<0&&(this.stepContactCount++,this.velocity.minusMultEquals(t.normal,s),!this.canBounce&&t.normal.y<0&&(this.onGround=!0),this.contactNormal.copy(t.normal),!0)}t(t){this.debug>0&&this.debug--}respondBulletCollision(t){return t.time<=this.toi&&(this.toi=t.time,this.positionCorrection.copy(t.sweepPosition),this.contactNormal.copy(t.normal),!0)}updatePosition(){if(!this.skip&&!this.isSleeping)if(this.isBullet)this.toi<L?(this.position.copy(this.positionCorrection),this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity)):this.position.copy(this.predictedPosition);else{if(this.stepContactCount>0&&!this.canBounce&&this.contactNormal.y<0){this.tangent.copy(this.contactNormal),this.tangent.rightHandNormalEquals();var t=this.originalVelocity.dot(this.tangent)*this.material.friction;this.velocity.x-=this.tangent.x*t,this.velocity.y-=this.tangent.y*t}this.positionCorrection.plusEquals(this.velocity),this.positionCorrection.multEquals(this.dt),this.position.plusEquals(this.positionCorrection),this.positionCorrection.setTo(0,0),this.stepContactCount>0&&this.canBounce&&(this.originalVelocity.reflectEquals(this.contactNormal),this.originalVelocity.multEquals(this.material.elasticity),this.velocity.copy(this.originalVelocity),this.bounceCount++)}}addForce(t){this.forces.plusMultEquals(t,this.invMass),this.wake()}addMasslessForce(t){this.forces.plusEquals(t),this.wake()}addProportionalForce(t){this.forces.plusMultEquals(t,this.mass),this.wake()}setMass(t){this.mass=t,this.invMass=1/t}setMassFromVolumeMaterial(t){this.setMass(this.material.density*t*Yt)}setStaticPosition(t,e){this.position.setTo(t,e),this.positionCorrection.setTo(0,0),this.predictedPosition.setTo(0,0),this.forces.setTo(0,0),this.accumulatedForces.setTo(0,0),this.velocity.setTo(0,0),this.originalVelocity.setTo(0,0),this.delta.setTo(0,0),this.wake()}setBounces(t){this.totalBounceCount=t,this.bounceCount=0}get canBounce(){return 0!=this.totalBounceCount&&this.bounceCount<this.totalBounceCount}wake(){this.canSleep=!1,this.motion=jt,this.bounceCount=0}get down(){return this.contactNormal.y<0}get downPrev(){return this.prevContactNormal.y<0}get up(){return this.contactNormal.y>0}get upPrev(){return this.prevContactNormal.y>0}get left(){return this.contactNormal.x<0}get leftPrev(){return this.prevContactNormal.x<0}get right(){return this.contactNormal.x>0}get rightPrev(){return this.prevContactNormal.x>0}static Create(t,e,i,s,n){var r=new Jt(t);return r.setMass(e),r.setBounces(i),r.globalForceFactor=s,r.maxScalarVelocity=n,r}}class Kt{}class Zt extends v{constructor(){super([C,Ut,Kt]),this.globalForce=new s(0,30),this.globalDamping=.99}onEntityAdded(t,e,i,s){i.body.position.copy(e.coords)}updateEntity(t,e,i,s){i.body.update(this.dt/1e3,this.globalForce,this.globalDamping),e.direction.x=i.body.velocity.x>0?1:-1}}class Qt{constructor(t){this.force=1,this.force=t}}class $t extends v{constructor(t){super([Ut,Qt]),this.input=t}onEntityAdded(t,e,i){}updateEntity(t,e,i){this.input.Pressed(38)&&(e.body.velocity.y-=i.force),this.input.Pressed(40)&&(e.body.velocity.y+=i.force),this.input.Pressed(37)&&(e.body.velocity.x-=i.force),this.input.Pressed(39)&&(e.body.velocity.x+=i.force)}}class te{constructor(t=""){this.setTileFrameId(t)}setTileFrameId(t){return this.tileFrameId=t,null!=this.onChange&&this.onChange(),t}}class ee extends v{constructor(t,e,i){super([C,te]),this.updates=new Array,this.frames=new Map,this.tileMap=e,this.map=i,this.parseFramesConfig(t)}parseFramesConfig(t){JSON.parse(t).sheets.forEach((t,e)=>{Object.keys(t).forEach(i=>{t[i].push(e),this.frames.set(i,t[i])})})}onEntityAdded(t,e,i){i.onChange=this.onChange.bind(this,t),null!=i.tileFrameId&&this.onChange(t)}onChange(t){this.updates.push(t)}updateAllEntities(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,C),i=this.engine.getComponentForEntity(t,te);""!=i.tileFrameId&&this.tileMap.updateMap(this.map.data.Index(e.coords.x),this.map.data.Index(e.coords.y),this.frames.get(i.tileFrameId))}}}class ie{constructor(t){this.first=!0,this.maxSprites=t}Init(t,e){this.gl=t,this.camera=e,this.projection=new s,this.pointSpriteShader=new Y(t,j(t,ie.SPRITE_VERTEX_SHADER,ie.SPRITE_FRAGMENT_SHADER)),this.dataBuffer=this.gl.createBuffer(),this.arrayBuffer=new ArrayBuffer(80*this.maxSprites),this.data=new Float32Array(this.arrayBuffer),this.data8=new Uint8ClampedArray(this.arrayBuffer),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.ResetBatch()}Resize(t,e){this.projection.x=t/2,this.projection.y=e/2}AddStage(t){this.stage=t}ResetBatch(){this.indexRun=0}AddSpriteToBatch(t,e,i,s,n,r,o){var a=4*this.indexRun;this.data[a+0]=t,this.data[a+1]=e,this.data[a+2]=i,a*=4,this.data8[a+12]=n,this.data8[a+13]=r,this.data8[a+14]=o,this.data8[a+15]=s,this.indexRun++}Render(t){0!=this.indexRun&&(this.gl.useProgram(this.pointSpriteShader.program),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferSubData(WebGLRenderingContext.ARRAY_BUFFER,0,this.data),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.position),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.size),this.gl.enableVertexAttribArray(this.pointSpriteShader.attribute.colour),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.position,2,WebGLRenderingContext.FLOAT,!1,16,0),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.size,1,WebGLRenderingContext.FLOAT,!1,16,8),this.gl.vertexAttribPointer(this.pointSpriteShader.attribute.colour,4,WebGLRenderingContext.UNSIGNED_BYTE,!0,16,12),this.gl.uniform2f(this.pointSpriteShader.uniform.cameraPosition,this.camera.position.x,this.camera.position.y),this.gl.uniform2f(this.pointSpriteShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.drawArrays(WebGLRenderingContext.POINTS,0,this.indexRun))}}ie.SPRITE_VERTEX_SHADER="\n        precision mediump float;\n        uniform vec2 projectionVector;\n        uniform vec2 cameraPosition;\n\n        attribute vec2 position;\n        attribute float size;\n        attribute vec4 colour;\n        varying vec4 vColor;\n        void main() {\n            gl_PointSize = size;\n            vColor = colour;\n            gl_Position = vec4( (cameraPosition.x + position.x) / projectionVector.x -1.0, (cameraPosition.y + position.y) / -projectionVector.y + 1.0 , 0.0, 1.0);            \n        }\n    ",ie.SPRITE_FRAGMENT_SHADER="\n        precision mediump float;\n\n        varying vec4 vColor;\n        void main() {\n            gl_FragColor = vColor;\n        }\n    ";const se=1/255;class ne{constructor(){}Initalize(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,y){this.pX=t,this.pY=e,this.vX=i,this.vY=s,this.fX=n,this.fY=r,this.ttl=o,this.age=o,this.damping=a,this.decay=h,this.externalForce=c,this.size=d,this.alpha=u*se,this.red=p,this.green=g,this.blue=y}Update(t,e){return this.vX+=this.fX+this.externalForce.x,this.vY+=this.fY+this.externalForce.y,this.vX*=this.damping,this.vY*=this.damping,this.pX+=this.vX*e,this.pY+=this.vY*e,this.age-=t,this.alpha-=this.decay,this.age>0}}class re{constructor(t,e,i){this.particleCount=t,this.deltaTime=e,this.invDeltaTime=e/1e3,this.map=i,this.ZERO_FORCE=new s,this.activeParticles=new Array,this.activeParticles[0]=new Array(this.particleCount),this.activeParticles[1]=new Array(this.particleCount),this.cachedParticles=new Array(this.particleCount);for(let e=0;e<t;e++)this.cachedParticles[e]=new ne;this.availableParticleCount=this.particleCount,this.activeParticlesCount=0,this.activePool=0,this.renderer=new ie(t)}EmitParticle(t,e,i,s,n,r,o,a,h,l,c,d,u,p,g,y){if(0==this.availableParticleCount)return!1;var m=this.cachedParticles[--this.availableParticleCount];return this.activeParticles[this.activePool][this.activeParticlesCount++]=m,m.Initalize(t,e,i,s,n,r,o,a,h?this.deltaTime/o:0,l,null!=c?c:this.ZERO_FORCE,d,u,p,g,y),!0}Update(){this.renderer.ResetBatch();const t=this.activeParticles[this.activePool],e=this.activeParticles[1===this.activePool?0:1];let i=0;for(var s=0;s<this.activeParticlesCount;s++){const n=t[s];n.Update(this.deltaTime,this.invDeltaTime)&&1!=(1&this.map.getReal(n.pX,n.pY,0))?(this.renderer.AddSpriteToBatch(n.pX,n.pY,n.size,255*n.alpha|0,n.red,n.green,n.blue),e[i++]=n):this.cachedParticles[this.availableParticleCount++]=n}this.activeParticlesCount=i,this.activePool=1===this.activePool?0:1}}class oe{constructor(t){this.emitters=t}}class ae extends v{constructor(t){super([C,Kt,oe]),this.blockParticleEngine=t}updateEntity(t,e,i,s){s.emitters.forEach(i=>i.update(this.timestamp,this.engine.c4e.get(t),e.coords,this.blockParticleEngine))}postUpdate(){this.blockParticleEngine.Update()}}class he{constructor(t,e,i){this.initalize(t,e,i)}initalize(t,e,i){this.gridWidth=t,this.gridHeight=e,this.cellSize=i,this.invCellSize=1/i,this.data=new Array(this.gridWidth*this.gridHeight)}get(t,e){return this.data[e*this.gridWidth+t]}getSafe(t,e){return t>=this.gridWidth||e>=this.gridHeight||t<0||e<0?null:this.data[e*this.gridWidth+t]}set(t,e,i){this.data[e*this.gridWidth+t]=i}Index(t){return t*this.invCellSize|0}Width(){return this.gridWidth*this.cellSize}Height(){return this.gridHeight*this.cellSize}}class le{constructor(){this.aabb=new Tt,this.isStatic=!1,this.entity=null,this.active=!1,this.referenceCount=0}}class ce{constructor(t,e,i){this.count=1,this.updateDistanceDelta=1e4,this.grid=new he(t,e,i),this.currentCells=new Array;for(let t=0;t<this.grid.gridWidth;t++)for(let e=0;e<this.grid.gridHeight;e++)this.grid.set(e,t,new de)}addEntity(t,e,i){var s=new le;s.aabb.position=e.coords,s.aabb.extents=i.halfWidths,s.isStatic=!0,s.entity=t,this.hashProxy(s)}hashProxy(t){var e=this.grid.Index(t.aabb.position.x-t.aabb.extents.x),i=this.grid.Index(t.aabb.position.y-t.aabb.extents.y),s=this.grid.Index(t.aabb.position.x+t.aabb.extents.x)+1,n=this.grid.Index(t.aabb.position.y+t.aabb.extents.y)+1;for(let r=i;r<n;r++)for(let i=e;i<s;i++){this.grid.get(i,r).proxies.push(t)}}addActiveCell(t,e,i){t.proxies.forEach(t=>{0==t.referenceCount++&&i(t.entity,!0)}),t.updateCount=this.count}removeActiveCell(t,e,i){t.proxies.forEach(t=>{0==--t.referenceCount&&i(t.entity,!1)}),t.updateCount=0}search(t,e){if(null==this.lastUpdatePosition)this.lastUpdatePosition=t.position.clone();else{if(this.lastUpdatePosition.distSqrd(t.position)<this.updateDistanceDelta)return;this.lastUpdatePosition.copy(t.position)}var i=this.grid.Index(t.position.x-t.extents.x),s=this.grid.Index(t.position.y-t.extents.y),n=this.grid.Index(t.position.x+t.extents.x)+1,r=this.grid.Index(t.position.y+t.extents.y)+1;for(let t=s;t<r;t++)for(let e=i;e<n;e++){null!=(a=this.grid.get(e,t))&&(0==a.updateCount?this.currentCells.push(a):a.updateCount=this.count)}for(var o=this.currentCells.length;o-- >0;){var a;0==(a=this.currentCells[o]).updateCount?this.addActiveCell(a,t,e):a.updateCount<this.count&&(this.removeActiveCell(a,t,e),this.currentCells.splice(o,1))}this.count++}}class de{constructor(){this.proxies=new Array,this.updateCount=0}}class ue{}class pe extends v{constructor(t){super([C,Mt,Wt]),this.camera=t,this.spaceManager=new ce(10,10,500),this.activeSpaceAABB=new Tt,this.activeSpaceAABB.extents.setTo(t.viewportSize.x,t.viewportSize.y),this.setEntityStatus=this.setEntityStatus.bind(this)}onEntityAdded(t,e,i,s){this.spaceManager.addEntity(t,e,i)}updateAllEntities(){this.activeSpaceAABB.position.copy(this.camera.realPosition),this.spaceManager.search(this.activeSpaceAABB,this.setEntityStatus)}setEntityStatus(t,e){1==e?this.engine.addComponentsToEntity(t,[new ue]):this.engine.removeComponentsFromEntityByType(t,[ue])}}class ge{constructor(t,e){this.ttl=t,this.age=0,this.onExpire=e}growOlder(t){return this.age+=t,this.isExpired()}isExpired(){return this.age>this.ttl}reset(){this.age=0}}class ye{constructor(t,e,i){this.states=t,this.currentState=e,this.messages=new g}setState(t){this.currentState=t,null!=this.onChange&&this.onChange()}}class me extends v{constructor(){super([ge,ye,Kt])}updateEntity(t,e,i,s){e.growOlder(this.dt)&&null!=e.onExpire&&i.setState(e.onExpire)}}class xe{constructor(t,e,i,s){this.maxHealth=t,this.currentHealth=e,this.recoveryPerSecond=i,this.recoveryPerMs=i/1e3,this.onNoHealth=s}applyDamage(t){this.currentHealth-=t}isDead(){return this.currentHealth<=0}}class be extends v{constructor(){super([xe,ye,Kt])}updateEntity(t,e,i,s){e.currentHealth<=0?null!=e.onNoHealth&&i.setState(e.onNoHealth):e.currentHealth=Math.min(e.maxHealth,e.currentHealth+e.recoveryPerMs*this.dt)}}class fe{constructor(t,e,i=!0){this.count=t,this.onCount=e,this.ignoreStatic=i}}class Ee extends v{constructor(){super([fe,It,ye,Kt]),this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){i.proxy.contactCallbacks.push(this.callback)}onEntityRemoved(t,e,i,s,n){i.proxy.contactCallbacks.splice(i.proxy.contactCallbacks.indexOf(this.callback),1)}updateAllEntities(){}callback(t,e,i){var s=this.engine.getComponentForEntity(t.entity,fe),n=--s.count;if(null==e){if(n<=0&&null!=s.onCount)this.engine.getComponentForEntity(t.entity,ye).setState(s.onCount)}else{if(e.isSensor)return;if(this.engine.getComponentForEntity(e.entity,zt)&&null!=s.onCount)this.engine.getComponentForEntity(t.entity,ye).setState(s.onCount)}}}class we{}we.PLAYER_CAT=4,we.PROJECTILE_CAT=8,we.PROJECTILE_COLLIDABLE_CAT=16,we.SOLID_CAT=32,we.HOLDABLE_CAT=64,we.ph1_CAT=128,we.ph2_CAT=256,we.ph3_CAT=512,we.ph4_CAT=1024,we.ph5_CAT=2048,we.PLAYER_GROUP=-1,we.ENEMY_GROUP=-2,we.TURRET_GROUP=-3,we.BIRD_GROUP=-3,we.SOLID_OBJECT_GROUP=1;class ve{static calcProjectileVelocity(t,e,i){var s=e.clone();s.minusEquals(t.position),s.normalize(),s.multEquals(i),t.maxScalarVelocity=i,t.velocity.setTo(s.x,s.y)}static calcProjectileForce(t,e,i){var s=e.clone();s.minusEquals(t.position),s.normalize(),s.multEquals(i),t.addForce(s)}}class Ce{constructor(t){this.count=t}}function Te(t,e){return Math.random()*(e-t)+t}function Se(t=.5){return Math.random()<t}function Ae(t,e){return Math.floor(Te(t,e))}class Re{constructor(t,e){this.mass=t,this.power=e}update(t,e,i,s){for(let t=0;t<this.mass;t++){var n=Te(0,2*Math.PI),r=Te(0,2*this.power),o=Math.cos(n)*r,a=Math.sin(n)*r;s.EmitParticle(i.x,i.y,o,a,0,1,Te(250,300),.999,!0,!0,null,4,255,255,0,0)}s.EmitParticle(i.x,i.y,o,a,0,1,Te(250,300),.999,!0,!0,null,4,0,0,0,0)}}class Pe{constructor(){this.origin=new s,this.target=new s,this.range=0,this.delta=new s,this.direction=new s,this.contact=new ct,this.bounds=new B}initalize(t,e,i,s){this.reset(),this.origin.copy(t),this.target.copy(e),this.delta.copy(e),this.delta.minusEquals(t),this.direction.copy(this.delta),this.direction.normalize(),i<=0?this.range=this.delta.length():(this.range=i,this.delta.copy(this.direction),this.delta.multEquals(i)),this.bounds.addPoint(this.origin.x,this.origin.y),this.bounds.addPoint(this.origin.x+this.delta.x,this.origin.y+this.delta.y),this.callback=s}reset(){this.contact.distance=9999999999,this.hit=!1}report(t,e,i,s,n=null){if(!(null!=this.callback&&null!=n&&this.callback(n)<0)){var r=t*t+e*e;r<this.contact.distance*this.contact.distance&&(this.contact.position.setTo(this.origin.x+t,this.origin.y+e),this.contact.normal.setTo(i,s),this.contact.distance=Math.sqrt(r),this.hit=!0)}}}class Le{constructor(t){this.entity=t}reset(){}static SortClosestFirst(t,e){return t.distance-e.distance}}class _e{constructor(){this.entities=new Array}addItem(t){const e=new Le(t);return this.entities.push(e),e}getItem(t){return this.entities.find(e=>e.entity===t)}removeItem(t){this.entities=this.entities.filter(e=>e.entity!==t)}filter(t){this.entities=this.entities.filter(t)}clear(){this.entities.length=0}}class Fe{constructor(t,e){this.engine=t,this.broadphase=e,this.entityCollection=new _e,this.aabb=new Tt,this.ray=new Pe,this.addBroadphaseItem=this.addBroadphaseItem.bind(this)}query(t,e,i,s){}addBroadphaseItem(t){if(null==this.filterEntity||t.entity!=this.filterEntity){var e=t.aabb.position.distSqrd(this.aabb.position)+R;if(e>Fe.RAYCAST_THRESHOLD&&this.visibleCheck){const e=this.engine.getComponentForEntity(t.entity,C);if(this.ray.initalize(this.aabb.position,e.coords,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),this.ray.hit)return}var i=this.entityCollection.addItem(t.entity);i.distance=e,i.perspective=this.aabb.position}}}var Be;Fe.RAYCAST_THRESHOLD=10,function(t){t[t.ALL=0]="ALL",t[t.FRIENDLY=1]="FRIENDLY",t[t.ENEMY=2]="ENEMY"}(Be||(Be={}));class Me{constructor(){}static setup(t,e){Me.engine=t,Me.broadphase=e,Me.bfAreaQuery=new Fe(t,e),Me.ray=new Pe}static CanSee(t,e,i){return!(t.distSqrd(e)>=i*i)&&(this.ray.initalize(t,e,0,null),this.broadphase.CastRay(this.ray,null,!1,!1),!this.ray.hit)}static SearchSortAndFilter(t,e,i,s){return Me.referenceEntity=i,Me.bfAreaQuery.query(t,e,i,!0),Me.bfAreaQuery.entityCollection}static explode(t,e,i,s){Me.bfAreaQuery.query(t,e,s,!0),Me.bfAreaQuery.entityCollection.entities.forEach(s=>{if(!Me.engine.getComponentForEntity(s.entity,Ce)){var n=Me.engine.getComponentForEntity(s.entity,xe),r=Me.engine.getComponentForEntity(s.entity,Ut);if(null!=n||null!=r){var o=e/Math.sqrt(s.distance)*i;if(null!=n&&n.applyDamage(o),null!=r){var a=r.body.position.clone();a.minusEquals(t),a.normalize(),a.multEquals(o),r.body.addForce(a)}}}})}}class Ge{constructor(t,e,i,s,n,r,o){this.range=t,this.attenuation=e,this.intensity=i,this.flicker=s,this.red=n,this.green=r,this.blue=o}}class Ie{static create(t,e,i,s){var n=new Jt(Ht.LIGHTMETAL);n.setMass(24),n.setBounces(3),n.globalForceFactor=1,n.isBullet=!0,n.maxScalarVelocity=1e4,i.categoryBits|=we.PROJECTILE_CAT,i.maskBits|=we.PROJECTILE_COLLIDABLE_CAT;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Mt(2,2),new T("projectiles","standard"),new Ut(n,!0),new zt,new It(!1,i,[]),new oe([]),new ye(Ie.states,null,!1),new fe(3,"destroy"),new xe(10,10,0,"destroy"),new ge(1e3,"destroy"),new Kt,new Ge(64,1,1,1,255,255,255),new ue]),ve.calcProjectileVelocity(n,s,2e3),r}static onDestroy(t,e){t.getComponentForEntity(e,Ce)||(t.addComponentsToEntity(e,[new Ce(1)]),t.getComponentForEntity(e,oe).emitters.push(new Re(10,50)))}}Ie.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,Ce)||(t.addComponentsToEntity(e,[new Ce(1)]),t.getComponentForEntity(e,oe).emitters.push(new Re(4,80)),Me.explode(t.getComponentForEntity(e,C).coords,100,1e4,e))}};class We extends v{constructor(){super([Ce]),this.toDelete=new Array}updateEntity(t,e){e.count--<=0&&this.toDelete.push(t)}postUpdate(){this.toDelete.forEach(t=>this.engine.destroyEntity(t)),this.toDelete.length=0}}class De{}class ze{static create(t,e){var i=new dt;i.categoryBits=we.PLAYER_CAT,i.maskBits|=we.PROJECTILE_CAT,i.groupIndex=we.PLAYER_GROUP;var s=new Jt(new Ht(1,.3,.1));s.maxScalarVelocity=0,s.maxVelocity.setTo(1600,1e3);var n=t.createEntity();return t.addComponentsToEntity(n,[new De,e,new Mt(7,20),new T("player"),new ot("player","idle"),new Ut(s,!0),new It(!1,i,[]),new zt,new Kt,new Ge(256,1,1,0,255,0,0),new ue]),n}}class Oe{constructor(t,e,i){this.controlForce=new s,this.jumpUnit=new s,this.jumping=!1,this.isWalking=!1,this.originalFriction=0,this.burn=0,this.input=t,this.body=e,this.originalFriction=e.material.friction,this.originalVelocityClamp=e.maxVelocity.clone(),this.setBaseForce(i)}setBaseForce(t){this.BASE_FORCE=600,this.WALK_FORCE=2*this.BASE_FORCE,this.AIR_CONTROL_FORCE=1*this.BASE_FORCE,this.JUMP_FORCE=30*this.BASE_FORCE,this.MAX_AIR_HORIZONTAL_VELOCITY=.5*this.BASE_FORCE,this.MAX_BURN=5*this.BASE_FORCE,this.BOOST_FACTOR=1.4}update(){this.controlForce.setTo(0,0),this.left=this.input.PressedDuration(65),this.right=this.input.PressedDuration(68);var t=this.input.JustPressed(87),e=this.input.PressedDuration(87);if(this.down=this.input.PressedDuration(83),this.boost=this.input.PressedDuration(16),!this.jumping&&this.body.onGround&&t&&(this.jumping=!0,this.controlForce.y-=this.JUMP_FORCE/5),(this.jumping&&this.input.Released(87)||this.body.contactNormal.y>0)&&(this.jumping=!1),this.body.onGround&&!this.body.onGroundPrev&&(this.burn=0),this.body.onGround)this.left>0&&(this.controlForce.x-=this.WALK_FORCE),this.right>0&&(this.controlForce.x+=this.WALK_FORCE),t&&(this.controlForce.y-=this.JUMP_FORCE);else{this.left>0&&(this.controlForce.x-=this.AIR_CONTROL_FORCE),this.right>0&&(this.controlForce.x+=this.AIR_CONTROL_FORCE);t&&(this.burn=this.MAX_BURN),e>0&&(this.burn+=this.BASE_FORCE)}this.boost>0?this.burn=Math.min(this.burn,this.MAX_BURN*this.BOOST_FACTOR):this.burn=Math.min(this.burn,this.MAX_BURN),this.controlForce.y-=this.burn,this.burn*=.95,this.isWalking=this.body.onGround&&(this.left>0||this.right>0),this.isWalking,this.body.addForce(this.controlForce)}}class Ue{constructor(t,e){this.maxAcceleration=t,this.maxSteeringForcePerStep=e}}Ue.default_scale=.2,Ue.heavy_scale=5,Ue.default_maxAcceleration=100,Ue.default_maxSteeringForcePerStep=100;const ke=new Ue(Ue.default_maxAcceleration*Ue.default_scale,Ue.default_maxSteeringForcePerStep*Ue.default_scale),Ne=new Ue(Ue.default_maxAcceleration*Ue.heavy_scale,Ue.default_maxSteeringForcePerStep*Ue.heavy_scale);class Ve{constructor(t,e=null,i=Ve.CALCULATE_SUM){this.behaviors=t,this.steeringParameters=null==e?ke:e,this.hasChanged=!0}addBehavior(t){this.behaviors.push(t),this.hasChanged=!0}removeBehaviour(t){this.behaviors.splice(this.behaviors.indexOf(t),1),this.hasChanged=!0}getBehaviour(t){return this.behaviors.find(e=>e.constructor.name===t.name)}}Ve.CALCULATE_SUM=0,Ve.CALCULATE_SPEED=1,Ve.CALCULATE_ACCURACY=2;class He{constructor(t=1,e=1,i=1,s=!0){this.weight=t,this.priority=e,this.probability=i,this.active=s}calculate(t,e,i){}}class qe{}qe.speedTweaker=.3,qe.arriveFast=1,qe.arriveNormal=3,qe.arriveSlow=5,qe.wanderJitter=300,qe.wanderDistance=25,qe.wanderRadius=15,qe.separationProbability=.2,qe.cohesionProbability=.6,qe.alignmentProbability=.3,qe.dodgeProbability=.6,qe.seekProbability=.8,qe.fleeProbability=.6,qe.pursuitProbability=.8,qe.evadeProbability=1,qe.offsetPursuitProbability=.8,qe.arriveProbability=.5,qe.obstacleAvoidanceProbability=.5,qe.wallAvoidanceProbability=.5,qe.hideProbability=.8,qe.followPathProbability=.7,qe.interposeProbability=.8,qe.wanderProbability=.8,qe.separationWeight=1,qe.alignmentWeight=3,qe.cohesionWeight=2,qe.dodgeWeight=1,qe.seekWeight=1,qe.fleeWeight=1,qe.pursuitWeight=1,qe.evadeWeight=.1,qe.offsetPursuitWeight=1,qe.arriveWeight=1,qe.obstacleAvoidanceWeight=10,qe.wallAvoidanceWeight=10,qe.hideWeight=1,qe.followPathWeight=.5,qe.interposeWeight=1,qe.wanderWeight=1,qe.wallAvoidancePriority=10,qe.obstacleAvoidancePriority=20,qe.evadePriority=30,qe.hidePriority=35,qe.seperationPriority=40,qe.alignmentPriority=50,qe.cohesionPriority=60,qe.dodgePriority=65,qe.seekPriority=70,qe.fleePriority=80,qe.arrivePriority=90,qe.pursuitPriority=100,qe.offsetPursuitPriority=110,qe.interposePriority=120,qe.followPathPriority=130,qe.wanderPriority=140;class Xe extends He{constructor(t,e=0){super(qe.seekWeight,qe.seekPriority),this.target=t,this.seekDist=e}calculate(t,e,i){Xe.calc(t,e,i,this.target,this.seekDist)}static calc(t,e,i,s,n=0){var r=s.x-t.position.x+1e-6,o=s.y-t.position.y+1e-6,a=r*r+o*o;if(n>0&&a<n*n)return!1;var h=Math.sqrt(a);return i.x=r/h,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.y=o/h,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,!0}}class je extends He{constructor(t=8,e=1,i=4){super(qe.wanderWeight,qe.wanderPriority),this.circleCenter=new s,this.displacement=new s,this.circleRadius=t,this.circleDistance=e,this.wanderAngle=Te(0,2*Math.PI),this.wanderChange=i}calculate(t,e,i){this.wanderAngle+=Te(-this.wanderChange,this.wanderChange),this.circleCenter.copy(t.velocity),this.circleCenter.normalize(),this.circleCenter.multEquals(this.circleDistance),this.circleCenter.plusEquals(t.position);var s=Math.atan2(t.velocity.y,t.velocity.x);s+=Math.PI/2,this.displacement.setTo(this.circleRadius*Math.cos(this.wanderAngle+s),this.circleRadius*Math.sin(this.wanderAngle+s)),this.circleCenter.plusEquals(this.displacement),Xe.calc(t,e,i,this.circleCenter,0)}}class Ye{constructor(t,e){this.angle=t,this.length=e,this.base=new s,this.tip=new s,this.closestIP=new s,this.ip=new s,this.normal=new s}Reset(t,e){if(this.distToClosestIP=L,this.tip.copy(t),this.base.copy(e),0!=this.angle){var i=Math.atan2(t.y,t.x);i+=this.angle,this.tip.x=Math.cos(i),this.tip.y=Math.sin(i)}this.tip.multEquals(length),this.tip.plusEquals(this.base)}TestSegment(t,e,i){var s=function(t,e,i,s,n){var r=(t.y-i.y)*(s.x-i.x)-(t.x-i.x)*(s.y-i.y),o=(t.y-i.y)*(e.x-t.x)-(t.x-i.x)*(e.y-t.y),a=(e.x-t.x)*(s.y-i.y)-(e.y-t.y)*(s.x-i.x),h=(e.x-t.x)*(s.y-i.y)-(e.y-t.y)*(s.x-i.x);if(0==a||0==h)return-1;var l=r/a,c=o/h;return l>0&&l<1&&c>0&&c<1?(n.x=t.x+l*(e.x-t.x),n.y=t.y+l*(e.y-t.y),t.distSqrd(e)*l):0}(this.base,this.tip,t,e,this.ip);s>0&&s<this.distToClosestIP&&(this.distToClosestIP=s,this.closestIP.copy(this.ip),this.normal.copy(i))}CalculateForce(t){if(this.distToClosestIP!=L){var e=this.tip.clone();e.minusEquals(this.closestIP),this.normal.multEquals(e.length()),t.plusEquals(this.normal)}}}class Je extends He{constructor(t){super(qe.wallAvoidanceWeight,qe.wallAvoidancePriority),this.pA=new s,this.pB=new s,this.top=new s(0,-1),this.right=new s(1,0),this.bottom=new s(0,1),this.left=new s(-1,0),this.searchAABB=new B,this.closestFeeler=null,this.closestDist=L,this.feelerLength=t,this.ptv1=new s,this.ptv2=new s,this.feelers=new Array,this.feelers.push(new Ye(0,t)),this.feelers.push(new Ye(F(-40),.5*t)),this.feelers.push(new Ye(F(40),.5*t)),this.lastPos=new s}checkAABB(t){for(var e=0;e<this.feelers.length;e++){const i=this.feelers[e];this.pA.setTo(t.l,t.t),this.pB.setTo(t.r,t.t),i.TestSegment(this.pA,this.pB,this.top),this.pA.setTo(t.r,t.b),i.TestSegment(this.pB,this.pA,this.right),this.pB.setTo(t.l,t.b),i.TestSegment(this.pA,this.pB,this.bottom),this.pA.setTo(t.l,t.t),i.TestSegment(this.pB,this.pA,this.left),i.distToClosestIP<this.closestDist&&(this.closestDist=i.distToClosestIP,this.closestFeeler=i)}}calculate(t,e,i){if(!(this.lastPos.distSqrd(t.position)<1)){this.lastPos.copy(t.position);var s=t.velocity.clone();s.normalize();for(var n=0;n<this.feelers.length;n++){this.feelers[n].Reset(s,t.position)}this.closestFeeler=null,this.closestDist=L,this.searchAABB.reset(),this.searchAABB.addPoint(t.position.x,t.position.y),this.searchAABB.addPoint(this.feelers[0].tip.x,this.feelers[0].tip.y),this.searchAABB.addPoint(this.feelers[1].tip.x,this.feelers[1].tip.y),this.searchAABB.addPoint(this.feelers[2].tip.x,this.feelers[2].tip.y),e.map.iterateCells(this.searchAABB,this.checkAABB),null!=this.closestFeeler&&this.closestFeeler.CalculateForce(i)}}}class Ke{static create(t,e){var i=new Jt(new Ht(.1,.3,0));i.setMass(.1),i.setBounces(0),i.globalForceFactor=0,i.maxScalarVelocity=200;var s=t.createEntity();return t.addComponentsToEntity(s,[e,new Mt(1.5,1.5),new T("insects"),new ot("insects","firefly"),new Ut(i,!0),new zt,new It(!1,null,[]),new Ve([new je(80,40,143.5),new Xe(e.coords.clone(),32),new Je(40)],Ne),new ye(Ke.states,null,!1),new ge(1e4,"destroy"),new xe(10,10,0,"destroy"),new Kt]),s}static onDestroy(t,e){t.getComponentForEntity(e,Ce)||t.addComponentsToEntity(e,[new Ce(1)])}}Ke.states={destroy:function(t,e){t.getComponentForEntity(e,Ce)||t.addComponentsToEntity(e,[new Ce(1)])}};class Ze{constructor(t){this.holder=t}}class Qe{constructor(t){this.activate=!1,this.heldItem=null,this.parent=null,this.parent=t}static drop(t,e){if(null!=e.heldItem){const i=e.heldItem;return t.removeComponentsFromEntityByType(e.heldItem,[Ze]),e.heldItem=null,i}return null}}class $e{constructor(t,e){this.rate=t,this.speed=e}update(t,e,i,s){const n=e(Ut).body.velocity;for(let t=0;t<5;t++){var r=Te(0,2*Math.PI),o=n.x+Math.cos(r)*this.speed*Te(0,2),a=n.y+Math.sin(r)*this.speed*Te(0,2);s.EmitParticle(i.x,i.y,o,a,0,0,100,.7,!0,!0,null,4,255,229,252,114)}}}class ti{static create(t,e,i,s){var n=new Jt(Ht.LIGHTMETAL);n.setMass(.3),n.setBounces(0),n.globalForceFactor=.1,n.isBullet=!0,n.maxScalarVelocity=1e4,i.categoryBits|=we.PROJECTILE_CAT,i.maskBits|=we.PROJECTILE_COLLIDABLE_CAT;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Mt(2,2),new T("projectiles","plasma"),new Ut(n,!0),new zt,new It(!1,i,[]),new oe([new $e(0,400)]),new ye(ti.states,null,!1),new fe(1,"destroy"),new xe(10,10,0,"destroy"),new ge(1e3,"destroy"),new Kt]),ve.calcProjectileVelocity(n,s,600),r}static onDestroy(t,e){t.getComponentForEntity(e,Ce)||(t.addComponentsToEntity(e,[new Ce(1)]),t.getComponentForEntity(e,oe).emitters.push(new Re(10,50)))}}ti.states={alive:function(t,e){},destroy:function(t,e){t.getComponentForEntity(e,Ce)||(t.addComponentsToEntity(e,[new Ce(1)]),t.getComponentForEntity(e,oe).emitters.push(new Re(10,50)),Me.explode(t.getComponentForEntity(e,C).coords,100,1e4,e))}};class ei{constructor(){this.parent=-1,this.children=[],this.level=0}static addChild(t,e,i){let s=t.getComponentForEntity(e,ei);if(s||(s=new ei,t.addComponentsToEntity(e,[s])),-1!=s.children.indexOf(i))return;let n=t.getComponentForEntity(i,ei);n?n.parent&&ei.removeChild(t,n.parent,i):(n=new ei,t.addComponentsToEntity(i,[n])),n.parent=e,n.level=s.level+1,s.children.push(i),n.children.length>0&&ei.updateChildLevel(t,n)}static removeChild(t,e,i){const s=t.getComponentForEntity(e,ei);if(s){const e=s.children.indexOf(i);if(e>0){const n=t.getComponentForEntity(i,ei);n&&(n.parent=null,n.level=0,s.children.splice(e,1))}}}static updateChildLevel(t,e){for(let i of e.children){const s=t.getComponentForEntity(i,ei);s.level=e.level+1,s.children.length>0&&ei.updateChildLevel(t,s)}}}class ii{constructor(t){this.point=t}}class si extends v{constructor(t,e){super([C,De,It,Ut,ot,Mt]),this.currentWeapon=0,this.input=t,this.particleEngine=e}onEntityAdded(t,e,i,n,r,o,a){r.body.usesStairs=!0,this.characterController=new Oe(this.input,r.body,800),this.holder=new Qe(t),this.playerHolder=this.engine.createEntity(),this.engine.addComponentsToEntity(this.playerHolder,[new C(0,0),new ii(new s(0,0)),a,this.holder,new It(!0,new dt(1,0,we.PLAYER_GROUP),[],!1,r.body),new zt,new Kt]),ei.addChild(this.engine,t,this.playerHolder)}updateEntity(t,e,i,s,n,r,o){this.characterController.update(),n.body.onGround&&Math.abs(n.body.velocity.x)>10?r.play("runright"):n.body.onGround?r.play("idle"):r.play("fly"),this.characterController.left>0&&(e.direction.x=-1),this.characterController.right>0&&(e.direction.x=1),n.body.collideOneWay=!(this.characterController.down>0);var a=this.input.JustPressed(32);this.input.JustPressed(71),this.input.Pressed(72),this.input.Pressed(82);if(this.input.Pressed(85)&&Ke.create(this.engine,e.clone()),this.holder.activate=this.input.JustPressed(72),this.input.JustPressed(74))Qe.drop(this.engine,this.holder);else if(this.input.JustPressed(75)){const t=Qe.drop(this.engine,this.holder);null!=t&&ve.calcProjectileVelocity(this.engine.getComponentForEntity(t,Ut).body,this.input.ViewCorrectedMousePosition(),700)}if(a&&(0==this.currentWeapon&&Ie.create(this.engine,e.clone(),s.proxy.filter.clone(),this.input.ViewCorrectedMousePosition()),1==this.currentWeapon&&ti.create(this.engine,e.clone(),s.proxy.filter.clone(),this.input.ViewCorrectedMousePosition())),this.input.Pressed(69)){var h=this.input.ViewCorrectedMousePosition().clone();h.minusEquals(e.coords),h.normalize(),h.multEquals(2e3),this.particleEngine.EmitParticle(e.coords.x,e.coords.y,h.x,h.y,0,0,200,1,!1,!0,null,4,255,255,255,255)}if(this.characterController.burn>0){var l=e.coords.x-8*e.direction.x,c=200+Te(-150,150),d=Math.floor((this.characterController.burn+500)/1e3);d>0&&this.particleEngine.EmitParticle(l,e.coords.y+6,Te(-10,10),c,0,0,40,.9,!1,!1,null,4,255,255,0,0);for(var u=0;u<d;u++)this.particleEngine.EmitParticle(l,e.coords.y+6,Te(-50,50),c,0,0,280,.9,!0,!0,null,4,255,255,255,255)}this.input.JustPressed(49)&&(this.currentWeapon=0),this.input.JustPressed(50)&&(this.currentWeapon=1)}}class ni{constructor(t,e,i,n,r){this.direction=new s,this.direction.setUnitRotation(t-90),this.minForce=e,this.maxForce=i,this.minDuration=n,this.maxDuration=r}}class ri{constructor(t){this.direction=new s,this.power=0,this.ttl=0,this.data=t}}class oi extends v{constructor(){super([It,Mt,ri,Kt]),this.temp=new s,this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){e.proxy.contactCallbacks.push(this.callback),this.setActiveForce(s,0)}updateEntity(t,e,i,s,n){s.ttl>0&&(s.ttl-=this.dt,s.ttl)}onFinished(t){t.currentIndex++,t.currentIndex>=t.data.length&&(t.currentIndex=0),this.setActiveForce(t,t.currentIndex)}setActiveForce(t,e){t.currentIndex=e;var i=t.data[e];t.direction.copy(i.direction),t.power=i.maxForce,t.ttl=0==i.minDuration?-1:Te(1e3*i.minDuration,1e3*i.maxDuration)}callback(t,e,i){var s=t.aabb.overlapArea(e.aabb),n=this.engine.getComponentForEntity(t.entity,ri);this.temp.copy(n.direction),this.temp.multEquals(n.power*s),e.body.addForce(this.temp)}}function ai(t){return new C(li(t.x+t.width/2),li(t.y+t.height/2))}function hi(t){return new Mt(li(t.width/2),li(t.height/2))}function li(t){return 2*t}class ci{constructor(t){this.particlePerUnitPerFrame=t,this.particleCount=0,this.incPerFrame=0}}class di{static createTMXEntity(t,e){const i=t.createEntity();var s=[];s.push(ai(e)),s.push(hi(e)),s.push(new It(!0,null,[])),s.push(new Wt),s.push(new Kt);var n=[];return e.properties.forEach(t=>{const e=t.value.split(",").map(parseFloat);n.push(new ni(e[0],e[1]*di.FORCE_SCALE,e[2]*di.FORCE_SCALE,e[3],e[4]))}),s.push(new ri(n)),s.push(new ci(.001)),t.addComponentsToEntity(i,s),i}}di.FORCE_SCALE=.01,di.mapping="Force";class ui{constructor(t,e,i){this.radius=t,this.maxLights=e,this.lightingShader=i,this.lights=[];for(let t=0;t<this.maxLights;t++)this.lights.push(new pi);this.reset()}reset(){this.activeLights=0}addLight(t,e,i,s,n,r){const o=this.lights[this.activeLights++];o.x=t,o.y=e,o.intensity=i,o.red=s,o.green=n,o.blue=r}}class pi{}class gi{constructor(t,e){this.quadVerts=new Float32Array([-1,-1,1,-1,1,1,-1,1]),this.ranges=t,this.renderSurface=this.renderSurface.bind(this),this.lastSnap=new s(0,0),this.thisSnap=new s(-1e3,-1e3),this.snapChanged=!1,this.layer=e,this.tileSize=16,this.halfTileSize=this.tileSize/2}Init(t,e){this.gl=t,this.camera=e,this.projection=new s,this.indexBuffer=t.createBuffer(),this.dataBuffer=t.createBuffer(),this.scaledViewportSize=new Float32Array(2),this.viewportSize=new s,this.sprite=new H,this.sprite.id="lightTexture",this.ResizeBatch(20*this.ranges.length),this.lightGroups=this.ranges.map(e=>new ui(e,20,new Y(t,j(t,gi.LIGHTING_VERTEX_SHADER,gi.LIGHTING_FRAGMENT_SHADER_FACTORY(e/this.tileSize,1))))),this.lightGroupsMap=new Array(this.ranges[this.ranges.length-1]),this.ranges.forEach((t,e)=>{this.lightGroupsMap[t]=this.lightGroups[e]})}ResizeBatch(t){this.size=t,this.dynamicSize=t,this.data=new Float32Array(20*this.dynamicSize),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferData(WebGLRenderingContext.ARRAY_BUFFER,this.data,WebGLRenderingContext.DYNAMIC_DRAW),this.indices=new Uint16Array(6*this.dynamicSize);for(let t=0;t<this.dynamicSize;t++){const e=6*t,i=4*t;this.indices[e+0]=i+0,this.indices[e+1]=i+1,this.indices[e+2]=i+2,this.indices[e+3]=i+0,this.indices[e+4]=i+2,this.indices[e+5]=i+3}this.gl.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,this.indices,WebGLRenderingContext.STATIC_DRAW)}Resize(t,e){var i=Math.floor(t/this.tileSize)+2,n=Math.floor(e/this.tileSize)+2;this.viewportSize.x=i,this.viewportSize.y=n,this.scaledViewportSize[0]=this.viewportSize.x,this.scaledViewportSize[1]=this.viewportSize.y,this.projection.x=i*this.tileSize/2,this.projection.y=n*this.tileSize/2,this.surface=new W(this.gl,i,n),this.texture=new z(this.surface,new D(0,0,i,n),new s(0,0)),this.sprite.texture=this.texture,this.sprite.scale.setTo(this.tileSize,-this.tileSize),this.sprite.pivot.setTo(i/2,n/2)}reset(){for(const t of this.lightGroups)t.reset()}addUnblockedLight(t,e,i,s,n,r){}addBlockedLight(t,e,i,s,n,r){const o=this.lightGroupsMap[Math.round(i)];o&&o.addLight(t,e,i,s,n,r)}processLightsBatch(){let t=0;for(const e of this.lightGroups)for(let i=0;i<e.activeLights;i++){const s=e.lights[i],n=20*t,r=this.quadVerts,o=this.quadVerts,a=s.intensity+this.halfTileSize,h=s.intensity/this.tileSize;let l=s.x,c=s.y;l+=Math.floor(this.camera.position.x/this.tileSize)*this.tileSize,c+=Math.floor(this.camera.position.y/this.tileSize)*this.tileSize,l+=2*this.tileSize,c+=2*this.tileSize;s.red,s.green,s.blue;this.data[n+0]=l+o[0]*a,this.data[n+1]=c+o[1]*a,this.data[n+2]=r[0]*h,this.data[n+3]=r[1]*h,this.data[n+4]=1,this.data[n+5]=l+o[2]*a,this.data[n+6]=c+o[3]*a,this.data[n+7]=r[2]*h,this.data[n+8]=r[3]*h,this.data[n+9]=1,this.data[n+10]=l+o[4]*a,this.data[n+11]=c+o[5]*a,this.data[n+12]=r[4]*h,this.data[n+13]=r[5]*h,this.data[n+14]=1,this.data[n+15]=l+o[6]*a,this.data[n+16]=c+o[7]*a,this.data[n+17]=r[6]*h,this.data[n+18]=r[7]*h,this.data[n+19]=1,t++}}calcSnap(t){return this.lastSnap.copy(this.thisSnap),this.thisSnap.x=Math.floor(t.x/this.tileSize)*this.tileSize,this.thisSnap.y=Math.floor(t.y/this.tileSize)*this.tileSize,this.thisSnap.x+=this.tileSize,this.thisSnap.y+=this.tileSize,this.snapChanged=this.lastSnap.x!=this.thisSnap.x||this.lastSnap.y!=this.thisSnap.y,this.snapChanged}Render(t){this.processLightsBatch(),this.calcSnap(this.camera.position),this.sprite.position.setTo(640,360),this.sprite.position.minusEquals(this.thisSnap),this.surface.drawTo(this.renderSurface)}renderSurface(){this.gl.clearColor(0,0,0,.5),this.gl.colorMask(!0,!0,!0,!0),this.gl.clear(WebGLRenderingContext.COLOR_BUFFER_BIT),this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.ZERO,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,this.dataBuffer),this.gl.bufferSubData(WebGLRenderingContext.ARRAY_BUFFER,0,this.data),this.gl.activeTexture(WebGLRenderingContext.TEXTURE0),this.gl.bindTexture(WebGLRenderingContext.TEXTURE_2D,this.layer.tileDataTexture);let t=0;for(const e of this.lightGroups)0!=e.activeLights&&(this.gl.useProgram(e.lightingShader.program),this.gl.uniform2f(e.lightingShader.uniform.projectionVector,this.projection.x,this.projection.y),this.gl.uniform2fv(e.lightingShader.uniform.viewportSize,this.scaledViewportSize),this.gl.uniform2f(e.lightingShader.uniform.viewOffset,this.thisSnap.x/this.tileSize,this.thisSnap.y/this.tileSize),this.gl.uniform2fv(e.lightingShader.uniform.inverseTileTextureSize,this.layer.inverseTileDataTextureSize),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aVertexPosition),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aTextureCoord),this.gl.enableVertexAttribArray(e.lightingShader.attribute.aColor),this.gl.vertexAttribPointer(e.lightingShader.attribute.aVertexPosition,2,WebGLRenderingContext.FLOAT,!1,20,0),this.gl.vertexAttribPointer(e.lightingShader.attribute.aTextureCoord,2,WebGLRenderingContext.FLOAT,!1,20,8),this.gl.vertexAttribPointer(e.lightingShader.attribute.aColor,1,WebGLRenderingContext.FLOAT,!1,20,16),this.gl.drawElements(WebGLRenderingContext.TRIANGLES,6*e.activeLights,WebGLRenderingContext.UNSIGNED_SHORT,t),t+=12*e.activeLights);this.gl.blendEquation(WebGLRenderingContext.FUNC_ADD),this.gl.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA),this.gl.colorMask(!0,!0,!0,!0)}}gi.LIGHTING_VERTEX_SHADER="\n        precision mediump float;\n\n        uniform vec2 projectionVector;\n        uniform vec2 viewOffset;\n        \n        attribute vec2 aVertexPosition;\n        attribute vec2 aTextureCoord;\n        attribute float aColor;\n\n        varying vec2 vTextureCoord;\n        varying float vColor;\n\n        void main(void) {\n            gl_Position = vec4( aVertexPosition.x / projectionVector.x -1.0, aVertexPosition.y / -projectionVector.y + 1.0 , 0.0, 1.0);\n            vTextureCoord = aTextureCoord;\n            vColor = aColor;\n        }",gi.LIGHTING_FRAGMENT_SHADER_FACTORY=(t,e)=>`\n        precision mediump float;\n\n        const int PATH_TRACKING_SAMPLES = ${t};\n        const float INV_PATH_TRACKING_SAMPLES = 1.0 / float(PATH_TRACKING_SAMPLES);\n        const vec2 EMPTY_TILE = vec2(1.0, 1.0);\n        const float LIGHT_TO_MAP_RESOLUTION_RATIO = float(${e}); // 0.5;\n\n        uniform sampler2D uSampler;\n        uniform vec2 viewOffset;\n        uniform vec2 viewportSize;\n        uniform vec2 inverseTileTextureSize;\n\n        varying vec2 vTextureCoord;\n        varying float vColor;\n\n        void main(void) {\n            vec2 fragToCenterPos = vTextureCoord.xy;\n            float d = length(fragToCenterPos) / float(PATH_TRACKING_SAMPLES);\n            \n            vec2 pos = vec2(gl_FragCoord.x - 1., viewportSize.y - gl_FragCoord.y);\n\n            vec2 currentPos = (pos - viewOffset) - vec2(0.5,0.5); // * inverseTileTextureSize;\n            vec2 centerPos = currentPos - fragToCenterPos; // * inverseTileTextureSize;\n\n            float m = INV_PATH_TRACKING_SAMPLES * d; // * 0.5;\n\n            float stepPos = 0.;\n            float obs = 1. - d;\n    \n            vec2 scaledTilesSize = inverseTileTextureSize * LIGHT_TO_MAP_RESOLUTION_RATIO;\n\n            for(int i = 0; i < PATH_TRACKING_SAMPLES; i++)\n            {\n                stepPos += INV_PATH_TRACKING_SAMPLES; \n                vec4 tile = texture2D(uSampler, floor(mix(centerPos, currentPos, stepPos)) * scaledTilesSize);\n\n                if (all(lessThan(tile.xy, EMPTY_TILE))) {\n                    obs -= m;\n                    // obs *= m;\n                    // col *= saturate(1 - (1 - obstacle)*obstacle.a*m);\n                }\n            }\n        \n            gl_FragColor.a = clamp(obs,0.,1.);\n            // gl_FragColor = vec4(1.,1.,1.,1.0-d);\n\n        }`;class yi extends v{constructor(t,e){super([C,Ge,ue]),this.map=t,this.renderer=new gi([64,160,256,320,480],e)}preUpdate(){return this.renderer.reset(),!0}updateEntity(t,e,i,s){i.flicker>0?this.renderer.addBlockedLight(e.coords.x+Te(-10,10),e.coords.y+Te(-10,10),i.range*i.intensity,i.red,i.green,i.blue):this.renderer.addBlockedLight(e.coords.x,e.coords.y,i.range*i.intensity,i.red,i.green,i.blue)}nexLightIntensity(t){return e=t+(Math.random()-.3)/10,i=0,s=1,Math.min(Math.max(e,i),s);var e,i,s}}class mi extends v{constructor(t){super([Ut,Ve]),this.behaviorForce=new s,this.totalForce=new s,this.map=t}updateEntity(t,e,i){i.hasChanged&&(i.steeringParameters.map=this.map,i.behaviors.sort(this.behaviorsCompare),i.hasChanged=!1),this.runningSum(i,e.body),e.body.addProportionalForce(this.totalForce)}runningSum(t,e){this.totalForce.setTo(0,0);for(var i=0;i<t.behaviors.length;i++){const s=t.behaviors[i];s.active&&(this.behaviorForce.setTo(0,0),s.calculate(e,t.steeringParameters,this.behaviorForce),this.behaviorForce.multEquals(s.weight),this.totalForce.plusEquals(this.behaviorForce))}this.totalForce.clampScalar(t.steeringParameters.maxAcceleration)}behaviorsCompare(t,e){return t.priority<e.priority?-1:t.priority==e.priority?0:1}}var xi;!function(t){t.Destroy="destroy"}(xi||(xi={}));class bi{constructor(t){this.maxMembers=t,this.members=new Set,this.messages=new g,this.onMemberMessage=this.onMemberMessage.bind(this)}addMember(t,e){this.hasCapacity()&&(this.members.add(t),e.messages.add(this.onMemberMessage))}removeMember(t){this.members.delete(t)}onMemberMessage(t,e){switch(e){case xi.Destroy:this.removeMember(t)}}hasCapacity(){return this.members.size<this.maxMembers}}class fi{constructor(t){this.group=new bi(t)}}class Ei extends v{constructor(){super([fi,ue,Kt])}onEntityRemoved(t,e,i,s){e.group.members.forEach(t=>{this.engine.getComponentForEntity(t,ye).setState(xi.Destroy)})}updateEntity(t,e,i,s){if(e.group.hasCapacity()&&Se(.01)){var n=Ke.create(this.engine,this.engine.getComponentForEntity(t,C).clone());const i=this.engine.getComponentForEntity(n,ye);e.group.addMember(n,i)}}}class wi{constructor(t=0){this.reset(t)}reset(t=0){this.current=0,this.intervalTime=t,this.intervals=0}tick(t){return this.current+=t,this.current>this.intervalTime&&(this.current=0,this.intervals++,!0)}}class vi{constructor(t){this.triggered=!1,this.radius=100,this.group=new bi(t),this.intervalDelay=new wi(1e3)}}class Ci{constructor(){this.stack=new Array}update(t,e){var i=this.getCurrentState();null!=i&&i(t,this,e)}popState(){return this.stack.pop()}popAllStates(){for(;this.stack.length>0;)this.popState()}pushState(t){this.stack.push(t)}setState(t){this.popState(),this.pushState(t)}resetState(t){this.popAllStates(),this.pushState(t)}getCurrentState(){return this.stack.length>0?this.stack[this.stack.length-1]:null}}class Ti{constructor(t){this.nest=t,this.ai=new Ci,this.delay=new wi(1e3),this.chaseCheck=new wi(500)}}class Si extends He{constructor(t,e=0,i=0){super(qe.seekWeight,qe.seekPriority),this.target=t,this.arrivalZone=e,this.seekDist=i}calculate(t,e,i){Si.calc(t,e,i,this.target,this.arrivalZone,this.seekDist)}static calc(t,e,i,s,n=0,r=0){var o=s.x-t.position.x+1e-6,a=s.y-t.position.y+1e-6,h=o*o+a*a;if(r>0&&h<r*r)return!1;var l=Math.sqrt(h),c=1;return l<n&&(c=l/n),i.x=o/l,i.x*=e.maxSteeringForcePerStep,i.x-=.06*t.velocity.x,i.x*=c,i.y=a/l,i.y*=e.maxSteeringForcePerStep,i.y-=.06*t.velocity.y,i.x*=c,!0}}class Ai{static create(t,e,i,s){var n=new Jt(new Ht);n.setMass(1),n.setBounces(0),n.globalForceFactor=0,n.maxScalarVelocity=200;var r=t.createEntity();return t.addComponentsToEntity(r,[e,new Ti(s),new Mt(4,4),new T("bird"),new Ut(n,!1),new zt,new It(!1,null,[]),new ot("bird","fly"),new Ve([new je(55,80,.3),new Si(i.coords,256),new Je(60)]),new ye(Ai.states,null,!1),new ge(15e3,"destroy"),new xe(10,10,0,"destroy"),new Kt]),r}static onDestroy(t,e){t.getComponentForEntity(e,Ce)||t.addComponentsToEntity(e,[new Ce(1)])}}Ai.states={destroy:function(t,e){t.getComponentForEntity(e,Ce)||t.addComponentsToEntity(e,[new Ce(1)])}};class Ri extends v{constructor(){super([C,vi,ue,Kt])}onEntityAdded(t,e,i,s,n){i.trigger=this.engine.createEntity(),this.engine.addComponentsToEntity(i.trigger,[e,new Mt(i.radius/2,i.radius/2),new It(!0,null,[this.triggerCallback]),new Wt,new Kt])}updateEntity(t,e,i,s,n){if(i.intervalDelay.tick(this.dt)){var r=this.evaluateTargets(t);r>=0&&this.releaseBird(t,r)}i.triggered&&(i.triggered=!1)}triggerCallback(t,e,i){}evaluateTargets(t){const e=this.engine.getComponentForEntity(t,C);var i=Me.SearchSortAndFilter(e.coords,200,t,Be.ALL).entities;return i.length>0?i[0].entity:-1}releaseBird(t,e){var i=this.engine.getComponentForEntity(t,vi);if(i.group.hasCapacity()){const e=this.engine.getComponentForEntity(t,C);var s=Ai.create(this.engine,e.clone(),e,t);const n=this.engine.getComponentForEntity(s,ye);i.group.addMember(t,n)}}}class Pi extends v{constructor(t){super([Ti,It,xe,Ve]),this.bfAreaQuery=t,this.baseState=this.baseState.bind(this),this.seekState=this.seekState.bind(this)}onEntityAdded(t,e,i,s,n){e.ai.pushState(this.baseState)}updateEntity(t,e,i,s,n){e.ai.update(t,this.dt)}baseState(t,e,i){this.engine.getComponentForEntity(t,Ti).delay.tick(i)&&e.pushState(this.seekState)}seekState(t,e,i){const s=this.engine.getComponentForEntity(t,C);var n=Me.SearchSortAndFilter(s.coords,300,t,Be.ALL).entities;if(n.length>0){var r=this.engine.getComponentForEntity(t,Ti);r.target=n[0].entity;var o=this.engine.getComponentForEntity(t,Ve),a=o.getBehaviour(Si);return a.target=this.engine.getComponentForEntity(r.target,C).coords,a.arrivalZone=1,o.getBehaviour(je).active=!1,e.popState(),void e.pushState(this.chaseState)}e.popState()}chaseState(t,e,i){}}class Li{constructor(){}}class _i extends v{constructor(t){super([It,Mt,Li]),this.particleEngine=t,this.cycle=0,this.callback=this.callback.bind(this),this._tempVec=new s}onEntityAdded(t,e,i,s){this.engine.getComponentForEntity(t,It).proxy.contactCallbacks.push(this.callback)}updateAllEntities(){this.cycle=2*Math.PI/1e3*this.timestamp%1e3}callback(t,e,i){var s=t.aabb.overlapArea(e.aabb);e.body.damping=.9,this._tempVec.setTo(0,-s*(4.5+.5*Math.sin(this.cycle))),e.body.addForce(this._tempVec),e.body.inWaterPrev?e.aabb.t<t.aabb.t&&Se(.1)&&null!=this.engine.getComponentForEntity(t.entity,ue)&&this.particleEngine.EmitParticle(Te(e.aabb.l,e.aabb.r),t.aabb.t,Te(-20,20),Te(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255):(this.particleEngine.EmitParticle(Te(e.aabb.l,e.aabb.r),t.aabb.t,Te(-20,20),Te(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(Te(e.aabb.l,e.aabb.r),t.aabb.t,Te(-20,20),Te(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255),this.particleEngine.EmitParticle(Te(e.aabb.l,e.aabb.r),t.aabb.t,Te(-20,20),Te(-5,-15),0,1,500,1,!0,!0,null,4,255,255,255,255)),e.body.inWater=!0}}class Fi extends v{constructor(t,e){super([Mt,ri,ci,ue,It,Kt]),this.particleEngine=t,this.tileSize=e}onEntityAdded(t,e,i,s,n,r,o){var a=e.halfWidths.x*e.halfWidths.y*4/(this.tileSize*this.tileSize);s.incPerFrame=s.particlePerUnitPerFrame*a}updateEntity(t,e,i,s,n,r,o){for(s.particleCount+=s.incPerFrame;s.particleCount>1;)this.particleEngine.EmitParticle(Te(r.proxy.aabb.l,r.proxy.aabb.r),Te(r.proxy.aabb.t,r.proxy.aabb.b),i.direction.x*i.power*50,i.direction.y*i.power*50,0,1,Ae(200,400),1,!0,!0,null,4,255,255,255,255),s.particleCount--}}class Bi{static createTMXEntity(t,e){const i=t.createEntity();var s=[];return s.push(ai(e)),s.push(hi(e)),s.push(new It(!0,null,[])),s.push(new Wt),s.push(new Kt),s.push(new Li),t.addComponentsToEntity(i,s),i}}Bi.mapping="Water";class Mi{constructor(t,e,i){this.type=t,this.open=e,this.triggerEvent=i}}class Gi{constructor(t,e){this.channel=t,this.sequence=e}}class Ii{static create(t,e,i,s,n){var r=t.createEntity();return(new dt).groupIndex=we.SOLID_OBJECT_GROUP,t.addComponentsToEntity(r,[e,i,new te(n),new It(!1,null,[]),new Wt,new Mi("door",!1,""),new ye(Ii.states,"open",!0),new Gi("doorA",["open","close"]),new Kt]),r}static onDestroy(t,e){}static createTMXEntity(t,e){const i=hi(e);return i.halfWidths.x/=2,Ii.create(t,ai(e),i,"doorOpen","doorClosed")}}Ii.mapping="door",Ii.states={open:function(t,e){var i=t.getComponentForEntity(e,Mi);t.getComponentForEntity(e,te).setTileFrameId(i.type+"Open");var s=t.getComponentForEntity(e,It);s.proxy.responseBias.x=0,s.proxy.isActive=!1},close:function(t,e){var i=t.getComponentForEntity(e,Mi);t.getComponentForEntity(e,te).setTileFrameId(i.type+"Closed");var s=t.getComponentForEntity(e,It);s.proxy.responseBias.x=1,s.proxy.isActive=!0}};class Wi extends v{constructor(){super([ye]),this.updates=new Array}onEntityAdded(t,e){e.onChange=this.onChange.bind(this,t)}onEntityRemoved(t,e){}updateAllEntities(){for(;this.updates.length>0;){var t=this.updates.pop(),e=this.engine.getComponentForEntity(t,ye);if(null===e||null===e.currentState)return;e.states[e.currentState](this.engine,t),e.messages.dispatch(t,e.currentState)}}onChange(t){this.updates.push(t)}}class Di{constructor(){this.bus=new Map}registerChannels(t,e){t.forEach(t=>{this.bus.has(t)||this.bus.set(t,new g),this.bus.get(t).add(e)})}unregisterChannels(t,e){t.forEach(t=>{this.bus.has(t)&&this.bus.get(t).remove(e)})}trigger(t,e){this.bus.has(t)&&this.bus.get(t).dispatch(e)}}class zi extends v{constructor(t){super([ye,Gi]),this.bus=t}onEntityAdded(t,e,i){i.onChange=this.onChange.bind(this,t),this.bus.registerChannels([i.channel],i.onChange)}onEntityRemoved(t,e,i){this.bus.unregisterChannels([i.channel],i.onChange)}updateAllEntities(){}onChange(t){var e=this.engine.getComponentForEntity(t,ye),i=this.engine.getComponentForEntity(t,Gi);let s=i.sequence.indexOf(e.currentState);const n=++s%i.sequence.length;e.setState(i.sequence[n])}}const Oi=t=>["<thead>","<tr>","<th></th>",t.map(t=>`<th class="rotate"><div><span>${t}</span></div></th>`).join(""),"</tr>","</thead>"].join(""),Ui=(t,e,i,s)=>{const n=[];for(let r=t;r<t+e;r++)n.push(ki(r,i,s));return n.join("")},ki=(t,e,i)=>["<tr>",`<th class="row-header">${t}</th>`,e.map(e=>null===i.get(e)[t]?"<td></td>":"<td>X</td>").join(""),"</tr>"].join("");class Ni{}class Vi{static create(t,e){const i=t.createEntity();var s=new Jt(Ht.RUBBER);return s.setMass(.1),s.setBounces(7),s.maxScalarVelocity=1e3,t.addComponentsToEntity(i,[new Ni,e,new Mt(12,12),new T("chicken"),new ot("chicken","walk"),new It(!1,new dt,[]),new Ut(s,!0),new zt,new Kt,new Ge(64,1,1,1,255,255,255),new ue]),i}}Vi.states={destroy:function(t,e){t.getComponentForEntity(e,Ce)||t.addComponentsToEntity(e,[new Ce(1)])}};const Hi=t=>{document.getElementById("debugDump").addEventListener("click",()=>{const e=document.getElementById("debugResult"),i=((t,e,i)=>{const s=[...t.components.keys()].sort();return['<table class="table table-header-rotated">',Oi(s),"<tbody>",Ui(e,i,s,t.components),"</tbody>"].join("")})(t,0,100);e.innerHTML=i}),document.getElementById("debugChickens").addEventListener("click",()=>{const e=t.query([De])[0],i=t.getComponentForEntity(e,C);for(let e=0;e<10;e++){const e=Vi.create(t,i.clone());t.getComponentForEntity(e,Ut).body.addForce(new s(Ae(-1e5,1e5),Ae(-1e5,-5e3)))}}),document.getElementById("debugDraw").addEventListener("click",t=>{document.getElementById("viewDebug").style.display=t.target.checked?"block":"none",w.params.debug=t.target.checked})},qi=5,Xi=3;class ji{constructor(t){this.bounds=new B,this.reset(t)}reset(t){this.parent=t||null,this.body=null,this.bounds.reset(),this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Yi{constructor(t=new B(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this.worldBounds=t,this.root=null,this.nodes=new Map,this.tempBounds=new B,this.nodePool=new o(()=>new ji),this.nodePool.addCapacity(1e4)}insertNode(t){if(null===this.root)return this.root=t,void(this.root.parent=null);for(var e=t.bounds,i=this.root;!i.isLeaf();){const t=i.left,r=i.right,o=i.bounds.perimeter(),a=this.tempBounds.combine2(i.bounds,e).perimeter(),h=2*a,l=2*(a-o);var s=0;const c=this.tempBounds.combine2(e,t.bounds).perimeter();s=t.isLeaf()?c+l:c-t.bounds.perimeter()+l;var n=0;const d=this.tempBounds.combine2(e,r.bounds).perimeter();if(n=r.isLeaf()?d+l:d-r.bounds.perimeter()+l,h<s&&h<n)break;i=s<n?t:r}var r=i.parent,o=this.nodePool.reserve();o.reset(r),o.bounds.combine2(e,i.bounds),o.height=i.height+1,null!==r?(r.left===i?r.left=o:r.right=o,o.left=i,o.right=t,i.parent=o,t.parent=o):(o.left=i,o.right=t,i.parent=o,t.parent=o,this.root=o);for(var a=t.parent;a;){if(!(a=this.balanceNode(a)).left)throw new Error("Parent of current leaf cannot have a null left child"+a);if(!a.right)throw new Error("Parent of current leaf cannot have a null right child"+a);a.height=1+Math.max(a.left.height,a.right.height),a.bounds.combine2(a.left.bounds,a.right.bounds),a=a.parent}}removeNode(t){if(t===this.root)return void(this.root=null);const e=t.parent,i=e.parent;var s;if(s=e.left===t?e.right:e.left,i){i.left===e?i.left=s:i.right=s,s.parent=i,this.nodePool.free(e);for(var n=i;n;)(n=this.balanceNode(n)).bounds.combine2(n.left.bounds,n.right.bounds),n.height=1+Math.max(n.left.height,n.right.height),n=n.parent}else this.root=s,s.parent=null,this.nodePool.free(e)}trackBody(t){var e=this.nodePool.reserve();e.reset(),e.body=t,e.bounds.copyAABB(t.aabb),e.bounds.expand(2),this.nodes.set(t.id,e),this.insertNode(e)}updateBody(t){var e=this.nodes.get(t.id);if(!e)return!1;this.tempBounds.copyAABB(t.aabb);var i=t.body.delta.x,s=t.body.delta.y;return i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,s<0?this.tempBounds.t+=s:this.tempBounds.b+=s,!e.bounds.contains(this.tempBounds)&&(this.removeNode(e),this.tempBounds.l-=qi,this.tempBounds.t-=qi,this.tempBounds.r+=qi,this.tempBounds.b+=qi,i=t.body.delta.x*Xi,s=t.body.delta.y*Xi,i<0?this.tempBounds.l+=i:this.tempBounds.r+=i,s<0?this.tempBounds.t+=s:this.tempBounds.b+=s,e.bounds.copy(this.tempBounds),this.insertNode(e),!0)}untrackBody(t){var e=this.nodes.get(t.id);e&&(this.removeNode(e),this.nodePool.free(e),this.nodes.delete(t.id))}balanceNode(t){if(t.isLeaf()||t.height<2)return t;var e=t.left,i=t.right,s=t,n=e,r=i,o=e.left,a=e.right,h=i.left,l=i.right,c=r.height-n.height;if(c>1)return r.left=s,r.parent=s.parent,s.parent=r,r.parent?r.parent.left===s?r.parent.left=r:r.parent.right=r:this.root=r,h.height>l.height?(r.right=h,s.right=l,l.parent=s,s.bounds.combine2(n.bounds,l.bounds),r.bounds.combine2(s.bounds,h.bounds),s.height=1+Math.max(n.height,l.height),r.height=1+Math.max(s.height,h.height)):(r.right=l,s.right=h,h.parent=s,s.bounds.combine2(n.bounds,h.bounds),r.bounds.combine2(s.bounds,l.bounds),s.height=1+Math.max(n.height,h.height),r.height=1+Math.max(s.height,l.height)),r;if(c<-1){if(n.left=s,n.parent=s.parent,s.parent=n,n.parent)if(n.parent.left===s)n.parent.left=n;else{if(n.parent.right!==s)throw"Error rotating Dynamic Tree";n.parent.right=n}else this.root=n;return o.height>a.height?(n.right=o,s.left=a,a.parent=s,s.bounds.combine2(r.bounds,a.bounds),n.bounds.combine2(s.bounds,o.bounds),s.height=1+Math.max(r.height,a.height),n.height=1+Math.max(s.height,o.height)):(n.right=a,s.left=o,o.parent=s,s.bounds.combine2(r.bounds,o.bounds),n.bounds.combine2(s.bounds,a.bounds),s.height=1+Math.max(r.height,o.height),n.height=1+Math.max(s.height,a.height)),n}return t}getHeight(){return null===this.root?0:this.root.height}query(t){var e=this.nodes.get(t.id).bounds;Yi.queryHelper(t,e,this.root)}static queryHelper(t,e,i){let s=1;for(Yi.stack[0]=i;s>0;){const i=Yi.stack[--s];i.bounds.intersect(e)&&(i.isLeaf()?i.body!==t&&pt(t,i.body):(Yi.stack[s++]=i.left,Yi.stack[s++]=i.right))}return!1}static queryHelper2(t,e,i){return!(!i||!i.bounds.intersect(e))&&(i.isLeaf()&&i.body!==t?(pt(t,i.body),!1):Yi.queryHelper(t,e,i.left)||Yi.queryHelper(t,e,i.right))}rayCastQuery(t,e=L,i){var s=e=>{if(e&&yt(t,e.body)){if(!e.isLeaf())return s(e.left)||s(e.right);if(i.call(t,e.body))return!0}return!1};s(this.root)}queryArea(t,e){Yi.queryAreaHelper(this.root,t,e)}static queryAreaHelper(t,e,i){let s=1;for(Yi.stack[0]=t;s>0;){const t=Yi.stack[--s];t.bounds.intersect(e)&&(t.isLeaf()?i(t.body):(Yi.stack[s++]=t.left,Yi.stack[s++]=t.right))}return!1}debugDraw(t){var e=i=>{i&&(i.isLeaf()?t.DrawAABB2(i.bounds,"green"):t.DrawAABB2(i.bounds,"white"),i.left&&e(i.left),i.right&&e(i.right))};e(this.root)}}Yi.stack=new Array(100);class Ji{constructor(t){this.map=t,this.staticProxies=new Array,this.dynamicProxies=new Array,this.sleepingProxies=new Array,this.tree=new Yi,this.tempArea=new B}addProxy(t){(t.isStatic?this.staticProxies:this.dynamicProxies).push(t),this.tree.trackBody(t)}removeProxy(t){var e=t.isStatic?this.staticProxies:this.dynamicProxies;e.splice(e.indexOf(t),1),this.tree.untrackBody(t)}collide(){for(var t=this.dynamicProxies.length;--t>=0;){null!=(i=this.dynamicProxies[t]).body&&(i.isSensor||this.map.testCollision(i),i.body.canSleep&&this.sleep(i)),this.tree.updateBody(i)}for(var e=this.dynamicProxies.length;--e>=0;){var i=this.dynamicProxies[e];this.tree.query(i)}}QueryArea(t,e,i=!0,s=!0){this.tempArea.copyAABB(t),this.tree.queryArea(this.tempArea,e)}CastRay(t,e,i=!0,s=!0){this.map.castRay(t)}wake(t){}sleep(t){}}class Ki extends v{constructor(t){super([C,Ni,Ut]),this.particleEngine=t}updateEntity(t,e,i,n){var r=1e6,o=n.body,a=0;if(null!=this.scaredOfPosition&&(r=o.position.distSqrd(this.scaredOfPosition.coords),a=o.position.x-this.scaredOfPosition.coords.x<0?-1:1),r<4096)Se(.1)&&(o.addForce(new s(5e3*a,-8e3)),this.particleEngine.EmitParticle(o.position.x,o.position.y,-10*a,-100,0,5,800,1,!1,!0,null,4,255,255,255,255));else if(Se(.005)){a=function(t=.5){return Math.random()<t?1:-1}(.5);e.direction.x=-a,o.addForce(new s(5e3*a,-8e3)),this.particleEngine.EmitParticle(o.position.x,o.position.y,-20*a,-100,0,5,800,1,!1,!0,null,4,255,255,255,255)}}scaredOf(t){const e=this.engine.getComponentForEntity(t,C);e&&(this.scaredOfPosition=e)}}class Zi{constructor(){}}class Qi{constructor(t,e,i=800,s=600){this.view=t,this.camera=e,this.ctx=t.getContext("2d"),this.Resize(i,s)}Resize(t,e){this.width=t,this.height=e,this.view.width=t,this.view.height=e}Clear(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.strokeStyle="rgba(0,255,0,1)",this.ctx.translate(this.camera.position.x,this.camera.position.y)}DrawRect(t,e,i,s,n){this.ctx.strokeRect(t,e,i,s)}DrawAABB(t,e="white"){this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t.l,t.t),this.ctx.lineTo(t.r,t.t),this.ctx.moveTo(t.r,t.b),this.ctx.lineTo(t.l,t.b),this.ctx.stroke()}DrawAABB2(t,e="white"){this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t.l,t.t),this.ctx.lineTo(t.r,t.t),this.ctx.lineTo(t.r,t.b),this.ctx.lineTo(t.l,t.b),this.ctx.lineTo(t.l,t.t),this.ctx.stroke()}DrawCross(t,e,i){this.ctx.beginPath(),this.ctx.moveTo(t-i,e),this.ctx.lineTo(t+i,e),this.ctx.moveTo(t,e-i),this.ctx.lineTo(t,e+i),this.ctx.stroke()}}class $i extends v{constructor(t,e){super([C,Mt,Zi]),this.canvas=t,this.camera=e,this.debugRender=new Qi(t,e,1280,768)}preUpdate(){if(!w.params.debug)return!1;this.debugRender.Clear()}updateEntity(t,e,i,s){this.debugRender.DrawCross(e.coords.x,e.coords.y,15)}}class ts{constructor(t){this.intervalDelay=new wi(t)}}class es extends v{constructor(){super([ts,C])}updateEntity(t,e,i){if(e.intervalDelay.tick(this.dt)){var s=Me.SearchSortAndFilter(i.coords,200,t,Be.ENEMY).entities;s.length>0&&this.fireBulletAtEntity(i,s[0].entity)}}fireBulletAtEntity(t,e){this.fireBullet(t.coords.clone(),this.engine.getComponentForEntity(e,C).coords.clone())}fireBullet(t,e){var i=new dt;i.groupIndex=we.TURRET_GROUP;Ie.create(this.engine,new C(t.x,t.y),i,e)}}const is=function(t,e){let i=0;return function(){const s=Date.now();s-i>e&&(i=s,t(...arguments))}};class ss extends M{constructor(){super(),this.id="Camera",this.realPosition=new s,this.viewportSize=new s,this.halfViewportSize=new s,this.shake=new s,this.viewPortAABB=new B,this.worldExtentsAABB=new B}rf(t){return t}Focus(t,e){this.realPosition.x=t,this.realPosition.y=e,this.cameraExtentsAABB.fitPoint(this.realPosition);var i=-this.realPosition.x+this.halfViewportSize.x,s=-this.realPosition.y+this.halfViewportSize.y;Math.abs(i-this.position.x)>2&&(this.position.x=this.position.x+.1*(i-this.position.x)),Math.abs(s-this.position.y)>2&&(this.position.y=this.position.y+.1*(s-this.position.y)),this.position.plusEquals(this.shake),this.position.x=this.rf(this.position.x),this.position.y=this.rf(this.position.y),this.shake.setTo(0,0)}Resize(t,e){this.viewportSize.x=t,this.viewportSize.y=e,this.halfViewportSize.x=t/2,this.halfViewportSize.y=e/2,this.viewPortAABB.l=this.viewPortAABB.t=0,this.viewPortAABB.r=this.viewportSize.x,this.viewPortAABB.b=this.viewportSize.y,this.cameraExtentsAABB=this.worldExtentsAABB.clone(),this.cameraExtentsAABB.expand2(t,e)}}class ns{constructor(){}}class rs extends v{constructor(t){super([It,Mt,Qe,Kt]),this.holderFilterCategory=t,this.callback=this.callback.bind(this)}onEntityAdded(t,e,i,s,n){e.proxy.contactCallbacks.push(this.callback),e.proxy.filter.maskBits|=this.holderFilterCategory}updateAllEntities(){}callback(t,e,i){var s=this.engine.getComponentForEntity(t.entity,Qe);1==s.activate&&this.hold(s,e.entity,t.entity)}hold(t,e,i){if(null==t.heldItem&&null==this.engine.getComponentForEntity(e,Ze)){var s=new Ze(i);this.engine.addComponentsToEntity(e,[s]),t.heldItem=e}}}class os extends v{constructor(t){super([It,Mt,ns]),this.holderFilterCategory=t}onEntityAdded(t,e,i,s){e.proxy.filter.categoryBits|=this.holderFilterCategory}updateAllEntities(){}}class as{constructor(){}}class hs extends v{constructor(){super([C,ns,Ze,Ut,Kt])}onEntityAdded(t,e,i,s,n,r){var o=n.body;o.velocity.setTo(0,0),o.skip=!0;var a=this.engine.getComponentForEntity(s.holder,C).coords;if(e.coords.copy(a),n.body.position.copy(a),null==this.engine.getComponentForEntity(t,as)){var h=this.engine.getComponentForEntity(s.holder,Qe),l=this.engine.getComponentForEntity(h.parent,Ut).body;null!=l&&l.setMass(l.mass+o.mass)}}onEntityRemoved(t,e,i,s,n,r){this.drop(s.holder);var o=n.body;if(o.skip=!1,o.velocity.setTo(0,0),null==this.engine.getComponentForEntity(t,as)){var a=this.engine.getComponentForEntity(s.holder,Qe),h=this.engine.getComponentForEntity(a.parent,Ut).body;null!=h&&h.setMass(h.mass-o.mass)}}updateEntity(t,e,i,s,n,r){var o=s.holder,a=this.engine.getComponentForEntity(o,C),h=n.body;h.setStaticPosition(a.coords.x+4*a.direction.x,a.coords.y),e.update(h.position)}drop(t){if(null!=t){var e=t;return this.engine.removeComponentsFromEntityByType(t,[Ze]),t=null,e}return null}}class ls{constructor(){this.systems=[]}addSystem(t){this.engine.addPhaseSystemToEngine(t),this.systems.push(t)}updatePhase(t,e){this.systems.forEach(i=>i.updateSystem(t,e))}}class cs{constructor(t){this.teleportPosition=t}}class ds{constructor(t,e,i,s){this.velocity=e,this.interval=t,this.ttl=i,this.jitter=s,this.lastTime=0}update(t,e,i,s){if(!(t-this.lastTime<this.interval)){this.lastTime=t;var n=e(Mt).halfWidths;for(let t=0;t<16;t++)s.EmitParticle(i.x-16+2*t,i.y-n.y,0,this.velocity+Ae(-this.jitter,this.jitter),0,0,this.ttl,.99,!0,!0,null,4,255,255,255,255)}}}class us{static create(t,e,i){var n=t.createEntity();return(new dt).groupIndex=we.SOLID_OBJECT_GROUP,t.addComponentsToEntity(n,[e,i,new It(!0,null,[]),new Wt,new Mi("door",!1,""),new cs(new s(192,576)),new ye(us.states,"on",!0),new Gi("telporterA",["on","off"]),new Kt,new oe([new ds(200,100,600,10)])]),n}}us.mapping="teleporter",us.states={on:function(t,e){t.getComponentForEntity(e,It).proxy.isActive=!0,t.addComponentsToEntity(e,[])},off:function(t,e){t.getComponentForEntity(e,It).proxy.isActive=!0,t.removeComponentsFromEntityByType(e,[oe])}};class ps extends v{constructor(){super([It,cs]),this.onCollision=this.onCollision.bind(this)}onEntityAdded(t,e,i,s){e.proxy.contactCallbacks.push(this.onCollision)}onCollision(t,e,i){Se(.1)&&e.body.position.copy(this.engine.getComponentForEntity(t.entity,cs).teleportPosition)}}class gs{constructor(t){this.volume=t}}class ys extends v{constructor(){super([C,ii,ei])}updateEntity(t,e,i,s){e.prevCoords.copy(e.coords);const n=this.engine.getComponentForEntity(s.parent,C);e.coords.x=n.coords.x+i.point.x*n.direction.x,e.coords.y=n.coords.y+i.point.y*n.direction.y}}const ms="data/16map.json",xs="data/sprites.json",bs="data/sprites.png",fs="data/frames.json",Es="data/tileFrames.json",ws="data/superSet.png",vs=16;new class extends w{constructor(){super(document.getElementById("view")),this.loadAssets([xs,bs,fs,ms,ws,Es])}initalize(){this.engine.addCapacityToEngine(1e3);const t=JSON.parse(this.assets.assets.get(ms));var e=new B(0,vs*t.width,vs*t.height,0);e.expand(-vs);const i=new ss;i.worldExtentsAABB=e;const n=function(t,e,i){for(var s=new Q(t.width,t.height,i,1),n=0;n<t.width;n++)for(var r=0;r<t.height;r++){var o=t.get(n,r,0);if(o>0){var a=o-e;s.set(n,r,0,1<<a)}else s.set(n,r,0,0)}for(var h=0;h<30;h++){let t="";for(var l=0;l<30;l++)t+=s.get(l,h,0)?"X":"0"}return s}(tt(et(t,"Collision")),function(t,e){const i=t.tilesets.filter(t=>t.name===e);return 1===i.length?i[0]:null}(t,"Collision").firstgid,vs),r=new Bt(n),o=new re(4e3,1e3/60,n),a=new Ji(r);this.dynamicTree=a.tree,Me.setup(this.engine,a);const h=new Di;window.mb=h;const l=new ls;this.engine.addPhase(l),l.addSystem(new Nt),l.addSystem(new Dt(a)),l.addSystem(new Ot(a)),l.addSystem(new Zt),l.addSystem(new kt(a)),l.addSystem(new Vt),l.addSystem(new ys),l.addSystem(new hs),l.addSystem(new si(this.input,o)),l.addSystem(new mi(r)),l.addSystem(new $t(this.input)),l.addSystem(new ae(o)),l.addSystem(new pe(i)),l.addSystem(new me),l.addSystem(new be),l.addSystem(new Ee),l.addSystem(new oi),l.addSystem(new Ei),l.addSystem(new Ri),l.addSystem(new Pi(Me.bfAreaQuery));const c=new Ki(o);l.addSystem(c),l.addSystem(new es),l.addSystem(new _i(o)),l.addSystem(new Fi(o,16)),l.addSystem(new Wi),l.addSystem(new zi(h)),l.addSystem(new rs(we.HOLDABLE_CAT)),l.addSystem(new os(we.HOLDABLE_CAT)),l.addSystem(new ps),l.addSystem(new We);const d=new ls;this.engine.addPhase(d),this.renderSystem=new q(this.canvas,i,new s(1280,720)),this.renderSystem.textureManager.AddTexture(bs,this.assets.assets.get(bs)),this.renderSystem.textureManager.AddTexture(ws,this.assets.assets.get(ws)),this.renderSystem.textureManager.ParseTexturePackerJSON(this.assets.assets.get(xs),bs),this.renderSystem.frameListManager.ParseFrameListJSON(this.assets.assets.get(fs)),d.addSystem(new ht(this.renderSystem.frameListManager));const u=it(tt(et(t,"Background"))),p=it(tt(et(t,"Foreground1"))),g=it(tt(et(t,"Foreground2")));var y=new rt(8,2);y.SetTileRenderLayer("bg",["Background","Foreground1"]),y.SetTileRenderLayer("fg",["Foreground2"]),this.renderSystem.renderer.AddRenderer(y),y.SetTileLayerFromData(g,this.renderSystem.textureManager.baseTextures.get(ws),"Foreground2",1,1);const m=y.SetTileLayerFromData(p,this.renderSystem.textureManager.baseTextures.get(ws),"Foreground1",1,1);y.SetTileLayerFromData(u,this.renderSystem.textureManager.baseTextures.get(ws),"Background",1,1);const x=new yi(r,m);this.renderSystem.renderer.AddRenderer(x.renderer),d.addSystem(x),d.addSystem(new ee(this.assets.assets.get(Es),y,r));const b=new K;b.AddStage(this.renderSystem.stage),this.renderSystem.renderer.AddRenderer(b),this.renderSystem.itemContainer.addChild(y.renderLayersMap.get("bg").sprite),this.renderSystem.camera.addChild(y.renderLayersMap.get("fg").sprite),this.renderSystem.camera.addChild(x.renderer.sprite),d.addSystem(this.renderSystem);const f=document.getElementById("viewDebug"),E=new $i(f,this.renderSystem.camera);d.addSystem(E),this.debugGraphics=E.debugRender,this.renderSystem.renderer.AddRenderer(o.renderer);const w=this.mapPosition(33.5,38.5),v=ze.create(this.engine,w);c.scaredOf(v),this.renderSystem.cameraTarget=w.coords;let S=0,A=0,R=null;for(var P=0;P<1;P++){const t=this.engine.createEntity();null==R&&(R=t),(S+=20)>700&&(S=0,A+=20);var L=new Jt(Ht.NORMAL);L.setBounces(3),L.maxScalarVelocity=1e3,this.engine.addComponentsToEntity(t,[new C(100+S,200+A),new Mt(12,12),new T("chicken"),new ot("chicken","walk"),new It(!1,new dt,[]),new Ut(L,!0),new zt,new Kt,new ue,new Zi])}const _=new Map;_.set(di.mapping,di.createTMXEntity),_.set(Bi.mapping,Bi.createTMXEntity),_.set(Ii.mapping,Ii.createTMXEntity),function(t,e,i){e.objects.forEach(e=>{const s=i.get(e.type);s&&s(t,e)})}(this.engine,et(t,"Objects"),_),us.create(this.engine,this.mapPosition(3,23),new Mt(16,32));const F=this.engine.createEntity();this.engine.addComponentsToEntity(F,[this.mapPosition(10.5,18.5),new Mt(8,8),new It(!1,new dt,[is(()=>{h.trigger("doorA",{})},1e3)]),new Wt,new Kt,new te("switchOff")]);const M=this.engine.createEntity();this.engine.addComponentsToEntity(M,[this.mapPosition(20.5,17),new Mt(16,16),new T("insects","hive"),new It(!1,null,[]),new Wt,new Kt,new fi(5)]);const G=this.engine.createEntity();this.engine.addComponentsToEntity(G,[this.mapPosition(34,30),new Mt(7,7),new Wt,new vi(5),new Kt]);const I=this.engine.createEntity(),W=new dt;W.groupIndex=we.TURRET_GROUP,this.engine.addComponentsToEntity(I,[this.mapPosition(25,1.5),new te("turret"),new Mt(12,12),new It(!1,W,[]),new Wt,new ts(1e3),new Kt]);const D=this.engine.createEntity();this.engine.addComponentsToEntity(D,[this.mapPosition(13,4),new Mt(7,7),new T("items","rock"),new It(!1,new dt,[]),new zt,new Ut(new Jt(Ht.ROCK),!0),new ns,new Kt]);const z=this.engine.createEntity();this.engine.addComponentsToEntity(z,[this.mapPosition(23,46),new Mt(6,14),new T("items","water_container"),new It(!1,new dt,[]),new zt,new Ut(new Jt(Ht.NORMAL),!0),new ns,new gs(10),new Kt]),this.loop.start(),Hi(this.engine)}mapPosition(t,e){return new C(t*vs,e*vs)}fireBullet(t,e){var i=new dt;i.groupIndex=we.TURRET_GROUP;Ie.create(this.engine,new C(t.x,t.y),i,e)}preUpdate(){this.input.Update(-this.renderSystem.camera.position.x,-this.renderSystem.camera.position.y)}postUpdate(){w.params.debug&&this.dynamicTree&&this.dynamicTree.debugDraw(this.debugGraphics)}}}]);